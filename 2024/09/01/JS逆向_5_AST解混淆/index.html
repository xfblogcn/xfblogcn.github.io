<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="xfblog">
    
    <title>
        
            JSé€†å‘_5_ASTè§£æ··æ·† |
        
        XFBLOG.CN
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/favicon.webp">
    
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/font/css/brands.min.css">
    
        
            
                
<link rel="stylesheet" href="/css/custom-1.css">

            
        
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.xml"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"XFBLOG.CN","author":"xfblog","avatar":"/images/avatar.webp","logo":"/images/logo.webp","favicon":"/images/favicon.webp"},"menu":{"home":"/ || fa-solid fa-home","JumpTo":{"children":[{"JSé€†å‘_3_æ‰£ç®—æ³•ä¸“é¢˜":"/2024/05/01/JSé€†å‘_3_æ‰£ç®—æ³•ä¸“é¢˜/"},{"JSé€†å‘_4_è¡¥ç¯å¢ƒä¸“é¢˜":"/2024/07/01/JSé€†å‘_4_è¡¥ç¯å¢ƒä¸“é¢˜/"}]},"archives":"/archives || fa-solid fa-box-archive","tags":"/tags || fa-solid fa-tags","links":"/links || fa-solid fa-link","about":"/about || fa-solid fa-circle-info"},"first_screen":{"enable":true,"background_img":"/images/home_lights.webp","background_img_dark":"/images/home_dark.webp","description":null,"hitokoto":false},"social_contact":{"enable":true,"links":{"github":"https://github.com/xfblogcn","weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":true,"hide_header":true},"home":{"announcement":"ç‰ˆæƒå£°æ˜ï¼šæœ¬ç«™æ‰€æœ‰æ–‡ç« å‡ä¸º xfblog.cn å°å‚…åŸåˆ›ï¼Œè¯·éµå¾ª CC 4.0 BY-SA ç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚","category":true,"tag":true,"post_datetime":"created","post_datetime_format":"YYYY-MM-DD"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD","copyright_info":true,"share":true,"reward":{"enable":true,"img_link":"/images/zfb.webp","text":"åˆ›ä½œä¸æ˜“ï¼Œæ‰“èµéšæ„ï¼Œæ‚¨çš„æ”¯æŒæ˜¯æˆ‘æ›´æ–°çš„åŠ¨åŠ›ğŸ’ªï¼"}},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"obsidian"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":false,"site_pv":false,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"jsdelivr"},"pjax":{"enable":true},"footer":{"since":2021,"word_count":false,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":"èœ€ICPå¤‡2021021033å·-1","link":"https://beian.miit.gov.cn"},{"code":"å·å…¬ç½‘å®‰å¤‡ 51138102000134å·","link":"http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=51138102000134"}]}},"inject":{"enable":true,"css":["/css/custom-1.css"],"js":["/js/run_time.js","/js/code_click_copy.js","/js/copyrightpro.js"]},"root":"","source_data":{},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Keep" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.webp">
                </a>
            
            <a class="site-name border-box" href="/">
               XFBLOG.CN
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box has-sub-menu">
                            <a class="menu-text-color border-box" href="javascript:void(0);">
                                
                                JUMPTO
                                
                                    <i class="menu-text-color collapse-icon fa-solid fa-angle-down"></i>
                                
                            </a>
                            
                                <ul class="sub-menu-list border-box">
                                    
                                        
                                        <li class="sub-menu-item border-box ">
                                            <a class="menu-text-color border-box flex-start" href="/2024/05/01/JS%E9%80%86%E5%90%91_3_%E6%89%A3%E7%AE%97%E6%B3%95%E4%B8%93%E9%A2%98/">
                                                
                                                JSé€†å‘_3_æ‰£ç®—æ³•ä¸“é¢˜
                                            </a>
                                        </li>
                                    
                                        
                                        <li class="sub-menu-item border-box ">
                                            <a class="menu-text-color border-box flex-start" href="/2024/07/01/JS%E9%80%86%E5%90%91_4_%E8%A1%A5%E7%8E%AF%E5%A2%83%E4%B8%93%E9%A2%98/">
                                                
                                                JSé€†å‘_4_è¡¥ç¯å¢ƒä¸“é¢˜
                                            </a>
                                        </li>
                                    
                                </ul>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/links">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-link"></i>
                                
                                å‹é“¾
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/about">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-circle-info"></i>
                                
                                å…³äº
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box has-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="javascript:void(0);">
                            
                            JUMPTO
                        </a>
                        
                            <i class="right-side collapse-icon fa-solid fa-angle-left"></i>
                        
                    </label>
                    
                        <ul class="drawer-sub-menu-list border-box">
                            
                                
                                <li class="sub-menu-item border-box">
                                    <a class="drawer-menu-text-color border-box flex-start" href="/2024/05/01/js%E9%80%86%E5%90%91_3_%E6%89%A3%E7%AE%97%E6%B3%95%E4%B8%93%E9%A2%98/">
                                        
                                        JSé€†å‘_3_æ‰£ç®—æ³•ä¸“é¢˜
                                    </a>
                                </li>
                            
                                
                                <li class="sub-menu-item border-box">
                                    <a class="drawer-menu-text-color border-box flex-start" href="/2024/07/01/js%E9%80%86%E5%90%91_4_%E8%A1%A5%E7%8E%AF%E5%A2%83%E4%B8%93%E9%A2%98/">
                                        
                                        JSé€†å‘_4_è¡¥ç¯å¢ƒä¸“é¢˜
                                    </a>
                                </li>
                            
                        </ul>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/links">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-link"></i>
                                </span>
                            
                            å‹é“¾
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/about">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-circle-info"></i>
                                </span>
                            
                            å…³äº
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        JSé€†å‘_5_ASTè§£æ··æ·†
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/avatar.webp">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">xfblog</span>
                                
                                    <span class="author-badge">Lv3</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2024-09-01</span>
            </span>

            
                <span class="meta-info-item post-update-date">
                    <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                    <span class="datetime" data-updated="Tue Jun 17 2025 15:24:43 GMT+0800">2025-06-17</span>
                </span>
            
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/%E7%88%AC%E8%99%AB/">çˆ¬è™«</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/JS%E9%80%86%E5%90%91/">JSé€†å‘</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E7%88%AC%E8%99%AB/">çˆ¬è™«</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Python/">Python</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>40.8k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>209 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="é›¶ã€AST-é€šç”¨æ¨¡ç‰ˆ"><a href="#é›¶ã€AST-é€šç”¨æ¨¡ç‰ˆ" class="headerlink" title="é›¶ã€AST é€šç”¨æ¨¡ç‰ˆ"></a>é›¶ã€AST é€šç”¨æ¨¡ç‰ˆ</h2><h3 id="1-è§£æ··æ·†æ€è·¯ä¸ç»†èŠ‚å¤„ç†"><a href="#1-è§£æ··æ·†æ€è·¯ä¸ç»†èŠ‚å¤„ç†" class="headerlink" title="1. __è§£æ··æ·†æ€è·¯ä¸ç»†èŠ‚å¤„ç†"></a>1. __è§£æ··æ·†æ€è·¯ä¸ç»†èŠ‚å¤„ç†</h3><blockquote>
<p><strong>å…³äº scope ç»‘å®šï¼š</strong></p>
<ol>
<li>å•ç‹¬çš„èµ‹å€¼è¯­å¥ï¼Œå…¶æ ‡è¯†ç¬¦æ˜¯æ²¡æœ‰ç»‘å®šçš„ï¼Œå³ !binding &#x3D;&#x3D; trueï¼Œ<strong>ä½†å‡½æ•°ä¸­å½¢å‚æ˜¯æœ‰ç»‘å®šçš„ï¼Œè‹¥ä¸ºå½¢å‚çš„èµ‹å€¼è¯­å¥ï¼Œä¸”æ”¹å˜æ¬¡æ•°åªæœ‰ä¸€æ¬¡ï¼Œé‚£ä¹ˆå°±æ˜¯å…¶æœ¬èº«ï¼Œå³ constantViolations[0] &#x3D;&#x3D; binding.path</strong></li>
<li><strong><span style="color:green;">åœ¨ä»»ä½•å¾ªç¯è¯­å¥ä¸­ï¼Œè‹¥å˜é‡å®šä¹‰æ—¶èµ‹å€¼ï¼Œå³å˜é‡å£°æ˜ + å˜é‡å®šä¹‰ï¼Œä¸” kind å€¼ä¸º varï¼Œä¸”è¯­å¥æ˜¯å¾ªç¯è¯­å¥çš„ç›´ç³»å­èŠ‚ç‚¹ï¼Œåˆ™ä¼šè¢«è§†ä¸ºä¸€æ¬¡æ”¹å˜ï¼Œå³ constantViolations[0] &#x3D;&#x3D; binding.pathï¼ˆæ³¨æ„ä¸å¾ªç¯æ¬¡æ•°æ— å…³ï¼‰</span>ï¼Œä½†å¦‚æœå˜é‡æ˜¯å­˜åœ¨äºåµŒå¥—çš„å­èŠ‚ç‚¹ä¸‹ï¼ˆåµŒå¥—çš„å¾ªç¯è¯­å¥é™¤å¤–ï¼Œæ»¡è¶³ä¸Šé¢æ¡ä»¶ä¹Ÿç®—æ”¹å˜ä¸€æ¬¡ï¼‰ï¼Œé‚£ä¹ˆå°±å’Œå®šä¹‰åœ¨å¤–éƒ¨çš„æ™®é€šå˜é‡å®šä¹‰è¯­å¥ä¸€æ ·ï¼Œæ”¹å˜æ•°ä¸º 0ï¼›<span style="color:red;">ä½†å¦‚æœåœ¨å¾ªç¯è¯­å¥ä¸­ï¼Œæ˜¯ let æˆ– const å®šä¹‰å˜é‡ï¼Œåˆ™æ”¹å˜æ•°åŒæ ·ä¸º 0ï¼Œç®—åšå¸¸é‡ï¼Œä¹Ÿå°±æ˜¯è¯´é‡ç‚¹æ˜¯å˜é‡å®šä¹‰æ–¹å¼</span></strong></li>
<li><strong>å¯¹æ•°ç»„ arr æˆ–å¯¹è±¡ obj è¿›è¡Œå…ƒç´ èµ‹å€¼çš„æ“ä½œï¼Œåªç®—å¼•ç”¨æ¬¡æ•°ï¼Œä¸ç®—æ”¹å˜</strong>ï¼Œä¾‹ <code>arr[1] = 9;</code>ã€<code>++arr[1];</code>ã€<code>obj[&#39;age&#39;] = 18;</code></li>
<li>åœ¨ä¸€ä¸ªå±€éƒ¨ä½œç”¨åŸŸä¸­ï¼Œä¾‹å¦‚å‡½æ•°ä¸­å­˜åœ¨ä¸å‡½æ•°ååŒåçš„æ ‡è¯†ç¬¦ï¼ˆåŒ…æ‹¬å½¢å‚ï¼‰ï¼Œåˆ™éœ€è¦é€šè¿‡å…¶çˆ¶ path è·å–å½“å‰èŠ‚ç‚¹çš„ bindingï¼Œå¦åˆ™å¯èƒ½ä¼šè·å–é”™å¯¹è±¡çš„ç»‘å®š</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">var str1 = 1;</span><br><span class="line"></span><br><span class="line">for (var i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">    function func(str2) &#123;</span><br><span class="line">        str2 = 2;</span><br><span class="line">        var str3 = 3;</span><br><span class="line">    &#125;</span><br><span class="line">    while (i &lt; 5) &#123;</span><br><span class="line">        var str4 = 4;</span><br><span class="line">    &#125;</span><br><span class="line">    func();</span><br><span class="line">    var str5 = 5;</span><br><span class="line">    let str6 = 6;</span><br><span class="line">    const str7 = 7;</span><br><span class="line">&#125;</span><br><span class="line">while (false) &#123;</span><br><span class="line">    var str8 = 8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var arr = [1, 2, 3];</span><br><span class="line">const obj = &#123; name: &quot;Tom&quot;, age: 25 &#125;;</span><br><span class="line">arr[1] = 9;</span><br><span class="line">++arr[1];</span><br><span class="line">obj[&#x27;age&#x27;] = 18;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">str1 false 0 true 0</span><br><span class="line">i true 3 false 1</span><br><span class="line">str2 false 0 false 1</span><br><span class="line">str3 false 0 true 0</span><br><span class="line">str4 false 0 false 1</span><br><span class="line">str5 false 0 false 1</span><br><span class="line">str6 false 0 true 0</span><br><span class="line">str7 false 0 true 0</span><br><span class="line">str8 false 0 false 1</span><br><span class="line">arr true 2 true 0</span><br><span class="line">obj true 1 true 0</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">const newVisitor = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; node, scope &#125; = path;</span><br><span class="line">        let name = node.id.name;</span><br><span class="line">        scope.crawl();</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">    &#125;,</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; node, scope &#125; = path;</span><br><span class="line">        let name = node.left.name;</span><br><span class="line">        scope.crawl();</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, newVisitor);</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><strong>æ•°ç»„è¿˜åŸæ€è·¯ï¼š</strong>ç›´æ¥å¤åˆ¶ç½‘é¡µåŸå§‹æ•°ç»„ <code>copy(_$UH.map(String))</code> åœ¨æœ¬åœ°é€šè¿‡ ast éå†è¿˜åŸ</li>
<li><strong>é€šç”¨æ€è·¯ï¼š</strong><ol>
<li><strong>æ‹¿åˆ°ä¸€æ®µä»£ç ï¼Œå…ˆè¿›è¡Œé¢„å¤„ç†ï¼Œç„¶åè§‚å¯Ÿå…¶æ•´ä½“ç»“æ„ï¼Œä¸è¦ç›²ç›®è¿˜åŸï¼Œå¦‚æœéœ€è¦è¿˜åŸçš„å‡½æ•°è°ƒç”¨ï¼Œå…¶é‡Œé¢è¿˜åµŒå¥—çš„æœ‰å‡½æ•°è°ƒç”¨ï¼Œé‚£å°±åº”è¯¥å…ˆè¿˜åŸé‡Œé¢é‚£å±‚çš„</strong></li>
<li><strong>åµŒå¥—çš„èŠ‚ç‚¹è¿˜åŸï¼Œä¼˜å…ˆé‡‡ç”¨ exit æ–¹å¼éå†ï¼š</strong><code>a = b = c = d;</code>ã€<code>(n = (n = (n = (n = n[]())</code>ï¼Œå¦‚æœæ­¤æ—¶æ’ä»¶ä¸­è¿˜è¦éå†å…¶ä»–ç±»å‹èŠ‚ç‚¹è¿›è¡Œå¤„ç†ï¼Œè€Œè¿™ä¸ªå¤„ç†ç»“æœåˆå¯ä»¥ç»§ç»­ç”ŸæˆæŒ‡å®šç‰¹å¾çš„è¿˜åŸï¼Œé‚£ä¹ˆè¿™ä¸ªéå†<strong>ä¹Ÿè¦ç”¨ exit æ–¹å¼</strong>ï¼Œå› ä¸º<strong>è¦ä¿è¯ä¸‹é¢çš„éå†æ¯”ä¸Šé¢çš„éå†æ™šé€€å‡º</strong>ï¼ˆ<strong>æ³¨æ„å¦‚æœåŒæ—¶è¦åœ¨éå†è¿‡ç¨‹ä¸­éå†å¤„ç†å…¶ä»–ç±»å‹èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæœ€å¥½ä¸è¦å°†å…¶åˆ†å¼€ä¸ºå¤šä¸ªæ’ä»¶ï¼Œå› ä¸ºåœ¨åŒä¸€ä¸ªæ’ä»¶ä¸­ï¼Œæ˜¯ä¼šæ— é™é€’å½’éå†æ­¤ç±»å‹çš„èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬åˆšå¤„ç†è¿‡çš„ï¼›è€Œå°†æ’ä»¶åˆ†å¼€å†™ï¼Œå°±ä¼šå¯¼è‡´æ¯ä¸ªæ’ä»¶åˆ†å¼€ä½œç”¨ï¼Œæ’ä»¶1éå†ä¸€æ¬¡å¤„ç†å¥½äº†ï¼Œç„¶åæ’ä»¶2éå†æ’ä»¶1å¤„ç†å¥½çš„ç»“æœå¹¶å†æ¬¡å¤„ç†ï¼Œå†ç„¶åå°±ç»“æŸäº†</strong>ï¼ŒåŒæ—¶è¦æ³¨æ„é…åˆ <code>scope.crawl()</code> ä½¿ç”¨ï¼‰</li>
<li><strong><span style="color:red;">åœ¨ä¸€ä¸ªä½œç”¨åŸŸå†…ç»§ç»­è·å–å…ƒç´ çš„ bandingï¼Œå°±è¦ä½¿ç”¨å½“å‰ banding.path.scope.getBinding() å»è·å–</span></strong></li>
<li><strong>æ¯ä¸€æ¬¡è°ƒç”¨æ’ä»¶è¿˜åŸåï¼Œéƒ½åº”è¯¥æ€è€ƒå½“å‰èŠ‚ç‚¹è¢«è¿˜åŸåï¼Œå…¶å®šä¹‰æˆ–å…¶ä½¿ç”¨è¿‡çš„å¯¹è±¡æ˜¯å¦è¿˜æœ‰å­˜åœ¨çš„å¿…è¦</strong>ï¼Œæ²¡æœ‰åˆ™åº”è¯¥ç«‹å³åˆ é™¤ï¼Œ**<span style="color:red;">å°½ç®¡åˆ ä¸å¹²å‡€åŒç±»å‹çš„ï¼Œä½†è‡³å°‘åº”è¯¥æ¸…é™¤ä¸æ­¤æ¬¡è¿˜åŸç›¸å…³çš„åƒåœ¾ä»£ç </span><strong>ï¼ŒåŒç±»å‹çš„åƒåœ¾ä»£ç ç•™ç»™</strong>æœ€åä¸€æ¬¡è°ƒç”¨åƒåœ¾ä»£ç åˆ é™¤æ’ä»¶æ¸…é™¤å³å¯**ï¼Œç›®çš„æ˜¯ä¸ºäº†æ­¤æ¬¡è¿˜åŸä¸å½±å“åç»­æ’ä»¶çš„è°ƒç”¨</li>
<li><strong>åœ¨ obj å¯¹è±¡ value å®ç°ä¹‹å‰ï¼Œæ—¢è¦ä¿è¯å¯¹è±¡å±æ€§ä¸­çš„å‡½æ•°åªæœ‰ä¸€æ¡ return è¯­å¥ï¼Œè¿˜è¦ä¿è¯å±æ€§éå‡½æ•°çš„å‡ä¸ºå­é¢é‡ï¼Œå¦åˆ™æ— æ³•è¿˜åŸ</strong>ï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨ä¸€æ¬¡æŠ˜å å­é¢é‡æˆ–è¡¨è¾¾å¼çš„æ’ä»¶ï¼Œå¹¶ä¸”åœ¨å¯¹è±¡è¿˜åŸä¹‹ååˆä¼šå‡ºç°ä¸€äº›å­é¢é‡ï¼Œæ­¤æ—¶åº”è¯¥<strong>å†æ¬¡è°ƒç”¨ä¸€æ¬¡æŠ˜å å­é¢é‡æˆ–è¡¨è¾¾å¼çš„æ’ä»¶</strong></li>
<li><strong>AST åˆ é™¤çš„æ—¶å€™æœ‰ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯å…¶ç»‘å®šç›¸å…³çš„å‚æ•°éƒ½è¦é‡æ–°è§£æå¹¶åˆ é™¤ä¸€æ¬¡åæ‰ä¼šæ›´æ–°ï¼Œå³éœ€è¦åˆ é™¤ä¸¤æ¬¡</strong></li>
</ol>
</li>
<li><strong>é€šç”¨æ³•åˆ™ï¼š</strong><ol>
<li><strong>ä¸€ä¸ªæ’ä»¶ä¸­ä¸å…è®¸åŒæ—¶éå†ä¸¤ç§ç›¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼Œå³ä½¿éå†å†…å®¹ä¸ä¸€æ ·ä¹Ÿä¸è¡Œï¼Œå› ä¸ºåè€…ä¼šè¦†ç›–å‰è€…</strong></li>
<li><strong>å½“æ’ä»¶æ— ä½œç”¨çš„æ—¶å€™ï¼Œå¯ä»¥å°è¯•é‡æ–°è§£æä¸€æ¬¡ ast æ ‘</strong></li>
<li>åœ¨æ•´ä¸ª ast è§£æ··æ·†å¤§è‡´ç»“æŸæ—¶ï¼Œå¹¶ä¸”è°ƒç”¨åƒåœ¾ä»£ç æ’ä»¶åï¼Œå‰©ä½™çš„å†—ä½™ä»£ç ï¼Œå¯è‡ªè¡Œåˆ¤æ–­æ‰‹åŠ¨åˆ é™¤æ›´å¿«</li>
<li><strong>éå†èµ‹å€¼è¯­å¥é€šå¸¸éƒ½éœ€è¦è¿‡æ»¤ä¸€ä¸‹çˆ¶ path ç±»å‹ï¼Œå› ä¸ºä¸èƒ½æ”¹å˜åœ¨æŸäº›è¯­å¥çš„åˆ¤æ–­æ¡ä»¶ä¸­çš„èµ‹å€¼è¯­å¥</strong></li>
<li><strong>object å¯¹è±¡åˆå¹¶ï¼š</strong>æ„é€ å¯¹è±¡å±æ€§ <code>types.objectProperty(key, value)</code> ï¼Œæ’å…¥ <code>properties.push()</code></li>
<li><strong>é”™è¯¯ç¤ºèŒƒï¼š</strong><code>let &#123; switchNode, breakNode &#125; = body.body;</code> æ­¤æ—¶ body.body æ˜¯ä¸ª<strong>æ•°ç»„</strong>ï¼Œè¦ä¸­æ‹¬å·å–</li>
</ol>
</li>
<li><strong>å¦ä¸€ç§è¿˜åŸæ–¹å¼ï¼ˆä»£ç æ•´ä½“è¢«è‡ªæ‰§è¡Œå‡½æ•°åŒ…è£¹ï¼Œä¸”æ— ä¼ å‚ï¼‰ï¼š</strong><ol>
<li><strong>æ ¸å¿ƒæ€æƒ³ï¼šæƒ³æ–¹è®¾æ³•æ‹¿åˆ°éœ€è¦è¿˜åŸçš„å‡½æ•°çš„è°ƒç”¨ç»“æœ</strong></li>
<li><strong>æ ¸å¿ƒæ­¥éª¤ï¼š</strong>å¤åˆ¶ä¸€ä»½ encode æ–‡ä»¶ä¸º changeï¼Œ<strong>å»é™¤å¤–å±‚è‡ªæ‰§è¡Œå‡½æ•°åŒ…è£¹å¹¶æ›¿æ¢ä¸º try-catch è¯­å¥</strong>ï¼Œä¸ä»…å¯ä»¥è®©ç¨‹åºæ­£å¸¸è¿è¡Œï¼Œè¿˜å¯ä»¥<strong>åŠ å¤§å˜é‡ä½œç”¨åŸŸçš„èŒƒå›´</strong>ï¼›å¦‚æœæ­¤æ—¶å¯ä»¥æ‹¿åˆ°å‡½æ•°è°ƒç”¨å€¼ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥è¿˜åŸäº†</li>
<li><strong>å¼•å…¥æ–‡ä»¶ï¼š</strong><code>let decodeObCode = files.readFileSync(&quot;change.js&quot;, &#123; encoding: &quot;utf-8&quot; &#125;);</code>ï¼Œå¹¶é€šè¿‡ eval æ‰§è¡Œæ–‡ä»¶</li>
</ol>
</li>
</ul>
<h3 id="2-æ¨¡ç‰ˆ-ç®€æ˜“ç‰ˆè§£æ··æ·†æ¨¡ç‰ˆ"><a href="#2-æ¨¡ç‰ˆ-ç®€æ˜“ç‰ˆè§£æ··æ·†æ¨¡ç‰ˆ" class="headerlink" title="2. æ¨¡ç‰ˆ -&gt; ç®€æ˜“ç‰ˆè§£æ··æ·†æ¨¡ç‰ˆ"></a>2. æ¨¡ç‰ˆ -&gt; ç®€æ˜“ç‰ˆè§£æ··æ·†æ¨¡ç‰ˆ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">const _path = require(&#x27;path&#x27;);</span><br><span class="line">const files = require(&#x27;fs&#x27;);  // å¯¼å…¥æ–‡ä»¶åº“ï¼Œé˜²æ­¢ä¸fså˜é‡åå†²çª</span><br><span class="line">const types = require(&quot;@babel/types&quot;);</span><br><span class="line">const parser = require(&quot;@babel/parser&quot;);</span><br><span class="line">const template = require(&quot;@babel/template&quot;).default;</span><br><span class="line">const traverse = require(&quot;@babel/traverse&quot;).default;</span><br><span class="line">const generator = require(&quot;@babel/generator&quot;).default;</span><br><span class="line">const NodePath = require(&quot;@babel/traverse&quot;).NodePath; // æ™ºèƒ½æç¤ºæ‰€éœ€</span><br><span class="line"></span><br><span class="line">const encodeFile = _path.resolve(__dirname, &#x27;encode.js&#x27;);</span><br><span class="line">const decodeFile = _path.resolve(__dirname, &#x27;encode_ok.js&#x27;);</span><br><span class="line">let sourceCode = files.readFileSync(encodeFile, &#123; encoding: &quot;utf-8&quot; &#125;);</span><br><span class="line">let ast = parser.parse(sourceCode);</span><br><span class="line">console.time(&quot;å¤„ç†å®Œæ¯•ï¼Œè€—æ—¶&quot;);</span><br><span class="line"></span><br><span class="line">const decryptFile = _path.resolve(__dirname, &#x27;decode.js&#x27;);</span><br><span class="line">let decryptCode = files.readFileSync(decryptFile, &#123; encoding: &quot;utf-8&quot; &#125;); // è¯»å–è§£å¯†ä»£ç </span><br><span class="line">let evalAst = parser.parse(decryptCode);</span><br><span class="line">decryptCode = generator(evalAst, opts = &#123; compact: true &#125;).code // åˆ©ç”¨astå‹ç¼©ä»£ç </span><br><span class="line">eval(decryptCode);</span><br><span class="line"></span><br><span class="line">const visitor = &#123;</span><br><span class="line">    /**  @param  &#123;NodePath&#125; path */</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, visitor);</span><br><span class="line"></span><br><span class="line">ast.program.body.unshift(types.debuggerStatement());</span><br><span class="line"></span><br><span class="line">console.timeEnd(&quot;å¤„ç†å®Œæ¯•ï¼Œè€—æ—¶&quot;);</span><br><span class="line">let &#123; code &#125; = generator(ast, opts = &#123;</span><br><span class="line">    &quot;compact&quot;: false,  // æ˜¯å¦å‹ç¼©ä»£ç </span><br><span class="line">    &quot;comments&quot;: false,  // æ˜¯å¦ä¿ç•™æ³¨é‡Š</span><br><span class="line">    &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125;,  // Unicodeè½¬ä¹‰ï¼Œç¡®ä¿éASCIIå­—ç¬¦è¢«æ­£ç¡®åœ°ä¿ç•™å’Œæ˜¾ç¤ºï¼Œè€Œä¸æ˜¯è¢«è½¬ä¹‰</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">files.writeFile(decodeFile, code, (err) =&gt; &#123; &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="3-æ¨¡ç‰ˆ-å¸¸ç”¨-banding-å†™æ³•"><a href="#3-æ¨¡ç‰ˆ-å¸¸ç”¨-banding-å†™æ³•" class="headerlink" title="3. æ¨¡ç‰ˆ -&gt; å¸¸ç”¨ banding å†™æ³•"></a>3. æ¨¡ç‰ˆ -&gt; å¸¸ç”¨ banding å†™æ³•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">let binding = scope.getBinding(name);</span><br><span class="line">if (!binding) return;</span><br><span class="line">let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">// console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">if (constantViolations.length &gt; 1) return;</span><br><span class="line">if (constant || constantViolations[0] == binding.path) &#123; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-æ¨¡ç‰ˆ-é¢„å¤„ç†è§£æ··æ·†æ¨¡ç‰ˆ"><a href="#4-æ¨¡ç‰ˆ-é¢„å¤„ç†è§£æ··æ·†æ¨¡ç‰ˆ" class="headerlink" title="4. æ¨¡ç‰ˆ -&gt; é¢„å¤„ç†è§£æ··æ·†æ¨¡ç‰ˆ"></a>4. æ¨¡ç‰ˆ -&gt; é¢„å¤„ç†è§£æ··æ·†æ¨¡ç‰ˆ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br></pre></td><td class="code"><pre><span class="line">const _path = require(&#x27;path&#x27;);</span><br><span class="line">const files = require(&#x27;fs&#x27;);  // å¯¼å…¥æ–‡ä»¶åº“ï¼Œé˜²æ­¢ä¸fså˜é‡åå†²çª</span><br><span class="line">const types = require(&quot;@babel/types&quot;);</span><br><span class="line">const parser = require(&quot;@babel/parser&quot;);</span><br><span class="line">const template = require(&quot;@babel/template&quot;).default;</span><br><span class="line">const traverse = require(&quot;@babel/traverse&quot;).default;</span><br><span class="line">const generator = require(&quot;@babel/generator&quot;).default;</span><br><span class="line">const NodePath = require(&quot;@babel/traverse&quot;).NodePath; // æ™ºèƒ½æç¤ºæ‰€éœ€</span><br><span class="line"></span><br><span class="line">const encodeFile = _path.resolve(__dirname, &#x27;encode.js&#x27;);</span><br><span class="line">const decodeFile = _path.resolve(__dirname, &#x27;encode_ok.js&#x27;);</span><br><span class="line">let sourceCode = files.readFileSync(encodeFile, &#123; encoding: &quot;utf-8&quot; &#125;);</span><br><span class="line">let ast = parser.parse(sourceCode);</span><br><span class="line">console.time(&quot;å¤„ç†å®Œæ¯•ï¼Œè€—æ—¶&quot;);</span><br><span class="line"></span><br><span class="line">const decryptFile = _path.resolve(__dirname, &#x27;decode.js&#x27;);</span><br><span class="line">let decryptCode = files.readFileSync(decryptFile, &#123; encoding: &quot;utf-8&quot; &#125;); // è¯»å–è§£å¯†ä»£ç </span><br><span class="line">let evalAst = parser.parse(decryptCode);</span><br><span class="line">decryptCode = generator(evalAst, opts = &#123; compact: true &#125;).code // åˆ©ç”¨astå‹ç¼©ä»£ç </span><br><span class="line">eval(decryptCode);</span><br><span class="line"></span><br><span class="line">// 1. ç¼–ç è¿˜åŸåè¿›åˆ¶</span><br><span class="line">const simplifyLiteral = &#123;</span><br><span class="line">    NumericLiteral(&#123; node &#125;) &#123;</span><br><span class="line">        if (node.extra &amp;&amp; /^0[obx]/i.test(node.extra.raw)) &#123;</span><br><span class="line">            node.extra = undefined;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    StringLiteral(&#123; node &#125;) &#123;</span><br><span class="line">        if (node.extra &amp;&amp; /\\[ux]/gi.test(node.extra.raw)) &#123;</span><br><span class="line">            node.extra = undefined;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, simplifyLiteral);</span><br><span class="line"></span><br><span class="line">// 2. åˆ†ç¦»å¤šä¸ªå˜é‡åŒå®šä¹‰</span><br><span class="line">// var a, b, c;     ===&gt;     var a; var b; var c;</span><br><span class="line">const DeclaratorToDeclaration = &#123;</span><br><span class="line">    VariableDeclaration(path) &#123;</span><br><span class="line">        let &#123; parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isBlock()) return; // é¿å…å¤„ç†é‚£äº›åœ¨éå—çº§èŠ‚ç‚¹å†…çš„å˜é‡å£°æ˜`if (true) let a, b;`</span><br><span class="line"></span><br><span class="line">        let &#123; declarations, kind &#125; = node;</span><br><span class="line">        if (declarations.length == 1) return;</span><br><span class="line"></span><br><span class="line">        let newNodes = [];</span><br><span class="line">        for (let varNode of declarations) &#123;</span><br><span class="line">            let newDeclarationNode = types.variableDeclaration(kind, [varNode]);</span><br><span class="line">            newNodes.push(newDeclarationNode);</span><br><span class="line">        &#125;</span><br><span class="line">        path.replaceWithMultiple(newNodes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, DeclaratorToDeclaration);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// 3. ç”±å˜é‡å®šä¹‰çš„å‡½æ•°è¡¨è¾¾å¼ï¼Œç»Ÿä¸€è¿˜åŸä¸ºå‡½æ•°å®šä¹‰</span><br><span class="line">// var a =function()&#123;&#125;     ===&gt;     function a()&#123;&#125;</span><br><span class="line">const varDeclarToFuncDeclar = &#123;</span><br><span class="line">    VariableDeclaration(path) &#123;</span><br><span class="line">        let &#123; parentPath, node, scope &#125; = path;</span><br><span class="line">        if (!parentPath.isBlock()) return; // è¿‡æ»¤æ‰éƒ¨åˆ†ç‰¹æ®Šæƒ…å†µï¼Œä¾‹å¦‚forå¾ªç¯é‡Œçš„å˜é‡å®šä¹‰</span><br><span class="line"></span><br><span class="line">        let &#123; declarations, kind &#125; = node;</span><br><span class="line">        if (declarations.length != 1) return;</span><br><span class="line"></span><br><span class="line">        let &#123; id, init &#125; = declarations[0];</span><br><span class="line">        if (!types.isFunctionExpression(init, &#123; id: null &#125;)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; params, body &#125; = init;</span><br><span class="line">        let newNode = types.functionDeclaration(id, params, body);</span><br><span class="line">        path.replaceWith(newNode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, varDeclarToFuncDeclar);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// 4. ç¾åŒ–å¾ªç¯è¯­å¥å’Œ if-else è¯­å¥ï¼Œå¹¶ç®€åŒ–é€»è¾‘</span><br><span class="line">const SimplifyLoopAndIf = &#123;</span><br><span class="line">    &quot;ForStatement|WhileStatement|ForInStatement|ForOfStatement&quot;(&#123; node &#125;) &#123;</span><br><span class="line">        if (!types.isBlockStatement(node.body)) &#123;</span><br><span class="line">            node.body = types.blockStatement([node.body]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;IfStatement&quot;(path) &#123;</span><br><span class="line">        const test = path.get(&quot;test&quot;);</span><br><span class="line">        const consequent = path.get(&quot;consequent&quot;);</span><br><span class="line">        const alternate = path.get(&quot;alternate&quot;);</span><br><span class="line">        const evaluateTest = test.evaluateTruthy();</span><br><span class="line"></span><br><span class="line">        if (!consequent.isBlockStatement() &amp;&amp; !consequent.isEmptyStatement()) &#123;</span><br><span class="line">            consequent.replaceWith(types.blockStatement([consequent.node]));</span><br><span class="line">        &#125;</span><br><span class="line">        if (alternate.node !== null &amp;&amp; !alternate.isBlockStatement() &amp;&amp; !alternate.isEmptyStatement()) &#123;</span><br><span class="line">            alternate.replaceWith(types.blockStatement([alternate.node]));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (consequent.isEmptyStatement() || consequent.node.body.length == 0) &#123;</span><br><span class="line">            if (alternate.node == null || alternate.isEmptyStatement() || alternate.node.body.length == 0) &#123;</span><br><span class="line">                path.replaceWith(test.node);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                consequent.replaceWith(alternate.node);</span><br><span class="line">                alternate.remove();</span><br><span class="line">                path.node.alternate = null;</span><br><span class="line">                test.replaceWith(types.unaryExpression(&quot;!&quot;, test.node));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (alternate.node != null) &#123;</span><br><span class="line">            if (alternate.isEmptyStatement() || alternate.node.body.length == 0) &#123;</span><br><span class="line">                alternate.remove();</span><br><span class="line">                path.node.alternate = null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (evaluateTest === true) &#123;</span><br><span class="line">            path.replaceWithMultiple(consequent.node.body);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (evaluateTest === false) &#123;</span><br><span class="line">            (alternate.node === null || alternate.node.body.length == 0) ? path.remove() : path.replaceWithMultiple(alternate.node.body);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, SimplifyLoopAndIf);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// 5. å»é™¤é€—å·è¡¨è¾¾å¼1</span><br><span class="line">const resolveSequence1 = &#123;</span><br><span class="line">    SequenceExpression(path) &#123;</span><br><span class="line">        let &#123; parentPath, node, parent &#125; = path;</span><br><span class="line">        if (parentPath.parentPath.isLabeledStatement()) return; // æ ‡ç­¾èŠ‚ç‚¹æ— æ³•å¾€å‰æ’å…¥</span><br><span class="line">        let ancestorPath = parentPath.parentPath;</span><br><span class="line">        let expressions = node.expressions;</span><br><span class="line"></span><br><span class="line">        // æŠŠ (0, xxx) çš„é€—å·è¡¨è¾¾å¼ç›´æ¥æ›¿æ¢ä¸ºæœ¬èº«</span><br><span class="line">        if (parentPath.isCallExpression(&#123; callee: node &#125;) &amp;&amp; expressions.length == 2 &amp;&amp; types.isNumericLiteral(expressions[0], &#123; value: 0 &#125;)) &#123;</span><br><span class="line">            path.replaceWith(expressions[1])</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (parentPath.isReturnStatement(&#123; &quot;argument&quot;: node &#125;) ||</span><br><span class="line">            parentPath.isThrowStatement(&#123; &quot;argument&quot;: node &#125;) ||</span><br><span class="line">            parentPath.isIfStatement(&#123; &#x27;test&#x27;: node &#125;) ||</span><br><span class="line">            parentPath.isWhileStatement(&#123; &quot;test&quot;: node &#125;) ||</span><br><span class="line">            parentPath.isForInStatement(&#123; &quot;right&quot;: node &#125;) ||</span><br><span class="line">            parentPath.isForOfStatement(&#123; &quot;right&quot;: node &#125;) ||</span><br><span class="line">            parentPath.isSwitchStatement(&#123; &quot;discriminant&quot;: node &#125;) ||</span><br><span class="line">            (parentPath.isConditionalExpression(&#123; &quot;test&quot;: node &#125;) &amp;&amp; ancestorPath.isExpressionStatement(&#123; &quot;expression&quot;: parent &#125;)) ||</span><br><span class="line">            (parentPath.isUnaryExpression(&#123; &quot;argument&quot;: node &#125;) &amp;&amp; ancestorPath.isExpressionStatement(&#123; &quot;expression&quot;: parent &#125;)) ||</span><br><span class="line">            (parentPath.isAssignmentExpression(&#123; &quot;right&quot;: node &#125;) &amp;&amp; ancestorPath.isExpressionStatement(&#123; &quot;expression&quot;: parent &#125;)) ||</span><br><span class="line">            ((parentPath.isCallExpression(&#123; &quot;callee&quot;: node &#125;) || parentPath.isNewExpression(&#123; &quot;callee&quot;: node &#125;)) &amp;&amp; ancestorPath.isExpressionStatement(&#123; &quot;expression&quot;: parent &#125;)) ||</span><br><span class="line">            parentPath.isLogicalExpression(&#123; &#x27;left&#x27;: node &#125;) ||</span><br><span class="line">            parentPath.isExpressionStatement(&#123; &quot;expression&quot;: node &#125;)) &#123;</span><br><span class="line"></span><br><span class="line">            let lastExpression = expressions.pop(); // å–å‡ºæœ€åä¸€ä¸ªè¡¨è¾¾å¼</span><br><span class="line">            // å°†å‰é¢çš„æ¯ä¸ªè¡¨è¾¾å¼éƒ½æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ä¹‹å‰ï¼Œä½œä¸ºå•ç‹¬çš„ ExpressionStatement</span><br><span class="line">            for (let expression of expressions) &#123;</span><br><span class="line">                parentPath.insertBefore(types.expressionStatement(expression = expression));</span><br><span class="line">            &#125;</span><br><span class="line">            path.replaceInline(lastExpression); // ç”¨æœ€åä¸€ä¸ªè¡¨è¾¾å¼æ›¿æ¢å½“å‰çš„ SequenceExpression</span><br><span class="line">        &#125;</span><br><span class="line">        // å°† for å¾ªç¯çš„initå¤„çš„æ‰€æœ‰é€—å·è¡¨è¾¾å¼éƒ½æå‡ºæ¥</span><br><span class="line">        else if (parentPath.isForStatement(&#123; &#x27;init&#x27;: node &#125;)) &#123;</span><br><span class="line">            node.expressions.forEach(express =&gt; &#123; parentPath.insertBefore(types.expressionStatement(express)); &#125;);</span><br><span class="line">            path.remove();;</span><br><span class="line">        &#125;</span><br><span class="line">        // å˜é‡å®šä¹‰åº”è¯¥æ’å…¥åˆ°å£°æ˜ä¹‹å‰ï¼Œä¸ç„¶ä¼šæœ‰é—®é¢˜</span><br><span class="line">        else if (parentPath.isVariableDeclarator(&#123; &quot;init&quot;: node &#125;) &amp;&amp; ancestorPath.isVariableDeclaration() &amp;&amp; ancestorPath.parentPath.isBlock()) &#123;</span><br><span class="line">            let lastExpression = expressions.pop();</span><br><span class="line"></span><br><span class="line">            for (let expression of expressions) &#123;</span><br><span class="line">                ancestorPath.insertBefore(types.expressionStatement(expression = expression));</span><br><span class="line">            &#125;</span><br><span class="line">            path.replaceInline(lastExpression); // ç”¨æœ€åä¸€ä¸ªè¡¨è¾¾å¼æ›¿æ¢å½“å‰çš„ SequenceExpression</span><br><span class="line">        &#125;</span><br><span class="line">        // é€»è¾‘è¡¨è¾¾å¼ä¸­çš„å¤„ç†ï¼Œä¸ç®¡çˆ¶èŠ‚ç‚¹ç¬¦å·æ˜¯&amp;&amp;è¿˜æ˜¯||ï¼Œå·¦è¾¹éƒ½å¯ä»¥ç›´æ¥è¿˜åŸï¼Œå³è¾¹åˆ™éœ€åˆ¤æ–­</span><br><span class="line">        else if (parentPath.isLogicalExpression(&#123; &#x27;right&#x27;: node &#125;) &amp;&amp; parent.operator == &#x27;&amp;&amp;&#x27;) &#123;</span><br><span class="line">            let ifBody = [];</span><br><span class="line">            let lastExpression = expressions.pop();</span><br><span class="line">            for (let expression of expressions) &#123;</span><br><span class="line">                ifBody.push(types.expressionStatement(expression = expression));</span><br><span class="line">            &#125;</span><br><span class="line">            let ifNode = types.ifStatement(parent.left, types.blockStatement(ifBody), null)</span><br><span class="line"></span><br><span class="line">            path.replaceInline(lastExpression);</span><br><span class="line">            parentPath.insertBefore(ifNode);</span><br><span class="line">        &#125;</span><br><span class="line">        // jsä¸­é€»è¾‘æˆ–è¿ç®—ç¬¦ || ä½¿ç”¨äº†çŸ­è·¯æ±‚å€¼ï¼Œå¦‚æœ || è¿ç®—ç¬¦çš„å·¦æ“ä½œæ•°ä¸º trueï¼Œå³æ“ä½œæ•°å°†ä¸ä¼šè¢«è®¡ç®—æˆ–æ‰§è¡Œ</span><br><span class="line">        else if (parentPath.isLogicalExpression(&#123; &#x27;right&#x27;: node &#125;) &amp;&amp; parent.operator == &#x27;||&#x27;) &#123;</span><br><span class="line">            let ifBody = [];</span><br><span class="line">            let lastExpression = expressions.pop();</span><br><span class="line">            for (let expression of expressions) &#123;</span><br><span class="line">                ifBody.push(types.expressionStatement(expression = expression));</span><br><span class="line">            &#125;</span><br><span class="line">            let ifNode = types.ifStatement(parent.left, types.blockStatement([]), types.blockStatement(ifBody))</span><br><span class="line"></span><br><span class="line">            path.replaceInline(lastExpression);</span><br><span class="line">            parentPath.insertBefore(ifNode);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, resolveSequence1);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// 6. å­—é¢é‡åŒ–æˆå‘˜è¡¨è¾¾å¼ `b.length` ==&gt; `b[&#x27;length&#x27;]`</span><br><span class="line">const keyToLiteral = &#123;</span><br><span class="line">    MemberExpression: &#123;</span><br><span class="line">        exit(&#123; node &#125;) &#123;</span><br><span class="line">            const prop = node.property;</span><br><span class="line">            if (!node.computed &amp;&amp; types.isIdentifier(prop)) &#123;</span><br><span class="line">                node.property = types.stringLiteral(prop.name)</span><br><span class="line">                node.computed = true; // åªæœ‰å½“ä½¿ç”¨ä¸­æ‹¬å·è°ƒç”¨æ‰ä¸ºtrue</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    // å¯¹è±¡çš„ key ä¹Ÿç”±æ ‡è¯†ç¬¦è½¬ä¸ºå­—é¢é‡</span><br><span class="line">    ObjectProperty: &#123;</span><br><span class="line">        exit(&#123; node &#125;) &#123;</span><br><span class="line">            const key = node.key;</span><br><span class="line">            if (!node.computed &amp;&amp; types.isIdentifier(key)) &#123;</span><br><span class="line">                node.key = types.stringLiteral(key.name);</span><br><span class="line">            &#125;</span><br><span class="line">            if (node.computed &amp;&amp; types.isStringLiteral(key)) &#123;</span><br><span class="line">                node.computed = false; // ä¸æ˜¯é€šè¿‡è®¡ç®—å¾—æ¥çš„ï¼Œcomputedä¸ºfalse</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, keyToLiteral);</span><br><span class="line"></span><br><span class="line">// 7. objectå¯¹è±¡çš„valueå€¼å…¨éƒ¨ä¸ºå­—é¢é‡æ—¶çš„è¿˜åŸ</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isBaseLiteral(node) &#123;</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node) &amp;&amp; node.value != null) return true; // nullå¯èƒ½æœ‰å‘</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; literalList.includes(node.name)) return true;</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; typeof globalThis[node.name] != &quot;undefined&quot;) return true;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; [&quot;+&quot;, &quot;-&quot;, &quot;!&quot;].includes(node.operator)) &#123;</span><br><span class="line">        if (types.isArrayExpression(node.argument) &amp;&amp; node.argument.elements.length == 0) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return isBaseLiteral(node.argument);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const decodeObjectofValue = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; node, scope &#125; = path;</span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (!types.isObjectExpression(init)) return;</span><br><span class="line"></span><br><span class="line">        let properties = init.properties;</span><br><span class="line">        if (properties.length == 0 || !properties.every(property =&gt; isBaseLiteral(property.value))) return;</span><br><span class="line"></span><br><span class="line">        let newMap = new Map();</span><br><span class="line">        for (const property of properties) &#123;</span><br><span class="line">            let &#123; key, value &#125; = property;</span><br><span class="line">            let KeyName = types.isIdentifier(key) ? key.name : key.value;</span><br><span class="line"></span><br><span class="line">            newMap.set(KeyName, value);</span><br><span class="line">        &#125;</span><br><span class="line">        if (newMap.size != properties.length) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(id.name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(id.name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            let flag = false; // ç”¨äºæ ‡å¿—å½“å‰å¯¹è±¡æ˜¯å¦å¯ä»¥åˆ é™¤</span><br><span class="line">            for (const referencePath of referencePaths) &#123;</span><br><span class="line">                let &#123; parentPath &#125; = referencePath;</span><br><span class="line">                if (!parentPath.isMemberExpression()) break;</span><br><span class="line"></span><br><span class="line">                let AncestorPath = parentPath.parentPath;</span><br><span class="line">                if (AncestorPath.isAssignmentExpression(&#123; &quot;left&quot;: parentPath.node &#125;)) &#123;</span><br><span class="line">                    break; // ç‰¹æ®Šå¼•ç”¨ï¼Œå…¶å®æ˜¯èµ‹å€¼ obj[&#x27;c&#x27;] = 789;ï¼Œæœ‰èµ‹å€¼è‚¯å®šç›´æ¥å–æ¶ˆè¿˜åŸ</span><br><span class="line">                &#125;</span><br><span class="line">                if (AncestorPath.isUpdateExpression() &amp;&amp; [&#x27;++&#x27;, &#x27;--&#x27;].includes(AncestorPath.node.operator)) &#123;</span><br><span class="line">                    break; // åŒç†ï¼Œæœ‰è‡ªå¢è‡ªå‡çš„æ“ä½œï¼Œç­‰åŒäºèµ‹å€¼ï¼Œä¹Ÿå–æ¶ˆè¿˜åŸ</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                let &#123; property &#125; = parentPath.node;</span><br><span class="line">                let curKey = types.isIdentifier(property) ? property.name : property.value;</span><br><span class="line">                if (!newMap.has(curKey)) break;</span><br><span class="line"></span><br><span class="line">                flag = true;</span><br><span class="line">                parentPath.replaceWith(newMap.get(curKey))</span><br><span class="line">            &#125;</span><br><span class="line">            if (flag) &#123;</span><br><span class="line">                console.log(&quot;å¯¹è±¡ val å€¼å…¨ä¸ºå¸¸é‡&quot;, &quot;åˆ é™¤ --&gt; å¯¹è±¡å®šä¹‰:&quot;, path + &#x27;&#x27;);</span><br><span class="line">                path.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        newMap.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, decodeObjectofValue);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// 8. åˆå¹¶å˜é‡å£°æ˜ä¸å®šä¹‰</span><br><span class="line">// var a, b, c; a = 1; b = 2; c = 3;    ===&gt;    var a = 1, b = 2, c = 3;</span><br><span class="line">// èŠ‚ç‚¹å­é¢é‡åˆ¤æ–­</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    const literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (Array.isArray(node)) return node.every(isNodeLiteral);</span><br><span class="line">    if (types.isThisExpression(node)) return true;</span><br><span class="line">    if (types.isLiteral(node)) return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node)) &#123;</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27; || node.operator === &#x27;!&#x27;)) &#123;</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node)) &#123;</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node)) &#123;</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isIdentifier(node)) &#123;</span><br><span class="line">        if (literalList.includes(node.name) || typeof globalThis[node.name] !== &#x27;undefined&#x27;) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const combinDefineAndNextAssgin = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; scope, node &#125; = path;</span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (init != null) return;</span><br><span class="line"></span><br><span class="line">        let name = id.name;</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (constantViolations.length != 1) return;</span><br><span class="line">        if (!constantViolations[0].isAssignmentExpression()) return;</span><br><span class="line">        if (constantViolations[0].parentPath.isConditionalExpression() || constantViolations[0].parentPath.isLogicalExpression()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = constantViolations[0].node</span><br><span class="line">        if (!types.isIdentifier(left, &#123; name: name &#125;) || operator != &#x27;=&#x27; || !isNodeLiteral(right)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        path.set(&quot;init&quot;, right);</span><br><span class="line">        constantViolations[0].remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, combinDefineAndNextAssgin);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// 9. å˜é‡åˆå§‹åŒ–ä¸ºå­—é¢é‡ï¼Œä¸”æ²¡æœ‰ä¿®æ”¹çš„è¿˜åŸ</span><br><span class="line">const rebackVarDeclarator = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (parentPath.parentPath.isForStatement() || parentPath.find((p) =&gt; p.isSwitchCase())) return;</span><br><span class="line">        if (!types.isIdentifier(id) || init == null || !isBaseLiteral(init)) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(id.name);</span><br><span class="line">        if (!binding) return; // æ¦‚ç‡è¸©å‘æŠ¥é”™</span><br><span class="line">        let &#123; constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123; // å˜é‡å®šä¹‰åœ¨ for å¾ªç¯ä¸­æ˜¯ä¸€æ¬¡æ”¹å˜</span><br><span class="line">            for (let referencePath of referencePaths) &#123;</span><br><span class="line">                referencePath.replaceWith(init);</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&quot;å®šä¹‰å­—é¢é‡æœªæ”¹è¿˜åŸ&quot;, &quot;åˆ é™¤ --&gt; å˜é‡å®šä¹‰:&quot;, path.parentPath + &#x27;&#x27;);</span><br><span class="line">            path.remove(); // é¡ºä¾¿è¿˜æŠŠåˆå§‹åŒ–ä¸ºå¸¸é‡ï¼Œä½†æ²¡æœ‰ä½¿ç”¨è¿‡çš„å˜é‡å®šä¹‰ä¹Ÿåˆ äº†</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, rebackVarDeclarator);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// 10. é€šç”¨è¿˜åŸçº¯å‡½æ•°è°ƒç”¨è¡¨è¾¾å¼</span><br><span class="line">// åˆ¤æ–­å‡½æ•°æ˜¯å¦ä¸ºçº¯å‡½æ•°</span><br><span class="line">function isPureFunction(path) &#123;</span><br><span class="line">    let isPure = true;</span><br><span class="line"></span><br><span class="line">    // æ£€æŸ¥ body.body æ•°ç»„çš„æ¯è¡Œä»£ç æ˜¯å¦åŒ…å«å…¨å±€å±æ€§ï¼ŒåŒ…å«åˆ™ä¸è¿˜åŸï¼ŒåŒæ—¶è¿”å›å€¼ä¸å”¯ä¸€çš„ä¹Ÿä¸æ˜¯çº¯å‡½æ•°</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;, &#x27;try&#x27;, &#x27;random&#x27;, &#x27;Date&#x27;];</span><br><span class="line">    let sourceCode = path.toString();</span><br><span class="line">    let allElementsValid = literalList.every(ele =&gt; !sourceCode.includes(ele)); // ä¸º true åˆ™ä¸åŒ…å«ï¼Œä¸º false åˆ™è¯´æ˜åŒ…å«</span><br><span class="line">    if (!allElementsValid) return false; // åŒ…å«åˆ™ä¸æ˜¯çº¯å‡½æ•°</span><br><span class="line"></span><br><span class="line">    path.traverse(&#123;</span><br><span class="line">        MemberExpression(innerPath) &#123;</span><br><span class="line">            const &#123; object &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(object) &amp;&amp; object.name !== &#x27;this&#x27; &amp;&amp; !path.scope.hasBinding(object.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        AssignmentExpression(innerPath) &#123;</span><br><span class="line">            const &#123; left &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(left) &amp;&amp; !path.scope.hasBinding(left.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        CallExpression(innerPath) &#123;</span><br><span class="line">            const &#123; callee &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(callee)) &#123;</span><br><span class="line">                const binding = path.scope.getBinding(callee.name);</span><br><span class="line">                if (!binding || !isPureFunction(binding.path)) &#123;</span><br><span class="line">                    isPure = false;</span><br><span class="line">                    innerPath.stop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        UpdateExpression(innerPath) &#123;</span><br><span class="line">            const &#123; argument &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(argument) &amp;&amp; !path.scope.hasBinding(argument.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    return isPure;</span><br><span class="line">&#125;</span><br><span class="line">// èŠ‚ç‚¹å­é¢é‡åˆ¤æ–­</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    const literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (Array.isArray(node)) return node.every(isNodeLiteral);</span><br><span class="line">    if (types.isThisExpression(node)) return true;</span><br><span class="line">    if (types.isLiteral(node)) return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node)) &#123;</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27; || node.operator === &#x27;!&#x27;)) &#123;</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node)) &#123;</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node)) &#123;</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isIdentifier(node)) &#123;</span><br><span class="line">        if (literalList.includes(node.name) || typeof globalThis[node.name] !== &#x27;undefined&#x27;) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">// ä¸»è¦è¿˜åŸé€»è¾‘</span><br><span class="line">const callToString = &#123;</span><br><span class="line">    &quot;CallExpression&quot;: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; callee, arguments &#125; = path.node;</span><br><span class="line">            let &#123; name &#125; = callee;</span><br><span class="line">            if (!types.isIdentifier(callee) || arguments.length == 0 || !isNodeLiteral(arguments)) return;</span><br><span class="line"></span><br><span class="line">            let binding = path.scope.getBinding(name);</span><br><span class="line">            if (!binding) return;</span><br><span class="line"></span><br><span class="line">            let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">            // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">            // 1. å½“ binding.path ä¸ºå‡½æ•°æ—¶ï¼Œåªèƒ½è¿˜åŸçº¯å‡½æ•°</span><br><span class="line">            try &#123;</span><br><span class="line">                if (binding.path.isFunctionDeclaration()) &#123;</span><br><span class="line">                    // console.log(binding.path + &#x27;&#x27;, path + &#x27;&#x27;);</span><br><span class="line">                    // ******** ä¸ºè§£å†³ä¸‹é¢åœ¨ binding.path ä¸ºèµ‹å€¼è¯­å¥æ—¶çš„è¿˜åŸä¸­ï¼Œä¸è¿˜åŸå…¶æœ¬èº«çš„è°ƒç”¨è¡¨è¾¾å¼çš„é—®é¢˜ ******** </span><br><span class="line">                    if (decryptCode.includes(binding.path.toString().match(/function\s+\w+\s*\([^)]*\)/g)[0])) &#123;</span><br><span class="line"></span><br><span class="line">                        let value = eval(path.toString());</span><br><span class="line">                        console.log(path + &#x27;&#x27;, &quot;--&gt;&quot;, value,);</span><br><span class="line">                        path.replaceWith(types.valueToNode(value));</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (!isPureFunction(binding.path)) return; // åˆ¤æ–­å‡½æ•°æ˜¯å¦æ˜¯çº¯å‡½æ•°ï¼Œä¸æ˜¯åˆ™ä¸å¤„ç†</span><br><span class="line"></span><br><span class="line">                    let &#123; id, params, body &#125; = binding.path.node;</span><br><span class="line">                    if (params.length == 0 || body.body.length == 0) return;</span><br><span class="line">                    // ******** ä¸“ç”¨æ’ä»¶é…ç½®é™åˆ¶ï¼šå‡½æ•°åã€å‡½æ•°è°ƒç”¨çš„å®å‚ä¸ªæ•°ã€å‡½æ•°å®šä¹‰çš„å‡½æ•°ä½“å¤§å° ********</span><br><span class="line">                    if (id.name == &#x27;ln&#x27; || body.body.length &gt; 10) return;</span><br><span class="line">                    if (!types.isReturnStatement(body.body[body.body.length - 1])) return;</span><br><span class="line"></span><br><span class="line">                    eval(binding.path.toString());</span><br><span class="line"></span><br><span class="line">                    if (constantViolations.length &gt; 1) return;</span><br><span class="line">                    if (constant || constantViolations[0] == binding.path) &#123; // å¦‚æœä¸ºå¸¸é‡ï¼Œæˆ–æ›´æ”¹çš„é‚£ä¸€æ¬¡ä¸ºå®šä¹‰çš„é‚£ä¸€æ¬¡</span><br><span class="line">                        let value = eval(path.toString());</span><br><span class="line">                        console.log(path + &#x27;&#x27;, &#x27;--&gt;&#x27;, value);</span><br><span class="line">                        path.replaceWith(types.valueToNode(value));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (e) &#123; &#125;</span><br><span class="line">            // 2. å½“ binding.path ä¸ºèµ‹å€¼è¯­å¥æˆ–å˜é‡å®šä¹‰æ—¶ï¼Œéœ€è¦åœ¨ decode ä¸­å‡†å¤‡å”¯ä¸€è¢«è¿˜åŸå‡½æ•°</span><br><span class="line">            try &#123;</span><br><span class="line">                var funcNameArr = [&#x27;n&#x27;] // å”¯ä¸€è¢«è¿˜åŸå‡½æ•°çš„å‡½æ•°å</span><br><span class="line">                if (binding.path.isVariableDeclarator()) &#123;</span><br><span class="line">                    // console.log(binding.path.parentPath + &#x27;&#x27;, path + &#x27;&#x27;, referenced, references, constant, constantViolations.length);</span><br><span class="line">                    if (constantViolations.length &gt; 1) return;</span><br><span class="line">                    if (constant || (constantViolations.length == 1 &amp;&amp; constantViolations[0].isAssignmentExpression())) &#123; // å˜é‡å®šä¹‰åªæœ‰ä¸€æ¬¡æ”¹å˜ï¼Œæˆ–æ²¡æ”¹å˜</span><br><span class="line">                        // console.log(binding.path.parentPath + &#x27;&#x27;, path + &#x27;&#x27;);</span><br><span class="line">                        let &#123; id, init &#125; = binding.path.node;</span><br><span class="line">                        let &#123; name &#125; = id;</span><br><span class="line">                        if (init == null) &#123;</span><br><span class="line">                            init = types.identifier(constantViolations[0].node.right.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (!types.isIdentifier(id) || !funcNameArr.includes(init.name)) return;</span><br><span class="line">                        funcNameArr.push(name);</span><br><span class="line"></span><br><span class="line">                        let newCallExpression = types.callExpression(types.identifier(&#x27;n&#x27;), arguments);</span><br><span class="line">                        let value = eval(generator(newCallExpression).code);</span><br><span class="line">                        console.log(path + &#x27;&#x27;, &quot;--&gt;&quot;, value,);</span><br><span class="line">                        path.replaceWith(types.valueToNode(value));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, callToString);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line">// console.log(decryptCode);</span><br><span class="line"></span><br><span class="line">// 11. æŠ˜å è®¡ç®—éƒ¨åˆ†å­—é¢é‡æˆ–è¡¨è¾¾å¼</span><br><span class="line">const calcPartBinaryExpression = &#123;</span><br><span class="line">    &quot;BinaryExpression|UnaryExpression|ConditionalExpression|MemberExpression|CallExpression&quot;: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; parent, scope, parentPath, node &#125; = path;</span><br><span class="line">            let &#123; left, operator, right &#125; = node;</span><br><span class="line"></span><br><span class="line">            if ((isNodeLiteral(left) &amp;&amp; isNodeLiteral(right)) ||    // å¤„ç†æ•°å­—å­—é¢é‡ï¼Œç®€å•å­—ç¬¦ä¸²å­—é¢é‡</span><br><span class="line">                path.isUnaryExpression() ||                         // å¤„ç†jsfuckä»£ç çš„`!![]` </span><br><span class="line">                path.isMemberExpression() ||                        // å¤„ç†æˆå‘˜è¡¨è¾¾å¼</span><br><span class="line">                path.isCallExpression()) &#123;                          // å¤„ç†è°ƒç”¨è¡¨è¾¾å¼</span><br><span class="line">                const &#123; confident, value &#125; = path.evaluate();       // è¿™ä¸ªè®¡ç®—æ˜¯åŒ…å«äº†äºŒå…ƒè¡¨è¾¾å¼çš„</span><br><span class="line">                if (!confident || value == &quot;Infinity&quot;) return;</span><br><span class="line">                if (path.isUnaryExpression(&#123; operator: &#x27;-&#x27; &#125;) || path.isUnaryExpression(&#123; operator: &#x27;void&#x27; &#125;)) return;</span><br><span class="line">                try &#123;</span><br><span class="line">                    path.replaceWith(types.valueToNode(value));</span><br><span class="line">                &#125; catch &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        path.replaceWith(types.stringLiteral(value));</span><br><span class="line">                    &#125; catch (e) &#123;</span><br><span class="line">                        console.log(&quot;æ— æ³•è¿˜åŸåŸå› :&quot;, e.message);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // å¤„ç†æ¡ä»¶è¡¨è¾¾å¼ï¼ˆä¸‰ç›®è¡¨è¾¾å¼ï¼‰</span><br><span class="line">            if (path.isConditionalExpression()) &#123;</span><br><span class="line">                let &#123; test, consequent, alternate &#125; = path.node;</span><br><span class="line">                if (consequent.value != null &amp;&amp; alternate.value != null &amp;&amp; consequent.value == alternate.value) &#123;</span><br><span class="line">                    path.replaceWith(types.valueToNode(consequent.value));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                const &#123; confident, value &#125; = path.evaluate();</span><br><span class="line">                if (!confident || value == &quot;Infinity&quot;) return;</span><br><span class="line">                if (path.isUnaryExpression(&#123; operator: &#x27;-&#x27; &#125;) || path.isUnaryExpression(&#123; operator: &#x27;void&#x27; &#125;)) return;</span><br><span class="line">                path.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125;</span><br><span class="line">            // å¤„ç†å­—ç¬¦ä¸²ç›¸åŠ </span><br><span class="line">            if (parentPath.isBinaryExpression(&#123; left: node &#125;)) &#123;</span><br><span class="line">                if (!types.isLiteral(left) &amp;&amp; operator == &quot;+&quot; &amp;&amp; types.isLiteral(right)) &#123;</span><br><span class="line">                    if (parent.operator == &quot;+&quot; &amp;&amp; types.isLiteral(parent.right)) &#123;</span><br><span class="line">                        path.node.right.value += parent.right.value;</span><br><span class="line">                        parentPath.replaceWith(path.node);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, calcPartBinaryExpression);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">ast.program.body.unshift(types.debuggerStatement());</span><br><span class="line"></span><br><span class="line">console.timeEnd(&quot;å¤„ç†å®Œæ¯•ï¼Œè€—æ—¶&quot;);</span><br><span class="line">let &#123; code &#125; = generator(ast, opts = &#123;</span><br><span class="line">    &quot;compact&quot;: false,  // æ˜¯å¦å‹ç¼©ä»£ç </span><br><span class="line">    &quot;comments&quot;: false,  // æ˜¯å¦ä¿ç•™æ³¨é‡Š</span><br><span class="line">    &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125;,  // Unicodeè½¬ä¹‰ï¼Œç¡®ä¿éASCIIå­—ç¬¦è¢«æ­£ç¡®åœ°ä¿ç•™å’Œæ˜¾ç¤ºï¼Œè€Œä¸æ˜¯è¢«è½¬ä¹‰</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">files.writeFile(decodeFile, code, (err) =&gt; &#123; &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="ä¸€ã€AST-æŠ€æœ¯ä¸“é¢˜"><a href="#ä¸€ã€AST-æŠ€æœ¯ä¸“é¢˜" class="headerlink" title="ä¸€ã€AST æŠ€æœ¯ä¸“é¢˜"></a>ä¸€ã€AST æŠ€æœ¯ä¸“é¢˜</h2><blockquote>
<p><strong>AST æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼‰ï¼š</strong>AST æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œæ˜¯æºä»£ç çš„æŠ½è±¡è¯­æ³•ç»“æ„çš„æ ‘çŠ¶è¡¨ç°å½¢å¼ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ï¼Œå¦‚è¯­å¥ã€è¡¨è¾¾å¼ã€å˜é‡å£°æ˜ç­‰ã€‚è¯­æ³•æ ‘ä¸æ˜¯æŸä¸€ç§ç¼–ç¨‹è¯­è¨€ç‹¬æœ‰çš„ï¼Œå‡ ä¹æ‰€æœ‰ç¼–ç¨‹è¯­è¨€éƒ½æœ‰è¯­æ³•æ ‘ï¼Œ<strong>æ—¢ç„¶æ˜¯ä¸€æ£µæ ‘ï¼Œé‚£ä¸€å®šå­˜åœ¨èŠ‚ç‚¹ï¼Œæˆ–éå†ç›¸å…³çš„æ¦‚å¿µ</strong>ã€‚</p>
<ul>
<li><strong>å®‰è£… babel åº“ï¼š</strong><code>npm install @babel/core --save-dev</code>ï¼ˆå…¨å±€å®‰è£…å¯èƒ½ä¼šæœ‰æ— æ³•å¯¼å…¥åº“çš„æƒ…å†µï¼‰</li>
<li><strong>å°†æºä»£ç è§£æä¸º AST åœ¨çº¿ç½‘ç«™ï¼š</strong><a class="link"   href="https://astexplorer.net/"  target="_blank" rel="noopener">ASTÂ explorer<i class="fas fa-external-link-alt"></i></a>ï¼ˆè§£é‡Šå™¨é€‰æ‹© @babel&#x2F;parserï¼‰</li>
<li><strong>å°æŠ€å·§ï¼š</strong>åœ¨ AST explorer ä¸­ï¼Œç‚¹å‡»å·¦ä¾§æŸæ®µä»£ç çš„ä¸­é—´ï¼Œå¯¹åº”å³ä¾§çš„ AST æ ‘ç‰‡æ®µå°±ä¼šè¢«æ ‡é»„</li>
</ul>
<p><strong>åœ¨ç¼–è¯‘åŸç†ä¸­ï¼Œç¼–è¯‘å™¨è½¬æ¢ä»£ç è¦ç»è¿‡ä¸‰ä¸ªæ­¥éª¤ï¼šè¯æ³•åˆ†æ &#x3D;&gt; è¯­æ³•åˆ†æï¼ˆæ„å»º AST è¯­æ³•æ ‘ï¼‰ &#x3D;&gt; ä»£ç ç”Ÿæˆ</strong></p>
<img    
                       lazyload
                       alt="image"
                       data-src="https://xfblog.cn/images/1716090018-9dbb06e659303be.png"
                        
                 >
</blockquote>
<h3 id="1-ä»£ç æ··æ·†åŸç†"><a href="#1-ä»£ç æ··æ·†åŸç†" class="headerlink" title="1. ä»£ç æ··æ·†åŸç†"></a>1. ä»£ç æ··æ·†åŸç†</h3><ul>
<li><p><strong>ä¸ºæ··æ·†åšå‡†å¤‡ï¼š</strong></p>
<ol>
<li>åˆ©ç”¨<strong>å¯¹è±¡å±æ€§çš„ä¸¤ç§è®¿é—®æ–¹å¼</strong>ï¼Œå°†<strong>æ‰“ç‚¹è°ƒç”¨æ–¹å¼</strong>è½¬æ¢æˆ<strong>ä¸­æ‹¬å·è°ƒç”¨æ–¹å¼</strong>ï¼Œå³ <code>p.name =&gt; p[&#39;name&#39;]</code></li>
<li>js ä¸­å¾ˆå¤šå†…ç½®å¯¹è±¡éƒ½æ˜¯ window å¯¹è±¡çš„å±æ€§ï¼Œä¾‹ <code>Date() =&gt; window.Date() =&gt; window[&#39;Date&#39;]()</code></li>
</ol>
</li>
<li><p><strong>å­—ç¬¦ä¸²åŸºç¡€æ··æ·†å¤„ç†ï¼š</strong></p>
<ol>
<li><strong>16 è¿›åˆ¶ç¼–ç ï¼š</strong>å°†å­—ç¬¦ä¸²å¾ªç¯æ‹¼æ¥ <code>&quot;\x&quot; + code.charCodeAt(i).toString(16)</code> è½¬æ¢ä¸ºåå…­è¿›åˆ¶å½¢å¼ï¼Œç”±äºè¿˜åŸç®€å•ä¸€èˆ¬ä¸å¤§é¢ç§¯ä½¿ç”¨ï¼Œå¸¸ç”¨äºå˜é‡åçš„æ··æ·†ï¼Œ<strong>å› ä¸ºåœ¨ js ä¸­å˜é‡åæ— æ³•è¿›è¡ŒåŠ å¯†ç­‰æ“ä½œ</strong></li>
<li><strong>unicode ç¼–ç ï¼š</strong><code>&quot;\u&quot; + (&quot;0000&quot; + code.charCodeAt(i).toString(16)).substr(-4)</code>ï¼Œ<strong>unicode ç¼–ç ä¸ä»…ä»…é€‚ç”¨äºå˜é‡ï¼Œè¿˜é€‚ç”¨äº js ä¸­çš„æ–¹æ³•åç­‰æ ‡è¯†ç¬¦</strong>ï¼Œä½†ä¹Ÿå­˜åœ¨è¿˜åŸç®€å•çš„é—®é¢˜</li>
<li><strong>ascii ç¼–ç äº’è½¬ï¼š</strong>å…ˆå°†å­—ç¬¦ä¸²ä¸€ä¸ªä¸ªé€šè¿‡ charCodeAt æ–¹æ³•è½¬æ¢ä¸º ascii ç ï¼Œåœ¨ä½¿ç”¨æ—¶ä½¿ç”¨æ–¹æ³• <code>String.fromCharCode(...codes)</code> è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼ˆè¿˜å¯ä»¥é€‚ç”¨äº<strong>æ··æ·†æ•´å¥ä»£ç </strong>ï¼Œç”¨ eval æ‰§è¡Œä»£ç ï¼‰</li>
<li><strong>å¸¸é‡åŠ å¯†è§£å¯†ï¼š</strong>å…ˆæŠŠå­—ç¬¦ä¸²åŠ å¯†å¾—åˆ°å¯†æ–‡ï¼Œç„¶ååœ¨ä½¿ç”¨ä¹‹å‰ï¼Œè°ƒç”¨å¯¹åº”çš„è§£å¯†å‡½æ•°å»è§£å¯†ï¼Œå¾—åˆ°æ˜æ–‡ã€‚ä¾‹ Base64 ç¼–ç åï¼Œé€šè¿‡ atob è§£ç ï¼Œä½†åœ¨å®é™…æ··æ·†åº”ç”¨ä¸­ï¼Œatob è¿™ç§æ ‡è¯†ç¬¦æœ€å¥½è¦å¤„ç†ä¸ºæ²¡æœ‰è¯­ä¹‰çš„</li>
<li><strong>ç®—æ³•é‡Œçš„æ•°å€¼å¸¸é‡åŠ å¯†ï¼š</strong>åœ¨ç®—æ³•åŠ å¯†è¿‡ç¨‹ä¸­ï¼Œå¤§è‡´å·²ç»çŸ¥é“æ˜¯ä»€ä¹ˆç®—æ³•åŠ å¯†ï¼Œä½†æ˜¯æ— æ³•å®šä½ï¼Œåˆ™å¯ä»¥ç›´æ¥æœç´¢ç®—æ³•ä¸­çš„å¸¸é‡ï¼Œä¾‹å¦‚ md5 ä¸­çš„å¸¸é‡ 0x67452301ã€0xefcdab89 ç­‰ï¼Œè¾¾åˆ°å®šä½ä»£ç å…³é”®ä½ç½®çš„ç›®çš„ã€‚è€Œæœ€å¸¸è§çš„åˆ™æ˜¯<strong>åˆ©ç”¨ä½å¼‚æˆ–çš„ç‰¹æ€§åŠ å¯†ï¼Œä¾‹å¦‚ a^b&#x3D;cï¼Œé‚£ä¹ˆ c^b&#x3D;aï¼Œæ­¤æ—¶ b ç›¸å½“äºåŠ å¯†å¯†é’¥</strong>ï¼Œç½‘æ˜“å¸¸è§</li>
</ol>
</li>
<li><p><strong>è¾ƒå¤æ‚çš„æ··æ·†å¤„ç†ï¼š</strong></p>
<ol>
<li><strong>æ•°ç»„æ··æ·†ï¼š</strong>å°†æ‰€æœ‰çš„å­—ç¬¦ä¸²éƒ½æå–åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œç„¶ååœ¨éœ€è¦å¼•ç”¨å­—ç¬¦ä¸²çš„åœ°æ–¹ï¼Œå…¨éƒ¨éƒ½ä»¥æ•°ç»„ä¸‹æ ‡çš„æ–¹å¼å»è®¿é—®æ•°ç»„æˆå‘˜ã€‚è¿™å½’åŠŸäº js è¯­æ³•çš„çµæ´»ï¼ŒåŒä¸€ä¸ªæ•°ç»„å¯ä»¥å­˜æ”¾ä»»æ„ç±»å‹çš„æ•°æ®ï¼ŒåŒ…æ‹¬å‡½æ•°ã€‚ä¾‹å¦‚å°† <code>&quot;&quot;[&#39;constructor&#39;][&#39;fromCharCode&#39;]</code> æ”¾å…¥æ•°ç»„ï¼Œè¿™é‡Œ <strong>â€œâ€[â€˜constructorâ€™] è·å–æ„é€ å‡½æ•°ç­‰åŒäº String</strong></li>
<li><strong>æ•°ç»„ä¹±åºï¼š</strong>å°†æ•°ç»„æˆå‘˜é¡ºåºé€šè¿‡ä¸€å®šé€»è¾‘æ‰“ä¹±ï¼ŒåŒæ—¶å†…ç½®ä¸€æ®µå¯¹åº”çš„è¿˜åŸé¡ºåºé€»è¾‘ä»£ç ï¼Œç¡®ä¿å¼•ç”¨æ­£ç¡®</li>
<li><strong>èŠ±æŒ‡ä»¤ï¼š</strong>æ·»åŠ ä¸€äº›æ²¡æœ‰æ„ä¹‰å´å¯ä»¥æ··æ·†è§†å¬çš„ä»£ç ï¼Œç¬é—´è†¨èƒ€ä»£ç é‡ï¼Œæ˜¯èŠ±æŒ‡ä»¤çš„æ ¸å¿ƒã€‚å¸¸è§çš„æœ‰äºŒé¡¹å¼ç›¸åŠ è½¬å‡½æ•°çš„èŠ±æŒ‡ä»¤ã€å‡½æ•°è°ƒç”¨è¡¨è¾¾å¼çš„èŠ±æŒ‡ä»¤ç­‰ï¼Œå¹¶ä¸”éƒ½å¯ä»¥è¿›è¡Œ<strong>å¤šçº§åµŒå¥—</strong></li>
<li><strong>jsfuckï¼š</strong>åŸºäº js æ˜¯å¼±ç±»å‹è¯­è¨€ï¼Œå­˜åœ¨<strong>éšå¼è½¬æ¢</strong>çš„ç‰¹ç‚¹ï¼Œå°† js ä»£ç è½¬æ¢æˆåªç”¨ 6 ä¸ªå­—ç¬¦ ( ) + ! [ ] å°±å¯ä»¥è¡¨ç¤ºçš„ä»£ç ï¼Œ<strong>åœ¨ js ä¸­åªæœ‰ 7 ç§å€¼ falseã€undefinedã€nullã€0ã€-0ã€NaNã€â€â€ ä¸ºå‡</strong>ï¼Œå…¶ä½™å‡ä¸ºçœŸã€‚ä¾‹ <code>(!+[]+!![]+[])</code> ç­‰äº 2ï¼Œ[] ä¸ºçœŸï¼Œæ‰€ä»¥ +[] ä¼šè½¬æ¢ä¸ºæ•°å€¼ 0ï¼Œ!0 ä¼šè½¬æ¢ä¸ºå¸ƒå°”å€¼ 1ï¼ˆæ§åˆ¶å°å¯ä»¥ç›´æ¥è¿˜åŸï¼‰</li>
</ol>
</li>
<li><p><strong>ä»£ç æ‰§è¡Œæµç¨‹çš„é˜²æŠ¤åŸç†ï¼š</strong></p>
<ol>
<li><strong>æµç¨‹å¹³å¦åŒ–ï¼š</strong>switch case è¯­å¥å®ç°ï¼Œcase å—æ˜¯å¹³çº§çš„ã€‚é€šè¿‡ while æ­»å¾ªç¯ï¼Œå°†ä¸€ä¸ªè®°å½•äº†çœŸå®æ‰§è¡Œé¡ºåºçš„æ–‡æœ¬å­—ç¬¦ä¸² <code>&#39;7|5|1|3|2|4|6&#39;.split(&#39;|&#39;)</code> åˆ†å‰²ä¸ºæ•°ç»„ï¼Œä½œä¸º switch è¯­å¥çš„æ¡ä»¶ <code>arrStr[i++]</code>ï¼Œjs ä¸­ç´¢å¼•è¶Šç•Œæ—¶ä¸ä¼šæŠ¥é”™ï¼Œæ—  case åŒ¹é…æ—¶åˆ™ç›´æ¥ break è·³å‡ºç»“æŸï¼ˆ<strong>ç‰¹ç‚¹ï¼š</strong>case çš„æ¡ä»¶ä¸ä»…ä»…æ˜¯å­—ç¬¦ä¸²ï¼Œè¿˜å¯ä»¥æ˜¯å¯¹è±¡ï¼Œæ•°ç»„ç­‰ç±»å‹ã€‚åŒæ—¶ switch æ··æ·†çš„æ‰§è¡Œé¡ºåºå¹¶ä¸ä¸€å®šè¦é€šè¿‡æ–‡æœ¬ä¸²åˆ†å‰²å¾ªç¯æ•°ç»„çš„æ–¹å¼å®ç°ï¼Œ<strong>è¿˜å¯ä»¥é€šè¿‡åœ¨ case å—ä¸­ä¿®æ”¹ switch æ¡ä»¶ï¼Œä»è€Œæ§åˆ¶æ‰§è¡Œé¡ºåº</strong>ï¼‰</li>
<li><strong>é€—å·è¡¨è¾¾å¼ï¼š</strong>é€—å·è¡¨è¾¾å¼ä¼šæ‰§è¡Œéƒ½å¥½å‰é¢æ‰€æœ‰çš„è¯­å¥ï¼Œä½†<strong>åªè¿”å›æœ€åä¸€ä¸ªé€—å·çš„è¡¨è¾¾å¼çš„å€¼</strong>ï¼Œè¿™å…¶ä¸­å¯ä»¥æ·»åŠ å¾ˆå¤šæ— ç”¨çš„èŠ±æŒ‡ä»¤æ¥æ··æ·†è§†å¬ï¼Œè¿™å°±è®© return éƒ½å˜å¾—å¤æ‚</li>
</ol>
</li>
<li><p><strong>å…¶ä»–ä»£ç é˜²æŠ¤æ–¹æ¡ˆï¼š</strong></p>
<ol>
<li><strong>eval åŠ å¯†ï¼š</strong>åŸç†æ˜¯é€šè¿‡ä¸€ä¸ªè‡ªæ‰§è¡Œçš„åŒ¿åå‡½æ•°è¿”å›ä¸€æ®µå­—ç¬¦ä¸²ï¼Œå†ç”¨ eval æ‰§è¡Œè¿™æ®µå­—ç¬¦ä¸²ï¼Œä½¿å…¶æ•ˆæœç­‰åŒäºåŸä»£ç ã€‚<strong>åŒ¿åå‡½æ•°å¯ä»¥çœ‹ä½œè§£å¯†å‡½æ•°ï¼Œeval è§£å¯†å°±æ˜¯ç›´æ¥å»æ‰ evalï¼Œæ‰§è¡Œå‰©ä½™çš„ä»£ç ï¼Œå¾—åˆ°åŸä»£ç </strong></li>
<li><strong>å†…å­˜çˆ†ç ´ï¼š</strong>åœ¨ä»£ç ä¸­åŠ å…¥æ­»ä»£ç ï¼Œæ­£å¸¸æƒ…å†µä¸‹è¿™æ®µä»£ç ä¸æ‰§è¡Œï¼Œå½“æ£€æµ‹åˆ°å‡½æ•°è¢«æ ¼å¼åŒ–æˆ–è€…è¢« Hook æ—¶ï¼Œå°±è·³è½¬åˆ°è¿™æ®µä»£ç æ‰§è¡Œï¼Œè¿è¡Œç›´åˆ°å†…å­˜æº¢å‡ºã€‚ä¾‹å¦‚ for å¾ªç¯ä½¿ç”¨æ•°ç»„é•¿åº¦ä¸ºæ¡ä»¶ï¼Œæ— é™å¾€æ•°ç»„ä¸­æ·»åŠ æˆå‘˜</li>
<li><strong>æ£€æŸ¥ä»£ç æ˜¯å¦æ ¼å¼åŒ–ï¼š</strong>é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æŸä¸ªå‡½æ•°çš„ toString() æ¥åˆ¤æ–­ä»£ç æ˜¯å¦è¢«æ ¼å¼åŒ–</li>
</ol>
</li>
</ul>
<h3 id="2-è¯­æ³•æ ‘èŠ‚ç‚¹åè¯"><a href="#2-è¯­æ³•æ ‘èŠ‚ç‚¹åè¯" class="headerlink" title="2. è¯­æ³•æ ‘èŠ‚ç‚¹åè¯"></a>2. è¯­æ³•æ ‘èŠ‚ç‚¹åè¯</h3><ul>
<li><p>Programï¼ˆç¨‹åºä¸»ä½“ï¼‰ï¼šæ•´æ®µä»£ç çš„ä¸»ä½“</p>
</li>
<li><p>Identifierï¼ˆæ ‡è¯†ç¬¦ï¼‰ï¼šæ ‡è¯†ï¼Œä¾‹å¦‚å£°æ˜å˜é‡æ—¶ var obj &#x3D; 5 ä¸­çš„ obj</p>
</li>
<li><p>Propertyï¼ˆå±æ€§ï¼‰</p>
</li>
<li><p>Literalï¼ˆå­—é¢é‡ï¼‰ï¼š</p>
<ul>
<li>BooleanLiteralï¼ˆå¸ƒå°”å‹å­—é¢é‡ï¼‰ï¼šå¸ƒå°”å€¼ï¼Œä¾‹å¦‚ true false</li>
<li>NumericLiteralï¼ˆæ•°å­—å‹å­—é¢é‡ï¼‰ï¼šæ•°å­—ï¼Œä¾‹å¦‚ 100</li>
<li>StringLiteralï¼ˆå­—ç¬¦å‹å­—é¢é‡ï¼‰ï¼šå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ â€œvansenbâ€</li>
</ul>
</li>
<li><p>Declarationï¼ˆå£°æ˜ï¼‰ï¼š</p>
<ul>
<li><p>VariableDeclarationï¼ˆå˜é‡å£°æ˜ï¼‰ï¼šå£°æ˜ä¸€ä¸ªå˜é‡ï¼Œä¾‹å¦‚ var let const</p>
</li>
<li><p>VariableDeclaratorï¼ˆå˜é‡å®šä¹‰ï¼‰ï¼šå…·ä½“çš„å˜é‡å®šä¹‰ï¼Œä¸€ä¸ª VariableDeclaration å£°æ˜è¯­å¥ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª VariableDeclarator <strong>å£°æ˜å•å…ƒ</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// var a = 1, b, c = foo();</span><br><span class="line">&#123;</span><br><span class="line">  type: &quot;VariableDeclaration&quot;,</span><br><span class="line">  kind: &quot;var&quot; | &quot;let&quot; | &quot;const&quot;,</span><br><span class="line">  declarations: [ /* VariableDeclarator[] */ ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>FunctionDeclarationï¼ˆå‡½æ•°å£°æ˜ï¼‰ï¼šå£°æ˜ä¸€ä¸ªå‡½æ•°ï¼Œä¾‹å¦‚ function</p>
</li>
<li><p>FunctionExpression | ArrowFunctionExpressionï¼ˆå‡½æ•°|å¤åˆå‡½æ•°è¯­å¥ï¼‰ï¼šå˜é‡å£°æ˜çš„æ–¹å¼å®šä¹‰å‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function foo(x) &#123; &#125;  // FunctionDeclaration</span><br><span class="line">const bar = function baz(y) &#123; &#125;;  // FunctionExpression</span><br><span class="line">const arrow = (z) =&gt; z * 2;  // ArrowFunctionExpression</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Statementï¼ˆè¯­å¥ï¼‰ï¼š</p>
<ul>
<li>ExpressionStatementï¼ˆè¡¨è¾¾å¼è¯­å¥ï¼‰ï¼šé€šå¸¸æ˜¯è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œä¾‹å¦‚ console.log()</li>
<li>BlockStatementï¼ˆå—è¯­å¥ï¼‰ï¼šåŒ…è£¹åœ¨ {} å—å†…çš„ä»£ç ï¼Œä¾‹å¦‚ if (condition){var a &#x3D; 1;}</li>
<li>BreakStatementï¼ˆä¸­æ–­è¯­å¥ï¼‰ï¼šé€šå¸¸æŒ‡ break</li>
<li>ContinueStatementï¼ˆæŒç»­è¯­å¥ï¼‰ï¼šé€šå¸¸æŒ‡ continue</li>
<li>ReturnStatementï¼ˆè¿”å›è¯­å¥ï¼‰ï¼šé€šå¸¸æŒ‡ return</li>
<li>SwitchStatementï¼ˆSwitch è¯­å¥ï¼‰é€šå¸¸æŒ‡ Switch Case è¯­å¥ä¸­çš„ Switch</li>
<li><strong>SwitchCaseï¼ˆCase è¯­å¥ï¼‰ï¼š</strong>é€šå¸¸æŒ‡ Switch è¯­å¥ä¸­çš„ Case</li>
<li>IfStatementï¼ˆIf æ§åˆ¶æµè¯­å¥ï¼‰ï¼šæ§åˆ¶æµè¯­å¥ï¼Œé€šå¸¸æŒ‡ if(condition){}else{}</li>
</ul>
</li>
<li><p>Expressionï¼ˆè¡¨è¾¾å¼ï¼‰ï¼š</p>
<ul>
<li>CallExpressionï¼ˆè°ƒç”¨è¡¨è¾¾å¼ï¼‰ï¼šé€šå¸¸æŒ‡è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œä¾‹å¦‚ console.log()</li>
<li>BinaryExpressionï¼ˆäºŒè¿›åˆ¶è¡¨è¾¾å¼ï¼‰ï¼šé€šå¸¸æŒ‡è¿ç®—ï¼Œä¾‹å¦‚ 1+2</li>
<li>MemberExpressionï¼ˆæˆå‘˜è¡¨è¾¾å¼ï¼‰ï¼šé€šå¸¸æŒ‡è°ƒç”¨å¯¹è±¡çš„æˆå‘˜ï¼Œä¾‹å¦‚ console å¯¹è±¡çš„ log æˆå‘˜</li>
<li>ArrayExpressionï¼ˆæ•°ç»„è¡¨è¾¾å¼ï¼‰ï¼šé€šå¸¸æŒ‡ä¸€ä¸ªæ•°ç»„ï¼Œä¾‹å¦‚ [1, 3, 5]</li>
<li>NewExpressionï¼ˆNew è¡¨è¾¾å¼ï¼‰ï¼šé€šå¸¸æŒ‡ä½¿ç”¨ New å…³é”®è¯</li>
<li>AssignmentExpressionï¼ˆèµ‹å€¼è¡¨è¾¾å¼ï¼‰ï¼šé€šå¸¸æŒ‡å°†å‡½æ•°çš„è¿”å›å€¼èµ‹å€¼ç»™å˜é‡</li>
<li>UpdateExpressionï¼ˆæ›´æ–°è¡¨è¾¾å¼ï¼‰ï¼šé€šå¸¸æŒ‡æ›´æ–°æˆå‘˜å€¼ï¼Œä¾‹å¦‚ i++</li>
</ul>
</li>
</ul>
<h3 id="3-bable"><a href="#3-bable" class="headerlink" title="3. bable"></a>3. bable</h3><blockquote>
<p><strong>JavaScirpt çš„ Babel ç¼–è¯‘å™¨ï¼š</strong></p>
<ol>
<li><strong>@babel&#x2F;coreï¼š</strong>Babel ç¼–è¯‘å™¨æœ¬èº«ï¼Œæä¾›äº† babel çš„ç¼–è¯‘ API</li>
<li><strong>@babel&#x2F;parserï¼š</strong>å°† JavaScript ä»£ç è§£ææˆ AST è¯­æ³•æ ‘</li>
<li><strong>@babel&#x2F;traverseï¼š</strong>ç”¨äºéå†ã€ä¿®æ”¹ AST è¯­æ³•æ ‘çš„å„ä¸ªèŠ‚ç‚¹</li>
<li><strong>@babel&#x2F;typesï¼š</strong>ç”¨äºåˆ¤æ–­ã€éªŒè¯èŠ‚ç‚¹çš„ç±»å‹ã€æ„å»ºæ–° AST èŠ‚ç‚¹ç­‰</li>
<li><strong>@babel&#x2F;generatorï¼š</strong>å°† AST è¿˜åŸæˆ JavaScript ä»£ç </li>
</ol>
</blockquote>
<ul>
<li><strong>Bable ä¸­çš„ç»„ä»¶ï¼ˆ<a class="link"   href="https://babeljs.io/docs/babel-generator"  target="_blank" rel="noopener">å‚æ•°é…ç½®æŸ¥å®˜ç½‘<i class="fas fa-external-link-alt"></i></a>ï¼‰ï¼š</strong><ol>
<li><strong>parser ç»„ä»¶ï¼š</strong>parser çš„ parse æ–¹æ³•çš„ç¬¬ 2 ä¸ªå‚æ•°æ¥å—ä¸€ä¸ªå¯¹è±¡ï¼Œé»˜è®¤å€¼ä¸º <code>&#123;sourceType: &quot;script&quot;&#125;</code><ul>
<li>å½“è§£æçš„ js ä»£ç ä¸­å«æœ‰ export ç­‰ ES6 è¯­æ³•æ—¶ï¼Œéœ€è¦æŒ‡å®š sourceType ä¸º module å€¼ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</li>
</ul>
</li>
<li><strong>generator ç»„ä»¶ï¼š</strong>generator æ–¹æ³•çš„ç¬¬ 2 ä¸ªå‚æ•°æ¥å—ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥è‡ªå®šä¹‰è®¾ç½®è¾“å‡ºç»“æœçš„æ ¼å¼<ul>
<li><code>&#123;retainLines: false, comments: true, compact: true&#125;</code> å‡ä¸ºé»˜è®¤å€¼</li>
<li>retainLinesï¼šè¡¨ç¤ºæ˜¯å¦ä½¿ç”¨ä¸æºä»£ç ç›¸åŒçš„è¡Œå·ï¼Œå³å¦æ˜¯æ ¼å¼åŒ–</li>
<li>commentsï¼šè¡¨ç¤ºæ˜¯å¦ä¿ç•™æ³¨é‡Š</li>
<li>compactï¼šè¡¨ç¤ºæ˜¯å¦å‹ç¼©ä»£ç ï¼Œå‹ç¼©ç¨‹åº¦æ­£å¸¸ï¼Œminified è¡¨ç¤ºå‹ç¼©ç¨‹åº¦é«˜ï¼Œconciseè¡¨ç¤ºå‹ç¼©ç¨‹åº¦ä½</li>
</ul>
</li>
<li><strong>traverse ç»„ä»¶ä¸ visitor å¯¹è±¡ï¼š</strong><ul>
<li><strong>visitor å¯¹è±¡ï¼š</strong>ç”¨äºè¿‡æ»¤èŠ‚ç‚¹çš„ä¸€ä¸ªå¯¹è±¡ï¼Œé…åˆ traverse ç»„ä»¶ä¸€èµ·ä½¿ç”¨ <strong><code>traverse(ast, visitor);</code></strong></li>
<li><strong>enterã€exit å‡½æ•°ï¼š</strong>åœ¨éå†èŠ‚ç‚¹è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¼šæœ‰ä¸¤æ¬¡è®¿é—®æœºä¼šï¼Œå³ enter è¿›å…¥èŠ‚ç‚¹æ—¶ï¼ˆ<strong>ä»æ•´ä½“åˆ°éƒ¨åˆ†éå†ï¼Œå¤§ &#x3D;&gt; å°ï¼Œé»˜è®¤</strong>ï¼‰ä¸ exit é€€å‡ºèŠ‚ç‚¹æ—¶ï¼ˆ<strong>ä»éƒ¨åˆ†åˆ°æ•´ä½“éå†ï¼Œå° &#x3D;&gt; å¤§</strong>ï¼‰ï¼ˆ<strong>æ·±åº¦ä¼˜å…ˆ</strong>ï¼‰</li>
<li><strong>æŠŠä¸€ä¸ªå‡½æ•°åº”ç”¨åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼š</strong>ä½¿ç”¨ | åˆ†éš”ï¼Œ<code>&quot;FunctionExpression|BinaryExpression&quot;(path)</code></li>
<li><strong>æŠŠå¤šä¸ªå‡½æ•°åº”ç”¨åˆ°ä¸€ä¸ªèŠ‚ç‚¹ï¼š</strong>æŠŠå¤šä¸ªå‡½æ•°çš„æ•°ç»„èµ‹å€¼ç»™ enter å¯¹è±¡ï¼Œ<code>enter: [func1, func2]</code></li>
<li><strong>ä¸ä¸€å®šä»å¤´ï¼Œå¯ä»¥ä»ä»»æ„èŠ‚ç‚¹å‘ä¸‹å¼€å§‹éå†ï¼š</strong><code>path.traverse(visitorå¯¹è±¡, ä¼ å…¥çš„å‚æ•°å¯¹è±¡)</code></li>
</ul>
</li>
<li><strong>types ç»„ä»¶ï¼š</strong><ul>
<li><strong>åˆ¤æ–­èŠ‚ç‚¹ç±»å‹ï¼š</strong><code>types.isIdentifier(path.node, &#123;name: &#39;a&#39;&#125;)</code> åˆ¤æ–­ node çš„ type æ˜¯å¦æ˜¯æ ‡è¯†ç¬¦ï¼Œä¸”å€¼æ˜¯å¦ä¸º aï¼Œç­‰ä»·äº <code>path.isIdentifier(&#123;name: &#39;a&#39;&#125;)</code>ï¼Œä½†è¿™åˆ¤æ–­çš„æ˜¯ path ä¸‹çš„ type å€¼</li>
<li><strong>æ–­è¨€åˆ¤æ–­èŠ‚ç‚¹ç±»å‹ï¼š</strong>å½“èŠ‚ç‚¹ä¸ç¬¦åˆè¦æ±‚æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸è€Œä¸æ˜¯è¿”å›å¸ƒå°”å€¼ <code>types.assertIdentifier</code></li>
<li><strong>ä¸»è¦ç”¨äºæ„å»ºæ–°çš„ AST èŠ‚ç‚¹ï¼š</strong>æ ‘çš„ç»“æ„å¯¹åº”ä»£ç çš„å®ç°ä»ä¸‹è‡³ä¸Šï¼Œä»£ç çš„å®ç°å¯¹åº”ç›®æ ‡ä»£ç ç”±å¤–å‘å†…</li>
<li><strong>valueToNode æ–¹æ³•ï¼š</strong>ç”Ÿæˆå„ç§ç±»å‹å¯¹è±¡ï¼Œé™¤äº†åŸå§‹ç±»å‹ undefinedã€nullã€stringã€numberã€booleanï¼Œè¿˜å¯ä»¥æ˜¯å¯¹è±¡ç±»å‹ RegExpã€ReadonlyArrayã€objectï¼Œå¯ä»¥æ¥å—æ•°ç»„ï¼Œä¼ å…¥ä»€ä¹ˆç”Ÿæˆä»€ä¹ˆ</li>
</ul>
</li>
</ol>
</li>
<li><strong>å®šä¹‰ visitor å¯¹è±¡çš„ä¸‰ç§æ–¹å¼ï¼ˆå¸¸ç”¨ç¬¬ 2 ç§ï¼‰ï¼š</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">const visitor1 = &#123;</span><br><span class="line">    FunctionExpression: function (path) &#123;</span><br><span class="line">        console.log(&quot;xfblog&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">const visitor2 = &#123;</span><br><span class="line">    &quot;FunctionExpression|BinaryExpression&quot;(path) &#123;</span><br><span class="line">        console.log(&quot;xfblog&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">const visitor3 = &#123;</span><br><span class="line">    FunctionExpression: &#123;</span><br><span class="line">        // enter(path) &#123;</span><br><span class="line">        //     console.log(&quot;xfblog&quot;);</span><br><span class="line">        // &#125;</span><br><span class="line">        enter: [</span><br><span class="line">            function (path) &#123;</span><br><span class="line">                console.log(&quot;func1&quot;);</span><br><span class="line">            &#125;,</span><br><span class="line">            function (path) &#123;</span><br><span class="line">                console.log(&quot;func2&quot;);</span><br><span class="line">            &#125;,</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>åˆ©ç”¨ types ç»„ä»¶æ„å»ºæ–°çš„ AST èŠ‚ç‚¹ï¼š</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">const files = require(&#x27;fs&#x27;);</span><br><span class="line">const parser = require(&quot;@babel/parser&quot;);</span><br><span class="line">const traverse = require(&quot;@babel/traverse&quot;).default;</span><br><span class="line">const types = require(&quot;@babel/types&quot;);</span><br><span class="line">const generator = require(&quot;@babel/generator&quot;).default;</span><br><span class="line"></span><br><span class="line">const jscode = files.readFileSync(&quot;./demo.js&quot;, &#123;</span><br><span class="line">    encoding: &quot;utf-8&quot;</span><br><span class="line">&#125;);</span><br><span class="line">let ast = parser.parse(jscode);</span><br><span class="line"></span><br><span class="line">let a = types.identifier(&#x27;a&#x27;);</span><br><span class="line">let b = types.identifier(&#x27;b&#x27;);</span><br><span class="line">let binExpr2 = types.binaryExpression(&quot;+&quot;, a, b);</span><br><span class="line">let binExpr3 = types.binaryExpression(&quot;*&quot;, a, b);</span><br><span class="line">let retSta2 = types.returnStatement(types.binaryExpression(&quot;+&quot;, binExpr2, types.numericLiteral(1000)));</span><br><span class="line">let retSta3 = types.returnStatement(types.binaryExpression(&quot;+&quot;, binExpr3, types.numericLiteral(1000)));</span><br><span class="line">let bloSta2 = types.blockStatement([retSta2]);</span><br><span class="line">let bloSta3 = types.blockStatement([retSta3]);</span><br><span class="line">let funcExpr2 = types.functionExpression(null, [a, b], bloSta2);</span><br><span class="line">let funcExpr3 = types.functionExpression(null, [a, b], bloSta3);</span><br><span class="line">let objProp1 = types.objectProperty(types.identifier(&#x27;name&#x27;), types.stringLiteral(&#x27;xiaojianbang&#x27;));</span><br><span class="line">let objProp2 = types.objectProperty(types.identifier(&#x27;add&#x27;), funcExpr2);</span><br><span class="line">let objProp3 = types.objectProperty(types.identifier(&#x27;mul&#x27;), funcExpr3);</span><br><span class="line">let objExpr = types.objectExpression([objProp1, objProp2, objProp3]);</span><br><span class="line">let varDec = types.variableDeclarator(types.identifier(&#x27;obj&#x27;), objExpr);</span><br><span class="line">let loaclAst = types.variableDeclaration(&#x27;let&#x27;, [varDec]);</span><br><span class="line">let code = generator(loaclAst).code;</span><br><span class="line">console.log(code);</span><br><span class="line"></span><br><span class="line">// code = generator(ast).code;</span><br><span class="line">files.writeFile(&#x27;./demoNew.js&#x27;, code, (err) =&gt; &#123; &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="4-path"><a href="#4-path" class="headerlink" title="4. path"></a>4. path</h3><blockquote>
<p><strong>path ä¸ node çš„åŒºåˆ«ï¼š</strong>path æ˜¯åœ¨ä¸€å¼€å§‹ parser.parse è§£ææ—¶å°±ç”Ÿæˆçš„ï¼Œnode èŠ‚ç‚¹æ˜¯è¢«åŒ…å«åœ¨ path ä¸­çš„</p>
<p><strong>æ³¨æ„ï¼šåœ¨é€šè¿‡ type ç»„ä»¶æ„å»ºæ–°çš„ AST èŠ‚ç‚¹æ—¶ï¼Œç”Ÿæˆçš„æ–° node æ˜¯æ²¡æœ‰ path çš„ã€‚æ‰€ä»¥åœ¨å¯¹èŠ‚ç‚¹è¿›è¡Œå¢åˆ æ”¹åï¼Œéœ€è¦å…ˆå°† AST è½¬æˆä»£ç ï¼Œå†é‡æ–° parser.parse è§£æä¸º AST è¯­æ³•æ ‘ï¼Œæ­¤æ—¶ node èŠ‚ç‚¹æ‰ä¼šæœ‰ path å¯¹è±¡</strong></p>
<p><strong><span style="color:red;">é‡ç‚¹ï¼šå‡¡æ˜¯æ¶‰åŠåˆ°èŠ‚ç‚¹çš„æ“ä½œï¼Œéƒ½æ¨èä½¿ç”¨ path å¯¹è±¡çš„æ–¹æ³•ï¼Œå› ä¸ºåªæœ‰è¿™æ · Babel æ‰ä¼šæ›´æ–° path å¯¹è±¡ã€‚ä½†æœ‰æ—¶é¿å…ä¸äº†ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼Œæ‰€ä»¥æœ€å¥½çš„åŠæ³•å°±æ˜¯åœ¨ä¿®æ”¹ä¹‹å‰ï¼Œå…ˆå°† AST è½¬æˆä»£ç ï¼Œå†å°†ä»£ç è§£æä¸º AST</span></strong></p>
</blockquote>
<ul>
<li><p><strong>path.skip()ï¼š</strong>åªè·³è¿‡å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹éå†ï¼Œéå†å™¨ä¼šç»§ç»­å¤„ç†å½“å‰èŠ‚ç‚¹ä¹‹åçš„å…¶ä»–èŠ‚ç‚¹</p>
</li>
<li><p><strong>path.stop()ï¼š</strong>åœæ­¢æ•´ä¸ªéå†è¿‡ç¨‹ï¼Œä¸å†å¤„ç†ä»»ä½•èŠ‚ç‚¹</p>
</li>
<li><p>**<span style="color:red;">path.evaluate()ï¼š</span>**ç”¨äºè¯„ä¼°ä¸€ä¸ªè¡¨è¾¾å¼å¹¶è¿”å›å…¶è®¡ç®—ç»“æœï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å±æ€§</p>
<ul>
<li><strong>confidentï¼š</strong>ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤º Babel æ˜¯å¦ç¡®ä¿¡å¯ä»¥ç¡®å®šè¯¥è¡¨è¾¾å¼çš„å€¼</li>
<li><strong>valueï¼š</strong>è¡¨è¾¾å¼çš„å€¼ï¼ˆå¦‚æœ confident ä¸º trueï¼‰ï¼Œå¦åˆ™ä¸º undefined</li>
</ul>
</li>
<li><p><strong><span style="color:red;">path.evaluateTruthy()ï¼š</span><strong>ä¸“é—¨ç”¨äºè¯„ä¼°ä¸€ä¸ªè¡¨è¾¾å¼çš„çœŸå‡æ€§ï¼Œ</strong>ç›´æ¥è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼æˆ– undefined æ— æ³•ç¡®å®š</strong></p>
</li>
<li><p><strong>åˆ¤æ–­ path ç±»å‹ï¼š</strong>path çš„ type å±æ€§é€šå¸¸ä¸ node ä¸­çš„ type å±æ€§ä¸€è‡´ï¼Œç”¨äºåˆ¤æ–­è‡ªèº«ç±»å‹ï¼Œç”¨æ³•ä¸ types ç»„ä»¶å·®ä¸å¤šï¼Œä¾‹ <code>path.get(&#39;left&#39;).isIdentifier()</code> è¿”å›å¸ƒå°”å€¼</p>
</li>
<li><p><strong>èŠ‚ç‚¹è½¬ä»£ç ï¼š</strong>å°† ASTï¼ˆéƒ¨åˆ†ï¼‰èŠ‚ç‚¹è½¬æˆä»£ç ï¼Œ<code>path.toString()</code>ã€<code>path + &#39;&#39;</code>ï¼Œä¸ generator ç»„ä»¶ä½œç”¨ç›¸åŒ</p>
</li>
<li><p><strong>æ›¿æ¢èŠ‚ç‚¹å±æ€§ï¼š</strong>å°†æ ‡è¯†ç¬¦æ”¹ä¸º xï¼Œ<code>path.node.left = t.identifier(&quot;x&quot;)</code>ï¼ˆ**è¿™æ–¹å¼ä¸ä¼šæ›´æ–° path å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼æ›¿æ¢ <code>path.get(&#39;left&#39;).replaceWith(types.identifier(&#39;x&#39;))</code>**ï¼‰</p>
</li>
<li><p><strong>path çš„å±æ€§ï¼š</strong></p>
<ul>
<li>nodeï¼šè¡¨ç¤ºå½“å‰ path ä¸‹çš„ node èŠ‚ç‚¹</li>
<li>parentï¼šç”¨äºè·å–å½“å‰ path ä¸‹çš„çˆ¶ nodeï¼Œå¤šç”¨äºåˆ¤æ–­èŠ‚ç‚¹ç±»å‹</li>
<li>parentPathï¼šç”¨äºè·å–å½“å‰ path ä¸‹çš„çˆ¶ pathï¼Œå¤šç”¨äºåˆ¤æ–­èŠ‚ç‚¹ç±»å‹</li>
<li>scopeï¼šè¡¨ç¤ºå½“å‰ path ä¸‹çš„ä½œç”¨åŸŸ</li>
<li><strong>æ³¨æ„ï¼š</strong><code>path.parentPath.node</code> ç­‰ä»·äº <code>path.parent</code>ï¼Œå³ parent æ˜¯ parentPath çš„ä¸€éƒ¨åˆ†</li>
<li>typeï¼šç”¨äºè·å–å½“å‰ path çš„èŠ‚ç‚¹ç±»å‹</li>
</ul>
</li>
<li><p><strong>path ä¸­ container å®¹å™¨ç›¸å…³çš„å±æ€§ï¼š</strong></p>
<ul>
<li><p>inListï¼šåˆ¤æ–­æ˜¯å¦æœ‰åŒçº§èŠ‚ç‚¹ï¼Œå³æ˜¯å¦å¤„äºæ•°ç»„ä¸­ï¼ˆå½“æ•°ç»„åªæœ‰ä¸€ä¸ªæˆå‘˜æ—¶ï¼Œä¹Ÿä¼šè¿”å› trueï¼‰</p>
</li>
<li><p><strong>containerï¼š</strong>å®¹å™¨ï¼Œç”¨äºè·å–å½“å‰pathä¸‹çš„æ‰€æœ‰å…„å¼Ÿ<strong>èŠ‚ç‚¹</strong>ï¼ˆ<strong>åŒ…æ‹¬è‡ªèº«</strong>ï¼‰ï¼Œæ˜¯ä¸€ä¸ª Array ç±»å‹</p>
</li>
<li><p>keyï¼šè¡¨ç¤ºå½“å‰èŠ‚ç‚¹åœ¨ container <strong>æ•°ç»„</strong>ä¸­çš„ç´¢å¼•ï¼Œå¯ä»¥ç”¨äº path.get å‡½æ•°</p>
</li>
<li><p>listKeyï¼šè¡¨ç¤º container å®¹å™¨çš„åå­—</p>
</li>
</ul>
</li>
<li><p><strong>path çš„æ–¹æ³•ï¼š</strong></p>
<ul>
<li>toStringï¼šç”¨æ¥è·å–å½“å‰éå† path çš„ js æºä»£ç ï¼ŒåŒæ ·ç”¨æ³• <code>generator(path.node).code</code></li>
<li>getï¼šè·å–å­èŠ‚ç‚¹çš„ <strong>path</strong> å¯¹è±¡ï¼ˆåŒºåˆ«äº path.node. è·å–å­èŠ‚ç‚¹çš„ node å¯¹è±¡ï¼‰</li>
<li><strong>findParent</strong>ï¼šå‘çˆ¶èŠ‚ç‚¹æœå¯»èŠ‚ç‚¹ï¼Œä¸åŒ…æ‹¬å½“å‰èŠ‚ç‚¹ï¼Œæ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæ ¹æ®å›è°ƒå‡½æ•°çš„å¸ƒå°”å€¼ï¼Œä»è€Œè¿”å›æ‰¾åˆ°èŠ‚ç‚¹çš„ path æˆ– nullã€‚ä¾‹å¦‚ <code>path.findParent((p) =&gt; p.isObjectExpression())</code></li>
<li><strong>find</strong>ï¼šå‘çˆ¶èŠ‚ç‚¹æœå¯»èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬å½“å‰èŠ‚ç‚¹ï¼Œç”¨æ³•ä¸ findParent ä¸€è‡´</li>
<li>getFunctionParentï¼šè·å–å‡½æ•°ç±»å‹çˆ¶èŠ‚ç‚¹çš„ pathï¼Œå­˜åœ¨åˆ™è¿”å› pathï¼Œä¸å­˜åœ¨åˆ™è¿”å› null</li>
<li>getStatementParentï¼šè·å– Statement ç±»å‹çˆ¶èŠ‚ç‚¹çš„ pathï¼Œè¿™ä¸ªåŸºæœ¬ä¸Šéƒ½ä¼šæœ‰è¿”å›å€¼ï¼Œå¦‚æœå½“å‰éå†çš„æ˜¯ Program æˆ–è€… File èŠ‚ç‚¹ï¼Œåˆ™ä¼šæŠ¥é”™</li>
<li>getAncestryï¼šè·å–æ‰€æœ‰çš„ç¥–å…ˆèŠ‚ç‚¹çš„ pathï¼Œæ²¡æœ‰å®å‚ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ª Array å¯¹è±¡</li>
<li>isAncestor(someNode)ï¼šåˆ¤æ–­å½“å‰éå†çš„èŠ‚ç‚¹æ˜¯å¦æ˜¯ä¼ å…¥èŠ‚ç‚¹çš„ç¥–å…ˆèŠ‚ç‚¹ï¼ˆæ‰€æœ‰æ›´é«˜å±‚çº§çš„çˆ¶èŠ‚ç‚¹ï¼‰</li>
<li>isDescendant(someNode)ï¼šåˆ¤æ–­å½“å‰éå†çš„èŠ‚ç‚¹æ˜¯å¦æ˜¯ä¼ å…¥èŠ‚ç‚¹çš„å­å­™èŠ‚ç‚¹</li>
<li><strong>replaceWithï¼š</strong>ç”¨ AST èŠ‚ç‚¹æ›¿æ¢è¯¥èŠ‚ç‚¹ï¼ˆ<strong>ä¸¥æ ¼ä¸€æ¢ä¸€ï¼Œæ›¿æ¢æ–°èŠ‚ç‚¹ä¸€èˆ¬ç”± types ç»„ä»¶ç”Ÿæˆ</strong>ï¼‰</li>
<li><strong>replaceWithMultipleï¼š</strong>ç”¨å¤šä¸ª AST èŠ‚ç‚¹æ›¿æ¢å½“å‰èŠ‚ç‚¹ï¼ˆ<strong>å¤šæ¢ä¸€ï¼Œå®å‚ä¸ºæ•°ç»„ï¼Œæˆ–ä¸€æ¢ä¸€å•å…ƒç´ æ•°ç»„</strong>ï¼‰</li>
<li><strong>replaceInlineï¼š</strong>æ•´åˆ replaceWith ä¸ replaceWithMultipleï¼ˆ<strong>æ¥å—ä¸€ä¸ªèŠ‚ç‚¹åˆ™ä¸€æ¢ä¸€ï¼Œæ•°ç»„åˆ™ä¸€æ¢å¤š</strong>ï¼‰</li>
<li>replaceWithSourceStringï¼šç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²æºç æ›¿æ¢è¯¥èŠ‚ç‚¹ï¼ˆ<strong>æ›¿æ¢ä¸ºè¡¨è¾¾å¼ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²</strong>ï¼‰</li>
<li><strong>insertBeforeï¼š</strong>åœ¨å½“å‰èŠ‚ç‚¹ä¹‹å‰æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…„å¼ŸèŠ‚ç‚¹</li>
<li>insertAfterï¼šåœ¨å½“å‰èŠ‚ç‚¹ä¹‹åæ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…„å¼ŸèŠ‚ç‚¹</li>
<li><strong>removeï¼š</strong>åˆ é™¤èŠ‚ç‚¹ï¼Œç›´æ¥è°ƒç”¨å³å¯å°†å½“å‰éå†çš„æ‰€æœ‰<strong>ç¬¦åˆæ¡ä»¶çš„è·¯å¾„</strong>å…¨éƒ¨åˆ é™¤</li>
<li>traverseï¼šåœ¨å½“å‰èŠ‚ç‚¹ä¸‹éå†å…¶ä»–çš„èŠ‚ç‚¹</li>
<li>getSiblingï¼šè·å–ä¸åŒçš„åŒçº§ Pathï¼Œæ¥å—å®¹å™¨æ•°ç»„ä¸­çš„ç´¢å¼•ä¸ºå‚æ•°ï¼Œ<strong>é€šè¿‡ä¼ å‚ path.key çš„å¢å‡å®šä½</strong></li>
<li>getPrevSiblingï¼šè·å–å½“å‰ path çš„å‰ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œè¿”å›çš„æ˜¯ path ç±»å‹</li>
<li>getAllPrevSiblingsï¼šè·å–å½“å‰ path çš„æ‰€æœ‰å‰å…„å¼ŸèŠ‚ç‚¹ï¼Œè¿”å›çš„æ˜¯ Array ç±»å‹ï¼Œå…¶å…ƒç´ éƒ½æ˜¯ path ç±»å‹</li>
<li><strong>getNextSiblingï¼š</strong>è·å–å½“å‰ path çš„åä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œè¿”å›çš„æ˜¯ path ç±»å‹</li>
<li><strong>getAllNextSiblingsï¼š</strong>è·å–å½“å‰ path çš„æ‰€æœ‰åå…„å¼ŸèŠ‚ç‚¹ï¼Œè¿”å›çš„æ˜¯ Array ç±»å‹ï¼Œå…¶å…ƒç´ éƒ½æ˜¯ path ç±»å‹</li>
<li><strong>path.evaluateï¼šç”¨äºè®¡ç®—è¡¨è¾¾å¼çš„å€¼</strong></li>
<li>unshiftContainer å’Œ pushContainer æ–¹æ³•ï¼šåˆ†åˆ«ç”¨äºå¾€å®¹å™¨çš„æœ€å‰é¢å’Œæœ€åé¢åŠ å…¥èŠ‚ç‚¹ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸º listKey å®¹å™¨åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸º Nodes èŠ‚ç‚¹ï¼Œ<code>path.parentPath.unshiftContainer(body, [...])</code></li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/** æµ‹è¯•ä»£ç ï¼š</span><br><span class="line"> * let obj = &#123;</span><br><span class="line"> *     name : &#x27;xiaofu&#x27;,</span><br><span class="line"> *     add: function(a, b)&#123;</span><br><span class="line"> *         return a + b + 1000;</span><br><span class="line"> *     &#125;,</span><br><span class="line"> *     mul: function(a, b)&#123;</span><br><span class="line"> *         return a * b + 1000;</span><br><span class="line"> *     &#125;,</span><br><span class="line"> * &#125;</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">    ReturnStatement(path) &#123;</span><br><span class="line">        console.log(path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">/** è¾“å‡ºç»“æœï¼š</span><br><span class="line">NodePath &#123;</span><br><span class="line">  parentPath: NodePath &#123;......&#125;,</span><br><span class="line">  container: [</span><br><span class="line">    Node &#123;</span><br><span class="line">      type: &#x27;ReturnStatement&#x27;,</span><br><span class="line">      start: 272,</span><br><span class="line">      end: 292,</span><br><span class="line">      loc: [SourceLocation],</span><br><span class="line">      argument: [Node]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  listKey: &#x27;body&#x27;,</span><br><span class="line">  key: 0,</span><br><span class="line">  node: Node &#123;......&#125;,</span><br><span class="line">  type: &#x27;ReturnStatement&#x27;,</span><br><span class="line">  parent: Node &#123;......&#125;,</span><br><span class="line">  hub: undefined,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

<h3 id="5-scope"><a href="#5-scope" class="headerlink" title="5. scope"></a>5. scope</h3><blockquote>
<p><strong>path.scopeï¼š</strong>scope æä¾›äº†ä¸€äº›å±æ€§å’Œæ–¹æ³•ï¼Œå¯ä»¥æ–¹ä¾¿çš„æŸ¥æ‰¾æ ‡è¯†ç¬¦çš„ä½œç”¨åŸŸï¼Œè·å–æ ‡è¯†ç¬¦çš„æ‰€æœ‰å¼•ç”¨ï¼Œä¿®æ”¹æ ‡è¯†ç¬¦çš„æ‰€æœ‰å¼•ç”¨ï¼Œä»¥åŠè¯†åˆ«æ ‡è¯†ç¬¦æ˜¯å¦ä¸ºå‚æ•°ã€å¸¸é‡ç­‰ï¼Œå¦‚æœä¸æ˜¯å¸¸é‡ï¼Œä¹Ÿå¯ä»¥çŸ¥é“åœ¨å“ªé‡Œä¿®æ”¹äº†å®ƒ</p>
<p><strong><span style="color:red;">å…³äºæ ‡è¯†ç¬¦åœ¨ä½œç”¨åŸŸä¸­çš„å¼•ç”¨æ¬¡æ•°ä¸ scope.crawl() çš„ä½¿ç”¨çš„é‡è¦è§£è¯»ï¼š</span></strong></p>
<ol>
<li>åœ¨æ•´ä¸ªæ’ä»¶ç¼–å†™ä¸è°ƒç”¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šåœ¨æŸäº›æ’ä»¶ä¸­ä¿®æ”¹ä»£ç çš„ AST ç»“æ„æˆ–è€…åˆ›å»ºæ–°çš„èŠ‚ç‚¹ï¼Œè¿™å°†åŒæ—¶ä¼šå½±å“åˆ°ä»£ç çš„ä½œç”¨åŸŸï¼Œ<strong>ä½† scope å¯¹è±¡åœ¨æŸäº›æƒ…å†µä¸‹ä¸ä¼šè‡ªåŠ¨æ›´æ–°</strong>ï¼Œä»è€Œå¯¼è‡´å…¶ä¸­çš„ä¿¡æ¯æœ‰è¯¯å·®</li>
<li><strong>scope.crawl() çš„ä½¿ç”¨ï¼šåœ¨æ¶‰åŠæœ‰å…³ä½œç”¨åŸŸçš„æ“ä½œæ—¶ï¼Œæœ€å¥½åœ¨å…¶ä¹‹å‰å…ˆè°ƒç”¨ scope.crawl() æ–¹æ³•æ›´æ–°å½“å‰ä½œç”¨åŸŸä¿¡æ¯ï¼Œä»¥ç¡®ä¿è·å–å¯¹è±¡çš„ç»‘å®šä¿¡æ¯æ­£ç¡®ï¼ŒåŒæ—¶å»ºè®®åœ¨æ¯ä¸ªæ’ä»¶çš„æœ€åä¸€è¡Œéƒ½è°ƒç”¨æ­¤æ–¹æ³•æ›´æ–°ä½œç”¨åŸŸï¼ˆ<span style="color:red;">å…¶å¯ä»¥ç›´æ¥åœ¨åŒä¸€ä¸ªæ’ä»¶ä¸­ï¼Œå¦‚æœæœ‰å¯¹èŠ‚ç‚¹çš„æ”¹åŠ¨ï¼Œä½¿ç”¨ scope.crawl() å¯ä»¥ç«‹é©¬æ›´æ–°ä½œç”¨åŸŸ</span>ï¼‰</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scope.crawl();  // å…ˆæ›´æ–°ä½œç”¨åŸŸï¼Œå†è·å–ç»‘å®šï¼Œæ˜¯æœ€æ­£ç¡®çš„</span><br><span class="line"> let nameBin = scope.getBinding(left.name)</span><br><span class="line">if (nameBin.references == 0) &#123;</span><br><span class="line">    path.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><p><strong>scope.blockï¼š</strong>è¿”å›<strong>å½“å‰ä½œç”¨åŸŸ</strong>ä¸‹çš„æ‰€æœ‰ nodeï¼Œå¯ç”¨ <code>generator(path.scope.block).code</code> æŸ¥çœ‹ä»£ç ï¼›åœ¨éå†å‡½æ•°è·å–ä½œç”¨åŸŸæ—¶ï¼Œè¿”å›çš„æ˜¯å‡½æ•°æœ¬èº«çš„ nodeï¼Œå…¶çœŸå®ä½œç”¨åŸŸåº”è¯¥ä¸º <code>path.scope.parent.block</code></p>
</li>
<li><p><strong>scope.dump()ï¼š</strong>è¾“å‡ºå½“å‰æ¯ä¸ªå˜é‡çš„ä½œç”¨åŸŸä¿¡æ¯ã€‚è°ƒç”¨åç›´æ¥æ‰“å°ï¼Œä¸éœ€è¦åŠ æ‰“å°å‡½æ•°</p>
</li>
<li><p><strong><span style="color:red;">scope.crawl()ï¼š</span>æ›´æ–°ä½œç”¨åŸŸä¿¡æ¯ï¼Œå¹¶ç¡®ä¿ä¹‹åå¯¹ä½œç”¨åŸŸä¿¡æ¯çš„è®¿é—®æ˜¯æœ€æ–°çš„</strong></p>
</li>
<li><p><strong>scope.getBinding(name)ï¼š</strong>è·å–æŸä¸ªå˜é‡çš„ bindingï¼Œå¯ç†è§£ä¸ºå…¶ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…å«å¼•ç”¨ï¼Œä¿®æ”¹ä¹‹ç±»çš„ä¿¡æ¯ã€‚å‚æ•°å¿…é¡»æ˜¯å½“å‰èŠ‚ç‚¹èƒ½å¤Ÿå¼•ç”¨çš„åˆ°çš„æ ‡è¯†ç¬¦åï¼Œ<strong>åªæœ‰å˜é‡å®šä¹‰å’Œå‡½æ•°å®šä¹‰æ‹¥æœ‰ binding</strong>ï¼Œå…¶ä»–çš„è·å– binding éƒ½æ˜¯ undefinedã€‚è¿”å›çš„ä½œç”¨åŸŸä¸­æœ‰å‡ ä¸ªå…³é”®å±æ€§ï¼š</p>
<ul>
<li><p>pathï¼šç”¨äºå®šä½åˆå§‹æ‹¥æœ‰ binding çš„ pathï¼Œä¾‹å¦‚å½¢å‚æˆ–æ–°å®šä¹‰çš„å˜é‡</p>
</li>
<li><p>identifierï¼šæ˜¯å‚æ•°çš„ node å¯¹è±¡</p>
</li>
<li><p>scopeï¼šæ˜¯å‚æ•°çš„ scope å¯¹è±¡ï¼Œå°†å…¶ä¸­ block èŠ‚ç‚¹è½¬ä¸ºä»£ç åï¼Œä¸€æ ·å¯ä»¥å¾—åˆ°å…¶ä½œç”¨åŸŸèŒƒå›´ä»£ç </p>
</li>
<li><p>kindï¼šè¡¨ç¤ºæ­¤æ ‡è¯†ç¬¦çš„ç”Ÿæˆï¼Œæ˜¯å®šä¹‰ let è¿˜æ˜¯å‚æ•° params ç­‰ï¼Œä½†æ˜¯å®ƒå¹¶ä¸ä»£è¡¨å°±æ˜¯å½“å‰å‡½æ•°çš„å‚æ•°</p>
</li>
<li><p><strong>constantï¼š</strong>ç”¨äºåˆ¤æ–­å½“å‰å˜é‡æ˜¯å¦æ˜¯<strong>å¸¸é‡</strong>ï¼Œå³æ˜¯å¦<strong>æ²¡æœ‰</strong>è¢«æ›´æ”¹ï¼Œ<strong>åœ¨å®šä¹‰æ—¶èµ‹å€¼ä¸æ˜¯æ›´æ”¹ï¼Œä½†æ˜¯å…ˆå®šä¹‰åèµ‹å€¼å°±ç®—è¢«æ›´æ”¹ï¼ŒåŒæ—¶å‡½æ•°ä¸­å½¢å‚ä¹Ÿæ˜¯æœ‰ç»‘å®šçš„ï¼Œä¸ºå½¢å‚èµ‹å€¼å°±æ˜¯æ”¹å˜ï¼Œåœ¨è¿˜åŸæ—¶åº”åˆ¤æ–­å…¶æ”¹å˜æ˜¯å¦åªæœ‰ä¸€æ¬¡ä¸”ä¸ºæœ¬èº«</strong></p>
</li>
<li><p><strong>constantViolationsï¼š</strong>Array ç±»å‹ï¼ŒåŒ…å«æ‰€æœ‰<strong>ä¿®æ”¹</strong>è¯¥æ ‡è¯†ç¬¦èŠ‚ç‚¹çš„ path å¯¹è±¡ï¼Œå¤šç”¨äºåˆ¤æ–­</p>
</li>
<li><p><strong>referencedï¼š</strong>ç”¨äºåˆ¤æ–­å½“å‰å˜é‡æ˜¯å¦è¢«å¼•ç”¨ï¼Œ<strong>èµ‹å€¼ä¸ç®—å¼•ç”¨ï¼Œå–å€¼æ‰ç®—ï¼ˆä¾‹å¤– e[â€˜ageâ€™]&#x3D;18; ç®—å¼•ç”¨ï¼‰</strong></p>
</li>
<li><p><strong>referencePathsï¼š</strong>Array ç±»å‹ï¼ŒåŒ…å«æ‰€æœ‰å¼•ç”¨è¯¥æ ‡è¯†ç¬¦çš„èŠ‚ç‚¹çš„ path å¯¹è±¡ï¼Œå¤šç”¨äºæ›¿æ¢ï¼ˆ<strong>æ³¨æ„ï¼š</strong>å¾ªç¯éå†æ—¶ï¼Œé€šå¸¸ item çš„çˆ¶ path æ‰æ˜¯è°ƒç”¨è¡¨è¾¾å¼æˆ–æˆå‘˜è¡¨è¾¾å¼ï¼‰ï¼ˆ<strong>ä¿®æ”¹å˜é‡æ—¶è§£å†³é‡åé—®é¢˜</strong>ï¼‰</p>
</li>
<li><p><strong>referencesï¼š</strong>ä»£è¡¨æ ‡è¯†ç¬¦è¢«å¼•ç”¨çš„æ¬¡æ•°</p>
</li>
</ul>
</li>
<li><p><strong>scope.getOwnBinding()ï¼š</strong>ç”¨äºè·å–å½“å‰èŠ‚ç‚¹è‡ªå·±çš„ç»‘å®šï¼Œä¹Ÿå°±æ˜¯ä¸åŒ…å«çˆ¶çº§ä½œç”¨åŸŸä¸­å®šä¹‰çš„æ ‡è¯†ç¬¦çš„ç»‘å®šï¼Œä½†æ˜¯è¯¥å‡½æ•°ä¼šå¾—åˆ°å­å‡½æ•°ä¸­å®šä¹‰çš„æ ‡è¯†ç¬¦çš„ç»‘å®š</p>
</li>
<li><p><strong>scope.rename(oldName, newName, [block])ï¼š</strong>ä¿®æ”¹å½“å‰ä½œç”¨åŸŸä¸‹æŒ‡å®šçš„å˜é‡åï¼Œ<strong>åŒæ—¶ä¿®æ”¹æ‰€æœ‰å¼•ç”¨è¯¥æ ‡è¯†ç¬¦çš„åœ°æ–¹</strong>ï¼Œå®å‚ä¸ºå­—ç¬¦ä¸²ç±»å‹ã€‚æ³¨æ„ï¼ŒoldName éœ€è¦æœ‰ bindingï¼Œå¦åˆ™æ— æ³•é‡å‘½å</p>
<ul>
<li><strong>ç”Ÿæˆæ–°æ ‡è¯†ç¬¦åï¼š</strong><code>path.scope.generateUidIdentifier(&quot;uid&quot;).name</code></li>
</ul>
</li>
<li><p><strong>scope.traverse()ï¼š</strong>éå†å½“å‰ä½œç”¨åŸŸä¸‹çš„æŸäº›(ä¸ª)æ’ä»¶ï¼Œä½¿ç”¨ path.scope.traverse åˆ™æ˜¯å½“å‰èŠ‚ç‚¹çš„ä½œç”¨åŸŸï¼Œè€Œä½¿ç”¨ path.scope.getBinding(name).scope.traverse åˆ™æ˜¯éå†æ ‡è¯†ç¬¦ name çš„ä½œç”¨åŸŸï¼Œæ¨èåè€…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FunctionDeclaration(path) &#123;</span><br><span class="line">    let binding = path.scope.getBinding(&#x27;a&#x27;);</span><br><span class="line">    binding.scope.traverse(binding.scope.block, &#123;</span><br><span class="line">        AssignmentExpression(p) &#123;</span><br><span class="line">            if (p.node.left.name == &#x27;a&#x27;) &#123;</span><br><span class="line">                p.node.right = t.numericLiteral(5000)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>scope çš„å…¶ä»–æ–¹æ³•ï¼š</strong></p>
<ul>
<li><strong>scope.hasBinding(â€˜aâ€™)ï¼š</strong>æŸ¥è¯¢æ˜¯å¦æœ‰æ ‡è¯†ç¬¦ a çš„ç»‘å®šï¼Œè¿”å› true æˆ– false</li>
<li><strong>scope.hasOwnBinding(â€˜aâ€™)ï¼š</strong>æŸ¥è¯¢æ˜¯å¦æœ‰è‡ªå·±çš„ç»‘å®šï¼Œä¸åŒ…å«å‡½æ•°æœ¬èº«ï¼Œè¿”å› true æˆ– false</li>
<li><strong>scope.getAllBindings()ï¼š</strong>è·å–å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰ç»‘å®šï¼Œæ˜¯åŒ…å«å…¨å±€å˜é‡çš„ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚è¯¥å¯¹è±¡ä»¥æ ‡è¯†ç¬¦åä¸ºå±æ€§åï¼Œå¯¹åº”çš„ Binding ä¸ºå±æ€§å€¼</li>
<li><strong>scope.hasReference(â€˜aâ€™)ï¼š</strong>æŸ¥è¯¢å½“å‰èŠ‚ç‚¹ä¸­æ˜¯å¦æœ‰ a æ ‡è¯†ç¬¦çš„å¼•ç”¨ï¼Œè¿”å› true æˆ– false</li>
<li><strong>scope.getBindingIdentifier(â€˜aâ€™)ï¼š</strong>è·å–å½“å‰èŠ‚ç‚¹ä¸­ç»‘å®šçš„ a æ ‡è¯†ç¬¦ï¼Œè¿”å›çš„æ˜¯ Identifier çš„ Node å¯¹è±¡ã€‚åŒæ ·åœ°ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿæœ‰ Own ç‰ˆæœ¬ï¼Œscope.getOwnBindingldentifier(â€˜aâ€™)</li>
</ul>
</li>
</ul>
<h3 id="6-å¸¸è§è¯­æ³•æŠ€å·§"><a href="#6-å¸¸è§è¯­æ³•æŠ€å·§" class="headerlink" title="6. å¸¸è§è¯­æ³•æŠ€å·§"></a>6. å¸¸è§è¯­æ³•æŠ€å·§</h3><ul>
<li><p><strong>è·å–èŠ‚ç‚¹æºä»£ç ï¼š</strong></p>
<ul>
<li><strong>pathï¼š<code>path.toString()</code></strong></li>
<li><strong>nodeï¼š<code>generator(node).code</code></strong></li>
</ul>
</li>
<li><p><strong>ä½¿ç”¨ template æ„é€ èŠ‚ç‚¹ï¼š</strong></p>
<ol>
<li><pre><code>// åˆ›å»ºä¸€ä¸ªæ¨¡æ¿
let VAR_NODE = template(`var A = 1, B = A;`);

// å®šä¹‰æ›¿æ¢çš„æ ‡è¯†ç¬¦
let firstVar = types.identifier(&#39;a&#39;);
let secondVar = types.identifier(&#39;b&#39;);

// ç”Ÿæˆæ–°çš„èŠ‚ç‚¹
let newNode = VAR_NODE(&#123; A: firstVar, B: secondVar &#125;);
console.log(generator(newNode).code); // var a = 1, b = a;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. ```</span><br><span class="line">   let newNode = template.ast(&quot;aaa = 666;&quot;);</span><br><span class="line">   console.log(generator(newNode).code); // aaa = 666;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ol>
</li>
<li><p><strong>é™¤äº† path.remove() çš„å…¶ä»–åˆ é™¤èŠ‚ç‚¹æ–¹å¼ï¼š</strong></p>
<ol>
<li><strong>delete path.node.extraï¼š</strong>åˆ é™¤ <strong>StringLiteral</strong> èŠ‚ç‚¹çš„ extra å±æ€§ï¼Œå¯ä»¥è¿˜åŸç®€å•çš„è¿›åˆ¶æ··æ·†å­—é¢é‡</li>
<li><strong>body.pop()ï¼š</strong>éœ€åˆ é™¤çš„èŠ‚ç‚¹å­˜åœ¨å¤šä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œä¸”å­˜åœ¨ Array ä¸­ï¼Œåˆ™å¯é€šè¿‡éå†æ•°ç»„é…åˆæ¡ä»¶åˆ¤æ–­åˆ é™¤</li>
</ol>
</li>
</ul>
<h3 id="7-ast-å¿…å¤‡-js-è¯­æ³•ä¸ç‰¹æ€§"><a href="#7-ast-å¿…å¤‡-js-è¯­æ³•ä¸ç‰¹æ€§" class="headerlink" title="7. ast å¿…å¤‡ js è¯­æ³•ä¸ç‰¹æ€§"></a>7. ast å¿…å¤‡ js è¯­æ³•ä¸ç‰¹æ€§</h3><ol>
<li><strong>åœ¨ js ä¸­åªæœ‰ 7 ç§å€¼ falseã€undefinedã€nullã€0ã€-0ã€NaNã€â€â€ ä¸ºå‡</strong>ï¼Œå…¶ä½™å‡ä¸ºçœŸ</li>
<li>åœ¨ js ä¸­å¯¹è±¡çš„ key å¯ä»¥ä¸åŠ å¼•å·ï¼Œä¸åŒäº python</li>
<li><strong>åœ¨ js ä¸­å˜é‡åå’Œå¯¹è±¡é”®æ— æ³•ç›´æ¥è¿›è¡ŒåŠ å¯†ï¼Œåªèƒ½æ··æ·†</strong>ï¼Œå› ä¸ºåŠ å¯†ä¼šå¯¼è‡´ js å¼•æ“æ— æ³•æ­£ç¡®è§£æå’Œè®¿é—®</li>
</ol>
<ul>
<li><p><strong>æ•°ç»„å¸¸ç”¨å°æ–¹æ³•ï¼š</strong></p>
<ol>
<li><strong>push(ele)ï¼š</strong>åœ¨æ•°ç»„æœ«å°¾æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›æ•°ç»„çš„æ–°é•¿åº¦</li>
<li><strong>pop()ï¼š</strong>ä»æ•°ç»„æœ«å°¾ç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›è¯¥å…ƒç´ </li>
<li><strong>shift()ï¼š</strong>ä»æ•°ç»„å¼€å¤´ç§»é™¤ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›è¯¥å…ƒç´ </li>
<li><strong>unshift(ele)ï¼š</strong>åœ¨æ•°ç»„å¼€å¤´æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›æ•°ç»„çš„æ–°é•¿åº¦</li>
<li><strong>concat(arr1, arr2)ï¼š</strong>åˆå¹¶ä¸¤ä¸ªæˆ–å¤šä¸ªæ•°ç»„ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°æ•°ç»„</li>
<li><strong>sort()ï¼š</strong>å°±åœ°å¯¹æ•°ç»„çš„å…ƒç´ è¿›è¡Œæ’åºï¼Œå¹¶è¿”å›æ­¤æ•°ç»„ã€‚é»˜è®¤æ’åºé¡ºåºæ˜¯æ ¹æ®å­—ç¬¦ä¸² Unicode ç ç‚¹</li>
<li><strong>reverse()ï¼š</strong>å°±åœ°é¢ å€’æ•°ç»„ä¸­å…ƒç´ çš„é¡ºåºï¼Œå¹¶è¿”å›æ­¤æ•°ç»„</li>
<li><strong>join(separator)ï¼š</strong>å°†æ•°ç»„çš„æ‰€æœ‰å…ƒç´ è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…ƒç´ é€šè¿‡æŒ‡å®šçš„åˆ†éš”ç¬¦ separator åˆ†éš”</li>
<li><strong>includes(ele)ï¼š</strong>å¦‚æœæ•°ç»„åŒ…å«æŸä¸ªå…ƒç´ ï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› false</li>
</ol>
</li>
<li><p><strong>æ•°ç»„å¸¸ç”¨éå†æ–¹æ³•ï¼š</strong></p>
<ol>
<li><strong>forEach(callback)ï¼š</strong>å¯¹æ•°ç»„çš„æ¯ä¸ªå…ƒç´ æ‰§è¡Œä¸€æ¬¡æä¾›çš„å‡½æ•°</li>
<li><strong>filter(callback)ï¼š</strong>åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰é€šè¿‡æ‰€æä¾›å‡½æ•°å®ç°çš„æµ‹è¯•çš„å…ƒç´ </li>
<li><strong>every(callback)ï¼š</strong>æµ‹è¯•ä¸€ä¸ªæ•°ç»„çš„æ‰€æœ‰å…ƒç´ æ˜¯å¦éƒ½é€šè¿‡äº†æŒ‡å®šå‡½æ•°çš„æµ‹è¯•ï¼Œè¿”å›å¸ƒå°”å€¼</li>
<li><strong>some(callback)ï¼š</strong>æµ‹è¯•æ•°ç»„ä¸­çš„æŸäº›å…ƒç´ æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªé€šè¿‡äº†æä¾›çš„å‡½æ•°çš„æµ‹è¯•ï¼Œè¿”å›å¸ƒå°”å€¼</li>
<li><strong>map(callback)ï¼š</strong>åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œå…¶ç»“æœæ˜¯è¯¥æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ è°ƒç”¨ä¸€æ¬¡æä¾›çš„å‡½æ•°åçš„è¿”å›å€¼</li>
<li><strong>slice(beginIndex, endIndex)ï¼š</strong>è¿”å›ä¸€ä¸ªæ–°æ•°ç»„ï¼ŒåŒ…å«ä»å¼€å§‹åˆ°ç»“æŸï¼ˆå·¦é—­å³å¼€ï¼‰é€‰æ‹©çš„æ•°ç»„çš„ä¸€éƒ¨åˆ†</li>
<li><strong>splice(startIndex, deleteCount[, itemâ€¦])ï¼š</strong>é€šè¿‡åˆ é™¤æˆ–æ›¿æ¢ç°æœ‰å…ƒç´ å’Œ&#x2F;æˆ–æ·»åŠ æ–°å…ƒç´ æ¥ä¿®æ”¹æ•°ç»„çš„å†…å®¹ï¼Œå¹¶è¿”å›è¢«åˆ é™¤çš„å…ƒç´ </li>
</ol>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arr.every(element =&gt; element.toString() == &#x27;xfblog.cn&#x27;)</span><br></pre></td></tr></table></figure>

<h3 id="8-åŠ¨æ€-js-æ›¿æ¢è°ƒè¯•"><a href="#8-åŠ¨æ€-js-æ›¿æ¢è°ƒè¯•" class="headerlink" title="8. åŠ¨æ€ js æ›¿æ¢è°ƒè¯•"></a>8. åŠ¨æ€ js æ›¿æ¢è°ƒè¯•</h3><blockquote>
<p><strong>mitmproxyï¼š</strong>æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ã€äº¤äº’å¼çš„<strong>ä¸­é—´äººä»£ç†</strong>ï¼ˆMan-in-the-Middle Proxyï¼‰ï¼Œå¯ä»¥ç”¨äº<strong>æ‹¦æˆªã€ä¿®æ”¹å’ŒæŸ¥çœ‹ HTTP&#x2F;HTTPS è¯·æ±‚ä¸å“åº”ã€‚</strong></p>
<p><strong>mitmproxy åŸºæœ¬æ¶æ„ï¼š</strong>mitmproxy å……å½“<strong>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸­é—´äºº</strong>ã€‚å½“å®¢æˆ·ç«¯ï¼ˆå¦‚æµè§ˆå™¨æˆ–ä»»ä½• HTTP å®¢æˆ·ç«¯ï¼‰å‘å‡ºè¯·æ±‚æ—¶ï¼Œmitmproxy ä¼šæ‹¦æˆªå¹¶å¤„ç†è¯¥è¯·æ±‚ï¼Œç„¶åå°†å…¶è½¬å‘åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼›æ¥ç€ï¼Œmitmproxy ä¼šæ‹¦æˆªå¹¶å¤„ç†ä»ç›®æ ‡æœåŠ¡å™¨è¿”å›çš„å“åº”ï¼Œå†å°†å…¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>å¯åŠ¨ï¼š<code>mitmdump -q -p 8888 -s main.py</code>ï¼Œé‡åˆ° bcrypt æŠ¥é”™ï¼š<code>pip3 install bcrypt==3.2.0</code></p>
<p>åˆ‡æ¢ä»£ç†è‡³ <a class="link"   target="_blank" rel="noopener" href="http://127.0.0.1:8888/" >http://127.0.0.1:8888<i class="fas fa-external-link-alt"></i></a> ï¼šè®¿é—® <a class="link"   target="_blank" rel="noopener" href="http://mitm.it/" >http://mitm.it/<i class="fas fa-external-link-alt"></i></a> ä¸‹è½½ SSL è¯ä¹¦</p>
</blockquote>
<ul>
<li><strong>vpn + mitmproxyï¼š</strong><code>mitmdump --mode upstream:http://127.0.0.1:7890/ -q -p 8888 -s main.py</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import mitmproxy.http</span><br><span class="line"></span><br><span class="line">print(&#x27;è„šæœ¬åˆå§‹åŒ–æˆåŠŸ&#x27;)</span><br><span class="line"></span><br><span class="line">def request(flow: mitmproxy.http.HTTPFlow):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">def response(flow: mitmproxy.http.HTTPFlow):</span><br><span class="line">    if flow.request.method == &quot;GET&quot; and &quot;/cdn-cgi/challenge-platform/h/b/orchestrate/&quot; in flow.request.url:</span><br><span class="line">        with open(&quot;encode.js&quot;, &quot;w&quot;, encoding=&quot;utf-8&quot;) as fp:</span><br><span class="line">            fp.write(flow.response.text)</span><br><span class="line"></span><br><span class="line">        os.system(&quot;node main.js&quot;)</span><br><span class="line">        with open(&quot;encode_ok.js&quot;, &quot;r&quot;, encoding=&quot;utf-8&quot;) as fp:</span><br><span class="line">            flow.response.text = fp.read()</span><br></pre></td></tr></table></figure>

<h2 id="äºŒã€åˆ¤æ–­èŠ‚ç‚¹é€šç”¨å‡½æ•°"><a href="#äºŒã€åˆ¤æ–­èŠ‚ç‚¹é€šç”¨å‡½æ•°" class="headerlink" title="äºŒã€åˆ¤æ–­èŠ‚ç‚¹é€šç”¨å‡½æ•°"></a>äºŒã€åˆ¤æ–­èŠ‚ç‚¹é€šç”¨å‡½æ•°</h2><h3 id="1-å‡½æ•°-èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­"><a href="#1-å‡½æ•°-èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­" class="headerlink" title="1. å‡½æ•° -&gt; èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­"></a>1. å‡½æ•° -&gt; èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isBaseLiteral(node) &#123;</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node) &amp;&amp; node.value != null) return true; // nullå¯èƒ½æœ‰å‘</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; literalList.includes(node.name)) return true;</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; typeof globalThis[node.name] != &quot;undefined&quot;) return true;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; [&quot;+&quot;, &quot;-&quot;, &quot;!&quot;].includes(node.operator)) &#123;</span><br><span class="line">        if (types.isArrayExpression(node.argument) &amp;&amp; node.argument.elements.length == 0) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return isBaseLiteral(node.argument);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-å‡½æ•°-èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­"><a href="#2-å‡½æ•°-èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­" class="headerlink" title="2. å‡½æ•° -&gt; èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­"></a>2. å‡½æ•° -&gt; èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­</h3><blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">if (Array.isArray(node))</span><br><span class="line">    return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">if (types.isThisExpression(node))</span><br><span class="line">    return true;</span><br><span class="line"></span><br><span class="line">if (types.isLiteral(node))</span><br><span class="line">    return node.value != null;</span><br><span class="line"></span><br><span class="line">if (types.isBinaryExpression(node))</span><br><span class="line">    return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">    return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">if (types.isObjectExpression(node))</span><br><span class="line">    return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">if (types.isArrayExpression(node))</span><br><span class="line">    return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// ç”¨äºæ£€æŸ¥ä¸€ä¸ªç»™å®šçš„ AST èŠ‚ç‚¹æ˜¯å¦å¯ä»¥è¢«è§†ä¸ºå­—é¢é‡(Literal)</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    // node æ˜¯æ•°ç»„ï¼Œå‡½æ•°ä¼šé€’å½’åœ°æ£€æŸ¥æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯å¦éƒ½ç¬¦åˆå­—é¢é‡çš„æ¡ä»¶</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    // node æ˜¯ä¸€ä¸ª ThisExpression (ä¾‹`this`å…³é”®å­—)ï¼Œåˆ™è¿”å›trueï¼Œå› ä¸ºthiså¯ä»¥è¢«è§†ä¸ºå­—é¢é‡</span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    // node æ˜¯å­—é¢é‡ï¼Œå‡½æ•°ä¼šè¿›ä¸€æ­¥æ£€æŸ¥å®ƒçš„å€¼ã€‚å¦‚æœvalueä¸ºnullï¼Œè¿”å›falseï¼Œå¦åˆ™è¿”å›true</span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    // node æ˜¯äºŒå…ƒè¡¨è¾¾å¼ï¼Œå‡½æ•°ä¼šé€’å½’åœ°æ£€æŸ¥è¡¨è¾¾å¼çš„å·¦æ“ä½œæ•°å’Œå³æ“ä½œæ•°æ˜¯å¦éƒ½ä¸ºå­—é¢é‡</span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    // node æ˜¯ä¸€å…ƒè¡¨è¾¾å¼ï¼Œä¸”æ“ä½œç¬¦æ˜¯ + æˆ– -ï¼Œå‡½æ•°ä¼šé€’å½’åœ°æ£€æŸ¥è¡¨è¾¾å¼çš„å‚æ•°æ˜¯å¦ä¸ºå­—é¢é‡</span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    // node æ˜¯å¯¹è±¡è¡¨è¾¾å¼ï¼Œä¾‹`&#123;a: 1, b: 2&#125;`ï¼Œå‡½æ•°ä¼šæ£€æŸ¥å¯¹è±¡çš„å±æ€§ï¼Œå±æ€§ä¸ºç©ºåˆ™è¿”å›trueï¼Œå¦åˆ™é€’å½’æ£€æŸ¥æ¯ä¸ªå±æ€§æ˜¯å¦ä¸ºå­—é¢é‡</span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    // node æ˜¯æ•°ç»„è¡¨è¾¾å¼ï¼Œä¾‹`[1, 2, 3]`ï¼Œå‡½æ•°ä¼šæ£€æŸ¥æ•°ç»„çš„å…ƒç´ ï¼Œå…ƒç´ ä¸ºç©ºåˆ™è¿”å›trueï¼Œå¦åˆ™é€’å½’æ£€æŸ¥æ¯ä¸ªå…ƒç´ æ˜¯å¦ä¸ºå­—é¢é‡</span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-å‡½æ•°ä¼˜åŒ–-èŠ‚ç‚¹å­é¢é‡åˆ¤æ–­"><a href="#3-å‡½æ•°ä¼˜åŒ–-èŠ‚ç‚¹å­é¢é‡åˆ¤æ–­" class="headerlink" title="3. å‡½æ•°ä¼˜åŒ– -&gt; èŠ‚ç‚¹å­é¢é‡åˆ¤æ–­"></a>3. å‡½æ•°ä¼˜åŒ– -&gt; èŠ‚ç‚¹å­é¢é‡åˆ¤æ–­</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// èŠ‚ç‚¹å­é¢é‡åˆ¤æ–­</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    const literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (Array.isArray(node)) return node.every(isNodeLiteral);</span><br><span class="line">    if (types.isThisExpression(node)) return true;</span><br><span class="line">    if (types.isLiteral(node)) return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node)) &#123;</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27; || node.operator === &#x27;!&#x27;)) &#123;</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node)) &#123;</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node)) &#123;</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isIdentifier(node)) &#123;</span><br><span class="line">        if (literalList.includes(node.name) || typeof globalThis[node.name] !== &#x27;undefined&#x27;) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-å‡½æ•°-åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦çº¯å‡½æ•°"><a href="#3-å‡½æ•°-åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦çº¯å‡½æ•°" class="headerlink" title="3. å‡½æ•° -&gt; åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦çº¯å‡½æ•°"></a>3. å‡½æ•° -&gt; åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦çº¯å‡½æ•°</h3><blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">// åˆ¤æ–­å‡½æ•°æ˜¯å¦ä¸ºçº¯å‡½æ•°</span><br><span class="line">function isPureFunction(path) &#123;</span><br><span class="line"> let isPure = true;</span><br><span class="line"></span><br><span class="line"> // æ£€æŸ¥ body.body æ•°ç»„çš„æ¯è¡Œä»£ç æ˜¯å¦åŒ…å«å…¨å±€å±æ€§ï¼ŒåŒ…å«åˆ™ä¸è¿˜åŸï¼ŒåŒæ—¶è¿”å›å€¼ä¸å”¯ä¸€çš„ä¹Ÿä¸æ˜¯çº¯å‡½æ•°</span><br><span class="line"> let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;, &#x27;try&#x27;, &#x27;random&#x27;, &#x27;Date&#x27;];</span><br><span class="line"> let sourceCode = path.toString();</span><br><span class="line"> let allElementsValid = literalList.every(ele =&gt; !sourceCode.includes(ele)); // ä¸º true åˆ™ä¸åŒ…å«ï¼Œä¸º false åˆ™è¯´æ˜åŒ…å«</span><br><span class="line"> if (!allElementsValid) return false; // åŒ…å«åˆ™ä¸æ˜¯çº¯å‡½æ•°</span><br><span class="line"></span><br><span class="line"> path.traverse(&#123;</span><br><span class="line">     MemberExpression(innerPath) &#123;</span><br><span class="line">         const &#123; object &#125; = innerPath.node;</span><br><span class="line">         if (types.isIdentifier(object) &amp;&amp; object.name !== &#x27;this&#x27; &amp;&amp; !path.scope.hasBinding(object.name)) &#123;</span><br><span class="line">             isPure = false;</span><br><span class="line">             innerPath.stop();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     AssignmentExpression(innerPath) &#123;</span><br><span class="line">         const &#123; left &#125; = innerPath.node;</span><br><span class="line">         if (types.isIdentifier(left) &amp;&amp; !path.scope.hasBinding(left.name)) &#123;</span><br><span class="line">             isPure = false;</span><br><span class="line">             innerPath.stop();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     CallExpression(innerPath) &#123;</span><br><span class="line">         const &#123; callee &#125; = innerPath.node;</span><br><span class="line">         if (types.isIdentifier(callee)) &#123;</span><br><span class="line">             const binding = path.scope.getBinding(callee.name);</span><br><span class="line">             if (!binding || !isPureFunction(binding.path)) &#123;</span><br><span class="line">                 isPure = false;</span><br><span class="line">                 innerPath.stop();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     UpdateExpression(innerPath) &#123;</span><br><span class="line">         const &#123; argument &#125; = innerPath.node;</span><br><span class="line">         if (types.isIdentifier(argument) &amp;&amp; !path.scope.hasBinding(argument.name)) &#123;</span><br><span class="line">             isPure = false;</span><br><span class="line">             innerPath.stop();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"> return isPure;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">// åˆ¤æ–­å‡½æ•°æ˜¯å¦ä¸ºçº¯å‡½æ•°</span><br><span class="line">function isPureFunction(path) &#123;</span><br><span class="line">    let isPure = true;</span><br><span class="line">    </span><br><span class="line">    // æ£€æŸ¥ body.body æ•°ç»„çš„æ¯è¡Œä»£ç æ˜¯å¦åŒ…å«å…¨å±€å±æ€§ï¼ŒåŒ…å«åˆ™ä¸è¿˜åŸï¼ŒåŒæ—¶è¿”å›å€¼ä¸å”¯ä¸€çš„ä¹Ÿä¸æ˜¯çº¯å‡½æ•°</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;, &#x27;try&#x27;, &#x27;random&#x27;, &#x27;Date&#x27;];</span><br><span class="line">    let sourceCode = path.toString();</span><br><span class="line">    let allElementsValid = literalList.every(ele =&gt; !sourceCode.includes(ele)); // ä¸º true åˆ™ä¸åŒ…å«ï¼Œä¸º false åˆ™è¯´æ˜åŒ…å«</span><br><span class="line">    if (!allElementsValid) return false; // åŒ…å«åˆ™ä¸æ˜¯çº¯å‡½æ•°</span><br><span class="line"></span><br><span class="line">    // è®¿é—®å‡½æ•°å†…éƒ¨çš„æ‰€æœ‰èŠ‚ç‚¹</span><br><span class="line">    path.traverse(&#123;</span><br><span class="line">        // æ£€æŸ¥æ˜¯å¦æœ‰å‰¯ä½œç”¨</span><br><span class="line">        MemberExpression(innerPath) &#123;</span><br><span class="line">            const &#123; object &#125; = innerPath.node;</span><br><span class="line">            // å¦‚æœè®¿é—®äº†å¤–éƒ¨å˜é‡</span><br><span class="line">            if (types.isIdentifier(object) &amp;&amp; object.name !== &#x27;this&#x27; &amp;&amp; !path.scope.hasBinding(object.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        // æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†å¤–éƒ¨çŠ¶æ€</span><br><span class="line">        AssignmentExpression(innerPath) &#123;</span><br><span class="line">            const &#123; left &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(left) &amp;&amp; !path.scope.hasBinding(left.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        // æ£€æŸ¥æ˜¯å¦è°ƒç”¨äº†éçº¯å‡½æ•°</span><br><span class="line">        CallExpression(innerPath) &#123;</span><br><span class="line">            const &#123; callee &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(callee)) &#123;</span><br><span class="line">                const binding = path.scope.getBinding(callee.name);</span><br><span class="line">                if (!binding || !isPureFunction(binding.path)) &#123;</span><br><span class="line">                    isPure = false;</span><br><span class="line">                    innerPath.stop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        // å…¶ä»–å¯èƒ½çš„å‰¯ä½œç”¨</span><br><span class="line">        UpdateExpression(innerPath) &#123;</span><br><span class="line">            const &#123; argument &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(argument) &amp;&amp; !path.scope.hasBinding(argument.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        // æ£€æŸ¥ä½¿ç”¨äº†å…¨å±€å¯¹è±¡</span><br><span class="line">        Identifier(innerPath) &#123;</span><br><span class="line">            if ([&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;, &#x27;try&#x27;, &#x27;Date&#x27;, &#x27;random&#x27;].includes(innerPath.node.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return isPure;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸‰ã€è§£æ··æ·†é€šç”¨æ’ä»¶"><a href="#ä¸‰ã€è§£æ··æ·†é€šç”¨æ’ä»¶" class="headerlink" title="ä¸‰ã€è§£æ··æ·†é€šç”¨æ’ä»¶"></a>ä¸‰ã€è§£æ··æ·†é€šç”¨æ’ä»¶</h2><h3 id="1-æ’ä»¶-ç¼–ç è¿˜åŸåè¿›åˆ¶"><a href="#1-æ’ä»¶-ç¼–ç è¿˜åŸåè¿›åˆ¶" class="headerlink" title="1. æ’ä»¶ -&gt; ç¼–ç è¿˜åŸåè¿›åˆ¶"></a>1. æ’ä»¶ -&gt; ç¼–ç è¿˜åŸåè¿›åˆ¶</h3><ul>
<li>å½“ä»£ç ä¸­åŒ…å«<strong>éASCIIå­—ç¬¦</strong>æ—¶ï¼Œè¦å°½å¯èƒ½å°‘åœ°ä½¿ç”¨è½¬ä¹‰å­—ç¬¦ï¼Œä»¥ç¡®ä¿å…¶è¢«æ­£ç¡®åœ°ä¿ç•™å’Œæ˜¾ç¤ºï¼Œè€Œä¸æ˜¯è¢«è½¬ä¹‰<ul>
<li>é…ç½®ï¼š<code>let &#123; code &#125; = generator(ast, opts = &#123; jsescOption: &#123; &quot;minimal&quot;: true &#125; &#125;);</code></li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// ç¼–ç è¿˜åŸåè¿›åˆ¶</span><br><span class="line">const simplifyLiteral = &#123;</span><br><span class="line">    NumericLiteral(&#123; node &#125;) &#123;</span><br><span class="line">        if (node.extra &amp;&amp; /^0[obx]/i.test(node.extra.raw)) &#123;</span><br><span class="line">            node.extra = undefined;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    StringLiteral(&#123; node &#125;) &#123;</span><br><span class="line">        if (node.extra &amp;&amp; /\\[ux]/gi.test(node.extra.raw)) &#123;</span><br><span class="line">            node.extra = undefined;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, simplifyLiteral);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const e = &#x27;\u0041&#x27; + &#x27;\x41&#x27; + &#x27;\u00E9&#x27;;</span><br></pre></td></tr></table></figure>

<h3 id="2-æ’ä»¶-æ ‡è¯†ç¬¦ç»Ÿä¸€å­—é¢é‡åŒ–"><a href="#2-æ’ä»¶-æ ‡è¯†ç¬¦ç»Ÿä¸€å­—é¢é‡åŒ–" class="headerlink" title="2. æ’ä»¶ -&gt; æ ‡è¯†ç¬¦ç»Ÿä¸€å­—é¢é‡åŒ–"></a>2. æ’ä»¶ -&gt; æ ‡è¯†ç¬¦ç»Ÿä¸€å­—é¢é‡åŒ–</h3><ul>
<li>computed å±æ€§ï¼š<ul>
<li><code>node.computed === true</code>ï¼šè¡¨ç¤ºå±æ€§è®¿é—®ä½¿ç”¨äº†ä¸­æ‹¬å· <code>[]</code>ï¼Œå³æ˜¯â€œ<strong>è®¡ç®—å±æ€§</strong>â€</li>
<li><code>node.computed === false</code>ï¼šè¡¨ç¤ºå±æ€§è®¿é—®ä½¿ç”¨äº†ç‚¹æ“ä½œç¬¦ <code>.</code>ï¼Œå³æ˜¯â€œ<strong>éè®¡ç®—å±æ€§</strong>â€</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// å­—é¢é‡åŒ–æˆå‘˜è¡¨è¾¾å¼ `b.length` ==&gt; `b[&#x27;length&#x27;]`</span><br><span class="line">const keyToLiteral = &#123;</span><br><span class="line">    MemberExpression: &#123;</span><br><span class="line">        exit(&#123;node&#125;) &#123;</span><br><span class="line">            const prop = node.property;</span><br><span class="line">            if (node.computed === false &amp;&amp; types.isIdentifier(prop)) &#123;</span><br><span class="line">                node.property = types.stringLiteral(prop.name)</span><br><span class="line">                node.computed = true; // åªæœ‰å½“ä½¿ç”¨ä¸­æ‹¬å·è°ƒç”¨æ‰ä¸ºtrue</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    // å¯¹è±¡çš„ key ä¹Ÿç”±æ ‡è¯†ç¬¦è½¬ä¸ºå­—é¢é‡</span><br><span class="line">    ObjectProperty: &#123;</span><br><span class="line">        exit(&#123;node&#125;) &#123;</span><br><span class="line">            const key = node.key;</span><br><span class="line">            if (!node.computed &amp;&amp; types.isIdentifier(key)) &#123;</span><br><span class="line">                node.key = types.stringLiteral(key.name);</span><br><span class="line">            &#125;</span><br><span class="line">            if (node.computed &amp;&amp; types.isStringLiteral(key)) &#123;</span><br><span class="line">                node.computed = false; // æ¶ˆé™¤â€œè¯­æ³•ä¸Šçš„å†—ä½™è®¡ç®—å±æ€§â€</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, keyToLiteral);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">window.Date()</span><br><span class="line"></span><br><span class="line">const obj = &#123;</span><br><span class="line">  foo: 1,           // computed: false, key æ˜¯ Identifier(foo)</span><br><span class="line">  [&#x27;bar&#x27;]: 2,       // computed: true, key æ˜¯ StringLiteral(&#x27;bar&#x27;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-æ’ä»¶-æŠ˜å å­—é¢é‡æˆ–è¡¨è¾¾å¼"><a href="#3-æ’ä»¶-æŠ˜å å­—é¢é‡æˆ–è¡¨è¾¾å¼" class="headerlink" title="3. æ’ä»¶ -&gt; æŠ˜å å­—é¢é‡æˆ–è¡¨è¾¾å¼"></a>3. æ’ä»¶ -&gt; æŠ˜å å­—é¢é‡æˆ–è¡¨è¾¾å¼</h3><blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">// æŠ˜å è®¡ç®—éƒ¨åˆ†å­—é¢é‡æˆ–è¡¨è¾¾å¼</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line"> if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line">   </span><br><span class="line"> if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line">   </span><br><span class="line"> if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line">   </span><br><span class="line"> if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line">   </span><br><span class="line"> if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line">   </span><br><span class="line"> if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line">   </span><br><span class="line"> if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line">   </span><br><span class="line"> return false;</span><br><span class="line">   &#125;</span><br><span class="line">const calcPartBinaryExpression = &#123;</span><br><span class="line"> &quot;BinaryExpression|UnaryExpression|ConditionalExpression|MemberExpression|CallExpression&quot;: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; parent, scope, parentPath, node &#125; = path;</span><br><span class="line">            let &#123; left, operator, right &#125; = node;</span><br><span class="line">   </span><br><span class="line">         if ((isNodeLiteral(left) &amp;&amp; isNodeLiteral(right)) ||    // å¤„ç†æ•°å­—å­—é¢é‡ï¼Œç®€å•å­—ç¬¦ä¸²å­—é¢é‡</span><br><span class="line">                path.isUnaryExpression() ||                         // å¤„ç†jsfuckä»£ç çš„`!![]` </span><br><span class="line">                path.isMemberExpression() ||                        // å¤„ç†æˆå‘˜è¡¨è¾¾å¼</span><br><span class="line">                path.isCallExpression()) &#123;                          // å¤„ç†è°ƒç”¨è¡¨è¾¾å¼</span><br><span class="line">                const &#123; confident, value &#125; = path.evaluate();       // è¿™ä¸ªè®¡ç®—æ˜¯åŒ…å«äº†äºŒå…ƒè¡¨è¾¾å¼çš„</span><br><span class="line">                if (!confident || value == &quot;Infinity&quot;) return;</span><br><span class="line">                // å¯¹äºå•ç‹¬çš„ä¸€å…ƒè¡¨è¾¾å¼ä¼šæ— é™éå†ï¼Œå¯¼è‡´å †æ ˆæº¢å‡º</span><br><span class="line">                if (path.isUnaryExpression(&#123; operator: &#x27;-&#x27; &#125;) || path.isUnaryExpression(&#123; operator: &#x27;void&#x27; &#125;)) return;</span><br><span class="line">                try &#123;</span><br><span class="line">                    path.replaceWith(types.valueToNode(value));</span><br><span class="line">                &#125; catch &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        path.replaceWith(types.stringLiteral(value));</span><br><span class="line">                    &#125; catch (e) &#123;</span><br><span class="line">                        console.log(&quot;æ— æ³•è¿˜åŸåŸå› :&quot;, e.message);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // å¤„ç†æ¡ä»¶è¡¨è¾¾å¼ï¼ˆä¸‰ç›®è¡¨è¾¾å¼ï¼‰</span><br><span class="line">            if (path.isConditionalExpression()) &#123;</span><br><span class="line">                let &#123; test, consequent, alternate &#125; = path.node;</span><br><span class="line">                if (consequent.value != null &amp;&amp; alternate.value != null &amp;&amp; consequent.value == alternate.value) &#123;</span><br><span class="line">                    path.replaceWith(types.valueToNode(consequent.value));</span><br><span class="line">                &#125;</span><br><span class="line">   </span><br><span class="line">             const &#123; confident, value &#125; = path.evaluate();</span><br><span class="line">                if (!confident || value == &quot;Infinity&quot;) return;</span><br><span class="line">                if (path.isUnaryExpression(&#123; operator: &#x27;-&#x27; &#125;) || path.isUnaryExpression(&#123; operator: &#x27;void&#x27; &#125;)) return;</span><br><span class="line">                path.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125;</span><br><span class="line">            // å¤„ç†å­—ç¬¦ä¸²ç›¸åŠ </span><br><span class="line">            if (parentPath.isBinaryExpression(&#123; left: node &#125;)) &#123;</span><br><span class="line">                if (!types.isLiteral(left) &amp;&amp; operator == &quot;+&quot; &amp;&amp; types.isLiteral(right)) &#123;</span><br><span class="line">                    if (parent.operator == &quot;+&quot; &amp;&amp; types.isLiteral(parent.right)) &#123;</span><br><span class="line">                        path.node.right.value += parent.right.value;</span><br><span class="line">                        parentPath.replaceWith(path.node);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">traverse(ast, calcPartBinaryExpression);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">/** æ’ä»¶ï¼šæŠ˜å è®¡ç®—éƒ¨åˆ†å­—é¢é‡æˆ–è¡¨è¾¾å¼</span><br><span class="line"> * var a = 1 + 2 + 3 + 4;                   ===&gt; var a = 10;</span><br><span class="line"> * var b = 3 - 5;                           ===&gt; var b = -2;</span><br><span class="line"> * var c = true ? 7 : 2;                    ===&gt; var c = 7;</span><br><span class="line"> * var d = !![];                            ===&gt; var d = true;</span><br><span class="line"> * var e = pw + 1 + 5 + 66;                 ===&gt; var e = pw + 72;</span><br><span class="line"> * var f = 3 + 100 - 30 + pw + 1 + 5 + 66;  ===&gt; var f = 145 + pw;</span><br><span class="line"> * var aaa = &quot;a&quot; + &quot;b&quot; + c;                 ===&gt; var aaa = &quot;ab&quot; + c;</span><br><span class="line"> * var bbb = c + &quot;d&quot; + &quot;e&quot;;                 ===&gt; var bbb = c + &quot;de&quot;;</span><br><span class="line"> * var ccc = &quot;a&quot; + &quot;b&quot; + c + &quot;d&quot; + &quot;e&quot;;     ===&gt; var ccc = &quot;ab&quot; + c + &quot;de&quot;;</span><br><span class="line"> * var ddd = &quot;111&quot;.toString().length        ===&gt; var ddd = 3</span><br><span class="line"> */</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const calcPartBinaryExpression = &#123;</span><br><span class="line">    &quot;BinaryExpression|UnaryExpression|ConditionalExpression|MemberExpression|CallExpression&quot;: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; parent, scope, parentPath, node &#125; = path;</span><br><span class="line">            let &#123; left, operator, right &#125; = node;</span><br><span class="line"></span><br><span class="line">            if ((isNodeLiteral(left) &amp;&amp; isNodeLiteral(right)) ||    // å¤„ç†æ•°å­—å­—é¢é‡ï¼Œç®€å•å­—ç¬¦ä¸²å­—é¢é‡</span><br><span class="line">                path.isUnaryExpression(&#123; operator: &#x27;!&#x27; &#125;) ||        // å¤„ç†jsfuckä»£ç çš„`!![]` </span><br><span class="line">                path.isConditionalExpression() ||                   // å¤„ç†ä¸‰ç›®è¿ç®—ç¬¦</span><br><span class="line">                path.isMemberExpression() ||                        // å¤„ç†æˆå‘˜è¡¨è¾¾å¼</span><br><span class="line">                path.isCallExpression()) &#123;                          // å¤„ç†è°ƒç”¨è¡¨è¾¾å¼</span><br><span class="line">                // è¯„ä¼°å½“å‰è·¯å¾„ï¼ˆè¡¨è¾¾å¼ï¼‰çš„å€¼ï¼Œconfidentè¡¨ç¤ºè¯„ä¼°ç»“æœæ˜¯å¦ç¡®å®šï¼Œvalueè¡¨ç¤ºè¯„ä¼°çš„å…·ä½“å€¼</span><br><span class="line">                const &#123; confident, value &#125; = path.evaluate();</span><br><span class="line">                if (!confident || value == &quot;Infinity&quot;) return; // æ’é™¤valueå€¼ä¸º 1/0 æ— ç©·å¤§çš„æƒ…å†µ</span><br><span class="line">                if (path.isUnaryExpression(&#123; operator: &#x27;-&#x27; &#125;) || path.isUnaryExpression(&#123; operator: &#x27;void&#x27; &#125;)) return;</span><br><span class="line">                // console.log(path + &#x27;&#x27;);</span><br><span class="line">                // console.log(parentPath + &#x27;&#x27;);</span><br><span class="line">                path.replaceWith(types.valueToNode(value));</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // å¦‚æœçˆ¶èŠ‚ç‚¹æ˜¯äºŒå…ƒè¡¨è¾¾å¼ï¼Œä¸”çˆ¶èŠ‚ç‚¹å·¦ä¾§æ“ä½œæ•°ä¸ºå½“å‰èŠ‚ç‚¹          // å¤„ç†å³ä¾§å­—ç¬¦ä¸²å­—é¢é‡ç›¸åŠ </span><br><span class="line">            if (parentPath.isBinaryExpression(&#123; left: node &#125;)) &#123;</span><br><span class="line">                // å¦‚æœå½“å‰èŠ‚ç‚¹çš„å·¦æ“ä½œæ•°ä¸æ˜¯å­—é¢é‡ï¼Œæ“ä½œç¬¦æ˜¯åŠ å·ï¼Œä¸”å³æ“ä½œæ•°æ˜¯å­—é¢é‡</span><br><span class="line">                if (!types.isLiteral(left) &amp;&amp; operator == &quot;+&quot; &amp;&amp; types.isLiteral(right)) &#123;</span><br><span class="line">                    // åŒæ—¶å¦‚æœçˆ¶èŠ‚ç‚¹çš„æ“ä½œç¬¦ä¹Ÿæ˜¯åŠ å·ï¼Œä¸”å³æ“ä½œæ•°ä¹Ÿæ˜¯å­—é¢é‡</span><br><span class="line">                    if (parent.operator == &quot;+&quot; &amp;&amp; types.isLiteral(parent.right)) &#123;</span><br><span class="line">                        // åˆå¹¶å½“å‰èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹çš„å³ä¾§å­—é¢é‡å€¼ï¼Œå¹¶æ›¿æ¢çˆ¶èŠ‚ç‚¹</span><br><span class="line">                        // console.log(path + &#x27;&#x27;);</span><br><span class="line">                        // console.log(parentPath + &#x27;&#x27;);</span><br><span class="line">                        path.node.right.value += parent.right.value;</span><br><span class="line">                        parentPath.replaceWith(path.node);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // å¤„ç†`var a = 73 + b + 72;`çš„æƒ…å†µ</span><br><span class="line">                if (types.isNumericLiteral(left) &amp;&amp; types.isNumericLiteral(parent.right)) &#123;</span><br><span class="line">                    // console.log(path + &#x27;&#x27;);</span><br><span class="line">                    // console.log(parentPath + &#x27;&#x27;);   </span><br><span class="line">                    path.node.left.value += parent.right.value;</span><br><span class="line">                    parentPath.replaceWith(path.node);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, calcPartBinaryExpression);</span><br></pre></td></tr></table></figure>

<h3 id="4-æ’ä»¶-ç®€åŒ–å¾ªç¯å’Œ-if-è¯­å¥"><a href="#4-æ’ä»¶-ç®€åŒ–å¾ªç¯å’Œ-if-è¯­å¥" class="headerlink" title="4. æ’ä»¶ -&gt; ç®€åŒ–å¾ªç¯å’Œ if è¯­å¥"></a>4. æ’ä»¶ -&gt; ç®€åŒ–å¾ªç¯å’Œ if è¯­å¥</h3><blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// ç¾åŒ–å¾ªç¯è¯­å¥å’Œ if-else è¯­å¥ï¼Œå¹¶ç®€åŒ–é€»è¾‘</span><br><span class="line">const SimplifyLoopAndIf = &#123;</span><br><span class="line">       &quot;ForStatement|WhileStatement|ForInStatement|ForOfStatement&quot;(&#123; node &#125;) &#123;</span><br><span class="line">           if (!types.isBlockStatement(node.body)) &#123;</span><br><span class="line">               node.body = types.blockStatement([node.body]);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">       &quot;IfStatement&quot;(path) &#123;</span><br><span class="line">           const test = path.get(&quot;test&quot;);</span><br><span class="line">           const consequent = path.get(&quot;consequent&quot;);</span><br><span class="line">           const alternate = path.get(&quot;alternate&quot;);</span><br><span class="line">           const evaluateTest = test.evaluateTruthy();</span><br><span class="line"></span><br><span class="line">           if (!consequent.isBlockStatement() &amp;&amp; !consequent.isEmptyStatement()) &#123;</span><br><span class="line">               consequent.replaceWith(types.blockStatement([consequent.node]));</span><br><span class="line">           &#125;</span><br><span class="line">           if (alternate.node !== null &amp;&amp; !alternate.isBlockStatement() &amp;&amp; !alternate.isEmptyStatement()) &#123;</span><br><span class="line">               alternate.replaceWith(types.blockStatement([alternate.node]));</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (consequent.isEmptyStatement() || consequent.node.body.length == 0) &#123;</span><br><span class="line">               if (alternate.node == null || alternate.isEmptyStatement() || alternate.node.body.length == 0) &#123;</span><br><span class="line">                   path.replaceWith(test.node);</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   consequent.replaceWith(alternate.node);</span><br><span class="line">                   alternate.remove();</span><br><span class="line">                   path.node.alternate = null;</span><br><span class="line">                   test.replaceWith(types.unaryExpression(&quot;!&quot;, test.node));</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (alternate.node != null) &#123;</span><br><span class="line">               if (alternate.isEmptyStatement() || alternate.node.body.length == 0) &#123;</span><br><span class="line">                   alternate.remove();</span><br><span class="line">                   path.node.alternate = null;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (evaluateTest === true) &#123;</span><br><span class="line">               path.replaceWithMultiple(consequent.node.body);</span><br><span class="line">           &#125;</span><br><span class="line">           else if (evaluateTest === false) &#123;</span><br><span class="line">               (alternate.node === null || alternate.node.body.length == 0) ? path.remove() : path.replaceWithMultiple(alternate.node.body);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, SimplifyLoopAndIf);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">/** æ’ä»¶ï¼šç¾åŒ–å¾ªç¯è¯­å¥å’Œ if-else è¯­å¥ï¼Œå¹¶ç®€åŒ–é€»è¾‘</span><br><span class="line"> * if (a) b; else c;                ===&gt; if (a) &#123; b; &#125; else &#123; c; &#125;</span><br><span class="line"> * if (a);                          ===&gt; a;</span><br><span class="line"> * if (a) &#123; &#125;;                      ===&gt; a;</span><br><span class="line"> * if (a) &#123; &#125; else &#123; &#125;;             ===&gt; a;</span><br><span class="line"> * if (a) &#123; &#125; else &#123; b &#125;;           ===&gt; if (!a) &#123; b; &#125;</span><br><span class="line"> * if (a) &#123; &#125; else b;               ===&gt; if (!a) &#123; b; &#125;</span><br><span class="line"> * if (a) &#123; b &#125; else &#123; &#125;;           ===&gt; if (a) &#123; b; &#125;</span><br><span class="line"> * if (a) &#123; b &#125; else;               ===&gt; if (a) &#123; b; &#125;</span><br><span class="line"> * if (1 + 1) b; else c;            ===&gt; b;</span><br><span class="line"> * if (1 - 1) b; else c;            ===&gt; c;</span><br><span class="line"> */</span><br><span class="line">const SimplifyLoopAndIf = &#123;</span><br><span class="line">    &quot;ForStatement|WhileStatement|ForInStatement|ForOfStatement&quot;(&#123; node, scope &#125;) &#123;</span><br><span class="line">        if (!types.isBlockStatement(node.body)) &#123;</span><br><span class="line">            node.body = types.BlockStatement([node.body]);</span><br><span class="line">        &#125;</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;IfStatement&quot;(path) &#123;</span><br><span class="line">        const test = path.get(&quot;test&quot;);</span><br><span class="line">        const consequent = path.get(&quot;consequent&quot;);</span><br><span class="line">        const alternate = path.get(&quot;alternate&quot;);</span><br><span class="line">        const evaluateTest = test.evaluateTruthy(); // ifçš„æ¡ä»¶æ‰§è¡Œï¼Œè¿”å›å¸ƒå°”å€¼</span><br><span class="line"></span><br><span class="line">        if (!consequent.isBlockStatement() &amp;&amp; !consequent.isEmptyStatement()) &#123;</span><br><span class="line">            consequent.replaceWith(types.BlockStatement([consequent.node]));</span><br><span class="line">        &#125;</span><br><span class="line">        if (alternate.node !== null &amp;&amp; !alternate.isBlockStatement() &amp;&amp; !alternate.isEmptyStatement()) &#123;</span><br><span class="line">            alternate.replaceWith(types.BlockStatement([alternate.node]));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (consequent.isEmptyStatement() || consequent.node.body.length == 0) &#123; // `if(a);`æˆ–`if(a)&#123;&#125;;`</span><br><span class="line">            if (alternate.node == null || alternate.isEmptyStatement() || alternate.node.body.length == 0) &#123;</span><br><span class="line">                path.replaceWith(test.node);</span><br><span class="line">            &#125; else &#123; // `if(a)&#123;&#125; else&#123;b&#125;;`</span><br><span class="line">                consequent.replaceWith(alternate.node);</span><br><span class="line">                alternate.remove();</span><br><span class="line">                path.node.alternate = null;</span><br><span class="line">                test.replaceWith(types.unaryExpression(&quot;!&quot;, test.node));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // `if(a)&#123;b&#125; else;`æˆ–`if(a)&#123;b&#125; else&#123;&#125;;`</span><br><span class="line">        if (alternate.node != null) &#123;</span><br><span class="line">            if (alternate.isEmptyStatement() || alternate.node.body.length == 0) &#123;</span><br><span class="line">                alternate.remove();</span><br><span class="line">                path.node.alternate = null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // èƒ½è®¡ç®—å‡ºæ¡ä»¶çœŸå‡å€¼çš„æƒ…å†µ</span><br><span class="line">        if (evaluateTest === true) &#123;</span><br><span class="line">            path.replaceWithMultiple(consequent.node.body);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (evaluateTest === false) &#123; // ä¹Ÿå¯èƒ½ä¸ºundefinedï¼Œæ­¤æ—¶ä¸ç¡®å®šï¼Œåˆ™ä¸å¤„ç†</span><br><span class="line">            (alternate.node === null || alternate.node.body.length == 0) ? path.remove() : path.replaceWithMultiple(alternate.node.body);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        path.scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, SimplifyLoopAndIf);</span><br></pre></td></tr></table></figure>

<h3 id="5-æ’ä»¶-ç®€åŒ–é€—å·è¡¨è¾¾å¼"><a href="#5-æ’ä»¶-ç®€åŒ–é€—å·è¡¨è¾¾å¼" class="headerlink" title="5. æ’ä»¶ -&gt; ç®€åŒ–é€—å·è¡¨è¾¾å¼"></a>5. æ’ä»¶ -&gt; ç®€åŒ–é€—å·è¡¨è¾¾å¼</h3><blockquote>
<p><strong>æ³¨æ„ï¼šåœ¨ç®€åŒ–é€—å·è¡¨è¾¾å¼ä¹‹å‰ï¼Œæœ€å¥½å…ˆæ‰§è¡Œã€Šç®€åŒ–å¾ªç¯å’Œ if è¯­å¥ã€‹ã€Šæ¡ä»¶è¡¨è¾¾å¼è½¬ IFã€‹ï¼Œèƒ½å¤Ÿæ›´å¥½çš„è¿˜åŸ</strong></p>
</blockquote>
<ul>
<li><strong>ç¬¬ 1 ç§ï¼ˆå¸¸ç”¨ï¼‰ï¼š</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">// æ–°ç‰ˆå»é€—å·è¡¨è¾¾å¼</span><br><span class="line">const resolveSequence = &#123;</span><br><span class="line">    SequenceExpression: &#123;</span><br><span class="line">        /**  @param  &#123;NodePath&#125; path */</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let statementPath = path.getStatementParent();</span><br><span class="line">            if (!statementPath) return;</span><br><span class="line"></span><br><span class="line">            let canVisitFlag = true;  // åˆå§‹çŠ¶æ€ä¸ºå¯ä»¥è¿˜åŸ</span><br><span class="line"></span><br><span class="line">            statementPath.traverse(&#123;</span><br><span class="line">                // å¯¹å½“å‰é€—å·è¡¨è¾¾å¼è¿›è¡Œä¸‹é¢ä¸‰ç§æƒ…å†µçš„éå†ï¼Œéƒ½æ»¡è¶³æ‰å¯ä»¥è¿˜åŸ</span><br><span class="line">                &quot;LogicalExpression|ConditionalExpression|SequenceExpression&quot;(_path) &#123;</span><br><span class="line">                    console.log(&quot;-----------å¼€å§‹&quot; + path);</span><br><span class="line">                    console.log(&quot;***********å¼€å§‹&quot; + _path, _path.type);</span><br><span class="line">                    // å¦‚æœå½“å‰é€—å·è¡¨è¾¾å¼ path ä¸æ˜¯åµŒå¥—åœ¨å½“å‰éå†çš„ é€»è¾‘ã€æ¡ä»¶æˆ–é€—å·è¡¨è¾¾å¼ é‡Œé¢çš„ï¼Œ</span><br><span class="line">                    // é‚£å°±æ²¡å¿…è¦éå†ï¼Œç›´æ¥å°±å¯ä»¥èµ°åˆ°æœ€åè¿˜åŸäº†</span><br><span class="line">                    if (!_path.isAncestor(path)) &#123;</span><br><span class="line">                        console.log(&quot;æ‹¦æˆªåŸå› 1&quot;);</span><br><span class="line">                        return;  // ä»…ç»“æŸå½“å‰å›è°ƒå‡½æ•°çš„æ‰§è¡Œï¼Œå¹¶è·³è¿‡å½“å‰èŠ‚ç‚¹çš„è¿›ä¸€æ­¥å¤„ç†</span><br><span class="line">                        // è¿™é‡Œåªè·³è¿‡å¯¹å½“å‰èŠ‚ç‚¹çš„éå†ï¼Œç»§ç»­éå†å­èŠ‚ç‚¹ï¼Œè€Œä¸è®¾ç½® canVisitFlag = false;</span><br><span class="line">                        // æ˜¯å› ä¸ºæ‹¦æˆªåŸå› 1å·²ç»è¶³ä»¥è¯´æ˜å½“å‰é€—å·è¡¨è¾¾å¼æ˜¯æœ€å¤–å±‚</span><br><span class="line">                    &#125;</span><br><span class="line">                    // å¦‚æœæ˜¯åµŒå¥—çš„é€—å·è¡¨è¾¾å¼ï¼Œé‚£ä¹Ÿä¸è¿˜åŸï¼Œä¼šå‡ºé—®é¢˜</span><br><span class="line">                    if (_path.isSequenceExpression()) &#123;</span><br><span class="line">                        console.log(&quot;æ‹¦æˆªåŸå› 2&quot;);</span><br><span class="line">                        canVisitFlag = false;</span><br><span class="line">                        _path.stop();</span><br><span class="line">                    &#125;</span><br><span class="line">                    // åªæœ‰å½“å‰é€—å·è¡¨è¾¾å¼åŒ…å«åœ¨ é€»è¾‘è¡¨è¾¾å¼çš„left æˆ– æ¡ä»¶è¡¨è¾¾å¼çš„test æ‰å¯ä»¥è¿˜åŸ</span><br><span class="line">                    let key = _path.isLogicalExpression() ? &quot;left&quot; : &quot;test&quot;;</span><br><span class="line">                    let execPath = _path.get(key);</span><br><span class="line">                    if (execPath != path &amp;&amp; !execPath.isAncestor(path)) &#123;</span><br><span class="line">                        console.log(&quot;æ‹¦æˆªåŸå› 3&quot;);</span><br><span class="line">                        canVisitFlag = false;</span><br><span class="line">                        _path.stop();</span><br><span class="line">                    &#125;</span><br><span class="line">                    console.log(&quot;-----------ç»“æŸ&quot; + path);</span><br><span class="line">                    console.log(&quot;***********ç»“æŸ&quot; + _path + &quot;\n&quot;);</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            if (!canVisitFlag) return;</span><br><span class="line">            console.log(&quot;############&quot; + path + &#x27;\n&#x27;);</span><br><span class="line">            // å¦‚æœå¤–å±‚æ˜¯å¾ªç¯è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆé€—å·è¡¨è¾¾å¼å¿…é¡»æ˜¯ init æˆ–è€… init çš„å­èŠ‚ç‚¹</span><br><span class="line">            if (statementPath.isLoop()) &#123;</span><br><span class="line">                let initNode = statementPath.get(&#x27;init&#x27;).node ? &quot;init&quot; : &quot;right&quot;;</span><br><span class="line">                let initPath = statementPath.get(initNode);</span><br><span class="line">                if (initPath.node == undefined || (initPath != path &amp;&amp; !initPath.isAncestor(path))) &#123;</span><br><span class="line">                    return</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            let expressions = path.node.expressions;</span><br><span class="line">            let lastNode = expressions.pop();</span><br><span class="line">            for (let expression of expressions) &#123;</span><br><span class="line">                statementPath.insertBefore(types.expressionStatement(expression = expression));</span><br><span class="line">            &#125;</span><br><span class="line">            path.replaceWith(lastNode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, resolveSequence);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>ç¬¬ 2 ç§ï¼š</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">// å»é™¤é€—å·è¡¨è¾¾å¼1</span><br><span class="line">const resolveSequence1 = &#123;</span><br><span class="line">    SequenceExpression(path) &#123;</span><br><span class="line">        let &#123; parentPath, node, parent &#125; = path;</span><br><span class="line">        if (parentPath.parentPath.isLabeledStatement()) return; // æ ‡ç­¾èŠ‚ç‚¹æ— æ³•å¾€å‰æ’å…¥</span><br><span class="line">        let ancestorPath = parentPath.parentPath;</span><br><span class="line">        let expressions = node.expressions;</span><br><span class="line"></span><br><span class="line">        // æŠŠ (0, fn)(arg1, arg2) çš„é€—å·è¡¨è¾¾å¼ç›´æ¥æ›¿æ¢ä¸ºæœ¬èº« fn(arg1, arg2)</span><br><span class="line">        if (parentPath.isCallExpression(&#123; callee: node &#125;) &amp;&amp; expressions.length == 2 &amp;&amp; types.isNumericLiteral(expressions[0])) &#123;</span><br><span class="line">            path.replaceWith(expressions[1])</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        let statementPath = path.getStatementParent();</span><br><span class="line">        if (!statementPath) return;</span><br><span class="line"></span><br><span class="line">        let paths = [];</span><br><span class="line">        statementPath.traverse(&#123;</span><br><span class="line">            &quot;LogicalExpression|ConditionalExpression&quot;(_path) &#123;</span><br><span class="line">                paths.push(_path);  // æ”¶é›†æ‰€æœ‰ä¸ç¡®å®šä¼šä¸ä¼šæ‰§è¡Œçš„è¡¨è¾¾å¼</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">        // è¿‡æ»¤è¢«åŒ…è£¹åœ¨ é€»è¾‘è¡¨è¾¾å¼ æˆ– æ¡ä»¶è¡¨è¾¾å¼ ä¸­çš„é€—å·è¡¨è¾¾å¼ï¼Œå¤åˆå‹è¡¨è¾¾å¼å¯èƒ½ä¼šå¯¼è‡´ ä½œç”¨åŸŸã€æ‰§è¡Œé¡ºåºã€çŸ­è·¯æ±‚å€¼ ç­‰é—®é¢˜</span><br><span class="line">        let canVisitFlag = true;</span><br><span class="line">        for (let _path of paths) &#123;</span><br><span class="line">            if (_path.isAncestor(path)) &#123;</span><br><span class="line">                canVisitFlag = false;  // è¿‡æ»¤ä¸èƒ½è¿˜åŸçš„æƒ…å†µ</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (parentPath.isReturnStatement(&#123; &quot;argument&quot;: node &#125;) ||</span><br><span class="line">            parentPath.isThrowStatement(&#123; &quot;argument&quot;: node &#125;) ||</span><br><span class="line">            parentPath.isIfStatement(&#123; &#x27;test&#x27;: node &#125;) ||</span><br><span class="line">            parentPath.isForInStatement(&#123; &quot;right&quot;: node &#125;) ||</span><br><span class="line">            parentPath.isForOfStatement(&#123; &quot;right&quot;: node &#125;) ||</span><br><span class="line">            parentPath.isSwitchStatement(&#123; &quot;discriminant&quot;: node &#125;) ||</span><br><span class="line">            (parentPath.isConditionalExpression(&#123; &quot;test&quot;: node &#125;) &amp;&amp; ancestorPath.isExpressionStatement(&#123; &quot;expression&quot;: parent &#125;)) ||</span><br><span class="line">            (parentPath.isUnaryExpression(&#123; &quot;argument&quot;: node &#125;) &amp;&amp; ancestorPath.isExpressionStatement(&#123; &quot;expression&quot;: parent &#125;)) ||</span><br><span class="line">            (parentPath.isAssignmentExpression(&#123; &quot;right&quot;: node &#125;) &amp;&amp; ancestorPath.isExpressionStatement(&#123; &quot;expression&quot;: parent &#125;)) ||</span><br><span class="line">            ((parentPath.isCallExpression(&#123; &quot;callee&quot;: node &#125;) || parentPath.isNewExpression(&#123; &quot;callee&quot;: node &#125;)) &amp;&amp; ancestorPath.isExpressionStatement(&#123; &quot;expression&quot;: parent &#125;)) ||</span><br><span class="line">            (parentPath.isLogicalExpression(&#123; &#x27;left&#x27;: node &#125;) &amp;&amp; ancestorPath.isExpressionStatement(&#123; &quot;expression&quot;: parent &#125;)) ||</span><br><span class="line">            parentPath.isExpressionStatement(&#123; &quot;expression&quot;: node &#125;)) &#123;</span><br><span class="line"></span><br><span class="line">            let lastExpression = expressions.pop(); // å–å‡ºæœ€åä¸€ä¸ªè¡¨è¾¾å¼</span><br><span class="line">            // å°†å‰é¢çš„æ¯ä¸ªè¡¨è¾¾å¼éƒ½æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ä¹‹å‰ï¼Œä½œä¸ºå•ç‹¬çš„ ExpressionStatement</span><br><span class="line">            for (let expression of expressions) &#123;</span><br><span class="line">                parentPath.insertBefore(types.expressionStatement(expression = expression));</span><br><span class="line">            &#125;</span><br><span class="line">            path.replaceInline(lastExpression); // ç”¨æœ€åä¸€ä¸ªè¡¨è¾¾å¼æ›¿æ¢å½“å‰çš„ SequenceExpression</span><br><span class="line">        &#125;</span><br><span class="line">        // å°† for å¾ªç¯çš„initå¤„çš„æ‰€æœ‰é€—å·è¡¨è¾¾å¼éƒ½æå‡ºæ¥</span><br><span class="line">        else if (parentPath.isForStatement(&#123; &#x27;init&#x27;: node &#125;)) &#123;</span><br><span class="line">            node.expressions.forEach(express =&gt; &#123; parentPath.insertBefore(types.expressionStatement(express)); &#125;);</span><br><span class="line">            path.remove();;</span><br><span class="line">        &#125;</span><br><span class="line">        // å˜é‡å®šä¹‰åº”è¯¥æ’å…¥åˆ°å£°æ˜ä¹‹å‰ï¼Œä¸ç„¶ä¼šæœ‰é—®é¢˜</span><br><span class="line">        else if (parentPath.isVariableDeclarator(&#123; &quot;init&quot;: node &#125;) &amp;&amp; ancestorPath.isVariableDeclaration() &amp;&amp; ancestorPath.parentPath.isBlock()) &#123;</span><br><span class="line">            let lastExpression = expressions.pop();</span><br><span class="line"></span><br><span class="line">            for (let expression of expressions) &#123;</span><br><span class="line">                ancestorPath.insertBefore(types.expressionStatement(expression = expression));</span><br><span class="line">            &#125;</span><br><span class="line">            path.replaceInline(lastExpression); // ç”¨æœ€åä¸€ä¸ªè¡¨è¾¾å¼æ›¿æ¢å½“å‰çš„ SequenceExpression</span><br><span class="line">        &#125;</span><br><span class="line">        // é€»è¾‘è¡¨è¾¾å¼ä¸­çš„å¤„ç†ï¼Œä¸ç®¡çˆ¶èŠ‚ç‚¹ç¬¦å·æ˜¯&amp;&amp;è¿˜æ˜¯||ï¼Œå·¦è¾¹éƒ½å¯ä»¥ç›´æ¥è¿˜åŸï¼Œå³è¾¹åˆ™éœ€åˆ¤æ–­</span><br><span class="line">        else if (parentPath.isLogicalExpression(&#123; &#x27;right&#x27;: node &#125;) &amp;&amp; parent.operator == &#x27;&amp;&amp;&#x27; &amp;&amp; canVisitFlag) &#123;</span><br><span class="line">            let ifBody = [];</span><br><span class="line">            let lastExpression = expressions.pop();</span><br><span class="line">            for (let expression of expressions) &#123;</span><br><span class="line">                ifBody.push(types.expressionStatement(expression = expression));</span><br><span class="line">            &#125;</span><br><span class="line">            let ifNode = types.ifStatement(parent.left, types.blockStatement(ifBody), null)</span><br><span class="line"></span><br><span class="line">            path.replaceInline(lastExpression);</span><br><span class="line">            parentPath.insertBefore(ifNode);</span><br><span class="line">        &#125;</span><br><span class="line">        // jsä¸­é€»è¾‘æˆ–è¿ç®—ç¬¦ || ä½¿ç”¨äº†çŸ­è·¯æ±‚å€¼ï¼Œå¦‚æœ || è¿ç®—ç¬¦çš„å·¦æ“ä½œæ•°ä¸º trueï¼Œå³æ“ä½œæ•°å°†ä¸ä¼šè¢«è®¡ç®—æˆ–æ‰§è¡Œ</span><br><span class="line">        else if (parentPath.isLogicalExpression(&#123; &#x27;right&#x27;: node &#125;) &amp;&amp; parent.operator == &#x27;||&#x27; &amp;&amp; canVisitFlag) &#123;</span><br><span class="line">            let ifBody = [];</span><br><span class="line">            let lastExpression = expressions.pop();</span><br><span class="line">            for (let expression of expressions) &#123;</span><br><span class="line">                ifBody.push(types.expressionStatement(expression = expression));</span><br><span class="line">            &#125;</span><br><span class="line">            let ifNode = types.ifStatement(parent.left, types.blockStatement([]), types.blockStatement(ifBody))</span><br><span class="line"></span><br><span class="line">            path.replaceInline(lastExpression);</span><br><span class="line">            parentPath.insertBefore(ifNode);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, resolveSequence1);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="6-æ’ä»¶-å¯¹è±¡-val-å€¼å…¨ä¸ºå¸¸é‡"><a href="#6-æ’ä»¶-å¯¹è±¡-val-å€¼å…¨ä¸ºå¸¸é‡" class="headerlink" title="6. æ’ä»¶ -&gt; å¯¹è±¡ val å€¼å…¨ä¸ºå¸¸é‡"></a>6. æ’ä»¶ -&gt; å¯¹è±¡ val å€¼å…¨ä¸ºå¸¸é‡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">// objectå¯¹è±¡çš„valueå€¼å…¨éƒ¨ä¸ºå­—é¢é‡æ—¶çš„è¿˜åŸ</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isBaseLiteral(node) &#123;</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node) &amp;&amp; node.value != null) return true; // nullå¯èƒ½æœ‰å‘</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; literalList.includes(node.name)) return true;</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; typeof globalThis[node.name] != &quot;undefined&quot;) return true;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; [&quot;+&quot;, &quot;-&quot;, &quot;!&quot;].includes(node.operator)) &#123;</span><br><span class="line">        if (types.isArrayExpression(node.argument) &amp;&amp; node.argument.elements.length == 0) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return isBaseLiteral(node.argument);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const decodeObjectofValue = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; node, scope &#125; = path;</span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (!types.isObjectExpression(init)) return;</span><br><span class="line"></span><br><span class="line">        let properties = init.properties;</span><br><span class="line">        if (properties.length == 0 || !properties.every(property =&gt; isBaseLiteral(property.value))) return;</span><br><span class="line"></span><br><span class="line">        let newMap = new Map();</span><br><span class="line">        for (const property of properties) &#123;</span><br><span class="line">            let &#123; key, value &#125; = property;</span><br><span class="line">            let KeyName = types.isIdentifier(key) ? key.name : key.value;</span><br><span class="line"></span><br><span class="line">            newMap.set(KeyName, value);</span><br><span class="line">        &#125;</span><br><span class="line">        if (newMap.size != properties.length) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(id.name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(id.name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            let flag = false; // ç”¨äºæ ‡å¿—å½“å‰å¯¹è±¡æ˜¯å¦å¯ä»¥åˆ é™¤</span><br><span class="line">            for (const referencePath of referencePaths) &#123;</span><br><span class="line">                let &#123; parentPath &#125; = referencePath;</span><br><span class="line">                if (!parentPath.isMemberExpression()) break;</span><br><span class="line"></span><br><span class="line">                let AncestorPath = parentPath.parentPath;</span><br><span class="line">                if (AncestorPath.isAssignmentExpression(&#123; &quot;left&quot;: parentPath.node &#125;)) &#123;</span><br><span class="line">                    break; // ç‰¹æ®Šå¼•ç”¨ï¼Œå…¶å®æ˜¯èµ‹å€¼ obj[&#x27;c&#x27;] = 789;ï¼Œæœ‰èµ‹å€¼è‚¯å®šç›´æ¥å–æ¶ˆè¿˜åŸ</span><br><span class="line">                &#125;</span><br><span class="line">                if (AncestorPath.isUpdateExpression() &amp;&amp; [&#x27;++&#x27;, &#x27;--&#x27;].includes(AncestorPath.node.operator)) &#123;</span><br><span class="line">                    break; // åŒç†ï¼Œæœ‰è‡ªå¢è‡ªå‡çš„æ“ä½œï¼Œç­‰åŒäºèµ‹å€¼ï¼Œä¹Ÿå–æ¶ˆè¿˜åŸ</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                let &#123; property &#125; = parentPath.node;</span><br><span class="line">                let curKey = types.isIdentifier(property) ? property.name : property.value;</span><br><span class="line">                if (!newMap.has(curKey)) break;</span><br><span class="line"></span><br><span class="line">                flag = true;</span><br><span class="line">                parentPath.replaceWith(newMap.get(curKey))</span><br><span class="line">            &#125;</span><br><span class="line">            if (flag) &#123;</span><br><span class="line">                console.log(&quot;å¯¹è±¡ val å€¼å…¨ä¸ºå¸¸é‡&quot;, &quot;åˆ é™¤ --&gt; å¯¹è±¡å®šä¹‰:&quot;, path + &#x27;&#x27;);</span><br><span class="line">                path.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        newMap.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, decodeObjectofValue);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="7-æ’ä»¶-æ•°ç»„å…ƒç´ å…¨ä¸ºå¸¸é‡"><a href="#7-æ’ä»¶-æ•°ç»„å…ƒç´ å…¨ä¸ºå¸¸é‡" class="headerlink" title="7. æ’ä»¶ -&gt; æ•°ç»„å…ƒç´ å…¨ä¸ºå¸¸é‡"></a>7. æ’ä»¶ -&gt; æ•°ç»„å…ƒç´ å…¨ä¸ºå¸¸é‡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// Array æ•°æ®ç±»å‹è¿˜åŸï¼Œéœ€è¦å…ƒç´ å…¨éƒ¨ä¸º Literal</span><br><span class="line">// var a=[1,&#x27;xfblog&#x27;,window];  res=a[2](a[0]+a[1]);     ===&gt;     res = window(1 + &#x27;xfblog&#x27;);</span><br><span class="line">const replaceArrayElements = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; node, scope &#125; = path;</span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (!types.isArrayExpression(init) || init.elements.length == 0) return;</span><br><span class="line"></span><br><span class="line">        for (let ele of init.elements) &#123;</span><br><span class="line">            if (types.isArrayExpression(ele) || types.isObjectExpression(ele)) &#123;</span><br><span class="line">                return;  // ä¸å¤„ç†æ•°ç»„ä¸­æœ‰åµŒå¥—æ•°ç»„æˆ–å¯¹è±¡çš„æƒ…å†µ</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        const binding = scope.getBinding(id.name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            let flag = false;</span><br><span class="line">            for (let referPath of referencePaths) &#123;</span><br><span class="line">                let &#123; node, parent, parentPath &#125; = referPath;</span><br><span class="line">                if (!parentPath.isMemberExpression(&#123; object: node &#125;) || !types.isNumericLiteral(parent.property)) break;</span><br><span class="line"></span><br><span class="line">                if (parentPath.parentPath.isAssignmentExpression(&#123; &quot;left&quot;: parent &#125;)) break; // arr[1] = arr[0] + arr[2];</span><br><span class="line">                if (parentPath.parentPath.isUpdateExpression(&#123; &quot;argument&quot;: parent &#125;)) break; // ++arr[1];</span><br><span class="line"></span><br><span class="line">                flag = true;</span><br><span class="line">                let index = parent.property.value;</span><br><span class="line">                parentPath.replaceWith(init.elements[index]);</span><br><span class="line">            &#125;</span><br><span class="line">            if (flag) &#123;</span><br><span class="line">                console.log(&quot;æ•°ç»„å…ƒç´ å…¨ä¸ºå¸¸é‡&quot;, &quot;åˆ é™¤ --&gt; æ•°ç»„å®šä¹‰:&quot;, path + &#x27;&#x27;);</span><br><span class="line">                path.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, replaceArrayElements);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="8-æ’ä»¶-åƒåœ¾ä»£ç åˆ é™¤"><a href="#8-æ’ä»¶-åƒåœ¾ä»£ç åˆ é™¤" class="headerlink" title="8. æ’ä»¶ -&gt; åƒåœ¾ä»£ç åˆ é™¤"></a>8. æ’ä»¶ -&gt; åƒåœ¾ä»£ç åˆ é™¤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">// æœ€åä½¿ç”¨ï¼šåƒåœ¾ä»£ç åˆ é™¤</span><br><span class="line">function containsSequenceExpression(path) &#123;</span><br><span class="line">    let containsSequence = false;</span><br><span class="line">    // æ·±åº¦ä¼˜å…ˆéå†å½“å‰è·¯å¾„åŠå…¶æ‰€æœ‰å­è·¯å¾„</span><br><span class="line">    path.traverse(&#123;</span><br><span class="line">        &quot;SequenceExpression|AssignmentExpression&quot;(_path) &#123;</span><br><span class="line">            containsSequence = true;</span><br><span class="line">            _path.stop(); // æ‰¾åˆ°é€—å·è¡¨è¾¾å¼åç«‹å³åœæ­¢éå†</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    return containsSequence;</span><br><span class="line">&#125;</span><br><span class="line">const removeDeadCode = &#123;</span><br><span class="line">    &quot;IfStatement|ConditionalExpression&quot;(path) &#123;</span><br><span class="line">        let &#123; node &#125; = path;</span><br><span class="line">        let &#123; consequent, alternate &#125; = node;</span><br><span class="line">        let testPath = path.get(&#x27;test&#x27;);</span><br><span class="line"></span><br><span class="line">        //ä¸å¤„ç†é€—å·è¡¨è¾¾å¼ï¼Œèµ‹å€¼è¯­å¥é˜²æ­¢è¯¯åˆ </span><br><span class="line">        if (testPath.isSequenceExpression() || testPath.isAssignmentExpression() || containsSequenceExpression(testPath)) return;</span><br><span class="line"></span><br><span class="line">        const evaluateTest = testPath.evaluateTruthy();</span><br><span class="line">        if (evaluateTest === true) &#123;</span><br><span class="line">            if (types.isBlockStatement(consequent)) &#123;</span><br><span class="line">                consequent = consequent.body;</span><br><span class="line">            &#125;</span><br><span class="line">            path.replaceWithMultiple(consequent);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (evaluateTest === false) &#123;</span><br><span class="line">            if (alternate != null) &#123;</span><br><span class="line">                if (types.isBlockStatement(alternate)) &#123;</span><br><span class="line">                    alternate = alternate.body;</span><br><span class="line">                &#125;</span><br><span class="line">                path.replaceWithMultiple(alternate);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                path.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;LogicalExpression&quot;(path) &#123;</span><br><span class="line">        let &#123; node &#125; = path;</span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        let leftPath = path.get(&#x27;left&#x27;);</span><br><span class="line"></span><br><span class="line">        //ä¸å¤„ç†é€—å·è¡¨è¾¾å¼ï¼Œèµ‹å€¼è¯­å¥é˜²æ­¢è¯¯åˆ </span><br><span class="line">        if (leftPath.isSequenceExpression() || leftPath.isAssignmentExpression() || containsSequenceExpression(leftPath)) return;</span><br><span class="line"></span><br><span class="line">        const evaluateLeft = leftPath.evaluateTruthy();</span><br><span class="line">        if ((operator == &quot;||&quot; &amp;&amp; evaluateLeft == true) || (operator == &quot;&amp;&amp;&quot; &amp;&amp; evaluateLeft == false)) &#123;</span><br><span class="line">            path.replaceWith(left);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if ((operator == &quot;||&quot; &amp;&amp; evaluateLeft == false) || (operator == &quot;&amp;&amp;&quot; &amp;&amp; evaluateLeft == true)) &#123;</span><br><span class="line">            path.replaceWith(right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;EmptyStatement|DebuggerStatement&quot;(path) &#123;</span><br><span class="line">        path.remove();</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;VariableDeclarator&quot;(path) &#123;</span><br><span class="line">        let &#123; node, scope, parentPath, parent &#125; = path;</span><br><span class="line">        let ancestryPath = parentPath.parentPath;</span><br><span class="line"></span><br><span class="line">        // forå¾ªç¯ä¸­çš„å˜é‡å®šä¹‰ä¸èƒ½åˆ é™¤</span><br><span class="line">        if (ancestryPath.isForOfStatement(&#123; left: parent &#125;) || ancestryPath.isForInStatement(&#123; left: parent &#125;)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        //ç›®å‰åªå‘ç°èµ‹å€¼è¯­å¥å’Œè°ƒç”¨è¯­å¥ä¼šæœ‰é—®é¢˜ã€‚åç»­å¾…æ·»åŠ </span><br><span class="line">        if (!types.isIdentifier(id) || types.isCallExpression(init) || types.isAssignmentExpression(init)) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(id.name); // é‡æ–°è§£æaståï¼Œä¸€å®šä¼šæœ‰binding</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations &#125; = binding;</span><br><span class="line">        // console.log(id.name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; å˜é‡å®šä¹‰:&quot;, path.parentPath + &#x27;&#x27;);</span><br><span class="line">            path.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;AssignmentExpression&quot;(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27;) return;</span><br><span class="line"></span><br><span class="line">        let name = left.name;</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line"></span><br><span class="line">        let &#123; referenced, constant, constantViolations &#125; = binding;</span><br><span class="line">        // console.log(path + &#x27;&#x27;, referenced, constant, constantViolations.length);</span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; èµ‹å€¼è¯­å¥:&quot;, path + &#x27;&#x27;);</span><br><span class="line">            path.remove();</span><br><span class="line">            if (binding.path.parentPath.isFunctionExpression() || binding.path.parentPath.isFunctionDeclaration()) &#123;</span><br><span class="line">                binding.path.remove(); // åˆ é™¤çš„å‡½æ•°å½¢å‚</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ContinueStatement|BreakStatement|ReturnStatement|ThrowStatement&quot;(path) &#123;</span><br><span class="line">    		if (!path.parentPath.isSwitchCase()) return; // åªå¤„ç†åœ¨ switch-case è¯­å¥ä¸­çš„</span><br><span class="line">        let AllNextSiblings = path.getAllNextSiblings(); // è·å–æ‰€æœ‰çš„åç»­å…„å¼ŸèŠ‚ç‚¹</span><br><span class="line">        for (let nextSibling of AllNextSiblings) &#123;</span><br><span class="line">            if (nextSibling.isFunctionDeclaration() || nextSibling.isVariableDeclaration(&#123; kind: &quot;var&quot; &#125;)) &#123; //å˜é‡æå‡.....</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            nextSibling.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;FunctionDeclaration&quot;(path) &#123;</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; id, params &#125; = node;</span><br><span class="line">        if (!params) return;</span><br><span class="line">        let flag = true;</span><br><span class="line"></span><br><span class="line">        let binding = parentPath.scope.getBinding(id.name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations &#125; = binding;</span><br><span class="line">        // console.log(id.name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; å‡½æ•°å®šä¹‰:&quot;, path + &#x27;&#x27;);</span><br><span class="line">            path.remove();</span><br><span class="line">            flag = false;</span><br><span class="line">        &#125;</span><br><span class="line">        if (flag) &#123;</span><br><span class="line">            for (let i of params) &#123;</span><br><span class="line">                if (!types.isIdentifier(i)) continue;</span><br><span class="line">                let binding = scope.getBinding(i.name);</span><br><span class="line">                if (!binding) continue;</span><br><span class="line"></span><br><span class="line">                let &#123; references, constantViolations &#125; = binding;</span><br><span class="line">                if (references === 0 &amp;&amp; constantViolations.length === 0) &#123;</span><br><span class="line">                    // å°†æœªä½¿ç”¨çš„å‚æ•°æ ‡è®°ä¸ºåˆ é™¤</span><br><span class="line">                    console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; å‡½æ•°å½¢å‚:&quot;, i.name);</span><br><span class="line">                    params = params.filter(param =&gt; param !== i);</span><br><span class="line">                    console.log(params);</span><br><span class="line">                &#125;</span><br><span class="line">                path.node.params = params;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">for (let i = 0; i &lt; 3; i++) &#123;</span><br><span class="line">    traverse(ast, removeDeadCode); // åˆ é™¤ä¸å¤Ÿå½»åº•åˆ™å†è°ƒç”¨ä¸€æ¬¡ï¼Œä»¥æ­¤ç±»æ¨</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å››ã€å˜é‡ç›¸å…³æ’ä»¶"><a href="#å››ã€å˜é‡ç›¸å…³æ’ä»¶" class="headerlink" title="å››ã€å˜é‡ç›¸å…³æ’ä»¶"></a>å››ã€å˜é‡ç›¸å…³æ’ä»¶</h2><h3 id="1-æ’ä»¶-åˆ†ç¦»å¤šä¸ªå˜é‡åŒå®šä¹‰"><a href="#1-æ’ä»¶-åˆ†ç¦»å¤šä¸ªå˜é‡åŒå®šä¹‰" class="headerlink" title="1. æ’ä»¶ -&gt; åˆ†ç¦»å¤šä¸ªå˜é‡åŒå®šä¹‰"></a>1. æ’ä»¶ -&gt; åˆ†ç¦»å¤šä¸ªå˜é‡åŒå®šä¹‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// åˆ†ç¦»å¤šä¸ªå˜é‡åŒå®šä¹‰</span><br><span class="line">// var a, b, c;     ===&gt;     var a; var b; var c;</span><br><span class="line">const DeclaratorToDeclaration = &#123;</span><br><span class="line">    VariableDeclaration(path) &#123;</span><br><span class="line">        let &#123; parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isBlock()) return; // é¿å…å¤„ç†é‚£äº›åœ¨éå—çº§èŠ‚ç‚¹å†…çš„å˜é‡å£°æ˜`if (true) let a, b;`</span><br><span class="line"></span><br><span class="line">        let &#123; declarations, kind &#125; = node;</span><br><span class="line">        if (declarations.length == 1) return;</span><br><span class="line"></span><br><span class="line">        let newNodes = [];</span><br><span class="line">        for (let varNode of declarations) &#123;</span><br><span class="line">            let newDeclarationNode = types.variableDeclaration(kind, [varNode]);</span><br><span class="line">            newNodes.push(newDeclarationNode);</span><br><span class="line">        &#125;</span><br><span class="line">        path.replaceWithMultiple(newNodes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, DeclaratorToDeclaration);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="2-æ’ä»¶-åˆå¹¶å˜é‡å£°æ˜ä¸å®šä¹‰"><a href="#2-æ’ä»¶-åˆå¹¶å˜é‡å£°æ˜ä¸å®šä¹‰" class="headerlink" title="2. æ’ä»¶ -&gt; åˆå¹¶å˜é‡å£°æ˜ä¸å®šä¹‰"></a>2. æ’ä»¶ -&gt; åˆå¹¶å˜é‡å£°æ˜ä¸å®šä¹‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">// åˆå¹¶å˜é‡å£°æ˜ä¸å®šä¹‰</span><br><span class="line">// var a, b, c; a = 1; b = 2; c = 3;    ===&gt;    var a = 1, b = 2, c = 3;</span><br><span class="line">// èŠ‚ç‚¹å­é¢é‡åˆ¤æ–­</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    const literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (Array.isArray(node)) return node.every(isNodeLiteral);</span><br><span class="line">    if (types.isThisExpression(node)) return true;</span><br><span class="line">    if (types.isLiteral(node)) return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node)) &#123;</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27; || node.operator === &#x27;!&#x27;)) &#123;</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node)) &#123;</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node)) &#123;</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (types.isIdentifier(node)) &#123;</span><br><span class="line">        if (literalList.includes(node.name) || typeof globalThis[node.name] !== &#x27;undefined&#x27;) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const combinDefineAndNextAssgin = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; scope, node &#125; = path;</span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (init != null) return;</span><br><span class="line"></span><br><span class="line">        let name = id.name;</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (constantViolations.length != 1) return;</span><br><span class="line">        if (!constantViolations[0].isAssignmentExpression()) return;</span><br><span class="line">        if (constantViolations[0].parentPath.isConditionalExpression() || constantViolations[0].parentPath.isLogicalExpression()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = constantViolations[0].node</span><br><span class="line">        if (!types.isIdentifier(left, &#123; name: name &#125;) || operator != &#x27;=&#x27; || !isNodeLiteral(right)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        path.set(&quot;init&quot;, right);</span><br><span class="line">        constantViolations[0].remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, combinDefineAndNextAssgin);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="3-æ’ä»¶-å˜é‡å®šä¹‰å‡½æ•°è½¬è‡ªå®š"><a href="#3-æ’ä»¶-å˜é‡å®šä¹‰å‡½æ•°è½¬è‡ªå®š" class="headerlink" title="3. æ’ä»¶ -&gt; å˜é‡å®šä¹‰å‡½æ•°è½¬è‡ªå®š"></a>3. æ’ä»¶ -&gt; å˜é‡å®šä¹‰å‡½æ•°è½¬è‡ªå®š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// ç”±å˜é‡å®šä¹‰çš„å‡½æ•°è¡¨è¾¾å¼ï¼Œç»Ÿä¸€è¿˜åŸä¸ºå‡½æ•°å®šä¹‰</span><br><span class="line">// var a =function()&#123;&#125;     ===&gt;     function a()&#123;&#125;</span><br><span class="line">const varDeclarToFuncDeclar = &#123;</span><br><span class="line">    VariableDeclaration(path) &#123;</span><br><span class="line">        let &#123; parentPath, node, scope &#125; = path;</span><br><span class="line">        if (!parentPath.isBlock()) return; // è¿‡æ»¤æ‰éƒ¨åˆ†ç‰¹æ®Šæƒ…å†µï¼Œä¾‹å¦‚forå¾ªç¯é‡Œçš„å˜é‡å®šä¹‰</span><br><span class="line"></span><br><span class="line">        let &#123; declarations, kind &#125; = node;</span><br><span class="line">        if (declarations.length != 1) return;</span><br><span class="line"></span><br><span class="line">        let &#123; id, init &#125; = declarations[0];</span><br><span class="line">        if (!types.isFunctionExpression(init, &#123; id: null &#125;)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; params, body &#125; = init;</span><br><span class="line">        let newNode = types.functionDeclaration(id, params, body);</span><br><span class="line">        path.replaceWith(newNode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, varDeclarToFuncDeclar);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="4-æ’ä»¶-å®šä¹‰å­—é¢é‡æœªæ”¹è¿˜åŸ"><a href="#4-æ’ä»¶-å®šä¹‰å­—é¢é‡æœªæ”¹è¿˜åŸ" class="headerlink" title="4. æ’ä»¶ -&gt; å®šä¹‰å­—é¢é‡æœªæ”¹è¿˜åŸ"></a>4. æ’ä»¶ -&gt; å®šä¹‰å­—é¢é‡æœªæ”¹è¿˜åŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// å˜é‡åˆå§‹åŒ–ä¸ºå­—é¢é‡ï¼Œä¸”æ²¡æœ‰ä¿®æ”¹çš„è¿˜åŸ</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­å‡½æ•°ï¼ˆåªèƒ½ç”¨è¿™ä¸ªï¼Œå› ä¸ºä¸èƒ½è¿˜åŸå®¹å™¨ï¼‰</span><br><span class="line">function isBaseLiteral(node) &#123;</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node) &amp;&amp; node.value != null) return true; // nullå¯èƒ½æœ‰å‘</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; literalList.includes(node.name)) return true;</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; typeof globalThis[node.name] != &quot;undefined&quot;) return true;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; [&quot;+&quot;, &quot;-&quot;, &quot;!&quot;].includes(node.operator)) &#123;</span><br><span class="line">        if (types.isArrayExpression(node.argument) &amp;&amp; node.argument.elements.length == 0) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return isBaseLiteral(node.argument);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const rebackVarDeclarator = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (parentPath.parentPath.isForStatement() || parentPath.find((p) =&gt; p.isSwitchCase())) return;</span><br><span class="line">        if (!types.isIdentifier(id) || init == null || !isBaseLiteral(init)) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(id.name);</span><br><span class="line">        if (!binding) return; // æ¦‚ç‡è¸©å‘æŠ¥é”™</span><br><span class="line">        let &#123; constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123; // å˜é‡å®šä¹‰åœ¨ for å¾ªç¯ä¸­æ˜¯ä¸€æ¬¡æ”¹å˜</span><br><span class="line">            for (let referencePath of referencePaths) &#123;</span><br><span class="line">                referencePath.replaceWith(init);</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&quot;å®šä¹‰å­—é¢é‡æœªæ”¹è¿˜åŸ&quot;, &quot;åˆ é™¤ --&gt; å˜é‡å®šä¹‰:&quot;, path.parentPath + &#x27;&#x27;);</span><br><span class="line">            path.remove(); // é¡ºä¾¿è¿˜æŠŠåˆå§‹åŒ–ä¸ºå¸¸é‡ï¼Œä½†æ²¡æœ‰ä½¿ç”¨è¿‡çš„å˜é‡å®šä¹‰ä¹Ÿåˆ äº†</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, rebackVarDeclarator);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="5-æ’ä»¶-èµ‹å€¼å­—é¢é‡æœªæ”¹è¿˜åŸ"><a href="#5-æ’ä»¶-èµ‹å€¼å­—é¢é‡æœªæ”¹è¿˜åŸ" class="headerlink" title="5. æ’ä»¶ -&gt; èµ‹å€¼å­—é¢é‡æœªæ”¹è¿˜åŸ"></a>5. æ’ä»¶ -&gt; èµ‹å€¼å­—é¢é‡æœªæ”¹è¿˜åŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// åœ¨å‡½æ•°ä¸­å½¢å‚å˜é‡èµ‹å€¼ä¸ºå­—é¢é‡ï¼Œä¸”æ²¡æœ‰ä¿®æ”¹çš„è¿˜åŸ</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­å‡½æ•°ï¼ˆåªèƒ½ç”¨è¿™ä¸ªï¼Œå› ä¸ºä¸èƒ½è¿˜åŸå®¹å™¨ï¼‰</span><br><span class="line">function isBaseLiteral(node) &#123;</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node) &amp;&amp; node.value != null) return true; // nullå¯èƒ½æœ‰å‘</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; literalList.includes(node.name)) return true;</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; typeof globalThis[node.name] != &quot;undefined&quot;) return true;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; [&quot;+&quot;, &quot;-&quot;, &quot;!&quot;].includes(node.operator)) &#123;</span><br><span class="line">        if (types.isArrayExpression(node.argument) &amp;&amp; node.argument.elements.length == 0) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return isBaseLiteral(node.argument);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const restoreAssignment = &#123;</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        if (!parentPath.isExpressionStatement()) return; // å¿…é¡»åªå¤„ç†å•ç‹¬çš„è¯­å¥ï¼Œä¸èƒ½æ˜¯åµŒå¥—åœ¨å…¶ä»–è¯­å¥é‡Œçš„èµ‹å€¼è¯­å¥ï¼Œæ¶‰åŠåˆ é™¤</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27; || !isBaseLiteral(right)) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(left.name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // å¦‚æœç»‘å®šä¸æ˜¯å½¢å‚è€Œæ˜¯å˜é‡å®šä¹‰ï¼Œé‚£ä¹ˆå°±å­˜åœ¨ä¸€ç§æƒ…å†µï¼Œæ”¹å˜åªæœ‰ä¸€æ¬¡ï¼Œä½†æ˜¯èµ‹äº†ä¸¤æ¬¡å€¼ï¼Œæ‰€ä»¥è¦ç¡®ä¿å˜é‡å®šä¹‰æ— èµ‹å€¼</span><br><span class="line">        if (constantViolations.length != 1 || !binding.path.isVariableDeclarator(&#123; init: null &#125;)) return;</span><br><span class="line"></span><br><span class="line">        for (let referencePath of referencePaths) &#123;</span><br><span class="line">            referencePath.replaceWith(right);</span><br><span class="line">        &#125;</span><br><span class="line">        console.log(&quot;èµ‹å€¼å­—é¢é‡æœªæ”¹è¿˜åŸ&quot;, &quot;åˆ é™¤ --&gt; å˜é‡èµ‹å€¼ä¸å®šä¹‰:&quot;, path + &#x27;&#x27;, binding.path + &#x27;&#x27;);</span><br><span class="line">        path.remove(); // é¡ºä¾¿è¿˜æŠŠå½¢å‚ä¸ºå¸¸é‡ï¼Œä½†æ²¡æœ‰ä½¿ç”¨è¿‡çš„å½¢å‚èµ‹å€¼ä¹Ÿåˆ äº†</span><br><span class="line">        binding.path.remove(); // åˆ é™¤å‡½æ•°å½¢å‚</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, restoreAssignment);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h2 id="äº”ã€å‡½æ•°ç›¸å…³æ’ä»¶"><a href="#äº”ã€å‡½æ•°ç›¸å…³æ’ä»¶" class="headerlink" title="äº”ã€å‡½æ•°ç›¸å…³æ’ä»¶"></a>äº”ã€å‡½æ•°ç›¸å…³æ’ä»¶</h2><h3 id="1-æ’ä»¶-å†…ç½®å‡½æ•°è°ƒç”¨è¿˜åŸ"><a href="#1-æ’ä»¶-å†…ç½®å‡½æ•°è°ƒç”¨è¿˜åŸ" class="headerlink" title="1. æ’ä»¶ -&gt; å†…ç½®å‡½æ•°è°ƒç”¨è¿˜åŸ"></a>1. æ’ä»¶ -&gt; å†…ç½®å‡½æ•°è°ƒç”¨è¿˜åŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// ä¸‡èƒ½è°ƒç”¨è¡¨è¾¾å¼æ›¿æ¢è®¡ç®—å€¼æ’ä»¶</span><br><span class="line">// var a = &quot;motnahp&quot;[&quot;split&quot;](&#x27;&#x27;)[&quot;reverse&quot;]()[&quot;join&quot;](&#x27;&#x27;);    ===&gt;    var a = &quot;phantom&quot;;</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const callToStringLiteral = &#123;</span><br><span class="line">    CallExpression: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; arguments &#125; = path.node;</span><br><span class="line">            if (!isNodeLiteral(arguments)) return;</span><br><span class="line">            try &#123;</span><br><span class="line">                let arr = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;, &#x27;random&#x27;, &#x27;Date&#x27;];</span><br><span class="line">                let flag = arr.every(ele =&gt; !path.toString().includes(ele));</span><br><span class="line">                if (!flag) return;</span><br><span class="line"></span><br><span class="line">                let value = eval(path.toString());</span><br><span class="line">                // if (typeof value != &quot;string&quot;) return; // æœ‰æ—¶ä¹Ÿéœ€è¦è¿˜åŸä¸ºæ•°å­—</span><br><span class="line">                console.log(path.toString(), &quot;--&gt;&quot;, value);</span><br><span class="line">                path.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125; catch (e) &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, callToStringLiteral);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="2-æ’ä»¶-å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ"><a href="#2-æ’ä»¶-å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ" class="headerlink" title="2. æ’ä»¶ -&gt; å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ"></a>2. æ’ä»¶ -&gt; å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ</span><br><span class="line">const untruthFuncContent = &#123;</span><br><span class="line">    FunctionDeclaration(path) &#123;</span><br><span class="line">        let &#123; id, params, body &#125; = path.node;</span><br><span class="line">        if (params.length != 0 || body.body.length != 1 || !types.isExpressionStatement(body.body[0])) return;</span><br><span class="line"></span><br><span class="line">        let binding = path.scope.getBinding(id.name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        if (constantViolations.length &gt; 1 || !constant || referencePaths.length != 1) return;</span><br><span class="line">        let referPath = referencePaths[0]</span><br><span class="line">        let &#123; node, parentPath &#125; = referPath;</span><br><span class="line">        if (!parentPath.isCallExpression(&#123; callee: node &#125;)) return;</span><br><span class="line">        if (!parentPath.parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        console.log(&quot;å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ:&quot;, path + &#x27;&#x27;);</span><br><span class="line">        parentPath.parentPath.replaceWith(body.body[0]);</span><br><span class="line">        path.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, untruthFuncContent);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="3-æ’ä»¶-ob-å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ"><a href="#3-æ’ä»¶-ob-å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ" class="headerlink" title="3. æ’ä»¶ -&gt; ob å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ"></a>3. æ’ä»¶ -&gt; ob å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">// ob å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ</span><br><span class="line">const reStoreUnaryExpressionOfReturn = &#123;</span><br><span class="line">    FunctionDeclaration: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; scope, node &#125; = path;</span><br><span class="line">            let &#123; id, params, body &#125; = node;</span><br><span class="line">            if (params.length != 1 || body.body.length != 1 || !types.isReturnStatement(body.body[0]) ||</span><br><span class="line">                !types.isUnaryExpression(body.body[0].argument)) return;</span><br><span class="line"></span><br><span class="line">            let &#123; operator, argument &#125; = body.body[0].argument;</span><br><span class="line">            if (!types.isIdentifier(argument)) return;</span><br><span class="line"></span><br><span class="line">            let binding = scope.getBinding(id.name);</span><br><span class="line">            if (!binding || !binding.constant) return;</span><br><span class="line"></span><br><span class="line">            let canRemoved = true;</span><br><span class="line">            for (let referPath of binding.referencePaths.reverse()) &#123;</span><br><span class="line">                let &#123; parentPath, node &#125; = referPath;</span><br><span class="line"></span><br><span class="line">                if (!parentPath.isCallExpression(&#123; &quot;callee&quot;: node &#125;)) &#123;</span><br><span class="line">                    canRemoved = false;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                let &#123; arguments &#125; = parentPath.node;</span><br><span class="line">                if (arguments.length != 1) &#123;</span><br><span class="line">                    canRemoved = false;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                console.log(parentPath.toString());</span><br><span class="line">                parentPath.replaceWith(types.UnaryExpression(operator, arguments[0], prefix = true));</span><br><span class="line">            &#125;</span><br><span class="line">            canRemoved &amp;&amp; path.remove();</span><br><span class="line">            path.stop()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const reStoreBinaryExpressionOfReturn = &#123;</span><br><span class="line">    FunctionDeclaration(path) &#123;</span><br><span class="line">        let &#123; scope, node &#125; = path;</span><br><span class="line">        let &#123; id, params, body &#125; = node;</span><br><span class="line">        if (params.length != 2 || body.body.length != 1 || !types.isReturnStatement(body.body[0]) ||</span><br><span class="line">            !types.isBinaryExpression(body.body[0].argument)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; operator, left, right &#125; = body.body[0].argument;</span><br><span class="line">        if (!types.isIdentifier(left) || !types.isIdentifier(right)) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(id.name);</span><br><span class="line">        if (!binding || !binding.constant) return;</span><br><span class="line"></span><br><span class="line">        let canRemoved = true;</span><br><span class="line">        for (let referPath of binding.referencePaths.reverse()) &#123;</span><br><span class="line">            let &#123; parentPath, node &#125; = referPath;</span><br><span class="line"></span><br><span class="line">            if (!parentPath.isCallExpression(&#123; &quot;callee&quot;: node &#125;)) &#123;</span><br><span class="line">                canRemoved = false;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            let &#123; arguments &#125; = parentPath.node;</span><br><span class="line">            if (arguments.length != 2) &#123;</span><br><span class="line">                canRemoved = false;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(parentPath.toString());</span><br><span class="line">            // console.log(&#x27;------&#x27;, parentPath.parentPath.parentPath.toString());</span><br><span class="line">            parentPath.replaceWith(types.BinaryExpression(operator, arguments[0], arguments[1]));</span><br><span class="line">        &#125;</span><br><span class="line">        canRemoved &amp;&amp; path.remove();</span><br><span class="line">        path.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const reStoreArrayExpressionOfReturn = &#123;</span><br><span class="line">    FunctionDeclaration(path) &#123;</span><br><span class="line">        let &#123; scope, node &#125; = path;</span><br><span class="line">        let &#123; id, params, body &#125; = node;</span><br><span class="line">        if (params.length != 0 || body.body.length != 1 || !types.isReturnStatement(body.body[0]) ||</span><br><span class="line">            !types.isArrayExpression(body.body[0].argument)) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(id.name);</span><br><span class="line">        if (!binding || !binding.constant) return;</span><br><span class="line"></span><br><span class="line">        let canRemoved = true;</span><br><span class="line">        for (let referPath of binding.referencePaths.reverse()) &#123;</span><br><span class="line">            let &#123; parentPath, node &#125; = referPath;</span><br><span class="line"></span><br><span class="line">            if (!parentPath.isCallExpression(&#123; &quot;callee&quot;: node &#125;)) &#123;</span><br><span class="line">                canRemoved = false;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            let &#123; arguments &#125; = parentPath.node;</span><br><span class="line">            if (arguments.length != 0) &#123;</span><br><span class="line">                canRemoved = false;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(parentPath.toString());</span><br><span class="line">            // console.log(&#x27;------&#x27;, parentPath.parentPath.parentPath.toString());</span><br><span class="line">            parentPath.replaceWith(body.body[0].argument);</span><br><span class="line">        &#125;</span><br><span class="line">        canRemoved &amp;&amp; path.remove();</span><br><span class="line">        path.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for (let i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">    traverse(ast, reStoreUnaryExpressionOfReturn);</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">    traverse(ast, reStoreBinaryExpressionOfReturn);</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">    traverse(ast, reStoreArrayExpressionOfReturn);</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å…­ã€æ¡ä»¶ä¸é€»è¾‘è¡¨è¾¾å¼ç›¸å…³æ’ä»¶"><a href="#å…­ã€æ¡ä»¶ä¸é€»è¾‘è¡¨è¾¾å¼ç›¸å…³æ’ä»¶" class="headerlink" title="å…­ã€æ¡ä»¶ä¸é€»è¾‘è¡¨è¾¾å¼ç›¸å…³æ’ä»¶"></a>å…­ã€æ¡ä»¶ä¸é€»è¾‘è¡¨è¾¾å¼ç›¸å…³æ’ä»¶</h2><h3 id="1-åµŒå¥—åœ¨è¯­å¥ä¸­çš„ä¼˜åŒ–"><a href="#1-åµŒå¥—åœ¨è¯­å¥ä¸­çš„ä¼˜åŒ–" class="headerlink" title="1. åµŒå¥—åœ¨è¯­å¥ä¸­çš„ä¼˜åŒ–"></a>1. åµŒå¥—åœ¨è¯­å¥ä¸­çš„ä¼˜åŒ–</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// å½“æ¡ä»¶è¡¨è¾¾å¼çš„çˆ¶èŠ‚ç‚¹æ˜¯èµ‹å€¼è¯­å¥æˆ–è€…returnè¯­å¥æ—¶çš„ä¼˜åŒ–</span><br><span class="line">// a = b ? c : d;   ===&gt;    b ? a = c : a = d;</span><br><span class="line">let retNODE = template(`if(A)&#123;return B;&#125;else&#123;return C;&#125;`);</span><br><span class="line">const TransConditionExpression = &#123;</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; scope, node &#125; = path;</span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        if (!types.isConditionalExpression(right)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; test, consequent, alternate &#125; = right;</span><br><span class="line">        consequent = types.AssignmentExpression(operator, left, consequent);</span><br><span class="line">        alternate = types.AssignmentExpression(operator, left, alternate);</span><br><span class="line"></span><br><span class="line">        path.replaceWith(types.ConditionalExpression(test, consequent, alternate));</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;,</span><br><span class="line">    ReturnStatement(path) &#123;</span><br><span class="line">        let &#123; scope, node &#125; = path;</span><br><span class="line">        let &#123; argument &#125; = node;</span><br><span class="line">        if (!types.isConditionalExpression(argument)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; test, consequent, alternate &#125; = argument;</span><br><span class="line">        let retNode = retNODE(&#123; &quot;A&quot;: test, &quot;B&quot;: consequent, &quot;C&quot;: alternate &#125;)</span><br><span class="line">        path.replaceWith(retNode);</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, TransConditionExpression);</span><br></pre></td></tr></table></figure>

<h3 id="2-æ¡ä»¶è¡¨è¾¾å¼è½¬-if-è¯­å¥"><a href="#2-æ¡ä»¶è¡¨è¾¾å¼è½¬-if-è¯­å¥" class="headerlink" title="2. æ¡ä»¶è¡¨è¾¾å¼è½¬ if è¯­å¥"></a>2. æ¡ä»¶è¡¨è¾¾å¼è½¬ if è¯­å¥</h3><ul>
<li>æ–°ç‰ˆï¼š</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">// æ¡ä»¶è¡¨è¾¾å¼è½¬ if è¯­å¥</span><br><span class="line">const ConditionToIf = &#123;</span><br><span class="line">    ConditionalExpression: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; test, consequent, alternate &#125; = path.node;</span><br><span class="line">            if (types.isSequenceExpression(consequent)) &#123;</span><br><span class="line">                let expressions = consequent.expressions;</span><br><span class="line">                let retBody = [];</span><br><span class="line">                for (let expression of expressions) &#123;</span><br><span class="line">                    retBody.push(types.expressionStatement(expression));</span><br><span class="line">                &#125;</span><br><span class="line">                consequent = types.blockStatement(retBody);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                consequent = types.expressionStatement(consequent);</span><br><span class="line">                consequent = types.blockStatement([consequent]);</span><br><span class="line">            &#125;</span><br><span class="line">            if (types.isSequenceExpression(alternate)) &#123;</span><br><span class="line"></span><br><span class="line">                let expressions = alternate.expressions;</span><br><span class="line">                let retBody = [];</span><br><span class="line">                for (let expression of expressions) &#123;</span><br><span class="line">                    retBody.push(types.expressionStatement(expression));</span><br><span class="line">                &#125;</span><br><span class="line">                alternate = types.blockStatement(retBody);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                alternate = types.expressionStatement(alternate);</span><br><span class="line">                alternate = types.blockStatement([alternate]);</span><br><span class="line">            &#125;</span><br><span class="line">            let ifStateNode = types.ifStatement(test, consequent, alternate);</span><br><span class="line">            path.replaceWithMultiple(ifStateNode);</span><br><span class="line">            path.skip();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; left, operator, right &#125; = path.node;</span><br><span class="line">        if (!types.isConditionalExpression(right)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; test, consequent, alternate &#125; = right;</span><br><span class="line">        consequent = types.blockStatement([types.expressionStatement(types.assignmentExpression(operator, left, consequent))]);</span><br><span class="line">        alternate = types.blockStatement([types.expressionStatement(types.assignmentExpression(operator, left, alternate))]);</span><br><span class="line"></span><br><span class="line">        path.replaceWithMultiple(types.ifStatement(test, consequent, alternate));</span><br><span class="line">    &#125;,</span><br><span class="line">    ReturnStatement(path) &#123;</span><br><span class="line">        let &#123; argument &#125; = path.node;</span><br><span class="line">        if (!types.isConditionalExpression(argument)) return;</span><br><span class="line"></span><br><span class="line">        let retNODE = template(`if(A)&#123;return B;&#125;else&#123;return C;&#125;`);</span><br><span class="line">        let &#123; test, consequent, alternate &#125; = argument;</span><br><span class="line">        let retNode = retNODE(&#123; &quot;A&quot;: test, &quot;B&quot;: consequent, &quot;C&quot;: alternate, &#125;);</span><br><span class="line"></span><br><span class="line">        path.replaceWith(retNode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, ConditionToIf);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<ul>
<li>æ—§ç‰ˆï¼š</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">// æ¡ä»¶è¡¨è¾¾å¼è½¬ if è¯­å¥ï¼Œæ”¯æŒåµŒå¥—çš„æ¡ä»¶è¡¨è¾¾å¼ï¼ŒåŠå­èŠ‚ç‚¹åŒ…å«é€—å·è¡¨è¾¾å¼çš„æƒ…å†µ</span><br><span class="line">const ConditionToIf = &#123;</span><br><span class="line">    ConditionalExpression(path) &#123;</span><br><span class="line">        let &#123; scope, node, parentPath, parent &#125; = path;</span><br><span class="line">        let &#123; test, consequent, alternate &#125; = node;</span><br><span class="line">        if (parentPath.isObjectProperty()) return;</span><br><span class="line"></span><br><span class="line">        if (parentPath.isAssignmentExpression(&#123; right: node &#125;)) &#123;</span><br><span class="line">            let &#123; left, operator, right &#125; = parent;</span><br><span class="line">            if (!types.isIdentifier(left) || operator != &#x27;=&#x27; || !types.isConditionalExpression(right)) return;</span><br><span class="line">            let name = left.name;</span><br><span class="line"></span><br><span class="line">            if (types.isSequenceExpression(consequent)) &#123;</span><br><span class="line">                let lastExpression = consequent.expressions.pop(); // å–å‡ºæœ€åä¸€ä¸ªè¡¨è¾¾å¼</span><br><span class="line">                let retBody = [];</span><br><span class="line">                consequent.expressions.forEach(ele =&gt; retBody.push(types.ExpressionStatement(ele)))</span><br><span class="line">                retBody.push(types.assignmentExpression(&#x27;=&#x27;, types.identifier(name), lastExpression))</span><br><span class="line">                consequent = types.BlockStatement(retBody);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                consequent = types.ExpressionStatement(types.assignmentExpression(&#x27;=&#x27;, types.identifier(name), consequent));</span><br><span class="line">                consequent = types.BlockStatement([consequent]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (types.isSequenceExpression(alternate)) &#123;</span><br><span class="line">                let lastExpression = alternate.expressions.pop(); // å–å‡ºæœ€åä¸€ä¸ªè¡¨è¾¾å¼</span><br><span class="line">                let retBody = [];</span><br><span class="line">                alternate.expressions.forEach(ele =&gt; retBody.push(types.ExpressionStatement(ele)))</span><br><span class="line">                retBody.push(types.assignmentExpression(&#x27;=&#x27;, types.identifier(name), lastExpression))</span><br><span class="line">                alternate = types.BlockStatement(retBody);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                alternate = types.ExpressionStatement(types.assignmentExpression(&#x27;=&#x27;, types.identifier(name), alternate));</span><br><span class="line">                alternate = types.BlockStatement([alternate]);</span><br><span class="line">            &#125;</span><br><span class="line">            let ifStateNode = types.IfStatement(test, consequent, alternate);</span><br><span class="line">            parentPath.parentPath.replaceWith(ifStateNode);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (parentPath.isVariableDeclarator(&#123; init: node &#125;)) &#123;</span><br><span class="line">            let &#123; id, init &#125; = parent;</span><br><span class="line">            if (!types.isIdentifier(id) || !types.isConditionalExpression(init)) return;</span><br><span class="line">            let name = id.name;</span><br><span class="line"></span><br><span class="line">            if (types.isSequenceExpression(consequent)) &#123;</span><br><span class="line">                let lastExpression = consequent.expressions.pop(); // å–å‡ºæœ€åä¸€ä¸ªè¡¨è¾¾å¼</span><br><span class="line">                let retBody = [];</span><br><span class="line">                consequent.expressions.forEach(ele =&gt; retBody.push(types.ExpressionStatement(ele)))</span><br><span class="line">                let newNode = types.variableDeclaration(&#x27;var&#x27;, [types.variableDeclarator(types.identifier(name), lastExpression)])</span><br><span class="line">                retBody.push(newNode)</span><br><span class="line">                consequent = types.BlockStatement(retBody);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                consequent = types.variableDeclaration(&#x27;var&#x27;, [types.variableDeclarator(types.identifier(name), consequent)]);</span><br><span class="line">                consequent = types.BlockStatement([consequent]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (types.isSequenceExpression(alternate)) &#123;</span><br><span class="line">                let lastExpression = alternate.expressions.pop(); // å–å‡ºæœ€åä¸€ä¸ªè¡¨è¾¾å¼</span><br><span class="line">                let retBody = [];</span><br><span class="line">                alternate.expressions.forEach(ele =&gt; retBody.push(types.ExpressionStatement(ele)))</span><br><span class="line">                let newNode = types.variableDeclaration(&#x27;var&#x27;, [types.variableDeclarator(types.identifier(name), lastExpression)])</span><br><span class="line">                retBody.push(newNode)</span><br><span class="line">                alternate = types.BlockStatement(retBody);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                alternate = types.variableDeclaration(&#x27;var&#x27;, [types.variableDeclarator(types.identifier(name), alternate)]);</span><br><span class="line">                alternate = types.BlockStatement([alternate]);</span><br><span class="line">            &#125;</span><br><span class="line">            let ifStateNode = types.IfStatement(test, consequent, alternate);</span><br><span class="line">            parentPath.parentPath.replaceWith(ifStateNode);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            if (types.isSequenceExpression(consequent)) &#123;</span><br><span class="line">                let retBody = [];</span><br><span class="line">                consequent.expressions.forEach(ele =&gt; retBody.push(types.ExpressionStatement(ele)));</span><br><span class="line">                consequent = types.BlockStatement(retBody);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                consequent = types.ExpressionStatement(consequent);</span><br><span class="line">                consequent = types.BlockStatement([consequent]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (types.isSequenceExpression(alternate)) &#123;</span><br><span class="line">                let retBody = [];</span><br><span class="line">                alternate.expressions.forEach(ele =&gt; retBody.push(types.ExpressionStatement(ele)));</span><br><span class="line">                alternate = types.BlockStatement(retBody);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                alternate = types.ExpressionStatement(alternate);</span><br><span class="line">                alternate = types.BlockStatement([alternate]);</span><br><span class="line">            &#125;</span><br><span class="line">            let ifStateNode = types.IfStatement(test, consequent, alternate);</span><br><span class="line">            parentPath.replaceWith(ifStateNode);</span><br><span class="line">        &#125;</span><br><span class="line">        path.skip();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, ConditionToIf);</span><br></pre></td></tr></table></figure>

<h2 id="ä¸ƒã€5s-ç›¾è§£æ··æ·†ä¸“é¢˜"><a href="#ä¸ƒã€5s-ç›¾è§£æ··æ·†ä¸“é¢˜" class="headerlink" title="ä¸ƒã€5s ç›¾è§£æ··æ·†ä¸“é¢˜"></a>ä¸ƒã€5s ç›¾è§£æ··æ·†ä¸“é¢˜</h2><blockquote>
<p><strong>æ³¨æ„ï¼šæ–°ç‰ˆ 5s ç›¾æ˜¯æ–°ç‰ˆ ob æ··æ·†ç‰¹å¾ï¼Œå­˜åœ¨å¤§æ•°ç»„å‡½æ•°ã€ç§»ä½è‡ªæ‰§è¡Œå‡½æ•°ï¼ˆpush shiftå…³é”®å­—ï¼‰ã€è§£å¯†å‡½æ•°</strong></p>
</blockquote>
<h3 id="1-æ–°ç‰ˆé€šç”¨æ’ä»¶-è¯»å–è§£å¯†ä»£ç "><a href="#1-æ–°ç‰ˆé€šç”¨æ’ä»¶-è¯»å–è§£å¯†ä»£ç " class="headerlink" title="1. æ–°ç‰ˆé€šç”¨æ’ä»¶ -&gt; è¯»å–è§£å¯†ä»£ç "></a>1. æ–°ç‰ˆé€šç”¨æ’ä»¶ -&gt; è¯»å–è§£å¯†ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">// å…ˆæ‰§è¡Œè§£æ··æ·†æ¨¡ç‰ˆï¼Œå°†ä»£ç åˆæ­¥æ ¼å¼åŒ–</span><br><span class="line">let decryptCodes = &#x27;&#x27;;</span><br><span class="line">var funcNameArr = [];</span><br><span class="line">const newVisitor = &#123;</span><br><span class="line">    /**  @param  &#123;NodePath&#125; path */</span><br><span class="line">    CallExpression(path) &#123;</span><br><span class="line">        let &#123; node, parentPath, scope &#125; = path;</span><br><span class="line">        let &#123; callee, arguments &#125; = node;</span><br><span class="line">        if (!parentPath.isExpressionStatement() || !types.isFunctionExpression(callee) || arguments.length != 2) return;</span><br><span class="line">        decryptCodes += parentPath + &#x27;&#x27;;</span><br><span class="line"></span><br><span class="line">        let name = arguments[0].name;</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        var &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        if (constantViolations.length &gt; 1 || !constantViolations[0].isAssignmentExpression()) return;</span><br><span class="line">        let pPath = constantViolations[0].parentPath;</span><br><span class="line">        if (!pPath.parentPath.parentPath.isFunctionDeclaration()) return;</span><br><span class="line">        // console.log(pPath.parentPath.parentPath+&#x27;&#x27;);</span><br><span class="line">        decryptCodes += pPath.parentPath.parentPath + &#x27;;&#x27;;</span><br><span class="line"></span><br><span class="line">        // åœ¨è‡ªæ‰§è¡Œå‡½æ•°ä¸­éå†ï¼Œç”¨äºè·å–æ•°ç»„ funcNameArr çš„ä¸»è§’å‡½æ•°åï¼ŒåŒæ—¶å°†æ­¤å‡½æ•°å®šä¹‰æ·»åŠ è‡³ decryptCodes</span><br><span class="line">        path.traverse(&#123;</span><br><span class="line">            CallExpression(_path) &#123;</span><br><span class="line">                let &#123; node, parentPath, scope &#125; = _path;</span><br><span class="line">                if (!parentPath.isCallExpression() || !parentPath.get(&#x27;callee&#x27;).isIdentifier()) return;</span><br><span class="line"></span><br><span class="line">                let &#123; callee, arguments &#125; = node;</span><br><span class="line">                let name = callee.name;</span><br><span class="line"></span><br><span class="line">                let binding = scope.getBinding(name);</span><br><span class="line">                if (!binding) return;</span><br><span class="line">                var &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">                // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">                if (constantViolations.length &gt; 1 || !constantViolations[0].isAssignmentExpression()) return;</span><br><span class="line">                let &#123; left, operator, right &#125; = constantViolations[0].node;</span><br><span class="line">                let rname = right.name;</span><br><span class="line"></span><br><span class="line">                let rbinding = scope.getBinding(rname);</span><br><span class="line">                if (!rbinding) return;</span><br><span class="line">                var &#123; referenced, references, constant, constantViolations, referencePaths &#125; = rbinding;</span><br><span class="line">                // console.log(rname, referenced, references, constant, constantViolations.length);</span><br><span class="line">                funcNameArr.push(rname);</span><br><span class="line">                // referencePaths.forEach((__path) =&gt; &#123;</span><br><span class="line">                //     if (!__path.parentPath.isAssignmentExpression() || !__path.parentPath.parentPath.isExpressionStatement()) return;</span><br><span class="line">                //     decryptCodes += __path.parentPath.parentPath + &#x27;&#x27;;</span><br><span class="line">                // &#125;)</span><br><span class="line"></span><br><span class="line">                if (constantViolations.length &gt; 1 || !constantViolations[0].isAssignmentExpression()) return;</span><br><span class="line">                let pPath = constantViolations[0].parentPath;</span><br><span class="line"></span><br><span class="line">                if (!pPath.parentPath.parentPath.isFunctionDeclaration()) return;</span><br><span class="line">                decryptCodes += pPath.parentPath.parentPath + &#x27;;&#x27;;</span><br><span class="line"></span><br><span class="line">                _path.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, newVisitor);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line">eval(decryptCodes)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">zL = a;</span><br><span class="line">(function (U, s, Di, zk, h, M) &#123;</span><br><span class="line">    Di = &#123;</span><br><span class="line">        U: 672,</span><br><span class="line">        s: 628,</span><br><span class="line">        h: 990,</span><br><span class="line">        M: 422,</span><br><span class="line">        E: 1308,</span><br><span class="line">        D: 409,</span><br><span class="line">        K: 1440,</span><br><span class="line">        I: 1127,</span><br><span class="line">        Z: 697,</span><br><span class="line">        P: 1174,</span><br><span class="line">        g: 1321</span><br><span class="line">    &#125;;</span><br><span class="line">    zk = a;</span><br><span class="line">    h = U();</span><br><span class="line">    for (; true;) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            M = parseInt(zk(Di.U)) / 1 * (parseInt(zk(Di.s)) / 2) + -parseInt(zk(Di.h)) / 3 * (parseInt(zk(Di.M)) / 4) + -parseInt(zk(Di.E)) / 5 * (-parseInt(zk(Di.D)) / 6) + parseInt(zk(Di.K)) / 7 + parseInt(zk(Di.I)) / 8 * (parseInt(zk(Di.Z)) / 9) + parseInt(zk(Di.P)) / 10 + -parseInt(zk(Di.g)) / 11;</span><br><span class="line">            if (s === M) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                h.push(h.shift());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (E) &#123;</span><br><span class="line">            h.push(h.shift());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)(l, 751393);</span><br><span class="line"></span><br><span class="line">function a(U, s, h) &#123;</span><br><span class="line">    h = l();</span><br><span class="line">    a = function (M, z, E) &#123;</span><br><span class="line">        M = M - 407;</span><br><span class="line">        E = h[M];</span><br><span class="line">        return E;</span><br><span class="line">    &#125;;</span><br><span class="line">    return a(U, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function l(mX) &#123;</span><br><span class="line">    mX = [&quot;wBCu6&quot;, &quot;kdF&quot;, &quot;qKKr0&quot;, &quot;createObjectURL&quot;, &quot;MsNIz&quot;, &quot;time_check_cached_warning_aux&quot;, &quot;YyDvZ&quot;, &quot;getTime&quot;, &quot;MjJYd&quot;, &quot;review_connection&quot;, &quot;querySelector&quot;, &quot;8|5|6|1|0|2|3|7|4&quot;, &quot;PuTkp&quot;, &quot;rxdzJ&quot;, &quot;Tgfgj&quot;, &quot;GpkER&quot;, &quot;NDraW&quot;, &quot;footer&quot;, &quot;wzZrj&quot;, &quot;parseInt&quot;, &quot;hxSCL&quot;, &quot;font-red&quot;, &quot;WYwLT&quot;, &quot;KVgRh&quot;, &quot;1|0|4|2|3&quot;, &quot;MYkC1&quot;, &quot;errorInfoObject&quot;, &quot;msg&quot;, &quot;tEiOG&quot;, &quot;cbfTP&quot;, &quot;ekrbl&quot;, &quot;uzdsG&quot;];  // åˆ é™¤å¾ˆå¤š ......</span><br><span class="line">    l = function () &#123;</span><br><span class="line">        return mX;</span><br><span class="line">    &#125;;</span><br><span class="line">    return l();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.log(zL(705));  // document</span><br></pre></td></tr></table></figure>

<h3 id="2-æ–°ç‰ˆé€šç”¨æ’ä»¶-è¿˜åŸ-call"><a href="#2-æ–°ç‰ˆé€šç”¨æ’ä»¶-è¿˜åŸ-call" class="headerlink" title="2. æ–°ç‰ˆé€šç”¨æ’ä»¶ -&gt; è¿˜åŸ call()"></a>2. æ–°ç‰ˆé€šç”¨æ’ä»¶ -&gt; è¿˜åŸ call()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">// è¿˜åŸè°ƒç”¨è¡¨è¾¾å¼ a(805) zk(1005)</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">// var funcNameArr = [&#x27;b&#x27;]  æ–°ç‰ˆæ’ä»¶å·²ç»åœ¨è¯»å–è§£å¯†ä»£ç æ—¶ï¼Œç”Ÿæˆäº†åˆè¯†è°ƒç”¨å‡½æ•°çš„æ ‡è¯†ç¬¦ï¼Œå¹¶åŠ å…¥æ•°ç»„ funcNameArr</span><br><span class="line">const callToString = &#123;</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; scope, node &#125; = path;</span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        let &#123; name &#125; = left;</span><br><span class="line">        let initName = funcNameArr[0];</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27; || !funcNameArr.includes(right.name)) return;</span><br><span class="line">        funcNameArr.push(name)</span><br><span class="line">        // console.log(funcNameArr);</span><br><span class="line"></span><br><span class="line">        let binding = path.scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        const firstConstant = constantViolations[0];</span><br><span class="line">        let flag = constantViolations.every(constantPath =&gt; constantPath.toString() == firstConstant.toString());</span><br><span class="line">        if (!flag) return; // åœ¨forå¾ªç¯ä¸­ï¼Œå‡½æ•°æ‰§è¡Œä¸¤æ¬¡ï¼Œé‚£ä¹ˆå‡½æ•°èµ‹å€¼å°±æ˜¯ä¸¤æ¬¡ï¼Œè€Œè¿™ç§æƒ…å†µä¹Ÿè¦è¿˜åŸï¼Œæ‰€ä»¥åˆ¤æ–­æ¯æ¬¡æ”¹å˜æ˜¯å¦ä¸€æ ·å³å¯</span><br><span class="line"></span><br><span class="line">        let allCallFlag = 0;</span><br><span class="line">        let rebackFlag = 0;</span><br><span class="line">        referencePaths.forEach(element =&gt; &#123;</span><br><span class="line">            if (element.parentPath.isCallExpression()) &#123; ++allCallFlag; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        // è¿˜åŸä¸»è¦é€»è¾‘</span><br><span class="line">        for (let referencePath of referencePaths) &#123;</span><br><span class="line">            let &#123; parentPath &#125; = referencePath;</span><br><span class="line">            if (!parentPath.isCallExpression(&#123; callee: referencePath.node &#125;)) continue;</span><br><span class="line"></span><br><span class="line">            let &#123; arguments &#125; = parentPath.node;</span><br><span class="line">            if (!isNodeLiteral(arguments)) continue;</span><br><span class="line"></span><br><span class="line">            let newCallExpression = types.callExpression(types.identifier(initName), arguments);</span><br><span class="line">            let value = eval(generator(newCallExpression).code);</span><br><span class="line">            console.log(parentPath + &#x27;&#x27;, &quot;--&gt;&quot;, value, ++rebackFlag);</span><br><span class="line">            parentPath.replaceWith(types.valueToNode(value));</span><br><span class="line">        &#125;</span><br><span class="line">        if (rebackFlag == allCallFlag) &#123; // å¦‚æœè¿˜åŸçš„æ¬¡æ•°ç­‰äºå¼•ç”¨æ•°ç»„é‡Œæ‰€æœ‰è°ƒç”¨è¡¨è¾¾å¼çš„ä¸ªæ•°ï¼Œé‚£ä¹ˆè¯´æ˜è¿˜åŸå®Œäº†</span><br><span class="line">            console.log(&quot;è¿˜åŸcall()ååˆ é™¤æ— ç”¨èŠ‚ç‚¹:&quot;, binding.path + &#x27;&#x27;, path + &#x27;&#x27;);</span><br><span class="line">            path.remove();</span><br><span class="line">            binding.path.remove();</span><br><span class="line">        &#125;</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, callToString);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="3-ä¸“ç”¨æ’ä»¶-è¯»å–å¹¶è¿˜åŸ-call"><a href="#3-ä¸“ç”¨æ’ä»¶-è¯»å–å¹¶è¿˜åŸ-call" class="headerlink" title="3. ä¸“ç”¨æ’ä»¶ -&gt; è¯»å–å¹¶è¿˜åŸ call()"></a>3. ä¸“ç”¨æ’ä»¶ -&gt; è¯»å–å¹¶è¿˜åŸ call()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// å…ˆæ‰§è¡Œéœ€è¦çš„è§£å¯†ä»£ç ï¼Œæˆ–å†™å…¥ decode.js æ–‡ä»¶ä¸­</span><br><span class="line">// ......</span><br><span class="line"></span><br><span class="line">const evalCode = &#123;</span><br><span class="line">    AssignmentExpression: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; node &#125; = path;</span><br><span class="line">            let &#123; left, right, operator &#125; = node;</span><br><span class="line">            if (types.isIdentifier(left) &amp;&amp; left.name.length == 2 &amp;&amp; operator == &#x27;=&#x27; &amp;&amp; types.isObjectExpression(right)) &#123;</span><br><span class="line">                eval(path.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            if (types.isIdentifier(left) &amp;&amp; left.name.length == 2 &amp;&amp; operator == &#x27;=&#x27; &amp;&amp; types.isIdentifier(right, &#123; name: &#x27;b&#x27; &#125;)) &#123;</span><br><span class="line">                eval(path.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            if (types.isIdentifier(left) &amp;&amp; left.name.length == 2 &amp;&amp; operator == &#x27;=&#x27; &amp;&amp; types.isIdentifier(right) &amp;&amp; right.name.length == 2) &#123;</span><br><span class="line">                eval(path.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, evalCode);</span><br><span class="line"></span><br><span class="line">const callToString = &#123;</span><br><span class="line">    CallExpression: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; parentPath, node, scope &#125; = path;</span><br><span class="line">            if (types.isIdentifier(node.callee) &amp;&amp; node.callee.name.length == 2 &amp;&amp; node.arguments.length == 1) &#123;</span><br><span class="line">                if (types.isNumericLiteral(node.arguments[0])) &#123;</span><br><span class="line">                    value = i9(node.arguments[0].value);</span><br><span class="line">                    console.log(path + &#x27;&#x27;, &#x27;--&gt;&#x27;, value);</span><br><span class="line">                    path.replaceWith(types.valueToNode(value));</span><br><span class="line"></span><br><span class="line">                    // console.log(path + &#x27;&#x27;, &#x27;--&gt;&#x27;, eval(path.toString()));</span><br><span class="line">                    // path.replaceWith(types.StringLiteral(eval(path.toString())))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, callToString);</span><br></pre></td></tr></table></figure>

<h3 id="4-ä¸“ç”¨æ’ä»¶ä¼˜åŒ–-åŠé€šç”¨"><a href="#4-ä¸“ç”¨æ’ä»¶ä¼˜åŒ–-åŠé€šç”¨" class="headerlink" title="4. ä¸“ç”¨æ’ä»¶ä¼˜åŒ– -&gt; åŠé€šç”¨"></a>4. ä¸“ç”¨æ’ä»¶ä¼˜åŒ– -&gt; åŠé€šç”¨</h3><blockquote>
<p><strong>ä¸€ä¸ªå‡½æ•°å¼•ç”¨ï¼Œé€šè¿‡å¤šé‡çš„å˜é‡åå¤èµ‹å€¼ï¼Œç”Ÿæˆå¤šä¸ªåŒå¼•ç”¨ä¸åŒå‡½æ•°åçš„è°ƒç”¨ï¼Œè®©éœ€è¦è¢«è¿˜åŸçš„å‡½æ•°è¶…çº§å¤š</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">// ......ä»£ç ç¯å¢ƒ</span><br><span class="line"></span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">var funcNameArr = [&#x27;b&#x27;]</span><br><span class="line">const callToString = &#123;</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; scope, node &#125; = path;</span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        let &#123; name &#125; = left;</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27; || !funcNameArr.includes(right.name)) return;</span><br><span class="line">        funcNameArr.push(name)</span><br><span class="line"></span><br><span class="line">        let binding = path.scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        const firstConstant = constantViolations[0];</span><br><span class="line">        let flag = constantViolations.every(constantPath =&gt; constantPath.toString() == firstConstant.toString());</span><br><span class="line">        if (!flag) return; // åœ¨forå¾ªç¯ä¸­ï¼Œå‡½æ•°æ‰§è¡Œä¸¤æ¬¡ï¼Œé‚£ä¹ˆå‡½æ•°èµ‹å€¼å°±æ˜¯ä¸¤æ¬¡ï¼Œè€Œè¿™ç§æƒ…å†µä¹Ÿè¦è¿˜åŸï¼Œæ‰€ä»¥åˆ¤æ–­æ¯æ¬¡æ”¹å˜æ˜¯å¦ä¸€æ ·å³å¯</span><br><span class="line"></span><br><span class="line">        let allCallFlag = 0;</span><br><span class="line">        let rebackFlag = 0;</span><br><span class="line">        referencePaths.forEach(element =&gt; &#123;</span><br><span class="line">            if (element.parentPath.isCallExpression()) &#123; ++allCallFlag; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        // è¿˜åŸä¸»è¦é€»è¾‘</span><br><span class="line">        for (let referencePath of referencePaths) &#123;</span><br><span class="line">            let &#123; parentPath &#125; = referencePath;</span><br><span class="line">            if (!parentPath.isCallExpression(&#123; callee: referencePath.node &#125;)) continue;</span><br><span class="line"></span><br><span class="line">            let &#123; arguments &#125; = parentPath.node;</span><br><span class="line">            if (!isNodeLiteral(arguments)) continue;</span><br><span class="line"></span><br><span class="line">            let newCallExpression = types.callExpression(types.identifier(&#x27;b&#x27;), arguments);</span><br><span class="line">            let value = eval(generator(newCallExpression).code);</span><br><span class="line">            console.log(parentPath + &#x27;&#x27;, &quot;--&gt;&quot;, value, ++rebackFlag);</span><br><span class="line">            parentPath.replaceWith(types.valueToNode(value));</span><br><span class="line">        &#125;</span><br><span class="line">        if (rebackFlag == allCallFlag) &#123; // å¦‚æœè¿˜åŸçš„æ¬¡æ•°ç­‰äºå¼•ç”¨æ•°ç»„é‡Œæ‰€æœ‰è°ƒç”¨è¡¨è¾¾å¼çš„ä¸ªæ•°ï¼Œé‚£ä¹ˆè¯´æ˜è¿˜åŸå®Œäº†</span><br><span class="line">            console.log(&quot;åˆ é™¤æ— ç”¨èŠ‚ç‚¹:&quot;, binding.path + &#x27;&#x27;, path + &#x27;&#x27;);</span><br><span class="line">            path.remove();</span><br><span class="line">            binding.path.remove();</span><br><span class="line">        &#125;</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, callToString);</span><br></pre></td></tr></table></figure>

<h3 id="5-æ’ä»¶-object-å¯¹è±¡åˆå¹¶"><a href="#5-æ’ä»¶-object-å¯¹è±¡åˆå¹¶" class="headerlink" title="5. æ’ä»¶ -&gt; object å¯¹è±¡åˆå¹¶"></a>5. æ’ä»¶ -&gt; object å¯¹è±¡åˆå¹¶</h3><ul>
<li>æ›´æ–°ç‰ˆæœ¬ï¼šé€šè¿‡ç»‘å®šçš„å¼•ç”¨ path åˆå¹¶å¯¹è±¡</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">// objectå¯¹è±¡åˆå¹¶</span><br><span class="line">const preDecodeObject = &#123;</span><br><span class="line">    // é’ˆå¯¹OBæ··æ·†ï¼Œ5ç§’ç›¾ä¸­éƒ½æ˜¯èµ‹å€¼çš„ï¼Œobæ··æ·†ä¸­éƒ½æ˜¯å®šä¹‰çš„</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, parent, node &#125; = path;</span><br><span class="line">        if (!parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27; || !types.isObjectExpression(right)) return;</span><br><span class="line"></span><br><span class="line">        let name = left.name;</span><br><span class="line">        let properties = right.properties;</span><br><span class="line">        if (right.properties.length != 0) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            referencePaths.forEach((rpath) =&gt; &#123;</span><br><span class="line">                let &#123; node, parent, scope, parentPath &#125; = rpath;</span><br><span class="line">                if (!types.isMemberExpression(parent, &#123; &quot;object&quot;: node &#125;)</span><br><span class="line">                    || !parentPath.parentPath.isAssignmentExpression(&#123; operator: &quot;=&quot; &#125;)</span><br><span class="line">                    || !parentPath.parentPath.parentPath.isExpressionStatement()</span><br><span class="line">                ) return;</span><br><span class="line"></span><br><span class="line">                let &#123; object, property &#125; = parent;</span><br><span class="line">                if (!types.isLiteral(property)) return;</span><br><span class="line"></span><br><span class="line">                let value = parentPath.parentPath.node.right;</span><br><span class="line">                properties.push(types.objectProperty(property, value));</span><br><span class="line"></span><br><span class="line">                console.log(&quot;åˆå¹¶Objectå¯¹è±¡ååˆ é™¤åŸèŠ‚ç‚¹:&quot;, parentPath.parentPath.parentPath + &#x27;&#x27;);</span><br><span class="line">                parentPath.parentPath.parentPath.remove();</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, preDecodeObject);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<ul>
<li>æ—§ç‰ˆæœ¬ï¼šé€šè¿‡éå†åç»§èŠ‚ç‚¹åˆå¹¶å¯¹è±¡</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// objectå¯¹è±¡åˆå¹¶</span><br><span class="line">const preDecodeObject = &#123;</span><br><span class="line">    // é’ˆå¯¹OBæ··æ·†ï¼Œ5ç§’ç›¾ä¸­éƒ½æ˜¯èµ‹å€¼çš„ï¼Œobæ··æ·†ä¸­éƒ½æ˜¯å®šä¹‰çš„</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, parent, node &#125; = path;</span><br><span class="line">        if (!parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27; || !types.isObjectExpression(right)) return;</span><br><span class="line"></span><br><span class="line">        let name = left.name;</span><br><span class="line">        let properties = right.properties;</span><br><span class="line">        if (right.properties.length != 0) return;</span><br><span class="line"></span><br><span class="line">        let allNextSiblings = parentPath.getAllNextSiblings();</span><br><span class="line">        for (let nextSibling of allNextSiblings) &#123;</span><br><span class="line">            if (!nextSibling.isExpressionStatement()) break;</span><br><span class="line"></span><br><span class="line">            let expression = nextSibling.get(&#x27;expression&#x27;);</span><br><span class="line">            if (!expression.isAssignmentExpression(&#123; operator: &quot;=&quot; &#125;)) break;</span><br><span class="line"></span><br><span class="line">            let &#123; left, right &#125; = expression.node;</span><br><span class="line">            if (!types.isMemberExpression(left)) break;</span><br><span class="line"></span><br><span class="line">            let &#123; object, property &#125; = left;</span><br><span class="line">            if (!types.isIdentifier(object, &#123; name: name &#125;) || !types.isStringLiteral(property)) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            properties.push(types.ObjectProperty(property, right));</span><br><span class="line">            nextSibling.remove();</span><br><span class="line">        &#125;</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, preDecodeObject);</span><br></pre></td></tr></table></figure>

<h3 id="6-æ’ä»¶-æ·±æ‹·è´èµ‹å€¼å¼•ç”¨"><a href="#6-æ’ä»¶-æ·±æ‹·è´èµ‹å€¼å¼•ç”¨" class="headerlink" title="6. æ’ä»¶ -&gt; æ·±æ‹·è´èµ‹å€¼å¼•ç”¨"></a>6. æ’ä»¶ -&gt; æ·±æ‹·è´èµ‹å€¼å¼•ç”¨</h3><ul>
<li><p><strong>æ³¨æ„ï¼š</strong>è¿™é‡Œèµ‹å€¼è¯­å¥çš„ left.name æœ‰ç»‘å®šï¼Œæ˜¯å› ä¸ºè¿™ä¸ª name æ˜¯å‡½æ•°çš„å½¢å‚</p>
</li>
<li><p>æ›´æ–°ç‰ˆæœ¬ï¼šé€šè¿‡ç»‘å®šçš„å¼•ç”¨ path æ‹·è´å¯¹è±¡</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">// æ·±æ‹·è´èµ‹å€¼å¼•ç”¨</span><br><span class="line">const deepCopy = &#123;</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27; || !types.isObjectExpression(right)) return;</span><br><span class="line">        let targetObject = right;</span><br><span class="line"></span><br><span class="line">        let name = left.name;</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            referencePaths.forEach((rpath) =&gt; &#123;</span><br><span class="line">                let &#123; parentPath, parent, node, scope &#125; = rpath;</span><br><span class="line">                if (!types.isAssignmentExpression(parent, &#123; &quot;right&quot;: node &#125;) || !parentPath.parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">                let &#123; left, operator, right &#125; = parent;</span><br><span class="line">                if (operator != &#x27;=&#x27; || !types.isIdentifier(left)) return;</span><br><span class="line">                parent.right = targetObject;  // è¿˜åŸå…·ä½“æ“ä½œ</span><br><span class="line"></span><br><span class="line">                scope.crawl();</span><br><span class="line">                let binding = scope.getBinding(node.name);</span><br><span class="line">                if (!binding) return;</span><br><span class="line">                let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">                console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">                if (references != 0) return;  // å…¶ä½™åˆ¤æ–­åœ¨å¤–å±‚å·²ç»åˆ¤æ–­è¿‡äº†</span><br><span class="line">                console.log(&quot;æ‹·è´Objectå¯¹è±¡ååˆ é™¤å½¢å‚ä¸æ— ç”¨åŸèŠ‚ç‚¹:&quot;, binding.path + &#x27;&#x27;, path.parentPath + &#x27;&#x27;);</span><br><span class="line">                path.parentPath.remove();</span><br><span class="line">                binding.path.remove(); // åˆ é™¤çš„å‡½æ•°å½¢å‚</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, deepCopy);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<ul>
<li>æ—§ç‰ˆæœ¬ï¼šé€šè¿‡éå†åç»§èŠ‚ç‚¹æ‹·è´å¯¹è±¡</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// æ·±æ‹·è´èµ‹å€¼å¼•ç”¨</span><br><span class="line">const deepCopy = &#123;</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27; || !types.isObjectExpression(right)) return;</span><br><span class="line"></span><br><span class="line">        let name = left.name;</span><br><span class="line">        let object = right;</span><br><span class="line">        let allNextSiblings = parentPath.getAllNextSiblings();</span><br><span class="line">        for (let nextSibling of allNextSiblings) &#123;</span><br><span class="line">            if (!nextSibling.isExpressionStatement()) break;</span><br><span class="line"></span><br><span class="line">            let expression = nextSibling.get(&#x27;expression&#x27;);</span><br><span class="line">            if (!expression.isAssignmentExpression(&#123; operator: &quot;=&quot; &#125;)) break;</span><br><span class="line"></span><br><span class="line">            let &#123; left, right &#125; = expression.node;</span><br><span class="line">            if (!types.isIdentifier(left) || !types.isIdentifier(right, &#123; name: name &#125;)) break;</span><br><span class="line">            expression.node.right = object;</span><br><span class="line"></span><br><span class="line">            let binding = scope.getBinding(name);</span><br><span class="line">            let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">            console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">            if (references != 1 || constantViolations.length != 1) return;</span><br><span class="line">            if (constantViolations[0] == path) &#123;</span><br><span class="line">                console.log(&quot;æ·±æ‹·è´ååˆ é™¤æ— ç”¨èŠ‚ç‚¹ä¸å½¢å‚ï¼š&quot;, path + &#x27;&#x27;);</span><br><span class="line">                path.remove();</span><br><span class="line">                binding.path.remove(); // åˆ é™¤çš„å‡½æ•°å½¢å‚</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, deepCopy);</span><br></pre></td></tr></table></figure>

<h3 id="7-æ’ä»¶-obj-å¯¹è±¡-value-å®ç°"><a href="#7-æ’ä»¶-obj-å¯¹è±¡-value-å®ç°" class="headerlink" title="7. æ’ä»¶ -&gt; obj å¯¹è±¡ value å®ç°"></a>7. æ’ä»¶ -&gt; obj å¯¹è±¡ value å®ç°</h3><ul>
<li>æ’ä»¶å°æ›´æ–°ï¼š</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">// Object å¯¹è±¡çš„ value å€¼å®ç°è¿˜åŸ</span><br><span class="line">function isBaseLiteral(node) &#123;</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node) &amp;&amp; node.value != null) return true; // nullå¯èƒ½æœ‰å‘</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; literalList.includes(node.name)) return true;</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; typeof globalThis[node.name] != &quot;undefined&quot;) return true;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; [&quot;+&quot;, &quot;-&quot;, &quot;!&quot;].includes(node.operator)) &#123;</span><br><span class="line">        if (types.isArrayExpression(node.argument) &amp;&amp; node.argument.elements.length == 0) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return isBaseLiteral(node.argument);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const newDecodeObject = &#123;</span><br><span class="line">    // AssignmentExpressionå¯¹åº”5sç›¾ï¼ŒVariableDeclaratorå¯¹åº”obæ··æ·†</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27; || !types.isObjectExpression(right)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; properties &#125; = right;</span><br><span class="line">        if (properties.length == 0) return;</span><br><span class="line"></span><br><span class="line">        let name = left.name;</span><br><span class="line">        scope.crawl();</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        var &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (!constant &amp;&amp; constantViolations[0] != path) return;</span><br><span class="line"></span><br><span class="line">        // Map å¯¹è±¡ç”¨äºå­˜å‚¨é”®å€¼å¯¹ï¼Œå…¶ä¸­é”®å’Œå€¼éƒ½å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼›</span><br><span class="line">        // Map ä¿æŒé”®å€¼å¯¹çš„æ’å…¥é¡ºåºï¼Œè¿™æ„å‘³ç€è¿­ä»£é”®å€¼å¯¹æ—¶çš„é¡ºåºä¸æ’å…¥å®ƒä»¬æ—¶çš„é¡ºåºç›¸åŒ</span><br><span class="line">        let newMap = new Map();</span><br><span class="line">        for (const property of properties) &#123;</span><br><span class="line">            if (!property.key) break; // ES6è¯­æ³•æ²¡æœ‰key</span><br><span class="line"></span><br><span class="line">            let propKey = property.key.value;</span><br><span class="line">            let propValue = property.value;</span><br><span class="line">            if (isBaseLiteral(propValue)) &#123;</span><br><span class="line">                newMap.set(propKey, propValue.value); // å¦‚æœæ˜¯å­—ç¬¦ä¸²å°±ç›´æ¥å­˜å…¥å­—ç¬¦ä¸²</span><br><span class="line">            &#125;</span><br><span class="line">            else if (types.isFunctionExpression(propValue)) &#123;</span><br><span class="line">                let retState = propValue.body.body; // ç›´æ¥è·å–åˆ° return è¯­å¥</span><br><span class="line">                if (retState.length == 1 &amp;&amp; types.isReturnStatement(retState[0])) &#123;</span><br><span class="line">                    let argument = retState[0].argument;</span><br><span class="line">                    if (types.isCallExpression(argument)) &#123;</span><br><span class="line">                        newMap.set(propKey, &quot;Call&quot;); // å¦‚æœæ˜¯è°ƒç”¨è¡¨è¾¾å¼å°±å­˜å…¥ call ç‰¹è¯</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (types.isBinaryExpression(argument) || types.isLogicalExpression(argument)) &#123;</span><br><span class="line">                        newMap.set(propKey, argument.operator);</span><br><span class="line">                        // å¦‚æœæ˜¯äºŒé¡¹å¼è¡¨è¾¾å¼æˆ–è€…é€»è¾‘è¡¨è¾¾å¼ï¼Œå°±å­˜å…¥ operator æ“ä½œç¬¦</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // console.log(newMap);</span><br><span class="line"></span><br><span class="line">        if (newMap.size != properties.length) return;  // åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡ä¸­æ˜¯å¦å¤„ç†å®Œæ‰€æœ‰key</span><br><span class="line">        // éå†è¿˜åŸæ¯ä¸€ä¸ªå¼•ç”¨çš„åœ°æ–¹</span><br><span class="line">        for (const referPath of referencePaths.reverse()) &#123;</span><br><span class="line">            let &#123; node, parent, parentPath &#125; = referPath;</span><br><span class="line">            let ancestorPath = parentPath.parentPath; // å®å‚è¦é€šè¿‡ç¥–å…ˆèŠ‚ç‚¹è·å–ï¼Œaz[&#x27;XFB&#x27;](&#x27;L&#x27;,&#x27;OG&#x27;);</span><br><span class="line">            if (!parentPath.isMemberExpression(&#123; object: node &#125;)) continue;</span><br><span class="line"></span><br><span class="line">            let property = parent.property;</span><br><span class="line">            let propKey = types.isIdentifier(property) ? property.name : property.value;</span><br><span class="line">            let propValue = newMap.get(propKey);</span><br><span class="line">            if (!propValue) continue;</span><br><span class="line"></span><br><span class="line">            if (ancestorPath.isCallExpression(&#123; callee: parent &#125;)) &#123;</span><br><span class="line">                let &#123; arguments &#125; = ancestorPath.node;</span><br><span class="line">                switch (propValue) &#123;</span><br><span class="line">                    case &quot;Call&quot;:</span><br><span class="line">                        ancestorPath.replaceWith(types.callExpression(arguments[0], arguments.slice(1)));</span><br><span class="line">                        break;</span><br><span class="line">                    case &quot;||&quot;:</span><br><span class="line">                    case &quot;&amp;&amp;&quot;:</span><br><span class="line">                        ancestorPath.replaceWith(types.logicalExpression(propValue, arguments[0], arguments[1]));</span><br><span class="line">                        break;</span><br><span class="line">                    default:</span><br><span class="line">                        ancestorPath.replaceWith(types.binaryExpression(propValue, arguments[0], arguments[1]));</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                parentPath.replaceWith(types.valueToNode(propValue));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        scope.crawl();</span><br><span class="line">        let newbinding = scope.getBinding(name);</span><br><span class="line">        if (!newbinding) return;</span><br><span class="line">        var &#123; referenced, references, constant, constantViolations, referencePaths &#125; = newbinding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        if (references != 0) return;  // å…¶ä½™åˆ¤æ–­åœ¨å¤–å±‚å·²ç»åˆ¤æ–­è¿‡äº†</span><br><span class="line">        console.log(&quot;è¿˜åŸObjectå¯¹è±¡ååˆ é™¤å½¢å‚ä¸æ— ç”¨åŸèŠ‚ç‚¹:&quot;, binding.path + &#x27;&#x27;, path.parentPath + &#x27;&#x27;);</span><br><span class="line">        path.parentPath.remove();</span><br><span class="line">        binding.path.remove(); // åˆ é™¤çš„å‡½æ•°å½¢å‚</span><br><span class="line"></span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, newDecodeObject);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<ul>
<li>æ—§ç‰ˆæœ¬ï¼š</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">// objectç±»å‹valueå­—æ®µçš„å­—é¢é‡å’Œå‡½æ•°çš„è¿˜åŸ</span><br><span class="line">// ä¿å­˜å¯¹è±¡ä¸­æ‰€æœ‰å±æ€§çš„ç‰¹å¾åˆ° Map ä¸­</span><br><span class="line">function savePropertiesToObject(properties, newMap) &#123;</span><br><span class="line">    for (const property of properties) &#123;</span><br><span class="line">        if (!property.key) break; // ES6è¯­æ³•æ²¡æœ‰key</span><br><span class="line"></span><br><span class="line">        let propKey = property.key.value;</span><br><span class="line">        let propValue = property.value;</span><br><span class="line">        if (types.isLiteral(propValue)) &#123;</span><br><span class="line">            newMap.set(propKey, propValue.value); // å¦‚æœæ˜¯å­—ç¬¦ä¸²å°±ç›´æ¥å­˜å…¥å­—ç¬¦ä¸²</span><br><span class="line">        &#125;</span><br><span class="line">        else if (types.isFunctionExpression(propValue)) &#123;</span><br><span class="line">            let retState = propValue.body.body; // ç›´æ¥è·å–åˆ° return è¯­å¥</span><br><span class="line">            if (retState.length == 1 &amp;&amp; types.isReturnStatement(retState[0])) &#123;</span><br><span class="line">                let argument = retState[0].argument;</span><br><span class="line">                if (types.isCallExpression(argument)) &#123;</span><br><span class="line">                    newMap.set(propKey, &quot;Call&quot;); // å¦‚æœæ˜¯è°ƒç”¨è¡¨è¾¾å¼å°±å­˜å…¥ call ç‰¹è¯</span><br><span class="line">                &#125;</span><br><span class="line">                if (types.isBinaryExpression(argument) || types.isLogicalExpression(argument)) &#123;</span><br><span class="line">                    newMap.set(propKey, argument.operator);</span><br><span class="line">                    // å¦‚æœæ˜¯äºŒé¡¹å¼è¡¨è¾¾å¼æˆ–è€…é€»è¾‘è¡¨è¾¾å¼ï¼Œå°±å­˜å…¥ operator æ“ä½œç¬¦</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// éå†å¼•ç”¨çš„åœ°æ–¹ï¼Œæ ¹æ®ç‰¹å¾è¿˜åŸå­—ç¬¦ä¸²æˆ–å‡½æ•°</span><br><span class="line">function replaceReferNode(newMap, referencePaths, scope) &#123;</span><br><span class="line">    for (const referPath of referencePaths.reverse()) &#123;</span><br><span class="line">        let &#123; node, parent, parentPath &#125; = referPath;</span><br><span class="line">        let ancestorPath = parentPath.parentPath; // å®å‚è¦é€šè¿‡ç¥–å…ˆèŠ‚ç‚¹è·å–ï¼Œaz[&#x27;XFB&#x27;](&#x27;L&#x27;,&#x27;OG&#x27;);</span><br><span class="line">        if (!parentPath.isMemberExpression(&#123; object: node &#125;)) continue;</span><br><span class="line"></span><br><span class="line">        let property = parent.property;</span><br><span class="line">        let propKey = types.isIdentifier(property) ? property.name : property.value;</span><br><span class="line">        let propValue = newMap.get(propKey);</span><br><span class="line">        if (!propValue) continue;</span><br><span class="line"></span><br><span class="line">        if (ancestorPath.isCallExpression(&#123; callee: parent &#125;)) &#123;</span><br><span class="line">            let &#123; arguments &#125; = ancestorPath.node;</span><br><span class="line">            switch (propValue) &#123;</span><br><span class="line">                case &quot;Call&quot;:</span><br><span class="line">                    ancestorPath.replaceWith(types.CallExpression(arguments[0], arguments.slice(1)));</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;||&quot;:</span><br><span class="line">                case &quot;&amp;&amp;&quot;:</span><br><span class="line">                    ancestorPath.replaceWith(types.LogicalExpression(propValue, arguments[0], arguments[1]));</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    ancestorPath.replaceWith(types.BinaryExpression(propValue, arguments[0], arguments[1]));</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            parentPath.replaceWith(types.valueToNode(propValue));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">const decodeObject = &#123;</span><br><span class="line">    // AssignmentExpressionå¯¹åº”5sç›¾ï¼ŒVariableDeclaratorå¯¹åº”obæ··æ·†</span><br><span class="line">    AssignmentExpression(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27; || !types.isObjectExpression(right)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; properties &#125; = right;</span><br><span class="line">        if (properties.length == 0) return;</span><br><span class="line"></span><br><span class="line">        let name = left.name;</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line"></span><br><span class="line">        let &#123; referenced, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        if (constantViolations.length != 1) return;</span><br><span class="line"></span><br><span class="line">        // Map å¯¹è±¡ç”¨äºå­˜å‚¨é”®å€¼å¯¹ï¼Œå…¶ä¸­é”®å’Œå€¼éƒ½å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼›</span><br><span class="line">        // Map ä¿æŒé”®å€¼å¯¹çš„æ’å…¥é¡ºåºï¼Œè¿™æ„å‘³ç€è¿­ä»£é”®å€¼å¯¹æ—¶çš„é¡ºåºä¸æ’å…¥å®ƒä»¬æ—¶çš„é¡ºåºç›¸åŒ</span><br><span class="line">        let newMap = new Map();</span><br><span class="line">        savePropertiesToObject(properties, newMap);</span><br><span class="line"></span><br><span class="line">        if (newMap.size != properties.length) return; // åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡ä¸­æ˜¯å¦å¤„ç†å®Œæ‰€æœ‰key</span><br><span class="line">        try &#123;</span><br><span class="line">            replaceReferNode(newMap, referencePaths, scope);</span><br><span class="line">        &#125; catch &#123; &#125;;</span><br><span class="line">        scope.crawl();</span><br><span class="line"></span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            console.log(&quot;æ·±æ‹·è´ååˆ é™¤æ— ç”¨èŠ‚ç‚¹ä¸å½¢å‚:&quot;, path.toString());</span><br><span class="line">            path.remove();</span><br><span class="line">            if (binding.path.parentPath.isFunctionExpression() || binding.path.parentPath.isFunctionDeclaration()) &#123;</span><br><span class="line">                binding.path.remove(); // åˆ é™¤çš„å‡½æ•°å½¢å‚</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, decodeObject);</span><br></pre></td></tr></table></figure>

<h3 id="8-æ’ä»¶-å¤„ç†å¹³å¦æ§åˆ¶æµ"><a href="#8-æ’ä»¶-å¤„ç†å¹³å¦æ§åˆ¶æµ" class="headerlink" title="8. æ’ä»¶ -&gt; å¤„ç†å¹³å¦æ§åˆ¶æµ"></a>8. æ’ä»¶ -&gt; å¤„ç†å¹³å¦æ§åˆ¶æµ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">// å¹³å¦æ§åˆ¶æµå¤„ç†ï¼Œswitch-caseè¯­å¥</span><br><span class="line">const decode5sForSwitch = &#123;</span><br><span class="line">    &quot;ForStatement&quot;(path) &#123;</span><br><span class="line">        let &#123; node, scope, praent, praentPath &#125; = path;</span><br><span class="line">        let &#123; test, body &#125; = node;</span><br><span class="line">        if (!types.isBooleanLiteral(test) || body.body.length != 2) return;</span><br><span class="line"></span><br><span class="line">        let [switchNode, breakNode] = body.body;</span><br><span class="line">        if (!types.isSwitchStatement(switchNode) || !types.isBreakStatement(breakNode)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; discriminant, cases &#125; = switchNode;</span><br><span class="line">        if (!types.isMemberExpression(discriminant)) return;</span><br><span class="line"></span><br><span class="line">        let arrName = switchNode.discriminant.object.name;</span><br><span class="line">        let binding = scope.getBinding(arrName);</span><br><span class="line">        if (!binding || !binding.path) return;</span><br><span class="line"></span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        console.log(&quot;å¤„ç†å¹³å¦æ§åˆ¶æµ:&quot;, arrName, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (constantViolations.length != 1) return; // æ”¹å˜æœ‰å¤šæ¬¡ï¼Œå°±ä¸è¿˜åŸäº†</span><br><span class="line"></span><br><span class="line">        let &#123; left, right &#125; = constantViolations[0].node;</span><br><span class="line">        if (!types.isIdentifier(left) || !types.isCallExpression(right)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; callee, arguments &#125; = right;</span><br><span class="line">        if (!types.isMemberExpression(callee) || arguments.length != 1) return;</span><br><span class="line"></span><br><span class="line">        let &#123; object, property &#125; = callee;</span><br><span class="line">        if (!types.isStringLiteral(object) || !types.isStringLiteral(property, &#123; value: &#x27;split&#x27; &#125;)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        let disPatchArray = object.value.split(&#x27;|&#x27;);</span><br><span class="line">        let retBody = [];</span><br><span class="line">        disPatchArray.forEach(index =&gt; &#123;</span><br><span class="line">            let caseArr = cases.filter(cc =&gt; cc.test.value == index)[0].consequent;</span><br><span class="line">            if (types.isContinueStatement(caseArr[caseArr.length - 1])) &#123;</span><br><span class="line">                caseArr.pop() // å¦‚æœcaseä¸­æœ€åä¸€æ¡è¯­å¥æ˜¯continueè¯­å¥ï¼Œåˆ™åˆ é™¤è¿™æ¡è¯­å¥</span><br><span class="line">            &#125;</span><br><span class="line">            retBody = retBody.concat(caseArr);</span><br><span class="line">        &#125;);</span><br><span class="line">        path.replaceWithMultiple(retBody);</span><br><span class="line">        if (references == 1) &#123;</span><br><span class="line">            constantViolations[0].remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, decode5sForSwitch);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">function test(ay, i, f) &#123;</span><br><span class="line">    i = &#x27;4|1|3|2|5|0&#x27;[&#x27;split&#x27;](&#x27;|&#x27;);</span><br><span class="line">    f = 0;</span><br><span class="line">    for (; true;) &#123;</span><br><span class="line">        switch (i[f++]) &#123;</span><br><span class="line">            case &#x27;0&#x27;:</span><br><span class="line">                console.log(&#x27;æ‰§è¡Œ case 0 .&#x27;);</span><br><span class="line">                continue;</span><br><span class="line">            case &#x27;1&#x27;:</span><br><span class="line">                console.log(&#x27;æ‰§è¡Œ case 1 .&#x27;);</span><br><span class="line">                continue;</span><br><span class="line">            case &#x27;2&#x27;:</span><br><span class="line">                console.log(&#x27;æ‰§è¡Œ case 2 .&#x27;);</span><br><span class="line">                continue;</span><br><span class="line">            case &#x27;3&#x27;:</span><br><span class="line">                console.log(&#x27;æ‰§è¡Œ case 3 .&#x27;);</span><br><span class="line">                continue;</span><br><span class="line">            case &#x27;4&#x27;:</span><br><span class="line">                console.log(&#x27;æ‰§è¡Œ case 4 .&#x27;);</span><br><span class="line">                continue;</span><br><span class="line">            case &#x27;5&#x27;:</span><br><span class="line">                console.log(&#x27;æ‰§è¡Œ case 5 .&#x27;);</span><br><span class="line">                continue;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="9-æ’ä»¶-â€“-æ·»åŠ è°ƒè¯•æ‰“å°è¯­å¥"><a href="#9-æ’ä»¶-â€“-æ·»åŠ è°ƒè¯•æ‰“å°è¯­å¥" class="headerlink" title="9. æ’ä»¶ â€“&gt; æ·»åŠ è°ƒè¯•æ‰“å°è¯­å¥"></a>9. æ’ä»¶ â€“&gt; æ·»åŠ è°ƒè¯•æ‰“å°è¯­å¥</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ast.program.body.unshift(types.debuggerStatement());</span><br><span class="line">const adddebuggerStatement = &#123;</span><br><span class="line">    /**  @param  &#123;NodePath&#125; path */</span><br><span class="line">    MemberExpression(path) &#123;</span><br><span class="line">        let &#123; parent, node, parentPath &#125; = path;</span><br><span class="line">        if (!types.isCallExpression(parent, &#123; callee: node &#125;) || !parentPath.parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; object, property &#125; = node;</span><br><span class="line">        if (!types.isStringLiteral(property, &#123; &quot;value&quot;: &quot;send&quot; &#125;)) return;</span><br><span class="line"></span><br><span class="line">        let calleeNode = types.memberExpression(types.identifier(&quot;console&quot;), types.identifier(&quot;log&quot;))</span><br><span class="line">        let logNode = types.callExpression(calleeNode, parent.arguments)</span><br><span class="line">        parentPath.parentPath.insertAfter(logNode);</span><br><span class="line">        // parentPath.parentPath.insertAfter(types.debuggerStatement());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, adddebuggerStatement);</span><br></pre></td></tr></table></figure>

<h2 id="å…«ã€OB-è§£æ··æ·†ä¸“é¢˜"><a href="#å…«ã€OB-è§£æ··æ·†ä¸“é¢˜" class="headerlink" title="å…«ã€OB è§£æ··æ·†ä¸“é¢˜"></a>å…«ã€OB è§£æ··æ·†ä¸“é¢˜</h2><blockquote>
<p><strong>obæ··æ·†çš„è¿˜åŸæ€è·¯ï¼ˆ<a class="link"   href="https://obfuscator.io/"  target="_blank" rel="noopener">å®˜æ–¹ç½‘å€<i class="fas fa-external-link-alt"></i></a>ï¼‰ï¼š</strong></p>
<ol>
<li><strong>ä»£ç æ ¼å¼åŒ–æ£€æµ‹ï¼š</strong>é€šå¸¸åœ¨ <strong>å¤§æ•°ç»„</strong>ã€<strong>ç§»ä½è‡ªæ‰§è¡Œå‡½æ•°</strong> æˆ– <strong>è§£å¯†å‡½æ•°</strong> ä¸­ï¼Œéœ€è¦å‹ç¼©ä¸ºä¸€è¡Œï¼Œå¦åˆ™è¿è¡Œä¼šå¯¼è‡´å †æ ˆæº¢å‡º</li>
<li><strong>è§£æ··æ·†å‡ºä¹±ç ï¼š</strong>é€šå¸¸æ˜¯ç¼ºå°‘äº†<strong>ç§»ä½è‡ªæ‰§è¡Œå‡½æ•°</strong>å¯¹<strong>å¤§æ•°ç»„</strong>å…ƒç´ è¿›è¡Œæ­£ç¡®æ’åºï¼Œæœå¤§æ•°ç»„åå³å¯æ‰¾åˆ°</li>
<li><strong>å¹³å¦æ§åˆ¶æµå¤„ç†ï¼š</strong>åœ¨ ob æ··æ·†çš„ switch-case è¯­å¥ä¸­ï¼Œ<strong>å®šä½å­—ç¬¦ä¸²åˆ†éš”è¯­å¥</strong>ï¼Œå¯ä»¥é€šè¿‡ binding ç»‘å®šçš„ path å®šä½ï¼Œå› ä¸º ob çš„<strong>å®šä¹‰ç‰¹æ€§</strong>ï¼Œåœ¨ä¸€ä¸ªä½œç”¨åŸŸä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼ˆå®šä¹‰ï¼‰ï¼Œå³æ˜¯å…¶ç»‘å®šçš„ path</li>
</ol>
</blockquote>
<h3 id="1-æ’ä»¶-è¿˜åŸè°ƒç”¨è¡¨è¾¾å¼"><a href="#1-æ’ä»¶-è¿˜åŸè°ƒç”¨è¡¨è¾¾å¼" class="headerlink" title="1. æ’ä»¶ -&gt; è¿˜åŸè°ƒç”¨è¡¨è¾¾å¼"></a>1. æ’ä»¶ -&gt; è¿˜åŸè°ƒç”¨è¡¨è¾¾å¼</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">// èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">// æ”¶é›†æ‰€æœ‰éœ€è¦è¿˜åŸçš„è°ƒç”¨è¡¨è¾¾å¼å¯¹åº”çš„å‡½æ•°å®šä¹‰</span><br><span class="line">let decodeCode = &#x27;&#x27;;</span><br><span class="line">let funcNames = [];</span><br><span class="line">const collectObFuncs = &#123;</span><br><span class="line">    &quot;FunctionDeclaration&quot;(path) &#123;</span><br><span class="line">        let &#123; id, params, body &#125; = path.node;</span><br><span class="line">        if (params.length != 5 || body.body.length != 1) return;</span><br><span class="line">        if (!types.isReturnStatement(body.body[0])) return;</span><br><span class="line"></span><br><span class="line">        decodeCode += path + &#x27;&#x27;;</span><br><span class="line">        funcNames.push(id.name);</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;VariableDeclarator&quot;(path) &#123;</span><br><span class="line">        let &#123; parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isVariableDeclaration()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(id) || !types.isFunctionExpression(init)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; params, body &#125; = init;</span><br><span class="line">        if (params.length != 5 || body.body.length != 1) return;</span><br><span class="line">        if (!types.isReturnStatement(body.body[0])) return;</span><br><span class="line">        decodeCode += path + &#x27;&#x27;;</span><br><span class="line">        funcNames.push(id.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, collectObFuncs);</span><br><span class="line">eval(decodeCode); // æ”¶é›†çš„å‡½æ•°ä¸ºå­—ç¬¦ä¸²ï¼Œéœ€è¦åœ¨è¿™ä¸ª js æ–‡ä»¶æ‰§è¡Œä¸€æ¬¡</span><br><span class="line">// è¿˜åŸè°ƒç”¨è¡¨è¾¾å¼</span><br><span class="line">const callToString = &#123;</span><br><span class="line">    CallExpression(path) &#123;</span><br><span class="line">        let &#123; callee, arguments &#125; = path.node;</span><br><span class="line">        if (!types.isIdentifier(callee) || !funcNames.includes(callee.name) || arguments.length != 5 || !isNodeLiteral(arguments)) return;</span><br><span class="line"></span><br><span class="line">        value = eval(path + &#x27;&#x27;);</span><br><span class="line">        console.log(path + &#x27;&#x27;, &#x27;--&gt;&#x27;, value);</span><br><span class="line">        path.replaceWith(types.valueToNode(value));</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, callToString);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line">// åˆ é™¤æ²¡æœ‰è°ƒç”¨çš„å‡½æ•°</span><br><span class="line">const removeNoCallFuncs = &#123;</span><br><span class="line">    &quot;FunctionDeclaration&quot;(path) &#123;</span><br><span class="line">        let &#123; scope, node &#125; = path;</span><br><span class="line">        let name = node.id.name;</span><br><span class="line"></span><br><span class="line">        scope.crawl();</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (!constant &amp;&amp; constantViolations[0] != path) return;</span><br><span class="line">        console.log(&quot;åˆ é™¤æ— ç”¨ FunctionDeclaration:&quot;, path.toString());</span><br><span class="line">        path.remove();</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;VariableDeclarator&quot;(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isVariableDeclaration()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(id) || !types.isFunctionExpression(init)) return;</span><br><span class="line">        let name = id.name;</span><br><span class="line"></span><br><span class="line">        scope.crawl();</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (!constant &amp;&amp; constantViolations[0] != path) return;</span><br><span class="line">        console.log(&quot;åˆ é™¤æ— ç”¨ VariableDeclarator:&quot;, path.toString());</span><br><span class="line">        path.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, removeNoCallFuncs);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="2-æ’ä»¶-object-å¯¹è±¡åˆå¹¶"><a href="#2-æ’ä»¶-object-å¯¹è±¡åˆå¹¶" class="headerlink" title="2. æ’ä»¶ -&gt; object å¯¹è±¡åˆå¹¶"></a>2. æ’ä»¶ -&gt; object å¯¹è±¡åˆå¹¶</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// objectå¯¹è±¡åˆå¹¶</span><br><span class="line">const preDecodeObject = &#123;</span><br><span class="line">    // é’ˆå¯¹OBæ··æ·†ï¼Œobæ··æ·†ä¸­éƒ½æ˜¯å®šä¹‰çš„ï¼Œ5ç§’ç›¾ä¸­éƒ½æ˜¯èµ‹å€¼çš„</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; node, parentPath, scope &#125;=path;</span><br><span class="line">        const &#123; id, init &#125; = node;</span><br><span class="line">        if (!types.isObjectExpression(init)) return;</span><br><span class="line"></span><br><span class="line">        let name = id.name;</span><br><span class="line">        let properties = init.properties;</span><br><span class="line">        if (properties.length != 0) return;</span><br><span class="line">        </span><br><span class="line">        let allNextSiblings = parentPath.getAllNextSiblings();</span><br><span class="line">        for (let nextSibling of allNextSiblings) &#123;</span><br><span class="line">            if (!nextSibling.isExpressionStatement()) continue;</span><br><span class="line"></span><br><span class="line">            let expression = nextSibling.get(&#x27;expression&#x27;);</span><br><span class="line">            if (!expression.isAssignmentExpression(&#123; operator: &quot;=&quot; &#125;)) break;</span><br><span class="line"></span><br><span class="line">            let &#123; left, right &#125; = expression.node;</span><br><span class="line">            if (!types.isMemberExpression(left)) break;</span><br><span class="line">            </span><br><span class="line">            let &#123; object, property &#125; = left;</span><br><span class="line">            if (!types.isIdentifier(object, &#123; name: name &#125;) || !types.isStringLiteral(property)) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            properties.push(types.ObjectProperty(property, right));</span><br><span class="line">            nextSibling.remove();</span><br><span class="line">        &#125;</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, preDecodeObject);</span><br></pre></td></tr></table></figure>

<h3 id="3-æ’ä»¶-æ·±æ‹·è´èµ‹å€¼å¼•ç”¨"><a href="#3-æ’ä»¶-æ·±æ‹·è´èµ‹å€¼å¼•ç”¨" class="headerlink" title="3. æ’ä»¶ -&gt; æ·±æ‹·è´èµ‹å€¼å¼•ç”¨"></a>3. æ’ä»¶ -&gt; æ·±æ‹·è´èµ‹å€¼å¼•ç”¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// æ·±æ‹·è´èµ‹å€¼å¼•ç”¨</span><br><span class="line">const deepCopy = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, node &#125; = path;</span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(id) || !types.isObjectExpression(init)) return;</span><br><span class="line"></span><br><span class="line">        let name = id.name;</span><br><span class="line">        let object = init;</span><br><span class="line">        let allNextSiblings = parentPath.getAllNextSiblings();</span><br><span class="line">        for (let nextSibling of allNextSiblings) &#123;</span><br><span class="line">            if (!nextSibling.isVariableDeclaration()) continue;</span><br><span class="line"></span><br><span class="line">            let declarations = nextSibling.get(&#x27;declarations&#x27;)[0];</span><br><span class="line">            if (!declarations.isVariableDeclarator()) break;</span><br><span class="line"></span><br><span class="line">            let &#123; id, init &#125; = declarations.node;</span><br><span class="line">            if (!types.isIdentifier(id) || !types.isIdentifier(init, &#123; name: name &#125;)) break;</span><br><span class="line">            declarations.node.init = object;</span><br><span class="line"></span><br><span class="line">            let binding = scope.getBinding(name);</span><br><span class="line">            let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">            console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">            if (references != 1 || !constant) return;</span><br><span class="line">            console.log(&quot;æ·±æ‹·è´èµ‹å€¼å¼•ç”¨&quot;, &quot;åˆ é™¤ --&gt; åŸå¯¹è±¡:&quot;, id.name);</span><br><span class="line">            path.remove();</span><br><span class="line">        &#125;</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, deepCopy);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="4-æ’ä»¶-obj-å¯¹è±¡-value-å®ç°"><a href="#4-æ’ä»¶-obj-å¯¹è±¡-value-å®ç°" class="headerlink" title="4. æ’ä»¶ -&gt; obj å¯¹è±¡ value å®ç°"></a>4. æ’ä»¶ -&gt; obj å¯¹è±¡ value å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">// Object å¯¹è±¡çš„ value å€¼å®ç°è¿˜åŸ</span><br><span class="line">function isBaseLiteral(node) &#123;</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node) &amp;&amp; node.value != null) return true; // nullå¯èƒ½æœ‰å‘</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; literalList.includes(node.name)) return true;</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; typeof globalThis[node.name] != &quot;undefined&quot;) return true;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; [&quot;+&quot;, &quot;-&quot;, &quot;!&quot;].includes(node.operator)) &#123;</span><br><span class="line">        if (types.isArrayExpression(node.argument) &amp;&amp; node.argument.elements.length == 0) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return isBaseLiteral(node.argument);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const newDecodeObject = &#123;</span><br><span class="line">    // AssignmentExpressionå¯¹åº”5sç›¾ï¼ŒVariableDeclaratorå¯¹åº”obæ··æ·†</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isVariableDeclaration()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(id) || !types.isObjectExpression(init)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; properties &#125; = init;</span><br><span class="line">        if (properties.length == 0) return;</span><br><span class="line"></span><br><span class="line">        let name = id.name;</span><br><span class="line">        scope.crawl();</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        var &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (!constant &amp;&amp; constantViolations[0] != path) return;</span><br><span class="line"></span><br><span class="line">        // Map å¯¹è±¡ç”¨äºå­˜å‚¨é”®å€¼å¯¹ï¼Œå…¶ä¸­é”®å’Œå€¼éƒ½å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼›</span><br><span class="line">        // Map ä¿æŒé”®å€¼å¯¹çš„æ’å…¥é¡ºåºï¼Œè¿™æ„å‘³ç€è¿­ä»£é”®å€¼å¯¹æ—¶çš„é¡ºåºä¸æ’å…¥å®ƒä»¬æ—¶çš„é¡ºåºç›¸åŒ</span><br><span class="line">        let newMap = new Map();</span><br><span class="line">        for (const property of properties) &#123;</span><br><span class="line">            if (!property.key) break; // ES6è¯­æ³•æ²¡æœ‰key</span><br><span class="line"></span><br><span class="line">            let propKey = property.key.value;</span><br><span class="line">            let propValue = property.value;</span><br><span class="line">            if (isBaseLiteral(propValue)) &#123;</span><br><span class="line">                newMap.set(propKey, propValue.value); // å¦‚æœæ˜¯å­—ç¬¦ä¸²å°±ç›´æ¥å­˜å…¥å­—ç¬¦ä¸²</span><br><span class="line">            &#125;</span><br><span class="line">            else if (types.isFunctionExpression(propValue)) &#123;</span><br><span class="line">                let retState = propValue.body.body; // ç›´æ¥è·å–åˆ° return è¯­å¥</span><br><span class="line">                if (retState.length == 1 &amp;&amp; types.isReturnStatement(retState[0])) &#123;</span><br><span class="line">                    let argument = retState[0].argument;</span><br><span class="line">                    if (types.isCallExpression(argument)) &#123;</span><br><span class="line">                        newMap.set(propKey, &quot;Call&quot;); // å¦‚æœæ˜¯è°ƒç”¨è¡¨è¾¾å¼å°±å­˜å…¥ call ç‰¹è¯</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (types.isBinaryExpression(argument) || types.isLogicalExpression(argument)) &#123;</span><br><span class="line">                        newMap.set(propKey, argument.operator);</span><br><span class="line">                        // å¦‚æœæ˜¯äºŒé¡¹å¼è¡¨è¾¾å¼æˆ–è€…é€»è¾‘è¡¨è¾¾å¼ï¼Œå°±å­˜å…¥ operator æ“ä½œç¬¦</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // console.log(newMap);</span><br><span class="line"></span><br><span class="line">        if (newMap.size != properties.length) return;  // åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡ä¸­æ˜¯å¦å¤„ç†å®Œæ‰€æœ‰key</span><br><span class="line">        // éå†è¿˜åŸæ¯ä¸€ä¸ªå¼•ç”¨çš„åœ°æ–¹</span><br><span class="line">        for (const referPath of referencePaths.reverse()) &#123;</span><br><span class="line">            let &#123; node, parent, parentPath &#125; = referPath;</span><br><span class="line">            let ancestorPath = parentPath.parentPath; // å®å‚è¦é€šè¿‡ç¥–å…ˆèŠ‚ç‚¹è·å–ï¼Œaz[&#x27;XFB&#x27;](&#x27;L&#x27;,&#x27;OG&#x27;);</span><br><span class="line">            if (!parentPath.isMemberExpression(&#123; object: node &#125;)) continue;</span><br><span class="line"></span><br><span class="line">            let property = parent.property;</span><br><span class="line">            let propKey = types.isIdentifier(property) ? property.name : property.value;</span><br><span class="line">            let propValue = newMap.get(propKey);</span><br><span class="line">            if (!propValue) continue;</span><br><span class="line"></span><br><span class="line">            if (ancestorPath.isCallExpression(&#123; callee: parent &#125;)) &#123;</span><br><span class="line">                let &#123; arguments &#125; = ancestorPath.node;</span><br><span class="line">                switch (propValue) &#123;</span><br><span class="line">                    case &quot;Call&quot;:</span><br><span class="line">                        ancestorPath.replaceWith(types.callExpression(arguments[0], arguments.slice(1)));</span><br><span class="line">                        break;</span><br><span class="line">                    case &quot;||&quot;:</span><br><span class="line">                    case &quot;&amp;&amp;&quot;:</span><br><span class="line">                        ancestorPath.replaceWith(types.logicalExpression(propValue, arguments[0], arguments[1]));</span><br><span class="line">                        break;</span><br><span class="line">                    default:</span><br><span class="line">                        ancestorPath.replaceWith(types.binaryExpression(propValue, arguments[0], arguments[1]));</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                parentPath.replaceWith(types.valueToNode(propValue));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        scope.crawl();</span><br><span class="line">        let newbinding = scope.getBinding(name);</span><br><span class="line">        if (!newbinding) return;</span><br><span class="line">        var &#123; referenced, references, constant, constantViolations, referencePaths &#125; = newbinding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        if (references != 0) return;  // å…¶ä½™åˆ¤æ–­åœ¨å¤–å±‚å·²ç»åˆ¤æ–­è¿‡äº†</span><br><span class="line">        console.log(&quot;è¿˜åŸObjectå¯¹è±¡ååˆ é™¤å½¢å‚ä¸æ— ç”¨åŸèŠ‚ç‚¹:&quot;, path + &#x27;&#x27;);</span><br><span class="line">        path.remove();  // è¿™é‡Œä¸åˆ çˆ¶èŠ‚ç‚¹ï¼Œæ˜¯å› ä¸ºçˆ¶èŠ‚ç‚¹å¯èƒ½æ˜¯å¤šä¸ªå˜é‡çš„å£°æ˜å®šä¹‰ï¼Œä¸èƒ½å…¨åˆ ï¼Œåªèƒ½åˆ å½“å‰è¿™ä¸ª</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, newDecodeObject);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="5-æ’ä»¶-å¤„ç†å¹³å¦æ§åˆ¶æµ"><a href="#5-æ’ä»¶-å¤„ç†å¹³å¦æ§åˆ¶æµ" class="headerlink" title="5. æ’ä»¶ -&gt; å¤„ç†å¹³å¦æ§åˆ¶æµ"></a>5. æ’ä»¶ -&gt; å¤„ç†å¹³å¦æ§åˆ¶æµ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">// å¹³å¦æ§åˆ¶æµå¤„ç†ï¼Œswitch-caseè¯­å¥</span><br><span class="line">const decodeObWhileSwitch = &#123;</span><br><span class="line">    &quot;WhileStatement&quot;(path) &#123;</span><br><span class="line">        let &#123; node, scope, praent, praentPath &#125; = path;</span><br><span class="line">        let &#123; test, body &#125; = node;</span><br><span class="line">        if (!types.isBooleanLiteral(test) || body.body.length != 2) return;</span><br><span class="line"></span><br><span class="line">        let [switchNode, breakNode] = body.body;</span><br><span class="line">        if (!types.isSwitchStatement(switchNode) || !types.isBreakStatement(breakNode)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; discriminant, cases &#125; = switchNode;</span><br><span class="line">        if (!types.isMemberExpression(discriminant)) return;</span><br><span class="line"></span><br><span class="line">        let arrName = switchNode.discriminant.object.name;</span><br><span class="line">        let binding = scope.getBinding(arrName);</span><br><span class="line">        if (!binding || !binding.path || !binding.path.isVariableDeclarator()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        console.log(&quot;å¤„ç†å¹³å¦æ§åˆ¶æµ:&quot;, arrName, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        let &#123; id, init &#125; = binding.path.node; // ç»‘å®šçš„ path å°±æ˜¯åœ¨è¿™ä¸ªä½œç”¨åŸŸä¸­ç¬¬ä¸€æ¬¡å‡ºç°ï¼ˆå®šä¹‰ï¼‰çš„ä½ç½®</span><br><span class="line">        if (!types.isIdentifier(id, &#123; name: arrName &#125;) || !types.isCallExpression(init)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; callee, arguments &#125; = init;</span><br><span class="line">        if (!types.isMemberExpression(callee) || arguments.length != 1) return;</span><br><span class="line"></span><br><span class="line">        let &#123; object, property &#125; = callee;</span><br><span class="line">        if (!types.isStringLiteral(object) || !types.isStringLiteral(property, &#123; value: &#x27;split&#x27; &#125;)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        let disPatchArray = object.value.split(&#x27;|&#x27;);</span><br><span class="line">        let retBody = [];</span><br><span class="line">        disPatchArray.forEach(index =&gt; &#123;</span><br><span class="line">            let caseArr = cases[index].consequent;</span><br><span class="line">            if (types.isContinueStatement(caseArr[caseArr.length - 1])) &#123;</span><br><span class="line">                caseArr.pop() // å¦‚æœcaseä¸­æœ€åä¸€æ¡è¯­å¥æ˜¯continueè¯­å¥ï¼Œåˆ™åˆ é™¤æœ€åä¸€æ¡</span><br><span class="line">            &#125;</span><br><span class="line">            retBody = retBody.concat(caseArr);</span><br><span class="line">        &#125;);</span><br><span class="line">        path.replaceWithMultiple(retBody);</span><br><span class="line">        if (references == 1 &amp;&amp; (constant || constantViolations[0] == binding.path)) &#123;</span><br><span class="line">            // åœ¨ for å¾ªç¯ä¸­çš„å˜é‡å®šä¹‰ï¼Œå…¶ç»‘å®šä¸­ä¼šè¢«è®°å½•ä¸ºæ”¹å˜äº†ä¸€æ¬¡</span><br><span class="line">            binding.path.remove()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, decodeObWhileSwitch);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h2 id="ä¹ã€é‡ç‚¹-AST-è¿˜åŸä¸“é¢˜"><a href="#ä¹ã€é‡ç‚¹-AST-è¿˜åŸä¸“é¢˜" class="headerlink" title="ä¹ã€é‡ç‚¹ AST è¿˜åŸä¸“é¢˜"></a>ä¹ã€é‡ç‚¹ AST è¿˜åŸä¸“é¢˜</h2><h3 id="1-æ¡ˆä¾‹-å¤æ‚æ§åˆ¶æµè¿˜åŸ"><a href="#1-æ¡ˆä¾‹-å¤æ‚æ§åˆ¶æµè¿˜åŸ" class="headerlink" title="1. æ¡ˆä¾‹ -&gt; å¤æ‚æ§åˆ¶æµè¿˜åŸ"></a>1. æ¡ˆä¾‹ -&gt; å¤æ‚æ§åˆ¶æµè¿˜åŸ</h3><blockquote>
<p><strong>encode.js ç‰¹å¾ï¼š</strong></p>
<ol>
<li>æ¯ä¸€ä¸ª case è¯­å¥æœ€åä¸€æ®µä»£ç ï¼Œéƒ½æ˜¯ break è¯­å¥</li>
<li>æ²¡æœ‰ default è¯­å¥</li>
<li>æ¯ä¸€ä¸ª case è¯­å¥çš„å€’æ•°ç¬¬äºŒæ®µä»£ç ï¼Œæ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ª case è¯­å¥çš„ testã€æ¡ä»¶è¡¨è¾¾å¼ã€æˆ–è€…æ˜¯ return è¯­å¥</li>
</ol>
<p><strong>è¿˜åŸæ€è·¯ï¼š</strong></p>
<ol>
<li>ç»™ return è¯­å¥çš„åé¢åŠ ä¸Š break è¯­å¥ï¼Œæ–¹ä¾¿ç»Ÿä¸€å¤„ç†</li>
<li>å…ˆå¤„ç†å•çº¿æ§åˆ¶ï¼Œå³æŒ‡å‘å½“å‰ case çš„è¯­å¥ä¸ªæ•°åªæœ‰ä¸€ä¸ªï¼Œåˆ™å°†å½“å‰è¯­å¥ä¸ä¸Šä¸€ä¸ª case è¯­å¥å•çº¿åˆå¹¶</li>
<li>å†å¤„ç†æ¡ä»¶è¡¨è¾¾å¼ï¼Œè¿˜åŸä¸º while å¾ªç¯å¹¶åˆ é™¤ case è¯­å¥</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">function test(cU, cV) &#123;</span><br><span class="line">    var guagua = &quot;å‘±å‘±&quot;;</span><br><span class="line">    var cW = 1;</span><br><span class="line"></span><br><span class="line">    while (cW !== 0) &#123;</span><br><span class="line">        switch (cW) &#123;</span><br><span class="line">            case 1:</span><br><span class="line">                var cZ = [];</span><br><span class="line">                cW = 5;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 2:</span><br><span class="line">                cW = d0 &lt; cU ? 7 : 3;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 3:</span><br><span class="line">                cW = d1 &lt; cU ? 8 : 4;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 4:</span><br><span class="line">                return cZ;</span><br><span class="line"></span><br><span class="line">            case 5:</span><br><span class="line">                var d0 = 0;</span><br><span class="line">                cW = 6;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 6:</span><br><span class="line">                var d1 = 0;</span><br><span class="line">                cW = 2;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 7:</span><br><span class="line">                cZ[(d0 + cV) % cU] = [];</span><br><span class="line">                cW = 9;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 8:</span><br><span class="line">                var d2 = cU - 1;</span><br><span class="line">                cW = 10;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 9:</span><br><span class="line">                d0++;</span><br><span class="line">                cW = 2;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 10:</span><br><span class="line">                cW = d2 &gt;= 0 ? 12 : 11;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 11:</span><br><span class="line">                d1++;</span><br><span class="line">                cW = 3;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 12:</span><br><span class="line">                cZ[d1][(d2 + cV * d1) % cU] = cZ[d2];</span><br><span class="line">                cW = 13;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 13:</span><br><span class="line">                d2--;</span><br><span class="line">                cW = 10;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><strong>æ‰‹åŠ¨è¿˜åŸï¼š</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function test(cU, cV) &#123;</span><br><span class="line">	var guagua = &quot;å‘±å‘±&quot;;</span><br><span class="line">	var cW = 1;</span><br><span class="line">	</span><br><span class="line">	var cZ = [];</span><br><span class="line">	var d0 = 0;</span><br><span class="line">	var d1 = 0;</span><br><span class="line">	while (d0 &lt; cU) &#123;</span><br><span class="line">		cZ[(d0 + cV) % cU] = [];</span><br><span class="line">		d0++;</span><br><span class="line">	&#125;</span><br><span class="line">	while (d1 &lt; cU) &#123;</span><br><span class="line">		var d2 = cU - 1;</span><br><span class="line">		while (d2 &gt;= 0) &#123;</span><br><span class="line">			cZ[d1][(d2 + cV * d1) % cU] = cZ[d2];</span><br><span class="line">			d2--;</span><br><span class="line">		&#125;</span><br><span class="line">		d1++;</span><br><span class="line">	&#125;</span><br><span class="line">	return cZ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>AST è¿˜åŸï¼š</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">// ç»™caseè¯­å¥ç»“å°¾ç»Ÿä¸€åŠ ä¸Š break è¯­å¥ï¼Œæœ‰åˆ™ä¸åŠ </span><br><span class="line">const addBreakStatement = &#123;</span><br><span class="line">    SwitchCase(&#123; node &#125;) &#123;</span><br><span class="line">        let &#123; test, consequent &#125; = node;</span><br><span class="line">        if (types.isBreakStatement(consequent[consequent.length - 1])) return;</span><br><span class="line">        consequent.push(types.breakStatement());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, addBreakStatement)</span><br><span class="line">// å‡½æ•°ï¼šæ ¹æ®caseçš„testæ¡ä»¶ï¼Œè·å–å¯¹åº”caseçš„nodeèŠ‚ç‚¹ï¼Œè¿˜å¯ä»¥åˆ¤æ–­æ˜¯å¦åˆ é™¤èŠ‚ç‚¹</span><br><span class="line">function getItemFromTestValue(path, testValue, is_remove) &#123;</span><br><span class="line">    let &#123; cases &#125; = path.node;</span><br><span class="line">    for (let caseIndex in cases) &#123;</span><br><span class="line">        let caseItem = cases[caseIndex];</span><br><span class="line">        if (caseItem.test.value == testValue) &#123;</span><br><span class="line">            if (is_remove) &#123;</span><br><span class="line">                return cases.splice(caseIndex, 1)[0]; // ä»å½“å‰ç´¢å¼•å¼€å§‹åˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›è¢«åˆ é™¤çš„å…ƒç´ æ•°ç»„</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return caseItem</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">const dealWithSwitch = &#123;</span><br><span class="line">    SwitchStatement(path) &#123;</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; cases &#125; = node;</span><br><span class="line">        // ä¸ç®¡switchä»å“ªé‡Œå¼€å§‹ï¼Œå…ˆå•çº¿åˆå¹¶ï¼Œå†å¤„ç†æ¡ä»¶è¡¨è¾¾å¼å¹¶ç”¨whileå¾ªç¯æ›¿æ¢</span><br><span class="line">        for (let i = 0; i &lt; cases.length; i++) &#123;</span><br><span class="line">            let &#123; test, consequent &#125; = cases[i];</span><br><span class="line">            let jumpTo = consequent[consequent.length - 2].expression; // æ§åˆ¶caseè·³è½¬çš„èµ‹å€¼è¯­å¥</span><br><span class="line">            if (!types.isAssignmentExpression(jumpTo)) continue;</span><br><span class="line"></span><br><span class="line">            // 1. å½“è·³è½¬è¯­å¥çš„å³èŠ‚ç‚¹æ˜¯å­—é¢é‡æ—¶</span><br><span class="line">            if (types.isLiteral(jumpTo.right)) &#123;</span><br><span class="line">                // æ•°ç»„çš„é•¿åº¦å«ä¹‰ï¼šä»£è¡¨æŒ‡å‘ä¸‹ä¸€ä¸ªcaseå—çš„èµ‹å€¼è¯­å¥çš„æ•°é‡ï¼Œå³è¢«æŒ‡å‘çš„csaeå—æœ‰å‡ æ¬¡å¼•ç”¨</span><br><span class="line">                let newArr = cases.filter(element =&gt; &#123;</span><br><span class="line">                    let jumpto = element.consequent[element.consequent.length - 2].expression</span><br><span class="line">                    return generator(jumpto).code == generator(jumpTo).code;</span><br><span class="line">                &#125;);</span><br><span class="line">                // å¦‚æœåªæœ‰ä¸€æ¬¡ï¼Œåˆ™å¯ä»¥åˆå¹¶</span><br><span class="line">                if (newArr.length == 1) &#123;</span><br><span class="line">                    let nextItem = getItemFromTestValue(path, jumpTo.right.value, true);</span><br><span class="line">                    let nextItemConsequent = nextItem.consequent;</span><br><span class="line">                    consequent.splice(consequent.length - 2, 2, ...nextItemConsequent)</span><br><span class="line">                    i = -1; // æ¯åˆå¹¶ä¸€æ¬¡åˆä»å¤´éå†ï¼Œå› ä¸ºè¢«åˆå¹¶è¿‡çš„è¯­å¥å—å¯èƒ½è¿˜éœ€è¦å†æ¬¡åˆå¹¶</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // 2. å½“è·³è½¬è¯­å¥çš„å³èŠ‚ç‚¹æ˜¯æ¡ä»¶è¡¨è¾¾å¼æ—¶</span><br><span class="line">            if (types.isConditionalExpression(jumpTo.right)) &#123;</span><br><span class="line">                let nextTest = jumpTo.right.test</span><br><span class="line">                let nextConsequent = jumpTo.right.consequent</span><br><span class="line">                let nextAlternate = jumpTo.right.alternate</span><br><span class="line"></span><br><span class="line">                let nextItem = getItemFromTestValue(path, nextConsequent.value, false);</span><br><span class="line">                let nextItemConsequent = nextItem.consequent;</span><br><span class="line">                let nextJumpTo = nextItemConsequent[nextItemConsequent.length - 2].expression</span><br><span class="line">                if (!types.isAssignmentExpression(nextJumpTo) || !types.isLiteral(nextJumpTo.right)) continue;</span><br><span class="line"></span><br><span class="line">                if (nextJumpTo.right.value == test.value) &#123;</span><br><span class="line">                    let bodyNode = nextItemConsequent.slice(0, nextItemConsequent.length - 2);</span><br><span class="line">                    let whileNode = types.whileStatement(nextTest, types.blockStatement(bodyNode));</span><br><span class="line">                    consequent.splice(consequent.length - 2, 0, whileNode); // åˆ é™¤0ï¼Œåˆ™è¡¨ç¤ºæ’å…¥whileè¯­å¥</span><br><span class="line"></span><br><span class="line">                    getItemFromTestValue(path, nextConsequent.value, true);</span><br><span class="line">                    jumpTo.right = nextAlternate;</span><br><span class="line">                    i = -1;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // è¿˜åŸåˆ°æœ€åï¼Œåªå‰©ä¸€å±‚caseè¯­å¥ï¼Œåˆ™å¯ä»¥å°†æ•´æ®µä»£ç ä»switchä¸­è„±ç¦»å‡ºæ¥</span><br><span class="line">        if (cases.length == 1) &#123;</span><br><span class="line">            let caseNode = cases[0].consequent;</span><br><span class="line">            if (types.isBreakStatement(caseNode[caseNode.length - 1])) &#123;</span><br><span class="line">                caseNode.pop();</span><br><span class="line">            &#125;</span><br><span class="line">            parentPath.parentPath.replaceWithMultiple(caseNode);</span><br><span class="line">        &#125;</span><br><span class="line">        scope.crawl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, dealWithSwitch);</span><br></pre></td></tr></table></figure>

<h3 id="2-æ¡ˆä¾‹ä¼˜åŒ–-å¤æ‚æ§åˆ¶æµè¿˜åŸ"><a href="#2-æ¡ˆä¾‹ä¼˜åŒ–-å¤æ‚æ§åˆ¶æµè¿˜åŸ" class="headerlink" title="2. æ¡ˆä¾‹ä¼˜åŒ– -&gt; å¤æ‚æ§åˆ¶æµè¿˜åŸ"></a>2. æ¡ˆä¾‹ä¼˜åŒ– -&gt; å¤æ‚æ§åˆ¶æµè¿˜åŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">// å‡½æ•°ï¼šæ ¹æ®caseçš„testæ¡ä»¶ï¼Œè·å–å¯¹åº”caseçš„nodeèŠ‚ç‚¹ï¼Œè¿˜å¯ä»¥åˆ¤æ–­æ˜¯å¦åˆ é™¤èŠ‚ç‚¹</span><br><span class="line">function getItemFromTestValue(path, testValue, is_remove) &#123;</span><br><span class="line">    let &#123; cases &#125; = path.node;</span><br><span class="line">    for (let caseIndex in cases) &#123;</span><br><span class="line">        let caseItem = cases[caseIndex];</span><br><span class="line">        if (caseItem.test.value == testValue) &#123;</span><br><span class="line">            if (is_remove) &#123;</span><br><span class="line">                return cases.splice(caseIndex, 1)[0]; // ä»å½“å‰ç´¢å¼•å¼€å§‹åˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›è¢«åˆ é™¤çš„å…ƒç´ æ•°ç»„</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return caseItem</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">const dealWithSwitch = &#123;</span><br><span class="line">    SwitchStatement(path) &#123;</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; discriminant, cases &#125; = node;</span><br><span class="line">        let name = discriminant.name;</span><br><span class="line"></span><br><span class="line">        /* è·å– switch-case çš„åˆå§‹caseæ¡ä»¶ï¼Œé€šå¸¸åœ¨å¤–å±‚ for å¾ªç¯çš„initä¸­å®šä¹‰</span><br><span class="line">            let binding = scope.getBinding(name);</span><br><span class="line">            if (!binding) return;</span><br><span class="line">            let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">            // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">            if (!binding.path.isVariableDeclarator() &amp;&amp; !binding.path.isAssignmentExpression()) return;</span><br><span class="line">            if (binding.path.isVariableDeclarator() &amp;&amp; (startValue = binding.path.node.init) &amp;&amp; !types.isLiteral(startValue)) return;</span><br><span class="line">            if (binding.path.isAssignmentExpression() &amp;&amp; (startValue = binding.path.node.right) &amp;&amp; !types.isLiteral(startValue)) return;</span><br><span class="line">        */</span><br><span class="line">        if (!parentPath.parentPath.isForStatement()) return;</span><br><span class="line">        let &#123; init &#125; = parentPath.parentPath.node;</span><br><span class="line">        init = types.isVariableDeclaration(init) ? init.declarations[init.declarations.length - 1] : init;</span><br><span class="line">        if (!types.isVariableDeclarator(init) &amp;&amp; !types.isAssignmentExpression(init)) return;</span><br><span class="line">        if (types.isVariableDeclarator(init) &amp;&amp; (startValue = init.init) &amp;&amp; !types.isLiteral(startValue)) return;</span><br><span class="line">        if (types.isAssignmentExpression(init) &amp;&amp; (startValue = init.right) &amp;&amp; !types.isLiteral(startValue)) return;</span><br><span class="line"></span><br><span class="line">        // ä¸ç®¡switchä»å“ªé‡Œå¼€å§‹ï¼Œå…ˆå•çº¿åˆå¹¶ï¼Œå†å¤„ç†æ¡ä»¶è¡¨è¾¾å¼å¹¶ç”¨whileå¾ªç¯æ›¿æ¢</span><br><span class="line">        for (let i = 0; i &lt; cases.length; i++) &#123;</span><br><span class="line">            let &#123; test, consequent &#125; = cases[i];</span><br><span class="line">            let jumpTo = consequent.filter(ele =&gt; generator(ele).code.includes(name + &#x27; =&#x27;));</span><br><span class="line">            jumpTo = jumpTo[jumpTo.length - 1] ? jumpTo[jumpTo.length - 1].expression : null; // æ§åˆ¶caseè·³è½¬çš„èµ‹å€¼è¯­å¥</span><br><span class="line">            if (!types.isAssignmentExpression(jumpTo) || !types.isIdentifier(jumpTo.left, &#123; name: name &#125;)) continue;</span><br><span class="line"></span><br><span class="line">            // console.log(path + &#x27;&#x27;); // æ‰“å°å‡ºæ•´ä¸ªå¤„ç†è¿‡ç¨‹ï¼Œç”¨äºè°ƒè¯•</span><br><span class="line"></span><br><span class="line">            // 1. å½“è·³è½¬è¯­å¥çš„å³èŠ‚ç‚¹æ˜¯å­—é¢é‡æ—¶</span><br><span class="line">            if (types.isLiteral(jumpTo.right)) &#123;</span><br><span class="line">                // æ•°ç»„çš„é•¿åº¦å«ä¹‰ï¼šä»£è¡¨æŒ‡å‘ä¸‹ä¸€ä¸ªcaseå—çš„èµ‹å€¼è¯­å¥çš„æ•°é‡ï¼Œå³è¢«æŒ‡å‘çš„csaeå—æœ‰å‡ æ¬¡å¼•ç”¨</span><br><span class="line">                let newArr = cases.filter(ele =&gt; &#123;</span><br><span class="line">                    let jumpto = ele.consequent.filter(element =&gt; generator(element).code.includes(name + &#x27; =&#x27;));</span><br><span class="line">                    jumpto = jumpto[jumpto.length - 1] ? jumpto[jumpto.length - 1].expression : null; // æ§åˆ¶caseè·³è½¬çš„èµ‹å€¼è¯­å¥</span><br><span class="line">                    return generator(jumpto).code == generator(jumpTo).code;</span><br><span class="line">                &#125;);</span><br><span class="line">                // å¦‚æœåªæœ‰ä¸€æ¬¡ï¼Œåˆ™å¯ä»¥åˆå¹¶</span><br><span class="line">                if (newArr.length == 1) &#123;</span><br><span class="line">                    let nextItem = getItemFromTestValue(path, jumpTo.right.value, true);</span><br><span class="line">                    let nextItemConsequent = nextItem.consequent;</span><br><span class="line">                    // --------******** ç‰¹åˆ«æ³¨æ„ï¼šæ¯ä¸ªcaseæ›¿æ¢çš„è¡Œæ•°ç”±å®é™…æƒ…å†µè€Œå®š ********--------</span><br><span class="line">                    // ç»è¿‡æµ‹è¯•ï¼šä¸‹ä¸€ä¸ªcaseä¸­åªæœ‰ä¸€æ¡è¯­å¥ break; æ—¶è¿è¡Œæ­£å¸¸ï¼Œä½†æ˜¯å¦‚æœæ˜¯æ§åˆ¶caseè·³è½¬çš„èµ‹å€¼è¯­å¥ï¼Œå°±ä¼šè¿˜åŸé”™è¯¯</span><br><span class="line">                    consequent.splice(consequent.length - 2, 2, ...nextItemConsequent);</span><br><span class="line"></span><br><span class="line">                    i = -1; // æ¯åˆå¹¶ä¸€æ¬¡åˆä»å¤´éå†ï¼Œå› ä¸ºè¢«åˆå¹¶è¿‡çš„è¯­å¥å—å¯èƒ½è¿˜éœ€è¦å†æ¬¡åˆå¹¶</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // 2. å½“è·³è½¬è¯­å¥çš„å³èŠ‚ç‚¹æ˜¯æ¡ä»¶è¡¨è¾¾å¼æ—¶</span><br><span class="line">            if (types.isConditionalExpression(jumpTo.right)) &#123;</span><br><span class="line">                let newTest = jumpTo.right.test</span><br><span class="line">                let newConsequent = jumpTo.right.consequent</span><br><span class="line">                let newAlternate = jumpTo.right.alternate</span><br><span class="line"></span><br><span class="line">                let nextItem = getItemFromTestValue(path, newConsequent.value, false);</span><br><span class="line">                let nextItemConsequent = nextItem.consequent;</span><br><span class="line">                let nextJumpTo = nextItemConsequent.filter(ele =&gt; generator(ele).code.includes(name + &#x27; =&#x27;));</span><br><span class="line">                nextJumpTo = nextJumpTo[nextJumpTo.length - 1] ? nextJumpTo[nextJumpTo.length - 1].expression : null; // æ§åˆ¶caseè·³è½¬çš„èµ‹å€¼è¯­å¥</span><br><span class="line">                if (!types.isAssignmentExpression(nextJumpTo) || !types.isLiteral(nextJumpTo.right)) continue;</span><br><span class="line"></span><br><span class="line">                if (nextJumpTo.right.value == test.value) &#123;</span><br><span class="line">                    let bodyNode = nextItemConsequent.slice(0, nextItemConsequent.length - 2); // æˆªå–æœ‰æ•ˆå†…å®¹</span><br><span class="line">                    let whileNode = types.whileStatement(newTest, types.blockStatement(bodyNode));</span><br><span class="line">                    consequent.splice(consequent.length - 2, 0, whileNode); // åˆ é™¤0ï¼Œåˆ™è¡¨ç¤ºæ’å…¥whileè¯­å¥</span><br><span class="line"></span><br><span class="line">                    getItemFromTestValue(path, newConsequent.value, true);</span><br><span class="line">                    jumpTo.right = newAlternate;</span><br><span class="line">                    i = -1;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // è¿˜åŸåˆ°æœ€åï¼Œå°†æœ‰æ•ˆä»£ç ä»switchä¸­è„±ç¦»å‡ºæ¥</span><br><span class="line">        for (let item of cases) &#123;</span><br><span class="line">            let &#123; test, consequent &#125; = item;</span><br><span class="line">            if (test.value == startValue.value) &#123;</span><br><span class="line">                let lastSta = consequent[consequent.length - 1];</span><br><span class="line">                if (types.isBreakStatement(lastSta) || types.isContinueStatement(lastSta)) &#123;</span><br><span class="line">                    consequent.pop();</span><br><span class="line">                &#125;</span><br><span class="line">                parentPath.parentPath.replaceWithMultiple(consequent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, dealWithSwitch);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="3-æ¡†æ¶-é€šç”¨çº¯å‡½æ•°è¿˜åŸ"><a href="#3-æ¡†æ¶-é€šç”¨çº¯å‡½æ•°è¿˜åŸ" class="headerlink" title="3. æ¡†æ¶ -&gt; é€šç”¨çº¯å‡½æ•°è¿˜åŸ"></a>3. æ¡†æ¶ -&gt; é€šç”¨çº¯å‡½æ•°è¿˜åŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">// æ¡†æ¶ -&gt; é€šç”¨è¿˜åŸçº¯å‡½æ•°è°ƒç”¨è¡¨è¾¾å¼</span><br><span class="line">// åˆ¤æ–­å‡½æ•°æ˜¯å¦ä¸ºçº¯å‡½æ•°</span><br><span class="line">function isPureFunction(path) &#123;</span><br><span class="line">    let isPure = true;</span><br><span class="line"></span><br><span class="line">    // æ£€æŸ¥ body.body æ•°ç»„çš„æ¯è¡Œä»£ç æ˜¯å¦åŒ…å«å…¨å±€å±æ€§ï¼ŒåŒ…å«åˆ™ä¸è¿˜åŸï¼ŒåŒæ—¶è¿”å›å€¼ä¸å”¯ä¸€çš„ä¹Ÿä¸æ˜¯çº¯å‡½æ•°</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;, &#x27;try&#x27;, &#x27;random&#x27;, &#x27;Date&#x27;];</span><br><span class="line">    let sourceCode = path.toString();</span><br><span class="line">    let allElementsValid = literalList.every(ele =&gt; !sourceCode.includes(ele)); // ä¸º true åˆ™ä¸åŒ…å«ï¼Œä¸º false åˆ™è¯´æ˜åŒ…å«</span><br><span class="line">    if (!allElementsValid) return false; // åŒ…å«åˆ™ä¸æ˜¯çº¯å‡½æ•°</span><br><span class="line"></span><br><span class="line">    path.traverse(&#123;</span><br><span class="line">        MemberExpression(innerPath) &#123;</span><br><span class="line">            const &#123; object &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(object) &amp;&amp; object.name !== &#x27;this&#x27; &amp;&amp; !path.scope.hasBinding(object.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        AssignmentExpression(innerPath) &#123;</span><br><span class="line">            const &#123; left &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(left) &amp;&amp; !path.scope.hasBinding(left.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        CallExpression(innerPath) &#123;</span><br><span class="line">            const &#123; callee &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(callee)) &#123;</span><br><span class="line">                const binding = path.scope.getBinding(callee.name);</span><br><span class="line">                if (!binding || !isPureFunction(binding.path)) &#123;</span><br><span class="line">                    isPure = false;</span><br><span class="line">                    innerPath.stop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        UpdateExpression(innerPath) &#123;</span><br><span class="line">            const &#123; argument &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(argument) &amp;&amp; !path.scope.hasBinding(argument.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    return isPure;</span><br><span class="line">&#125;</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">// ä¸»è¦è¿˜åŸé€»è¾‘</span><br><span class="line">const callToString = &#123;</span><br><span class="line">    &quot;CallExpression&quot;: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; callee, arguments &#125; = path.node;</span><br><span class="line">            let &#123; name &#125; = callee;</span><br><span class="line">            if (!types.isIdentifier(callee) || arguments.length == 0 || !isNodeLiteral(arguments)) return;</span><br><span class="line"></span><br><span class="line">            let binding = path.scope.getBinding(name);</span><br><span class="line">            if (!binding) return;</span><br><span class="line"></span><br><span class="line">            let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">            // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">            // 1. å½“ binding.path ä¸ºå‡½æ•°æ—¶ï¼Œåªèƒ½è¿˜åŸçº¯å‡½æ•°</span><br><span class="line">            try &#123;</span><br><span class="line">                if (binding.path.isFunctionDeclaration()) &#123;</span><br><span class="line">                    // console.log(binding.path + &#x27;&#x27;, path + &#x27;&#x27;);</span><br><span class="line">                    // ******** ä¸ºè§£å†³ä¸‹é¢åœ¨ binding.path ä¸ºèµ‹å€¼è¯­å¥æ—¶çš„è¿˜åŸä¸­ï¼Œä¸è¿˜åŸå…¶æœ¬èº«çš„è°ƒç”¨è¡¨è¾¾å¼çš„é—®é¢˜ ******** </span><br><span class="line">                    if (decryptCode.includes(binding.path.toString().match(/function\s+\w+\s*\([^)]*\)/g)[0])) &#123;</span><br><span class="line"></span><br><span class="line">                        let value = eval(path.toString());</span><br><span class="line">                        console.log(path + &#x27;&#x27;, &quot;--&gt;&quot;, value,);</span><br><span class="line">                        path.replaceWith(types.valueToNode(value));</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (!isPureFunction(binding.path)) return; // åˆ¤æ–­å‡½æ•°æ˜¯å¦æ˜¯çº¯å‡½æ•°ï¼Œä¸æ˜¯åˆ™ä¸å¤„ç†</span><br><span class="line"></span><br><span class="line">                    let &#123; id, params, body &#125; = binding.path.node;</span><br><span class="line">                    if (params.length == 0 || body.body.length == 0) return;</span><br><span class="line">                    // ******** ä¸“ç”¨æ’ä»¶é…ç½®é™åˆ¶ï¼šå‡½æ•°åã€å‡½æ•°è°ƒç”¨çš„å®å‚ä¸ªæ•°ã€å‡½æ•°å®šä¹‰çš„å‡½æ•°ä½“å¤§å° ********</span><br><span class="line">                    if (id.name == &#x27;ln&#x27; || body.body.length &gt; 10) return;</span><br><span class="line">                    if (!types.isReturnStatement(body.body[body.body.length - 1])) return;</span><br><span class="line"></span><br><span class="line">                    eval(binding.path.toString());</span><br><span class="line"></span><br><span class="line">                    if (constantViolations.length &gt; 1) return;</span><br><span class="line">                    if (constant || constantViolations[0] == binding.path) &#123; // å¦‚æœä¸ºå¸¸é‡ï¼Œæˆ–æ›´æ”¹çš„é‚£ä¸€æ¬¡ä¸ºå®šä¹‰çš„é‚£ä¸€æ¬¡</span><br><span class="line">                        let value = eval(path.toString());</span><br><span class="line">                        console.log(path + &#x27;&#x27;, &#x27;--&gt;&#x27;, value);</span><br><span class="line">                        path.replaceWith(types.valueToNode(value));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (e) &#123; &#125;</span><br><span class="line">            // 2. å½“ binding.path ä¸ºèµ‹å€¼è¯­å¥æˆ–å˜é‡å®šä¹‰æ—¶ï¼Œéœ€è¦åœ¨ decode ä¸­å‡†å¤‡å”¯ä¸€è¢«è¿˜åŸå‡½æ•°</span><br><span class="line">            try &#123;</span><br><span class="line">                var funcNameArr = [&#x27;n&#x27;] // å”¯ä¸€è¢«è¿˜åŸå‡½æ•°çš„å‡½æ•°å</span><br><span class="line">                if (binding.path.isVariableDeclarator()) &#123;</span><br><span class="line">                    // console.log(binding.path.parentPath + &#x27;&#x27;, path + &#x27;&#x27;, referenced, references, constant, constantViolations.length);</span><br><span class="line">                    if (constantViolations.length &gt; 1) return;</span><br><span class="line">                    if (constant || (constantViolations.length == 1 &amp;&amp; constantViolations[0].isAssignmentExpression())) &#123; // å˜é‡å®šä¹‰åªæœ‰ä¸€æ¬¡æ”¹å˜ï¼Œæˆ–æ²¡æ”¹å˜</span><br><span class="line">                        // console.log(binding.path.parentPath + &#x27;&#x27;, path + &#x27;&#x27;);</span><br><span class="line">                        let &#123; id, init &#125; = binding.path.node;</span><br><span class="line">                        let &#123; name &#125; = id;</span><br><span class="line">                        if (init == null) &#123;</span><br><span class="line">                            init = types.identifier(constantViolations[0].node.right.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (!types.isIdentifier(id) || !funcNameArr.includes(init.name)) return;</span><br><span class="line">                        funcNameArr.push(name);</span><br><span class="line"></span><br><span class="line">                        let newCallExpression = types.callExpression(types.identifier(&#x27;n&#x27;), arguments);</span><br><span class="line">                        let value = eval(generator(newCallExpression).code);</span><br><span class="line">                        console.log(path + &#x27;&#x27;, &quot;--&gt;&quot;, value,);</span><br><span class="line">                        path.replaceWith(types.valueToNode(value));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, callToString);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line">// console.log(decryptCode);</span><br></pre></td></tr></table></figure>

<h3 id="4-æ¨¡ç‰ˆ-ä¸“ç”¨å‡½æ•°è¿˜åŸæ¨¡ç‰ˆ"><a href="#4-æ¨¡ç‰ˆ-ä¸“ç”¨å‡½æ•°è¿˜åŸæ¨¡ç‰ˆ" class="headerlink" title="4. æ¨¡ç‰ˆ -&gt; ä¸“ç”¨å‡½æ•°è¿˜åŸæ¨¡ç‰ˆ"></a>4. æ¨¡ç‰ˆ -&gt; ä¸“ç”¨å‡½æ•°è¿˜åŸæ¨¡ç‰ˆ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">// ä¸“ç”¨è°ƒç”¨è¡¨è¾¾å¼è¿˜åŸæ’ä»¶æ¨¡ç‰ˆ</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const tsCallToString = &#123;</span><br><span class="line">    // éå†å‡½æ•°å®šä¹‰æ˜¯å› ä¸ºç›´æ¥éå†è°ƒç”¨è¡¨è¾¾å¼è¿˜åŸåä¸å¥½åˆ é™¤</span><br><span class="line">    FunctionDeclaration(path) &#123;</span><br><span class="line">        let collectFuncCode = [];</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; id, params, body &#125; = node;</span><br><span class="line">        var name = id.name;</span><br><span class="line">        // ******** é…ç½®ä¸“ç”¨å‡½æ•°éœ€è¦è¿‡æ»¤çš„èŠ‚ç‚¹ ********</span><br><span class="line">        if (name != &#x27;ln&#x27;) return;</span><br><span class="line">        if (params.length != 2 || body.body.length != 1) return;</span><br><span class="line"></span><br><span class="line">        let binding = parentPath.scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        collectFuncCode.push(binding.path.toString());</span><br><span class="line"></span><br><span class="line">        // æ”¶é›†æ‰€æœ‰éœ€è¦çš„ç¯å¢ƒå‡½æ•°åˆ° collectFuncCode æ•°ç»„ä¸­ï¼Œæœ€ç»ˆæ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">        eval(collectFuncCode.join(&#x27;;&#x27;));</span><br><span class="line">        // console.log(collectFuncCode.join(&#x27;;&#x27;));</span><br><span class="line"></span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == binding.path) &#123;</span><br><span class="line">            let flag = true;</span><br><span class="line">            for (let referencePath of referencePaths) &#123;</span><br><span class="line">                let &#123; parentPath, node &#125; = referencePath;</span><br><span class="line">                if (!parentPath.isCallExpression(&#123; callee: node &#125;) || !isNodeLiteral(parentPath.node.arguments)) &#123;</span><br><span class="line">                    flag = false;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;;</span><br><span class="line">                // ä¸å¤„ç†ç¯å¢ƒå‡½æ•°ä¸­çš„è°ƒç”¨è¡¨è¾¾å¼ï¼Œä¼šæœ‰é—®é¢˜</span><br><span class="line">                if (parentPath.parentPath.isCallExpression() &amp;&amp; parentPath.parentPath.node.callee.name == &#x27;parseInt&#x27;) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                let value = eval(parentPath.toString());</span><br><span class="line">                console.log(parentPath + &#x27;&#x27;, &#x27;--&gt;&#x27;, value);</span><br><span class="line">                parentPath.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125;</span><br><span class="line">            if (flag) &#123;</span><br><span class="line">                // ä¸ä¸€å®šèƒ½åˆ ï¼Œæ ¹æ®å…·ä½“æƒ…å†µè€Œå®š</span><br><span class="line">                // path.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, tsCallToString);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="5-æ¡ˆä¾‹-datadomeè¿˜åŸ"><a href="#5-æ¡ˆä¾‹-datadomeè¿˜åŸ" class="headerlink" title="5. æ¡ˆä¾‹ -&gt; datadomeè¿˜åŸ"></a>5. æ¡ˆä¾‹ -&gt; datadomeè¿˜åŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br></pre></td><td class="code"><pre><span class="line">const _path = require(&#x27;path&#x27;);</span><br><span class="line">const files = require(&#x27;fs&#x27;);  // å¯¼å…¥æ–‡ä»¶åº“ï¼Œé˜²æ­¢ä¸fså˜é‡åå†²çª</span><br><span class="line">const types = require(&quot;@babel/types&quot;);</span><br><span class="line">const parser = require(&quot;@babel/parser&quot;);</span><br><span class="line">const template = require(&quot;@babel/template&quot;).default;</span><br><span class="line">const traverse = require(&quot;@babel/traverse&quot;).default;</span><br><span class="line">const generator = require(&quot;@babel/generator&quot;).default;</span><br><span class="line">const NodePath = require(&quot;@babel/traverse&quot;).NodePath; // æ™ºèƒ½æç¤ºæ‰€éœ€</span><br><span class="line"></span><br><span class="line">const encodeFile = _path.resolve(__dirname, &#x27;encode_ok.js&#x27;);</span><br><span class="line">const decodeFile = _path.resolve(__dirname, &#x27;ok_encode_ok.js&#x27;);</span><br><span class="line">let sourceCode = files.readFileSync(encodeFile, &#123; encoding: &quot;utf-8&quot; &#125;);</span><br><span class="line">let ast = parser.parse(sourceCode);</span><br><span class="line">console.time(&quot;å¤„ç†å®Œæ¯•ï¼Œè€—æ—¶&quot;);</span><br><span class="line"></span><br><span class="line">const decryptFile = _path.resolve(__dirname, &#x27;decode.js&#x27;);</span><br><span class="line">let decryptCode = files.readFileSync(decryptFile, &#123; encoding: &quot;utf-8&quot; &#125;); // è¯»å–è§£å¯†ä»£ç </span><br><span class="line">let evalAst = parser.parse(decryptCode);</span><br><span class="line">decryptCode = generator(evalAst, opts = &#123; compact: true &#125;).code // åˆ©ç”¨astå‹ç¼©ä»£ç </span><br><span class="line">eval(decryptCode);</span><br><span class="line"></span><br><span class="line">// ä¸“ç”¨è°ƒç”¨è¡¨è¾¾å¼è¿˜åŸæ’ä»¶æ¨¡ç‰ˆ</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const tsCallToString = &#123;</span><br><span class="line">    // éå†å‡½æ•°å®šä¹‰æ˜¯å› ä¸ºç›´æ¥éå†è°ƒç”¨è¡¨è¾¾å¼è¿˜åŸåä¸å¥½åˆ é™¤</span><br><span class="line">    FunctionDeclaration(path) &#123;</span><br><span class="line">        let &#123; node, parentPath &#125; = path;</span><br><span class="line">        let name = node.id.name;</span><br><span class="line">        if (name != &#x27;ln&#x27;) return;</span><br><span class="line"></span><br><span class="line">        let binding = parentPath.scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        let preNodePath = path.getPrevSibling();</span><br><span class="line">        eval(preNodePath.toString() + path.toString());</span><br><span class="line"></span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == binding.path) &#123;</span><br><span class="line">            let flag = true;</span><br><span class="line">            for (let referencePath of referencePaths) &#123;</span><br><span class="line">                let &#123; parentPath, node &#125; = referencePath;</span><br><span class="line">                if (!parentPath.isCallExpression(&#123; callee: node &#125;) || !isNodeLiteral(parentPath.node.arguments)) &#123;</span><br><span class="line">                    flag = false;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                let value = eval(parentPath.toString());</span><br><span class="line">                console.log(parentPath + &#x27;&#x27;, &#x27;--&gt;&#x27;, value);</span><br><span class="line">                parentPath.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125;</span><br><span class="line">            if (flag) &#123;</span><br><span class="line">                path.remove();</span><br><span class="line">                preNodePath.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, tsCallToString);</span><br><span class="line"></span><br><span class="line">// å˜é‡åˆå§‹åŒ–ä¸ºå­—é¢é‡ï¼Œä¸”æ²¡æœ‰ä¿®æ”¹çš„è¿˜åŸ</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isBaseLiteral(node) &#123;</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node) &amp;&amp; node.value != null) return true; // nullå¯èƒ½æœ‰å‘</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; literalList.includes(node.name)) return true;</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; typeof globalThis[node.name] != &quot;undefined&quot;) return true;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; [&quot;+&quot;, &quot;-&quot;, &quot;!&quot;].includes(node.operator)) &#123;</span><br><span class="line">        if (types.isArrayExpression(node.argument) &amp;&amp; node.argument.elements.length == 0) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return isBaseLiteral(node.argument);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const rebackVarDeclarator = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; scope, node &#125; = path;</span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(id) || init == null || !isBaseLiteral(init)) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(id.name);</span><br><span class="line">        if (!binding) return; // æ¦‚ç‡è¸©å‘æŠ¥é”™</span><br><span class="line">        let &#123; constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123; // å˜é‡å®šä¹‰åœ¨ for å¾ªç¯ä¸­æ˜¯ä¸€æ¬¡æ”¹å˜</span><br><span class="line">            for (let referencePath of referencePaths) &#123;</span><br><span class="line">                referencePath.replaceWith(init);</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&quot;å®šä¹‰å­—é¢é‡æœªæ”¹è¿˜åŸ&quot;, &quot;åˆ é™¤ --&gt; å˜é‡å®šä¹‰:&quot;, path.parentPath + &#x27;&#x27;);</span><br><span class="line">            path.remove(); // é¡ºä¾¿è¿˜æŠŠåˆå§‹åŒ–ä¸ºå¸¸é‡ï¼Œä½†æ²¡æœ‰ä½¿ç”¨è¿‡çš„å˜é‡å®šä¹‰ä¹Ÿåˆ äº†</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, rebackVarDeclarator);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// æŠ˜å è®¡ç®—éƒ¨åˆ†å­—é¢é‡æˆ–è¡¨è¾¾å¼</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const calcPartBinaryExpression = &#123;</span><br><span class="line">    &quot;BinaryExpression|UnaryExpression|ConditionalExpression|MemberExpression|CallExpression&quot;: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; parent, scope, parentPath, node &#125; = path;</span><br><span class="line">            let &#123; left, operator, right &#125; = node;</span><br><span class="line"></span><br><span class="line">            if ((isNodeLiteral(left) &amp;&amp; isNodeLiteral(right)) ||    // å¤„ç†æ•°å­—å­—é¢é‡ï¼Œç®€å•å­—ç¬¦ä¸²å­—é¢é‡</span><br><span class="line">                path.isUnaryExpression() ||                         // å¤„ç†jsfuckä»£ç çš„`!![]` </span><br><span class="line">                path.isMemberExpression() ||                        // å¤„ç†æˆå‘˜è¡¨è¾¾å¼</span><br><span class="line">                path.isCallExpression()) &#123;                          // å¤„ç†è°ƒç”¨è¡¨è¾¾å¼</span><br><span class="line">                const &#123; confident, value &#125; = path.evaluate();       // è¿™ä¸ªè®¡ç®—æ˜¯åŒ…å«äº†äºŒå…ƒè¡¨è¾¾å¼çš„</span><br><span class="line">                if (!confident || value == &quot;Infinity&quot;) return;</span><br><span class="line">                if (path.isUnaryExpression(&#123; operator: &#x27;-&#x27; &#125;) || path.isUnaryExpression(&#123; operator: &#x27;void&#x27; &#125;)) return;</span><br><span class="line">                path.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125;</span><br><span class="line">            // å¤„ç†æ¡ä»¶è¡¨è¾¾å¼ï¼ˆä¸‰ç›®è¡¨è¾¾å¼ï¼‰</span><br><span class="line">            if (path.isConditionalExpression()) &#123;</span><br><span class="line">                let &#123; test, consequent, alternate &#125; = path.node;</span><br><span class="line">                if (consequent.value != null &amp;&amp; alternate.value != null &amp;&amp; consequent.value == alternate.value) &#123;</span><br><span class="line">                    path.replaceWith(types.valueToNode(consequent.value));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                const &#123; confident, value &#125; = path.evaluate();</span><br><span class="line">                if (!confident || value == &quot;Infinity&quot;) return;</span><br><span class="line">                if (path.isUnaryExpression(&#123; operator: &#x27;-&#x27; &#125;) || path.isUnaryExpression(&#123; operator: &#x27;void&#x27; &#125;)) return;</span><br><span class="line">                path.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125;</span><br><span class="line">            // å¤„ç†å­—ç¬¦ä¸²ç›¸åŠ </span><br><span class="line">            if (parentPath.isBinaryExpression(&#123; left: node &#125;)) &#123;</span><br><span class="line">                if (!types.isLiteral(left) &amp;&amp; operator == &quot;+&quot; &amp;&amp; types.isLiteral(right)) &#123;</span><br><span class="line">                    if (parent.operator == &quot;+&quot; &amp;&amp; types.isLiteral(parent.right)) &#123;</span><br><span class="line">                        path.node.right.value += parent.right.value;</span><br><span class="line">                        parentPath.replaceWith(path.node);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, calcPartBinaryExpression);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">const callToStringLiteral = &#123;</span><br><span class="line">    CallExpression: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; arguments &#125; = path.node;</span><br><span class="line">            if (!isNodeLiteral(arguments)) return;</span><br><span class="line">            try &#123;</span><br><span class="line">                let arr = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;, &#x27;random&#x27;, &#x27;Date&#x27;];</span><br><span class="line">                let flag = arr.every(ele =&gt; !path.toString().includes(ele));</span><br><span class="line">                if (!flag) return;</span><br><span class="line"></span><br><span class="line">                let value = eval(path.toString());</span><br><span class="line">                // if (typeof value != &quot;string&quot;) return; // æœ‰æ—¶ä¹Ÿéœ€è¦è¿˜åŸä¸ºæ•°å­—</span><br><span class="line">                console.log(path.toString(), &quot;--&gt;&quot;, value);</span><br><span class="line">                path.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125; catch (e) &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, callToStringLiteral);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// æœ€åä½¿ç”¨ï¼šåƒåœ¾ä»£ç åˆ é™¤</span><br><span class="line">function containsSequenceExpression(path) &#123;</span><br><span class="line">    let containsSequence = false;</span><br><span class="line">    // æ·±åº¦ä¼˜å…ˆéå†å½“å‰è·¯å¾„åŠå…¶æ‰€æœ‰å­è·¯å¾„</span><br><span class="line">    path.traverse(&#123;</span><br><span class="line">        &quot;SequenceExpression|AssignmentExpression&quot;(_path) &#123;</span><br><span class="line">            containsSequence = true;</span><br><span class="line">            _path.stop(); // æ‰¾åˆ°é€—å·è¡¨è¾¾å¼åç«‹å³åœæ­¢éå†</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    return containsSequence;</span><br><span class="line">&#125;</span><br><span class="line">const removeDeadCode = &#123;</span><br><span class="line">    &quot;IfStatement|ConditionalExpression&quot;(path) &#123;</span><br><span class="line">        let &#123; node &#125; = path;</span><br><span class="line">        let &#123; consequent, alternate &#125; = node;</span><br><span class="line">        let testPath = path.get(&#x27;test&#x27;);</span><br><span class="line"></span><br><span class="line">        //ä¸å¤„ç†é€—å·è¡¨è¾¾å¼ï¼Œèµ‹å€¼è¯­å¥é˜²æ­¢è¯¯åˆ </span><br><span class="line">        if (testPath.isSequenceExpression() || testPath.isAssignmentExpression() || containsSequenceExpression(testPath)) return;</span><br><span class="line"></span><br><span class="line">        const evaluateTest = testPath.evaluateTruthy();</span><br><span class="line">        if (evaluateTest === true) &#123;</span><br><span class="line">            if (types.isBlockStatement(consequent)) &#123;</span><br><span class="line">                consequent = consequent.body;</span><br><span class="line">            &#125;</span><br><span class="line">            path.replaceWithMultiple(consequent);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (evaluateTest === false) &#123;</span><br><span class="line">            if (alternate != null) &#123;</span><br><span class="line">                if (types.isBlockStatement(alternate)) &#123;</span><br><span class="line">                    alternate = alternate.body;</span><br><span class="line">                &#125;</span><br><span class="line">                path.replaceWithMultiple(alternate);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                path.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;LogicalExpression&quot;(path) &#123;</span><br><span class="line">        let &#123; node &#125; = path;</span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        let leftPath = path.get(&#x27;left&#x27;);</span><br><span class="line"></span><br><span class="line">        //ä¸å¤„ç†é€—å·è¡¨è¾¾å¼ï¼Œèµ‹å€¼è¯­å¥é˜²æ­¢è¯¯åˆ </span><br><span class="line">        if (leftPath.isSequenceExpression() || leftPath.isAssignmentExpression() || containsSequenceExpression(leftPath)) return;</span><br><span class="line"></span><br><span class="line">        const evaluateLeft = leftPath.evaluateTruthy();</span><br><span class="line">        if ((operator == &quot;||&quot; &amp;&amp; evaluateLeft == true) || (operator == &quot;&amp;&amp;&quot; &amp;&amp; evaluateLeft == false)) &#123;</span><br><span class="line">            path.replaceWith(left);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if ((operator == &quot;||&quot; &amp;&amp; evaluateLeft == false) || (operator == &quot;&amp;&amp;&quot; &amp;&amp; evaluateLeft == true)) &#123;</span><br><span class="line">            path.replaceWith(right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;EmptyStatement|DebuggerStatement&quot;(path) &#123;</span><br><span class="line">        path.remove();</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;VariableDeclarator&quot;(path) &#123;</span><br><span class="line">        let &#123; node, scope, parentPath, parent &#125; = path;</span><br><span class="line">        let ancestryPath = parentPath.parentPath;</span><br><span class="line"></span><br><span class="line">        // forå¾ªç¯ä¸­çš„å˜é‡å®šä¹‰ä¸èƒ½åˆ é™¤</span><br><span class="line">        if (ancestryPath.isForOfStatement(&#123; left: parent &#125;) || ancestryPath.isForInStatement(&#123; left: parent &#125;)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        //ç›®å‰åªå‘ç°èµ‹å€¼è¯­å¥å’Œè°ƒç”¨è¯­å¥ä¼šæœ‰é—®é¢˜ã€‚åç»­å¾…æ·»åŠ </span><br><span class="line">        if (!types.isIdentifier(id) || types.isCallExpression(init) || types.isAssignmentExpression(init)) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(id.name); // é‡æ–°è§£æaståï¼Œä¸€å®šä¼šæœ‰binding</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations &#125; = binding;</span><br><span class="line">        // console.log(id.name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; å˜é‡å®šä¹‰:&quot;, path.parentPath + &#x27;&#x27;);</span><br><span class="line">            path.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;AssignmentExpression&quot;(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27;) return;</span><br><span class="line"></span><br><span class="line">        let name = left.name;</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line"></span><br><span class="line">        let &#123; referenced, constant, constantViolations &#125; = binding;</span><br><span class="line">        // console.log(path + &#x27;&#x27;, referenced, constant, constantViolations.length);</span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; èµ‹å€¼è¯­å¥:&quot;, path + &#x27;&#x27;);</span><br><span class="line">            path.remove();</span><br><span class="line">            if (binding.path.parentPath.isFunctionExpression() || binding.path.parentPath.isFunctionDeclaration()) &#123;</span><br><span class="line">                binding.path.remove(); // åˆ é™¤çš„å‡½æ•°å½¢å‚</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ContinueStatement|BreakStatement|ReturnStatement|ThrowStatement&quot;(path) &#123;</span><br><span class="line">        if (!path.parentPath.isSwitchCase()) return; // åªå¤„ç†åœ¨ switch-case è¯­å¥ä¸­çš„</span><br><span class="line">        let AllNextSiblings = path.getAllNextSiblings(); // è·å–æ‰€æœ‰çš„åç»­å…„å¼ŸèŠ‚ç‚¹</span><br><span class="line">        for (let nextSibling of AllNextSiblings) &#123;</span><br><span class="line">            if (nextSibling.isFunctionDeclaration() || nextSibling.isVariableDeclaration(&#123; kind: &quot;var&quot; &#125;)) &#123; //å˜é‡æå‡.....</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            nextSibling.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;FunctionDeclaration&quot;(path) &#123;</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; id, params &#125; = node;</span><br><span class="line">        if (!params) return;</span><br><span class="line">        let flag = true;</span><br><span class="line"></span><br><span class="line">        let binding = parentPath.scope.getBinding(id.name);</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations &#125; = binding;</span><br><span class="line">        // console.log(id.name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; å‡½æ•°å®šä¹‰:&quot;, path + &#x27;&#x27;);</span><br><span class="line">            path.remove();</span><br><span class="line">            flag = false;</span><br><span class="line">        &#125;</span><br><span class="line">        if (flag) &#123;</span><br><span class="line">            for (let i of params) &#123;</span><br><span class="line">                if (!types.isIdentifier(i)) continue;</span><br><span class="line">                let binding = scope.getBinding(i.name);</span><br><span class="line">                if (!binding) continue;</span><br><span class="line"></span><br><span class="line">                let &#123; references, constantViolations &#125; = binding;</span><br><span class="line">                if (references === 0 &amp;&amp; constantViolations.length === 0) &#123;</span><br><span class="line">                    // å°†æœªä½¿ç”¨çš„å‚æ•°æ ‡è®°ä¸ºåˆ é™¤</span><br><span class="line">                    console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; å‡½æ•°å½¢å‚:&quot;, i.name);</span><br><span class="line">                    params = params.filter(param =&gt; param !== i);</span><br><span class="line">                    console.log(params);</span><br><span class="line">                &#125;</span><br><span class="line">                path.node.params = params;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">for (let i = 0; i &lt; 5; i++) &#123;</span><br><span class="line">    traverse(ast, removeDeadCode); // åˆ é™¤ä¸å¤Ÿå½»åº•åˆ™å†è°ƒç”¨ä¸€æ¬¡ï¼Œä»¥æ­¤ç±»æ¨</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å‡½æ•°ï¼šæ ¹æ®caseçš„testæ¡ä»¶ï¼Œè·å–å¯¹åº”caseçš„nodeèŠ‚ç‚¹ï¼Œè¿˜å¯ä»¥åˆ¤æ–­æ˜¯å¦åˆ é™¤èŠ‚ç‚¹</span><br><span class="line">function getItemFromTestValue(path, testValue, is_remove) &#123;</span><br><span class="line">    let &#123; cases &#125; = path.node;</span><br><span class="line">    for (let caseIndex in cases) &#123;</span><br><span class="line">        let caseItem = cases[caseIndex];</span><br><span class="line">        if (caseItem.test.value == testValue) &#123;</span><br><span class="line">            if (is_remove) &#123;</span><br><span class="line">                return cases.splice(caseIndex, 1)[0]; // ä»å½“å‰ç´¢å¼•å¼€å§‹åˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›è¢«åˆ é™¤çš„å…ƒç´ æ•°ç»„</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return caseItem</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">const dealWithSwitch = &#123;</span><br><span class="line">    SwitchStatement(path) &#123;</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; discriminant, cases &#125; = node;</span><br><span class="line">        let name = discriminant.name;</span><br><span class="line"></span><br><span class="line">        /* è·å– switch-case çš„åˆå§‹caseæ¡ä»¶ï¼Œé€šå¸¸åœ¨å¤–å±‚ for å¾ªç¯çš„initä¸­å®šä¹‰</span><br><span class="line">            let binding = scope.getBinding(name);</span><br><span class="line">            if (!binding) return;</span><br><span class="line">            let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">            // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">            if (!binding.path.isVariableDeclarator() &amp;&amp; !binding.path.isAssignmentExpression()) return;</span><br><span class="line">            if (binding.path.isVariableDeclarator() &amp;&amp; (startValue = binding.path.node.init) &amp;&amp; !types.isLiteral(startValue)) return;</span><br><span class="line">            if (binding.path.isAssignmentExpression() &amp;&amp; (startValue = binding.path.node.right) &amp;&amp; !types.isLiteral(startValue)) return;</span><br><span class="line">        */</span><br><span class="line">        if (!parentPath.parentPath.isForStatement()) return;</span><br><span class="line">        let &#123; init &#125; = parentPath.parentPath.node;</span><br><span class="line">        init = types.isVariableDeclaration(init) ? init.declarations[init.declarations.length - 1] : init;</span><br><span class="line">        if (!types.isVariableDeclarator(init) &amp;&amp; !types.isAssignmentExpression(init)) return;</span><br><span class="line">        if (types.isVariableDeclarator(init) &amp;&amp; (startValue = init.init) &amp;&amp; !types.isLiteral(startValue)) return;</span><br><span class="line">        if (types.isAssignmentExpression(init) &amp;&amp; (startValue = init.right) &amp;&amp; !types.isLiteral(startValue)) return;</span><br><span class="line"></span><br><span class="line">        // ä¸ç®¡switchä»å“ªé‡Œå¼€å§‹ï¼Œå…ˆå•çº¿åˆå¹¶ï¼Œå†å¤„ç†æ¡ä»¶è¡¨è¾¾å¼å¹¶ç”¨whileå¾ªç¯æ›¿æ¢</span><br><span class="line">        for (let i = 0; i &lt; cases.length; i++) &#123;</span><br><span class="line">            let &#123; test, consequent &#125; = cases[i];</span><br><span class="line">            let jumpTo = consequent.filter(ele =&gt; generator(ele).code.includes(name + &#x27; =&#x27;));</span><br><span class="line">            jumpTo = jumpTo[jumpTo.length - 1] ? jumpTo[jumpTo.length - 1].expression : null; // æ§åˆ¶caseè·³è½¬çš„èµ‹å€¼è¯­å¥</span><br><span class="line">            if (!types.isAssignmentExpression(jumpTo) || !types.isIdentifier(jumpTo.left, &#123; name: name &#125;)) continue;</span><br><span class="line"></span><br><span class="line">            // console.log(path + &#x27;&#x27;); // æ‰“å°å‡ºæ•´ä¸ªå¤„ç†è¿‡ç¨‹ï¼Œç”¨äºè°ƒè¯•</span><br><span class="line"></span><br><span class="line">            // 1. å½“è·³è½¬è¯­å¥çš„å³èŠ‚ç‚¹æ˜¯å­—é¢é‡æ—¶</span><br><span class="line">            if (types.isLiteral(jumpTo.right)) &#123;</span><br><span class="line">                // æ•°ç»„çš„é•¿åº¦å«ä¹‰ï¼šä»£è¡¨æŒ‡å‘ä¸‹ä¸€ä¸ªcaseå—çš„èµ‹å€¼è¯­å¥çš„æ•°é‡ï¼Œå³è¢«æŒ‡å‘çš„csaeå—æœ‰å‡ æ¬¡å¼•ç”¨</span><br><span class="line">                let newArr = cases.filter(ele =&gt; &#123;</span><br><span class="line">                    let jumpto = ele.consequent.filter(element =&gt; generator(element).code.includes(name + &#x27; =&#x27;));</span><br><span class="line">                    jumpto = jumpto[jumpto.length - 1] ? jumpto[jumpto.length - 1].expression : null; // æ§åˆ¶caseè·³è½¬çš„èµ‹å€¼è¯­å¥</span><br><span class="line">                    return generator(jumpto).code == generator(jumpTo).code;</span><br><span class="line">                &#125;);</span><br><span class="line">                // å¦‚æœåªæœ‰ä¸€æ¬¡ï¼Œåˆ™å¯ä»¥åˆå¹¶</span><br><span class="line">                if (newArr.length == 1) &#123;</span><br><span class="line">                    let nextItem = getItemFromTestValue(path, jumpTo.right.value, true);</span><br><span class="line">                    let nextItemConsequent = nextItem.consequent;</span><br><span class="line">                    // --------******** ç‰¹åˆ«æ³¨æ„ï¼šæ¯ä¸ªcaseæ›¿æ¢çš„è¡Œæ•°ç”±å®é™…æƒ…å†µè€Œå®š ********--------</span><br><span class="line">                    // ç»è¿‡æµ‹è¯•ï¼šä¸‹ä¸€ä¸ªcaseä¸­åªæœ‰ä¸€æ¡è¯­å¥ break; æ—¶è¿è¡Œæ­£å¸¸ï¼Œä½†æ˜¯å¦‚æœæ˜¯æ§åˆ¶caseè·³è½¬çš„èµ‹å€¼è¯­å¥ï¼Œå°±ä¼šè¿˜åŸé”™è¯¯</span><br><span class="line">                    consequent.splice(consequent.length - 2, 2, ...nextItemConsequent);</span><br><span class="line"></span><br><span class="line">                    i = -1; // æ¯åˆå¹¶ä¸€æ¬¡åˆä»å¤´éå†ï¼Œå› ä¸ºè¢«åˆå¹¶è¿‡çš„è¯­å¥å—å¯èƒ½è¿˜éœ€è¦å†æ¬¡åˆå¹¶</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // 2. å½“è·³è½¬è¯­å¥çš„å³èŠ‚ç‚¹æ˜¯æ¡ä»¶è¡¨è¾¾å¼æ—¶</span><br><span class="line">            if (types.isConditionalExpression(jumpTo.right)) &#123;</span><br><span class="line">                let newTest = jumpTo.right.test</span><br><span class="line">                let newConsequent = jumpTo.right.consequent</span><br><span class="line">                let newAlternate = jumpTo.right.alternate</span><br><span class="line"></span><br><span class="line">                let nextItem = getItemFromTestValue(path, newConsequent.value, false);</span><br><span class="line">                let nextItemConsequent = nextItem.consequent;</span><br><span class="line">                let nextJumpTo = nextItemConsequent.filter(ele =&gt; generator(ele).code.includes(name + &#x27; =&#x27;));</span><br><span class="line">                nextJumpTo = nextJumpTo[nextJumpTo.length - 1] ? nextJumpTo[nextJumpTo.length - 1].expression : null; // æ§åˆ¶caseè·³è½¬çš„èµ‹å€¼è¯­å¥</span><br><span class="line">                if (!types.isAssignmentExpression(nextJumpTo) || !types.isLiteral(nextJumpTo.right)) continue;</span><br><span class="line"></span><br><span class="line">                if (nextJumpTo.right.value == test.value) &#123;</span><br><span class="line">                    let bodyNode = nextItemConsequent.slice(0, nextItemConsequent.length - 2); // æˆªå–æœ‰æ•ˆå†…å®¹</span><br><span class="line">                    let whileNode = types.whileStatement(newTest, types.blockStatement(bodyNode));</span><br><span class="line">                    consequent.splice(consequent.length - 2, 0, whileNode); // åˆ é™¤0ï¼Œåˆ™è¡¨ç¤ºæ’å…¥whileè¯­å¥</span><br><span class="line"></span><br><span class="line">                    getItemFromTestValue(path, newConsequent.value, true);</span><br><span class="line">                    jumpTo.right = newAlternate;</span><br><span class="line">                    i = -1;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // è¿˜åŸåˆ°æœ€åï¼Œå°†æœ‰æ•ˆä»£ç ä»switchä¸­è„±ç¦»å‡ºæ¥</span><br><span class="line">        for (let item of cases) &#123;</span><br><span class="line">            let &#123; test, consequent &#125; = item;</span><br><span class="line">            if (test.value == startValue.value) &#123;</span><br><span class="line">                let lastSta = consequent[consequent.length - 1];</span><br><span class="line">                if (types.isBreakStatement(lastSta) || types.isContinueStatement(lastSta)) &#123;</span><br><span class="line">                    consequent.pop();</span><br><span class="line">                &#125;</span><br><span class="line">                parentPath.parentPath.replaceWithMultiple(consequent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, dealWithSwitch);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">console.timeEnd(&quot;å¤„ç†å®Œæ¯•ï¼Œè€—æ—¶&quot;);</span><br><span class="line">let &#123; code &#125; = generator(ast, opts = &#123;</span><br><span class="line">    &quot;compact&quot;: false,  // æ˜¯å¦å‹ç¼©ä»£ç </span><br><span class="line">    &quot;comments&quot;: false,  // æ˜¯å¦ä¿ç•™æ³¨é‡Š</span><br><span class="line">    &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125;,  // Unicodeè½¬ä¹‰ï¼Œç¡®ä¿éASCIIå­—ç¬¦è¢«æ­£ç¡®åœ°ä¿ç•™å’Œæ˜¾ç¤ºï¼Œè€Œä¸æ˜¯è¢«è½¬ä¹‰</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">files.writeFile(decodeFile, code, (err) =&gt; &#123; &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="6-æ¡ˆä¾‹-px3-è¿˜åŸ"><a href="#6-æ¡ˆä¾‹-px3-è¿˜åŸ" class="headerlink" title="6. æ¡ˆä¾‹ -&gt; px3 è¿˜åŸ"></a>6. æ¡ˆä¾‹ -&gt; px3 è¿˜åŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br></pre></td><td class="code"><pre><span class="line">const _path = require(&#x27;path&#x27;);</span><br><span class="line">const files = require(&#x27;fs&#x27;);  // å¯¼å…¥æ–‡ä»¶åº“ï¼Œé˜²æ­¢ä¸fså˜é‡åå†²çª</span><br><span class="line">const types = require(&quot;@babel/types&quot;);</span><br><span class="line">const parser = require(&quot;@babel/parser&quot;);</span><br><span class="line">const template = require(&quot;@babel/template&quot;).default;</span><br><span class="line">const traverse = require(&quot;@babel/traverse&quot;).default;</span><br><span class="line">const generator = require(&quot;@babel/generator&quot;).default;</span><br><span class="line">const NodePath = require(&quot;@babel/traverse&quot;).NodePath; // æ™ºèƒ½æç¤ºæ‰€éœ€</span><br><span class="line"></span><br><span class="line">const encodeFile = _path.resolve(__dirname, &#x27;encode_ok.js&#x27;);</span><br><span class="line">const decodeFile = _path.resolve(__dirname, &#x27;ok_encode_ok.js&#x27;);</span><br><span class="line">let sourceCode = files.readFileSync(encodeFile, &#123; encoding: &quot;utf-8&quot; &#125;);</span><br><span class="line">let ast = parser.parse(sourceCode);</span><br><span class="line">console.time(&quot;å¤„ç†å®Œæ¯•ï¼Œè€—æ—¶&quot;);</span><br><span class="line"></span><br><span class="line">const decryptFile = _path.resolve(__dirname, &#x27;decode.js&#x27;);</span><br><span class="line">let decryptCode = files.readFileSync(decryptFile, &#123; encoding: &quot;utf-8&quot; &#125;); // è¯»å–è§£å¯†ä»£ç </span><br><span class="line">let evalAst = parser.parse(decryptCode);</span><br><span class="line">decryptCode = generator(evalAst, opts = &#123; compact: true &#125;).code // åˆ©ç”¨astå‹ç¼©ä»£ç </span><br><span class="line">eval(decryptCode);</span><br><span class="line"></span><br><span class="line">// åˆå¹¶å˜é‡å£°æ˜ä¸å®šä¹‰</span><br><span class="line">// var a, b, c; a = 1; b = 2; c = 3;    ===&gt;    var a = 1, b = 2, c = 3;</span><br><span class="line">const combinDefineAndNextAssgin = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; scope, node &#125; = path;</span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (init != null) return;</span><br><span class="line"></span><br><span class="line">        let name = id.name;</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (constantViolations.length != 1) return;</span><br><span class="line">        if (!constantViolations[0].isAssignmentExpression()) return;</span><br><span class="line">        if (constantViolations[0].parentPath.isConditionalExpression() || constantViolations[0].parentPath.isLogicalExpression()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = constantViolations[0].node</span><br><span class="line">        if (!types.isIdentifier(left, &#123; name: name &#125;) || operator != &#x27;=&#x27; || !isBaseLiteral(right)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        path.set(&quot;init&quot;, right);</span><br><span class="line">        constantViolations[0].remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, combinDefineAndNextAssgin);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// å˜é‡åˆå§‹åŒ–ä¸ºå­—é¢é‡ï¼Œä¸”æ²¡æœ‰ä¿®æ”¹çš„è¿˜åŸ</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isBaseLiteral(node) &#123;</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;];</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node) &amp;&amp; node.value != null) return true; // nullå¯èƒ½æœ‰å‘</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; literalList.includes(node.name)) return true;</span><br><span class="line">    if (types.isIdentifier(node) &amp;&amp; typeof globalThis[node.name] != &quot;undefined&quot;) return true;</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; [&quot;+&quot;, &quot;-&quot;, &quot;!&quot;].includes(node.operator)) &#123;</span><br><span class="line">        if (types.isArrayExpression(node.argument) &amp;&amp; node.argument.elements.length == 0) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return isBaseLiteral(node.argument);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const rebackVarDeclarator = &#123;</span><br><span class="line">    VariableDeclarator(path) &#123;</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        if (parentPath.parentPath.isForStatement()) return;</span><br><span class="line">        if (!types.isIdentifier(id) || init == null || !isBaseLiteral(init)) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(id.name);</span><br><span class="line">        if (!binding) return; // æ¦‚ç‡è¸©å‘æŠ¥é”™</span><br><span class="line">        let &#123; constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123; // å˜é‡å®šä¹‰åœ¨ for å¾ªç¯ä¸­æ˜¯ä¸€æ¬¡æ”¹å˜</span><br><span class="line">            for (let referencePath of referencePaths) &#123;</span><br><span class="line">                referencePath.replaceWith(init);</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&quot;å®šä¹‰å­—é¢é‡æœªæ”¹è¿˜åŸ&quot;, &quot;åˆ é™¤ --&gt; å˜é‡å®šä¹‰:&quot;, path.parentPath + &#x27;&#x27;);</span><br><span class="line">            path.remove(); // é¡ºä¾¿è¿˜æŠŠåˆå§‹åŒ–ä¸ºå¸¸é‡ï¼Œä½†æ²¡æœ‰ä½¿ç”¨è¿‡çš„å˜é‡å®šä¹‰ä¹Ÿåˆ äº†</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, rebackVarDeclarator);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// æŠ˜å è®¡ç®—éƒ¨åˆ†å­—é¢é‡æˆ–è¡¨è¾¾å¼</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const calcPartBinaryExpression = &#123;</span><br><span class="line">    &quot;BinaryExpression|UnaryExpression|ConditionalExpression|MemberExpression|CallExpression&quot;: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; parent, scope, parentPath, node &#125; = path;</span><br><span class="line">            let &#123; left, operator, right &#125; = node;</span><br><span class="line"></span><br><span class="line">            if ((isNodeLiteral(left) &amp;&amp; isNodeLiteral(right)) ||    // å¤„ç†æ•°å­—å­—é¢é‡ï¼Œç®€å•å­—ç¬¦ä¸²å­—é¢é‡</span><br><span class="line">                path.isUnaryExpression() ||                         // å¤„ç†jsfuckä»£ç çš„`!![]` </span><br><span class="line">                path.isMemberExpression() ||                        // å¤„ç†æˆå‘˜è¡¨è¾¾å¼</span><br><span class="line">                path.isCallExpression()) &#123;                          // å¤„ç†è°ƒç”¨è¡¨è¾¾å¼</span><br><span class="line">                const &#123; confident, value &#125; = path.evaluate();       // è¿™ä¸ªè®¡ç®—æ˜¯åŒ…å«äº†äºŒå…ƒè¡¨è¾¾å¼çš„</span><br><span class="line">                if (!confident || value == &quot;Infinity&quot;) return;</span><br><span class="line">                if (path.isUnaryExpression(&#123; operator: &#x27;-&#x27; &#125;) || path.isUnaryExpression(&#123; operator: &#x27;void&#x27; &#125;)) return;</span><br><span class="line">                path.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125;</span><br><span class="line">            // å¤„ç†æ¡ä»¶è¡¨è¾¾å¼ï¼ˆä¸‰ç›®è¡¨è¾¾å¼ï¼‰</span><br><span class="line">            if (path.isConditionalExpression()) &#123;</span><br><span class="line">                let &#123; test, consequent, alternate &#125; = path.node;</span><br><span class="line">                if (consequent.value != null &amp;&amp; alternate.value != null &amp;&amp; consequent.value == alternate.value) &#123;</span><br><span class="line">                    path.replaceWith(types.valueToNode(consequent.value));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                const &#123; confident, value &#125; = path.evaluate();</span><br><span class="line">                if (!confident || value == &quot;Infinity&quot;) return;</span><br><span class="line">                if (path.isUnaryExpression(&#123; operator: &#x27;-&#x27; &#125;) || path.isUnaryExpression(&#123; operator: &#x27;void&#x27; &#125;)) return;</span><br><span class="line">                path.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125;</span><br><span class="line">            // å¤„ç†å­—ç¬¦ä¸²ç›¸åŠ </span><br><span class="line">            if (parentPath.isBinaryExpression(&#123; left: node &#125;)) &#123;</span><br><span class="line">                if (!types.isLiteral(left) &amp;&amp; operator == &quot;+&quot; &amp;&amp; types.isLiteral(right)) &#123;</span><br><span class="line">                    if (parent.operator == &quot;+&quot; &amp;&amp; types.isLiteral(parent.right)) &#123;</span><br><span class="line">                        path.node.right.value += parent.right.value;</span><br><span class="line">                        parentPath.replaceWith(path.node);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, calcPartBinaryExpression);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// ä¸“ç”¨è°ƒç”¨è¡¨è¾¾å¼è¿˜åŸæ’ä»¶æ¨¡ç‰ˆ</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">const tsCallToString = &#123;</span><br><span class="line">    // éå†å‡½æ•°å®šä¹‰æ˜¯å› ä¸ºç›´æ¥éå†è°ƒç”¨è¡¨è¾¾å¼è¿˜åŸåä¸å¥½åˆ é™¤</span><br><span class="line">    FunctionDeclaration(path) &#123;</span><br><span class="line">        let collectFuncCode = [];</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; id, params, body &#125; = node;</span><br><span class="line">        if (params.length != 2 || body.body.length != 1) return;</span><br><span class="line">        if (!types.isCallExpression(node.body.body[0].argument)) return;</span><br><span class="line"></span><br><span class="line">        var name = id.name;</span><br><span class="line">        let binding = parentPath.scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        collectFuncCode.push(path.toString());</span><br><span class="line">        // console.log(binding.path + &#x27;&#x27;, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        function xxx(path) &#123;</span><br><span class="line">            let tempName = path.node.body.body[0].argument.callee.name;</span><br><span class="line">            let tempBinding = path.scope.getBinding(tempName);</span><br><span class="line">            if (!tempBinding) return;</span><br><span class="line">            // å¤„ç†æ”¶é›†çš„å‡½æ•°ä¸­å­˜åœ¨åŒåçš„é—®é¢˜</span><br><span class="line">            if (name == tempName) &#123;</span><br><span class="line">                tempBinding.scope.rename(tempName, path.scope.generateUidIdentifier(tempName).name);</span><br><span class="line">                collectFuncCode.pop();</span><br><span class="line">                collectFuncCode.push(path.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            collectFuncCode.push(tempBinding.path.toString());</span><br><span class="line">            // console.log(&quot;-----------------&quot;, tempBinding.path + &#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">            if (tempBinding.path.node.body.body.length == 1) &#123;</span><br><span class="line">                let recursiveBinding = xxx(tempBinding.path);</span><br><span class="line">                if (recursiveBinding) return recursiveBinding;</span><br><span class="line">            &#125;</span><br><span class="line">            return tempBinding;</span><br><span class="line">        &#125;</span><br><span class="line">        callFuncBinding = xxx(path);</span><br><span class="line">        if (!callFuncBinding) return;</span><br><span class="line"></span><br><span class="line">        let bigArrFuncName = callFuncBinding.path.node.body.body[0].declarations[0].init.callee.name;</span><br><span class="line">        let bigArrFuncBinding = callFuncBinding.scope.getBinding(bigArrFuncName);</span><br><span class="line">        if (!bigArrFuncBinding) return;</span><br><span class="line">        collectFuncCode.push(bigArrFuncBinding.path.toString());</span><br><span class="line"></span><br><span class="line">        // å¤„ç†æœ‰äº›å¤§æ•°ç»„å­˜åœ¨çš„ç§»ä½è‡ªæ‰§è¡Œå‡½æ•°</span><br><span class="line">        let referencePaths_3 = bigArrFuncBinding.referencePaths;</span><br><span class="line">        for (let reference of referencePaths_3) &#123;</span><br><span class="line">            if (!reference.parentPath.isCallExpression()) continue;</span><br><span class="line"></span><br><span class="line">            let &#123; callee, arguments &#125; = reference.parentPath.node;</span><br><span class="line">            if (!types.isFunctionExpression(callee) || arguments.length != 1 || arguments[0].name != bigArrFuncName) continue;</span><br><span class="line">            collectFuncCode.push(reference.parentPath.parentPath.toString());</span><br><span class="line">            // console.log(reference.parentPath.parentPath + &#x27;&#x27;, reference.parentPath.type);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        eval(collectFuncCode.join(&#x27;;&#x27;));</span><br><span class="line">        // console.log(collectFuncCode.join(&#x27;;&#x27;));</span><br><span class="line"></span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == binding.path) &#123;</span><br><span class="line">            for (let referencePath of referencePaths) &#123;</span><br><span class="line">                let &#123; parentPath, node &#125; = referencePath;</span><br><span class="line">                if (!parentPath.isCallExpression(&#123; callee: node &#125;) || !isNodeLiteral(parentPath.node.arguments)) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                // ä¸å¤„ç†ç¯å¢ƒå‡½æ•°ä¸­çš„è°ƒç”¨è¡¨è¾¾å¼ï¼Œä¼šæœ‰é—®é¢˜</span><br><span class="line">                if (parentPath.parentPath.isCallExpression() &amp;&amp; parentPath.parentPath.node.callee.name == &#x27;parseInt&#x27;) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                let value = eval(parentPath.toString());</span><br><span class="line">                console.log(parentPath + &#x27;&#x27;, &#x27;--&gt;&#x27;, value);</span><br><span class="line">                parentPath.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, tsCallToString);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">const tsCallToString2 = &#123;</span><br><span class="line">    // éå†å‡½æ•°å®šä¹‰æ˜¯å› ä¸ºç›´æ¥éå†è°ƒç”¨è¡¨è¾¾å¼è¿˜åŸåä¸å¥½åˆ é™¤</span><br><span class="line">    FunctionDeclaration(path) &#123;</span><br><span class="line">        let collectFuncCode = [];</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; id, params, body &#125; = node;</span><br><span class="line">        if (params.length != 2 || body.body.length &lt; 2) return;</span><br><span class="line">        if (!types.isVariableDeclaration(node.body.body[0]) ||</span><br><span class="line">            !types.isCallExpression(node.body.body[0].declarations[0].init) ||</span><br><span class="line">            !types.isIdentifier(node.body.body[0].declarations[0].init.callee)) return;</span><br><span class="line"></span><br><span class="line">        var name = id.name;</span><br><span class="line">        let binding = parentPath.scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        collectFuncCode.push(path.toString());</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        let bigArrFuncName = node.body.body[0].declarations[0].init.callee.name;</span><br><span class="line">        let bigArrFuncBinding = path.scope.getBinding(bigArrFuncName);</span><br><span class="line">        if (!bigArrFuncBinding) return;</span><br><span class="line">        collectFuncCode.push(bigArrFuncBinding.path.toString());</span><br><span class="line"></span><br><span class="line">        // å¤„ç†æœ‰äº›å¤§æ•°ç»„å­˜åœ¨çš„ç§»ä½è‡ªæ‰§è¡Œå‡½æ•°</span><br><span class="line">        let referencePaths_3 = bigArrFuncBinding.referencePaths;</span><br><span class="line">        for (let reference of referencePaths_3) &#123;</span><br><span class="line">            if (!reference.parentPath.isCallExpression()) continue;</span><br><span class="line"></span><br><span class="line">            let &#123; callee, arguments &#125; = reference.parentPath.node;</span><br><span class="line">            if (!types.isFunctionExpression(callee) || arguments.length != 1 || arguments[0].name != bigArrFuncName) continue;</span><br><span class="line">            collectFuncCode.push(reference.parentPath.parentPath.toString());</span><br><span class="line">            // console.log(reference.parentPath.parentPath + &#x27;&#x27;, reference.parentPath.type);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        eval(collectFuncCode.join(&#x27;;&#x27;));</span><br><span class="line">        // console.log(collectFuncCode.join(&#x27;;&#x27;));</span><br><span class="line"></span><br><span class="line">        if (constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] != 1) &#123;</span><br><span class="line">            for (let referencePath of referencePaths) &#123;</span><br><span class="line">                let &#123; parentPath, node &#125; = referencePath;</span><br><span class="line">                // console.log(&quot;sdfewrew2342&quot;,parentPath+&#x27;&#x27;);</span><br><span class="line">                if (!parentPath.isCallExpression(&#123; callee: node &#125;) || !isNodeLiteral(parentPath.node.arguments)) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                // ä¸å¤„ç†ç¯å¢ƒå‡½æ•°ä¸­çš„è°ƒç”¨è¡¨è¾¾å¼ï¼Œä¼šæœ‰é—®é¢˜</span><br><span class="line">                if (parentPath.parentPath.isCallExpression() &amp;&amp; parentPath.parentPath.node.callee.name == &#x27;parseInt&#x27;) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                let value = eval(parentPath.toString());</span><br><span class="line">                console.log(&quot;ç¬¬äºŒç§ç±»å‹çš„è¿˜åŸ:&quot;, parentPath + &#x27;&#x27;, &#x27;--&gt;&#x27;, value);</span><br><span class="line">                parentPath.replaceWith(types.valueToNode(value));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, tsCallToString2);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// åˆ¤æ–­å‡½æ•°æ˜¯å¦ä¸ºçº¯å‡½æ•°</span><br><span class="line">function isPureFunction(path) &#123;</span><br><span class="line">    let isPure = true;</span><br><span class="line"></span><br><span class="line">    // æ£€æŸ¥ body.body æ•°ç»„çš„æ¯è¡Œä»£ç æ˜¯å¦åŒ…å«å…¨å±€å±æ€§ï¼ŒåŒ…å«åˆ™ä¸è¿˜åŸï¼ŒåŒæ—¶è¿”å›å€¼ä¸å”¯ä¸€çš„ä¹Ÿä¸æ˜¯çº¯å‡½æ•°</span><br><span class="line">    let literalList = [&#x27;window&#x27;, &#x27;document&#x27;, &#x27;navigator&#x27;, &#x27;location&#x27;, &#x27;history&#x27;, &#x27;screen&#x27;, &#x27;try&#x27;, &#x27;random&#x27;, &#x27;Date&#x27;];</span><br><span class="line">    let sourceCode = path.toString();</span><br><span class="line">    let allElementsValid = literalList.every(ele =&gt; !sourceCode.includes(ele)); // ä¸º true åˆ™ä¸åŒ…å«ï¼Œä¸º false åˆ™è¯´æ˜åŒ…å«</span><br><span class="line">    if (!allElementsValid) return false; // åŒ…å«åˆ™ä¸æ˜¯çº¯å‡½æ•°</span><br><span class="line"></span><br><span class="line">    path.traverse(&#123;</span><br><span class="line">        MemberExpression(innerPath) &#123;</span><br><span class="line">            const &#123; object &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(object) &amp;&amp; object.name !== &#x27;this&#x27; &amp;&amp; !path.scope.hasBinding(object.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        AssignmentExpression(innerPath) &#123;</span><br><span class="line">            const &#123; left &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(left) &amp;&amp; !path.scope.hasBinding(left.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        CallExpression(innerPath) &#123;</span><br><span class="line">            const &#123; callee &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(callee)) &#123;</span><br><span class="line">                const binding = path.scope.getBinding(callee.name);</span><br><span class="line">                if (!binding || !isPureFunction(binding.path)) &#123;</span><br><span class="line">                    isPure = false;</span><br><span class="line">                    innerPath.stop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        UpdateExpression(innerPath) &#123;</span><br><span class="line">            const &#123; argument &#125; = innerPath.node;</span><br><span class="line">            if (types.isIdentifier(argument) &amp;&amp; !path.scope.hasBinding(argument.name)) &#123;</span><br><span class="line">                isPure = false;</span><br><span class="line">                innerPath.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    return isPure;</span><br><span class="line">&#125;</span><br><span class="line">// èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­å‡½æ•°</span><br><span class="line">function isNodeLiteral(node) &#123;</span><br><span class="line">    if (Array.isArray(node))</span><br><span class="line">        return node.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isThisExpression(node))</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (types.isLiteral(node))</span><br><span class="line">        return node.value != null;</span><br><span class="line"></span><br><span class="line">    if (types.isBinaryExpression(node))</span><br><span class="line">        return isNodeLiteral(node.left) &amp;&amp; isNodeLiteral(node.right);</span><br><span class="line"></span><br><span class="line">    if (types.isUnaryExpression(node) &amp;&amp; (node.operator === &#x27;-&#x27; || node.operator === &#x27;+&#x27;))</span><br><span class="line">        return isNodeLiteral(node.argument);</span><br><span class="line"></span><br><span class="line">    if (types.isObjectExpression(node))</span><br><span class="line">        return node.properties.length === 0 || node.properties.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    if (types.isArrayExpression(node))</span><br><span class="line">        return node.elements.length === 0 || node.elements.every(isNodeLiteral);</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">// ä¸»è¦è¿˜åŸé€»è¾‘</span><br><span class="line">const callToString = &#123;</span><br><span class="line">    &quot;CallExpression&quot;: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; callee, arguments &#125; = path.node;</span><br><span class="line">            let &#123; name &#125; = callee;</span><br><span class="line">            if (!types.isIdentifier(callee) || arguments.length == 0 || !isNodeLiteral(arguments)) return;</span><br><span class="line"></span><br><span class="line">            let binding = path.scope.getBinding(name);</span><br><span class="line">            if (!binding) return;</span><br><span class="line"></span><br><span class="line">            let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">            // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line">            // 1. å½“ binding.path ä¸ºå‡½æ•°æ—¶ï¼Œåªèƒ½è¿˜åŸçº¯å‡½æ•°</span><br><span class="line">            try &#123;</span><br><span class="line">                if (binding.path.isFunctionDeclaration()) &#123;</span><br><span class="line">                    // console.log(binding.path + &#x27;&#x27;, path + &#x27;&#x27;);</span><br><span class="line">                    // ******** ä¸ºè§£å†³ä¸‹é¢åœ¨ binding.path ä¸ºèµ‹å€¼è¯­å¥æ—¶çš„è¿˜åŸä¸­ï¼Œä¸è¿˜åŸå…¶æœ¬èº«çš„è°ƒç”¨è¡¨è¾¾å¼çš„é—®é¢˜ ******** </span><br><span class="line">                    if (decryptCode.includes(binding.path.toString().match(/function\s+\w+\s*\([^)]*\)/g)[0])) &#123;</span><br><span class="line"></span><br><span class="line">                        let value = eval(path.toString());</span><br><span class="line">                        console.log(path + &#x27;&#x27;, &quot;--&gt;&quot;, value,);</span><br><span class="line">                        path.replaceWith(types.valueToNode(value));</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (!isPureFunction(binding.path)) return; // åˆ¤æ–­å‡½æ•°æ˜¯å¦æ˜¯çº¯å‡½æ•°ï¼Œä¸æ˜¯åˆ™ä¸å¤„ç†</span><br><span class="line"></span><br><span class="line">                    let &#123; id, params, body &#125; = binding.path.node;</span><br><span class="line">                    if (params.length == 0 || body.body.length == 0) return;</span><br><span class="line">                    // ******** ä¸“ç”¨æ’ä»¶é…ç½®é™åˆ¶ï¼šå‡½æ•°åã€å‡½æ•°è°ƒç”¨çš„å®å‚ä¸ªæ•°ã€å‡½æ•°å®šä¹‰çš„å‡½æ•°ä½“å¤§å° ********</span><br><span class="line">                    if (id.name == &#x27;ln&#x27; || body.body.length &gt; 10) return;</span><br><span class="line">                    if (!types.isReturnStatement(body.body[body.body.length - 1])) return;</span><br><span class="line"></span><br><span class="line">                    eval(binding.path.toString());</span><br><span class="line"></span><br><span class="line">                    if (constantViolations.length &gt; 1) return;</span><br><span class="line">                    if (constant || constantViolations[0] == binding.path) &#123; // å¦‚æœä¸ºå¸¸é‡ï¼Œæˆ–æ›´æ”¹çš„é‚£ä¸€æ¬¡ä¸ºå®šä¹‰çš„é‚£ä¸€æ¬¡</span><br><span class="line">                        let value = eval(path.toString());</span><br><span class="line">                        console.log(path + &#x27;&#x27;, &#x27;--&gt;&#x27;, value);</span><br><span class="line">                        path.replaceWith(types.valueToNode(value));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (e) &#123; &#125;</span><br><span class="line">            // 2. å½“ binding.path ä¸ºèµ‹å€¼è¯­å¥æˆ–å˜é‡å®šä¹‰æ—¶ï¼Œéœ€è¦åœ¨ decode ä¸­å‡†å¤‡å”¯ä¸€è¢«è¿˜åŸå‡½æ•°</span><br><span class="line">            try &#123;</span><br><span class="line">                var funcNameArr = [&#x27;n&#x27;] // å”¯ä¸€è¢«è¿˜åŸå‡½æ•°çš„å‡½æ•°å</span><br><span class="line">                if (binding.path.isVariableDeclarator()) &#123;</span><br><span class="line">                    // console.log(binding.path.parentPath + &#x27;&#x27;, path + &#x27;&#x27;, referenced, references, constant, constantViolations.length);</span><br><span class="line">                    if (constantViolations.length &gt; 1) return;</span><br><span class="line">                    if (constant || (constantViolations.length == 1 &amp;&amp; constantViolations[0].isAssignmentExpression())) &#123; // å˜é‡å®šä¹‰åªæœ‰ä¸€æ¬¡æ”¹å˜ï¼Œæˆ–æ²¡æ”¹å˜</span><br><span class="line">                        // console.log(binding.path.parentPath + &#x27;&#x27;, path + &#x27;&#x27;);</span><br><span class="line">                        let &#123; id, init &#125; = binding.path.node;</span><br><span class="line">                        let &#123; name &#125; = id;</span><br><span class="line">                        if (init == null) &#123;</span><br><span class="line">                            init = types.identifier(constantViolations[0].node.right.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (!types.isIdentifier(id) || !funcNameArr.includes(init.name)) return;</span><br><span class="line">                        funcNameArr.push(name);</span><br><span class="line"></span><br><span class="line">                        let newCallExpression = types.callExpression(types.identifier(&#x27;n&#x27;), arguments);</span><br><span class="line">                        let value = eval(generator(newCallExpression).code);</span><br><span class="line">                        console.log(path + &#x27;&#x27;, &quot;--&gt;&quot;, value,);</span><br><span class="line">                        path.replaceWith(types.valueToNode(value));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, callToString);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">// åˆ é™¤è¿˜åŸä½¿ç”¨çš„ç¯å¢ƒå‡½æ•°ï¼Œå·²æ— ç”¨</span><br><span class="line">const collectRemoveTsCallToString = &#123;</span><br><span class="line">    FunctionDeclaration(path) &#123;</span><br><span class="line">        let collectFuncCode = [];</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; id, params, body &#125; = node;</span><br><span class="line">        if (params.length != 2 || body.body.length != 1) return;</span><br><span class="line">        if (!types.isCallExpression(node.body.body[0].argument)) return;</span><br><span class="line"></span><br><span class="line">        var name = id.name;</span><br><span class="line">        let binding = parentPath.scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        collectFuncCode.push(path);</span><br><span class="line"></span><br><span class="line">        try &#123; // ä½¿ç”¨ try æ˜¯å› ä¸ºæ˜æ˜èŠ‚ç‚¹å­˜åœ¨ï¼Œä½†ä¾ç„¶ä¼šæŠ¥é”™ï¼Œå®æµ‹æ•è·å¼‚å¸¸ä¸å½±å“åˆ é™¤åŠŸèƒ½</span><br><span class="line">            function xxx(path) &#123;</span><br><span class="line">                let tempName = path.node.body.body[0].argument.callee.name;</span><br><span class="line">                let tempBinding = path.scope.getBinding(tempName);</span><br><span class="line">                if (!tempBinding) return;</span><br><span class="line">                collectFuncCode.push(tempBinding.path);</span><br><span class="line"></span><br><span class="line">                if (tempBinding.path.node.body.body.length == 1) &#123;</span><br><span class="line">                    let recursiveBinding = xxx(tempBinding.path);</span><br><span class="line">                    if (recursiveBinding) return recursiveBinding;</span><br><span class="line">                &#125;</span><br><span class="line">                return tempBinding;</span><br><span class="line">            &#125;</span><br><span class="line">            callFuncBinding = xxx(path);</span><br><span class="line">            if (!callFuncBinding) return;</span><br><span class="line"></span><br><span class="line">            let bigArrFuncName = callFuncBinding.path.node.body.body[0].declarations[0].init.callee.name;</span><br><span class="line">            let bigArrFuncBinding = callFuncBinding.scope.getBinding(bigArrFuncName);</span><br><span class="line">            if (!bigArrFuncBinding) return;</span><br><span class="line">            collectFuncCode.push(bigArrFuncBinding.path);</span><br><span class="line"></span><br><span class="line">            // å¤„ç†æœ‰äº›å¤§æ•°ç»„å­˜åœ¨çš„ç§»ä½è‡ªæ‰§è¡Œå‡½æ•°</span><br><span class="line">            let referencePaths_3 = bigArrFuncBinding.referencePaths;</span><br><span class="line">            for (let reference of referencePaths_3) &#123;</span><br><span class="line">                if (!reference.parentPath.isCallExpression()) continue;</span><br><span class="line"></span><br><span class="line">                let &#123; callee, arguments &#125; = reference.parentPath.node;</span><br><span class="line">                if (!types.isFunctionExpression(callee) || arguments.length != 1 || arguments[0].name != bigArrFuncName) continue;</span><br><span class="line">                collectFuncCode.push(reference.parentPath.parentPath);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            for (let i of collectFuncCode) &#123;</span><br><span class="line">                i.remove();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; catch &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, collectRemoveTsCallToString);</span><br><span class="line"></span><br><span class="line">// æœ€åä½¿ç”¨ï¼šåƒåœ¾ä»£ç åˆ é™¤</span><br><span class="line">function containsSequenceExpression(path) &#123;</span><br><span class="line">    let containsSequence = false;</span><br><span class="line">    // æ·±åº¦ä¼˜å…ˆéå†å½“å‰è·¯å¾„åŠå…¶æ‰€æœ‰å­è·¯å¾„</span><br><span class="line">    path.traverse(&#123;</span><br><span class="line">        &quot;SequenceExpression|AssignmentExpression&quot;(_path) &#123;</span><br><span class="line">            containsSequence = true;</span><br><span class="line">            _path.stop(); // æ‰¾åˆ°é€—å·è¡¨è¾¾å¼åç«‹å³åœæ­¢éå†</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    return containsSequence;</span><br><span class="line">&#125;</span><br><span class="line">const removeDeadCode = &#123;</span><br><span class="line">    &quot;IfStatement|ConditionalExpression&quot;(path) &#123;</span><br><span class="line">        let &#123; node &#125; = path;</span><br><span class="line">        let &#123; consequent, alternate &#125; = node;</span><br><span class="line">        let testPath = path.get(&#x27;test&#x27;);</span><br><span class="line"></span><br><span class="line">        //ä¸å¤„ç†é€—å·è¡¨è¾¾å¼ï¼Œèµ‹å€¼è¯­å¥é˜²æ­¢è¯¯åˆ </span><br><span class="line">        if (testPath.isSequenceExpression() || testPath.isAssignmentExpression() || containsSequenceExpression(testPath)) return;</span><br><span class="line"></span><br><span class="line">        const evaluateTest = testPath.evaluateTruthy();</span><br><span class="line">        if (evaluateTest === true) &#123;</span><br><span class="line">            if (types.isBlockStatement(consequent)) &#123;</span><br><span class="line">                consequent = consequent.body;</span><br><span class="line">            &#125;</span><br><span class="line">            path.replaceWithMultiple(consequent);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (evaluateTest === false) &#123;</span><br><span class="line">            if (alternate != null) &#123;</span><br><span class="line">                if (types.isBlockStatement(alternate)) &#123;</span><br><span class="line">                    alternate = alternate.body;</span><br><span class="line">                &#125;</span><br><span class="line">                path.replaceWithMultiple(alternate);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                path.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;LogicalExpression&quot;(path) &#123;</span><br><span class="line">        let &#123; node &#125; = path;</span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        let leftPath = path.get(&#x27;left&#x27;);</span><br><span class="line"></span><br><span class="line">        //ä¸å¤„ç†é€—å·è¡¨è¾¾å¼ï¼Œèµ‹å€¼è¯­å¥é˜²æ­¢è¯¯åˆ </span><br><span class="line">        if (leftPath.isSequenceExpression() || leftPath.isAssignmentExpression() || containsSequenceExpression(leftPath)) return;</span><br><span class="line"></span><br><span class="line">        const evaluateLeft = leftPath.evaluateTruthy();</span><br><span class="line">        if ((operator == &quot;||&quot; &amp;&amp; evaluateLeft == true) || (operator == &quot;&amp;&amp;&quot; &amp;&amp; evaluateLeft == false)) &#123;</span><br><span class="line">            path.replaceWith(left);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if ((operator == &quot;||&quot; &amp;&amp; evaluateLeft == false) || (operator == &quot;&amp;&amp;&quot; &amp;&amp; evaluateLeft == true)) &#123;</span><br><span class="line">            path.replaceWith(right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;EmptyStatement|DebuggerStatement&quot;(path) &#123;</span><br><span class="line">        path.remove();</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;VariableDeclarator&quot;(path) &#123;</span><br><span class="line">        let &#123; node, scope, parentPath, parent &#125; = path;</span><br><span class="line">        let ancestryPath = parentPath.parentPath;</span><br><span class="line"></span><br><span class="line">        // forå¾ªç¯ä¸­çš„å˜é‡å®šä¹‰ä¸èƒ½åˆ é™¤</span><br><span class="line">        if (ancestryPath.isForOfStatement(&#123; left: parent &#125;) || ancestryPath.isForInStatement(&#123; left: parent &#125;)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; id, init &#125; = node;</span><br><span class="line">        //ç›®å‰åªå‘ç°èµ‹å€¼è¯­å¥å’Œè°ƒç”¨è¯­å¥ä¼šæœ‰é—®é¢˜ã€‚åç»­å¾…æ·»åŠ </span><br><span class="line">        if (!types.isIdentifier(id) || types.isCallExpression(init) || types.isAssignmentExpression(init)) return;</span><br><span class="line"></span><br><span class="line">        let binding = scope.getBinding(id.name); // é‡æ–°è§£æaståï¼Œä¸€å®šä¼šæœ‰binding</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations &#125; = binding;</span><br><span class="line">        // console.log(id.name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; å˜é‡å®šä¹‰:&quot;, path.parentPath + &#x27;&#x27;);</span><br><span class="line">            path.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;AssignmentExpression&quot;(path) &#123;</span><br><span class="line">        let &#123; scope, parentPath, node &#125; = path;</span><br><span class="line">        if (!parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        let &#123; left, operator, right &#125; = node;</span><br><span class="line">        if (!types.isIdentifier(left) || operator != &#x27;=&#x27;) return;</span><br><span class="line"></span><br><span class="line">        let name = left.name;</span><br><span class="line">        let binding = scope.getBinding(name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line"></span><br><span class="line">        let &#123; referenced, constant, constantViolations &#125; = binding;</span><br><span class="line">        // console.log(path + &#x27;&#x27;, referenced, constant, constantViolations.length);</span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; èµ‹å€¼è¯­å¥:&quot;, path + &#x27;&#x27;);</span><br><span class="line">            path.remove();</span><br><span class="line">            if (binding.path.parentPath.isFunctionExpression() || binding.path.parentPath.isFunctionDeclaration()) &#123;</span><br><span class="line">                binding.path.remove(); // åˆ é™¤çš„å‡½æ•°å½¢å‚</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ContinueStatement|BreakStatement|ReturnStatement|ThrowStatement&quot;(path) &#123;</span><br><span class="line">        if (!path.parentPath.isSwitchCase()) return; // åªå¤„ç†åœ¨ switch-case è¯­å¥ä¸­çš„</span><br><span class="line">        let AllNextSiblings = path.getAllNextSiblings(); // è·å–æ‰€æœ‰çš„åç»­å…„å¼ŸèŠ‚ç‚¹</span><br><span class="line">        for (let nextSibling of AllNextSiblings) &#123;</span><br><span class="line">            if (nextSibling.isFunctionDeclaration() || nextSibling.isVariableDeclaration(&#123; kind: &quot;var&quot; &#125;)) &#123; //å˜é‡æå‡.....</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            nextSibling.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;FunctionDeclaration&quot;(path) &#123;</span><br><span class="line">        let &#123; scope, node, parentPath &#125; = path;</span><br><span class="line">        let &#123; id, params &#125; = node;</span><br><span class="line">        if (!params) return;</span><br><span class="line">        let flag = true;</span><br><span class="line"></span><br><span class="line">        let binding = parentPath.scope.getBinding(id.name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations &#125; = binding;</span><br><span class="line">        // console.log(id.name, referenced, references, constant, constantViolations.length);</span><br><span class="line">        if (referenced || constantViolations.length &gt; 1) return;</span><br><span class="line">        if (constant || constantViolations[0] == path) &#123;</span><br><span class="line">            console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; å‡½æ•°å®šä¹‰:&quot;, path + &#x27;&#x27;);</span><br><span class="line">            path.remove();</span><br><span class="line">            flag = false;</span><br><span class="line">        &#125;</span><br><span class="line">        if (flag) &#123;</span><br><span class="line">            for (let i of params) &#123;</span><br><span class="line">                if (!types.isIdentifier(i)) continue;</span><br><span class="line">                let binding = scope.getBinding(i.name);</span><br><span class="line">                if (!binding) continue;</span><br><span class="line"></span><br><span class="line">                let &#123; references, constantViolations &#125; = binding;</span><br><span class="line">                if (references === 0 &amp;&amp; constantViolations.length === 0) &#123;</span><br><span class="line">                    // å°†æœªä½¿ç”¨çš„å‚æ•°æ ‡è®°ä¸ºåˆ é™¤</span><br><span class="line">                    console.log(&quot;åƒåœ¾ä»£ç åˆ é™¤&quot;, &quot;--&gt; å‡½æ•°å½¢å‚:&quot;, i.name);</span><br><span class="line">                    params = params.filter(param =&gt; param !== i);</span><br><span class="line">                    console.log(params);</span><br><span class="line">                &#125;</span><br><span class="line">                path.node.params = params;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">for (let i = 0; i &lt; 5; i++) &#123;</span><br><span class="line">    traverse(ast, removeDeadCode); // åˆ é™¤ä¸å¤Ÿå½»åº•åˆ™å†è°ƒç”¨ä¸€æ¬¡ï¼Œä»¥æ­¤ç±»æ¨</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">console.timeEnd(&quot;å¤„ç†å®Œæ¯•ï¼Œè€—æ—¶&quot;);</span><br><span class="line">let &#123; code &#125; = generator(ast, opts = &#123;</span><br><span class="line">    &quot;compact&quot;: false,  // æ˜¯å¦å‹ç¼©ä»£ç </span><br><span class="line">    &quot;comments&quot;: false,  // æ˜¯å¦ä¿ç•™æ³¨é‡Š</span><br><span class="line">    &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125;,  // Unicodeè½¬ä¹‰ï¼Œç¡®ä¿éASCIIå­—ç¬¦è¢«æ­£ç¡®åœ°ä¿ç•™å’Œæ˜¾ç¤ºï¼Œè€Œä¸æ˜¯è¢«è½¬ä¹‰</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">files.writeFile(decodeFile, code, (err) =&gt; &#123; &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="7-æ’ä»¶-px3-å‡½æ•°é‡å‘½å"><a href="#7-æ’ä»¶-px3-å‡½æ•°é‡å‘½å" class="headerlink" title="7. æ’ä»¶ -&gt; px3 å‡½æ•°é‡å‘½å"></a>7. æ’ä»¶ -&gt; px3 å‡½æ•°é‡å‘½å</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">/* </span><br><span class="line">è‡ªæ‰§è¡Œå‡½æ•°å¤–é¢æœ‰ä¸ªQå‡½æ•°ï¼Œè‡ªæ‰§è¡Œå‡½æ•°é‡Œé¢åˆä¸€ä¸ªåŒåçš„Qå‡½æ•°ï¼Œå¦‚æœä½¿ç”¨ obæ··æ·†ä¸€é”®è¿˜åŸè„šæœ¬é‡Œçš„æ€è·¯ï¼Œæ˜¯ä¼šè¦†ç›–æ‰å‰ä¸€ä¸ª Q å‡½æ•°çš„å£°æ˜ï¼Œå¯¹äºå®ƒçš„è°ƒç”¨ï¼Œè§£å¯†è‚¯å®šä¼šå‡ºé”™ã€‚</span><br><span class="line"></span><br><span class="line">å› æ­¤ï¼Œæˆ‘çš„æ€è·¯ï¼Œæ˜¯ï¼Œå°†æ‰€æœ‰çš„è¿™ç§ ç‰¹å¾å‡½æ•°ï¼Œå°†å®ƒçš„å‡½æ•°åé‡å‘½åï¼Œå¹¶åŒæ—¶ä¿®æ”¹å¼•ç”¨çš„ä½ç½®ï¼Œè¿™æ ·ï¼Œå°±å¯ä»¥é¿å…åŒåå‡½æ•°äº†ã€‚</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">function getRandomName(length) &#123;</span><br><span class="line">    let initArr = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27;, &#x27;f&#x27;, &#x27;g&#x27;, &#x27;h&#x27;, &#x27;i&#x27;, &#x27;j&#x27;, &#x27;k&#x27;, &#x27;l&#x27;, &#x27;m&#x27;, &#x27;n&#x27;, &#x27;o&#x27;, &#x27;p&#x27;, &#x27;q&#x27;, &#x27;r&#x27;, &#x27;s&#x27;, &#x27;t&#x27;, &#x27;u&#x27;, &#x27;v&#x27;, &#x27;w&#x27;, &#x27;x&#x27;, &#x27;y&#x27;, &#x27;z&#x27;];</span><br><span class="line">    let puzzleArr = [&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;, &#x27;D&#x27;, &#x27;E&#x27;, &#x27;F&#x27;, &#x27;G&#x27;, &#x27;H&#x27;, &#x27;I&#x27;, &#x27;J&#x27;, &#x27;K&#x27;, &#x27;L&#x27;, &#x27;M&#x27;, &#x27;N&#x27;, &#x27;O&#x27;, &#x27;P&#x27;, &#x27;Q&#x27;, &#x27;R&#x27;, &#x27;S&#x27;, &#x27;T&#x27;, &#x27;U&#x27;, &#x27;V&#x27;, &#x27;W&#x27;, &#x27;X&#x27;, &#x27;Y&#x27;, &#x27;Z&#x27;];</span><br><span class="line">    let ranInx = Math.floor(Math.random() * initArr.length);</span><br><span class="line">    let randomName = initArr[ranInx];</span><br><span class="line"></span><br><span class="line">    for (var i = 1; i &lt; length; i++) &#123;</span><br><span class="line">        ranInx = Math.floor(Math.random() * puzzleArr.length);</span><br><span class="line">        randomName += puzzleArr[ranInx];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return randomName;</span><br><span class="line">&#125;</span><br><span class="line">let allNewNames = new Map(); //å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä¿å­˜éœ€è¦å¤„ç†çš„å‡½æ•°</span><br><span class="line"></span><br><span class="line">//è·å–æœªè¢«ä½¿ç”¨çš„åç§°,è¿”å› Identifier ç±»å‹ã€‚</span><br><span class="line">function getUnusedIdentifier() &#123;</span><br><span class="line">    do &#123;</span><br><span class="line">        var newName = &quot;$C_&quot; + getRandomName(3);</span><br><span class="line">    &#125; while (allNewNames.has(newName))</span><br><span class="line"></span><br><span class="line">    allNewNames.set(newName, 1);</span><br><span class="line">    let UnusedIdentifier = types.Identifier(newName);</span><br><span class="line"></span><br><span class="line">    return UnusedIdentifier;</span><br><span class="line">&#125;</span><br><span class="line">const renameFunc = &#123;</span><br><span class="line">    FunctionDeclaration(path) &#123;</span><br><span class="line">        let &#123; node, parentPath &#125; = path;</span><br><span class="line">        let &#123; id, params, body &#125; = node;</span><br><span class="line">        let name = id.name;</span><br><span class="line"></span><br><span class="line">        // PX3ç‰¹å¾å‡½æ•°</span><br><span class="line">        if (params.length != 2 || body.body.length != 1 ||</span><br><span class="line">            !types.isReturnStatement(body.body[0]) || !types.isCallExpression(body.body[0].argument)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        let binding = parentPath.scope.getBinding(name);</span><br><span class="line">        if (!binding || !binding.constant) return;</span><br><span class="line"></span><br><span class="line">        let newNameId = getUnusedIdentifier();</span><br><span class="line">        for (let referPath of binding.referencePaths) &#123;</span><br><span class="line">            referPath.replaceWith(newNameId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        let newName = newNameId.name;</span><br><span class="line">        allNewNames.set(newName, name)</span><br><span class="line">        path.node.id.name = newName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, renameFunc);</span><br><span class="line">allNewNames.clear();</span><br></pre></td></tr></table></figure>

<h2 id="åã€Akamai-2-0-è¿˜åŸä¸“é¢˜"><a href="#åã€Akamai-2-0-è¿˜åŸä¸“é¢˜" class="headerlink" title="åã€Akamai 2.0 è¿˜åŸä¸“é¢˜"></a>åã€Akamai 2.0 è¿˜åŸä¸“é¢˜</h2><blockquote>
<p><strong>æœ‰ä¸ªå‘ï¼Œè¿˜åŸè¿‡åï¼Œæœ‰äº›ä»£ç çš„å®šä¹‰åœ¨æœ€å¤–å±‚ return ä¸‹é¢å¯¼è‡´æ›¿æ¢æ— æ•ˆï¼Œéœ€è¦æ‰‹åŠ¨å°†å…¶ç§»ä¸Šå»</strong></p>
</blockquote>
<h3 id="0-æŠ€å·§-è¿‡-toString-æ£€æµ‹"><a href="#0-æŠ€å·§-è¿‡-toString-æ£€æµ‹" class="headerlink" title="0. æŠ€å·§ -&gt; è¿‡ toString æ£€æµ‹"></a>0. æŠ€å·§ -&gt; è¿‡ toString æ£€æµ‹</h3><ul>
<li><strong>å®ç°æ­¥éª¤ï¼š</strong><ol>
<li>ä»ç½‘é¡µä¸Šå¤åˆ¶ä¸‹æ¥çš„æºç ä¸è¦æ ¼å¼åŒ–ï¼Œå‹ç¼©ä¸ºä¸€è¡Œï¼Œç›´æ¥ç”¨äº AST è§£æçš„ encode.js æ–‡ä»¶</li>
<li>åˆ©ç”¨ä»¥ä¸‹è„šæœ¬å¯¹æºç è¿›è¡Œè§£æï¼Œå¾—åˆ°ç”¨äºè¿‡æ‰ toString æ£€æµ‹çš„è„šæœ¬æ–¹æ³•</li>
<li>æœ€åå°†ä¸Šä¸€æ­¥å¾—åˆ°çš„è„šæœ¬æ–¹æ³•ï¼Œæ·»åŠ åˆ°æœ€ç»ˆç»è¿‡ AST è¿˜åŸï¼ˆå•ç‹¬å¯¹æºç è¿›è¡Œè§£æ··æ·†ï¼‰åçš„ä»£ç çš„æœ€å‰é¢</li>
<li>æœ€åé€šè¿‡æµè§ˆå™¨æ˜ å°„æŠ€æœ¯ï¼Œæ¯”å¦‚ Charles çš„æœ¬åœ°æ˜ å°„æ¥å®ç°æ›¿æ¢ç½‘é¡µæ–‡ä»¶å¹¶è°ƒè¯•</li>
</ol>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">const _path = require(&#x27;path&#x27;);</span><br><span class="line">const files = require(&#x27;fs&#x27;);  // å¯¼å…¥æ–‡ä»¶åº“ï¼Œé˜²æ­¢ä¸fså˜é‡åå†²çª</span><br><span class="line">const types = require(&quot;@babel/types&quot;);</span><br><span class="line">const parser = require(&quot;@babel/parser&quot;);</span><br><span class="line">const template = require(&quot;@babel/template&quot;).default;</span><br><span class="line">const traverse = require(&quot;@babel/traverse&quot;).default;</span><br><span class="line">const generator = require(&quot;@babel/generator&quot;).default;</span><br><span class="line">const NodePath = require(&quot;@babel/traverse&quot;).NodePath; // æ™ºèƒ½æç¤ºæ‰€éœ€</span><br><span class="line"></span><br><span class="line">const encodeFile = _path.resolve(__dirname, &#x27;encode.js&#x27;);</span><br><span class="line">const decodeFile = _path.resolve(__dirname, &#x27;toStringResult.js&#x27;);</span><br><span class="line">let sourceCode = files.readFileSync(encodeFile, &#123; encoding: &quot;utf-8&quot; &#125;);</span><br><span class="line">let ast = parser.parse(sourceCode);</span><br><span class="line">console.time(&quot;å¤„ç†å®Œæ¯•ï¼Œè€—æ—¶&quot;);</span><br><span class="line"></span><br><span class="line">let funStringPointArray = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">// ä¿å­˜å‡½æ•°æºä»£ç ï¼Œä¸ä½¿ç”¨ toString() å’Œ compact å‹ç¼©é€‰é¡¹ï¼ŒéåŸå§‹æ··æ·†ä»£ç </span><br><span class="line">const saveFuncString = &#123;</span><br><span class="line">	&quot;FunctionDeclaration&quot;(path) &#123;</span><br><span class="line">		let &#123; id, start, end &#125; = path.node;</span><br><span class="line">		funStringPointArray[id.name] = [start, end];</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;VariableDeclarator&quot;(path) &#123;</span><br><span class="line">		let &#123; id, init &#125; = path.node;</span><br><span class="line">		if (types.isFunctionExpression(init)) &#123;</span><br><span class="line">			let &#123; start, end &#125; = init;</span><br><span class="line">			funStringPointArray[id.name] = [start, end];</span><br><span class="line"></span><br><span class="line">			if (init.id != null) &#123;</span><br><span class="line">				funStringPointArray[init.id.name] = [start, end];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		if (types.isCallExpression(init) &amp;&amp; types.isFunctionExpression(init.callee)) &#123;</span><br><span class="line">			let &#123; start, end &#125; = init.callee;</span><br><span class="line">			funStringPointArray[id.name] = [start, end];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, saveFuncString);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var funStringArray = &#123;&#125;;</span><br><span class="line">for (var funName in funStringPointArray) &#123;</span><br><span class="line">	funStringArray[funName] = sourceCode.substring(funStringPointArray[funName][0], funStringPointArray[funName][1]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é€šè¿‡é‡å†™ Function.prototype.toStringï¼Œç¡®ä¿å½“è°ƒç”¨ toString() æ–¹æ³•æ—¶ï¼Œè¿”å›çš„æ˜¯åŸå§‹çš„æœªæ··æ·†ä»£ç ç‰‡æ®µ</span><br><span class="line">let data = `var _old = Function.prototype.toString.call;</span><br><span class="line">var tostringData = ` + JSON.stringify(funStringArray) + `\n</span><br><span class="line">Function.prototype.toString.call = function (arg) &#123;</span><br><span class="line">    if(tostringData.hasOwnProperty(arg.name))&#123;</span><br><span class="line">        return tostringData[arg.name];</span><br><span class="line">    &#125;</span><br><span class="line">    return _old.call(this, arg);</span><br><span class="line">&#125;;</span><br><span class="line">`</span><br><span class="line"></span><br><span class="line">console.timeEnd(&quot;å¤„ç†å®Œæ¯•ï¼Œè€—æ—¶&quot;);</span><br><span class="line">files.writeFile(decodeFile, data, (err) =&gt; &#123; &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="1-æ€è·¯-å›ºå®šç»“æœå‡½æ•°è¿˜åŸ"><a href="#1-æ€è·¯-å›ºå®šç»“æœå‡½æ•°è¿˜åŸ" class="headerlink" title="1. æ€è·¯ -&gt; å›ºå®šç»“æœå‡½æ•°è¿˜åŸ"></a>1. æ€è·¯ -&gt; å›ºå®šç»“æœå‡½æ•°è¿˜åŸ</h3><ul>
<li><strong>ç‰¹ç‚¹ï¼š</strong>é€šè¿‡åŸºæœ¬è·Ÿæ ˆå®šä½è‡³ 58 ä½å¤§æ•°ç»„ç”Ÿæˆä½ç½®ï¼Œå¯ä»¥å‘ç°å…¶ä¸Šé¢çš„ç±»ä¼¼ <code>Sx.zb.call(null, aa, bb)</code> çš„å‡½æ•°è°ƒç”¨ï¼Œç»è¿‡æµ‹è¯•å¯ä»¥çŸ¥é“<strong>è¿™ç±»å‡½æ•°è°ƒç”¨çš„ç»“æœä¸å½¢å‚æ— å…³ï¼Œæ— è®ºä¼ å…¥ä»€ä¹ˆå½¢å‚éƒ½æ˜¯ä¸€æ ·çš„ç»“æœ</strong></li>
<li><strong>è¿˜åŸæ€è·¯ï¼š</strong>åˆ›å»ºæ–°å¯¹è±¡ deObjï¼Œå°†ä¸»è¦è°ƒç”¨å¯¹è±¡ enObj ä¸­çš„æ¯ä¸ªå±æ€§å’Œæ–¹æ³•çš„è°ƒç”¨ç»“æœéƒ½å­˜å‚¨åœ¨ deObj ä¸­ï¼Œå†åˆ©ç”¨ AST éå†å¯¹åº”å‡½æ•°ï¼Œå°†å…¶è°ƒç”¨æ–¹æ³•è¿˜åŸä¸ºè¿™ä¸ª JSON å¯¹è±¡ä¸­çš„ç»“æœ</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">/* ******** å°† enObj ä¸­çš„æ¯ä¸ªå±æ€§å’Œæ–¹æ³•çš„è°ƒç”¨ç»“æœå­˜å‚¨åœ¨ deObj ä¸­ ********</span><br><span class="line">let enObj = Fn; // è¿™é‡Œçš„ Fn å³ä¸ºè°ƒç”¨çš„æœ€å¤–å±‚çš„å¯¹è±¡ï¼Œéœ€è¦ä¿®æ”¹</span><br><span class="line"></span><br><span class="line">let deObj = new Object();</span><br><span class="line">for (let key of Object.keys(enObj)) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        deObj[key] = enObj[key].apply(null,);</span><br><span class="line">    &#125; catch &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">copy(JSON.stringify(deObj))</span><br><span class="line">*********************************************************************/</span><br><span class="line"></span><br><span class="line">let enObjName = &quot;T6&quot;; // ä¸Šé¢ç”¨åˆ°çš„ enObj å¯¹è±¡</span><br><span class="line">let deObj = &#123;&quot;H2&quot;:&quot;-103&quot;,&quot;Rh&quot;:&quot;ButtonHighlight&quot;,&quot;ph&quot;:&quot;CaptionText&quot;, ...&#125; // å­˜å‚¨æ‰€æœ‰è°ƒç”¨ç»“æœçš„ JSON å¯¹è±¡</span><br><span class="line"></span><br><span class="line">// ä¸»è¦è¿˜åŸ Fn.xx.call(null, aa, bb) æˆ– Fn.xx(aa, bb) ç±»å‹çš„è°ƒç”¨è¡¨è¾¾å¼ï¼Œä¸”ç»“æœä¸å—å½¢å‚å½±å“</span><br><span class="line">const callToString = &#123;</span><br><span class="line">    CallExpression(path) &#123;</span><br><span class="line">        let &#123; callee &#125; = path.node;</span><br><span class="line">        if (!types.isMemberExpression(callee)) return;</span><br><span class="line"></span><br><span class="line">        let &#123; object, property, computed &#125; = callee;</span><br><span class="line">        // å¦‚æœ object æ˜¯æ ‡è¯†ç¬¦ï¼Œå³ Fn.xx(aa, bb)</span><br><span class="line">        if (types.isIdentifier(object, &#123; name: enObjName &#125;)) &#123;</span><br><span class="line">            let proName = computed ? property.value : property.name;</span><br><span class="line"></span><br><span class="line">            if (deObj.hasOwnProperty(proName)) &#123;</span><br><span class="line">                console.log(path + &#x27;&#x27;, &#x27;--&gt;&#x27;, deObj[proName]);</span><br><span class="line">                path.replaceWith(types.valueToNode(deObj[proName]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // å¦‚æœ object æ˜¯æˆå‘˜è¡¨è¾¾å¼ï¼Œå³ Fn.xx.call(null, aa, bb)</span><br><span class="line">        if (types.isMemberExpression(object)) &#123;</span><br><span class="line">            let proName = computed ? property.value : property.name;</span><br><span class="line">            if (![&#x27;apply&#x27;, &#x27;call&#x27;].includes(proName)) return;</span><br><span class="line"></span><br><span class="line">            if (object.object.name == enObjName) &#123;</span><br><span class="line">                let proName = object.computed ? object.property.value : object.property.name;</span><br><span class="line"></span><br><span class="line">                if (deObj.hasOwnProperty(proName)) &#123;</span><br><span class="line">                    console.log(path + &#x27;&#x27;, &#x27;--&gt;&#x27;, deObj[proName]);</span><br><span class="line">                    path.replaceWith(types.valueToNode(deObj[proName]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, callToString);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="2-æ€è·¯-å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ"><a href="#2-æ€è·¯-å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ" class="headerlink" title="2. æ€è·¯ -&gt; å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ"></a>2. æ€è·¯ -&gt; å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ</h3><ul>
<li>Akamai å­˜åœ¨ç”±å‡½æ•°ä½“è°ƒç”¨çš„å½¢å¼æ¥æ‰§è¡Œçš„ä»£ç ï¼Œå‡½æ•°æœ¬èº«æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œæ‰€ä»¥ä½¿ç”¨<strong>å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ</span><br><span class="line">const untruthFuncContent = &#123;</span><br><span class="line">    FunctionDeclaration(path) &#123;</span><br><span class="line">        let &#123; id, params, body &#125; = path.node;</span><br><span class="line">        if (params.length != 0 || body.body.length != 1 || !types.isExpressionStatement(body.body[0])) return;</span><br><span class="line"></span><br><span class="line">        let binding = path.scope.getBinding(id.name);</span><br><span class="line">        if (!binding) return;</span><br><span class="line">        let &#123; referenced, references, constant, constantViolations, referencePaths &#125; = binding;</span><br><span class="line">        // console.log(name, referenced, references, constant, constantViolations.length);</span><br><span class="line"></span><br><span class="line">        if (constantViolations.length &gt; 1 || !constant || referencePaths.length != 1) return;</span><br><span class="line">        let referPath = referencePaths[0]</span><br><span class="line">        let &#123; node, parentPath &#125; = referPath;</span><br><span class="line">        if (!parentPath.isCallExpression(&#123; callee: node &#125;)) return;</span><br><span class="line">        if (!parentPath.parentPath.isExpressionStatement()) return;</span><br><span class="line"></span><br><span class="line">        console.log(&quot;å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ:&quot;, path + &#x27;&#x27;);</span><br><span class="line">        parentPath.parentPath.replaceWith(body.body[0]);</span><br><span class="line">        path.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">traverse(ast, untruthFuncContent);</span><br><span class="line">ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br></pre></td></tr></table></figure>

<h3 id="3-æ€è·¯-å¤§é‡å­—é¢é‡è¿˜åŸ"><a href="#3-æ€è·¯-å¤§é‡å­—é¢é‡è¿˜åŸ" class="headerlink" title="3. æ€è·¯ -&gt; å¤§é‡å­—é¢é‡è¿˜åŸ"></a>3. æ€è·¯ -&gt; å¤§é‡å­—é¢é‡è¿˜åŸ</h3><ul>
<li>åŸºäºé¢„å¤„ç†è§£æ··æ·†æ¨¡ç‰ˆï¼Œè°ƒç”¨å¤šæ¬¡ <strong>åˆå¹¶å˜é‡å£°æ˜ä¸å®šä¹‰</strong>ã€<strong>å®šä¹‰å­—é¢é‡æœªæ”¹è¿˜åŸ</strong>ã€<strong>æŠ˜å å­—é¢é‡æˆ–è¡¨è¾¾å¼</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">for (let i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">    traverse(ast, combinDefineAndNextAssgin);</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">    traverse(ast, rebackVarDeclarator);</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">    traverse(ast, calcPartBinaryExpression);</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-æ€è·¯-ob-å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ"><a href="#4-æ€è·¯-ob-å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ" class="headerlink" title="4. æ€è·¯ -&gt; ob å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ"></a>4. æ€è·¯ -&gt; ob å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ</h3><ul>
<li>Akamai å­˜åœ¨å¤§é‡å…¸å‹çš„ OB æ··æ·†å‡½æ•°èŠ±æŒ‡ä»¤ï¼ŒAST å…¼å®¹ 3 ç§è¡¨è¾¾å¼è¿˜åŸå³å¯</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">// OB å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸï¼Œåˆ†åˆ«å¤„ç†å•å…ƒè¡¨è¾¾å¼ã€äºŒå…ƒè¡¨è¾¾å¼ã€æ•°ç»„</span><br><span class="line">const replaceExpressionOfReturn = (typeCheck, createReplacement) =&gt; (&#123;</span><br><span class="line">    FunctionDeclaration: &#123;</span><br><span class="line">        exit(path) &#123;</span><br><span class="line">            let &#123; scope, node &#125; = path;</span><br><span class="line">            let &#123; id, params, body &#125; = node;</span><br><span class="line">            if (body.body.length != 1 || !types.isReturnStatement(body.body[0]) || !typeCheck(body.body[0].argument)) return;</span><br><span class="line"></span><br><span class="line">            let expression = body.body[0].argument;</span><br><span class="line">            let binding = scope.getBinding(id.name);</span><br><span class="line">            if (!binding || !binding.constant) return;</span><br><span class="line"></span><br><span class="line">            let canRemoved = true;</span><br><span class="line">            for (let referPath of binding.referencePaths.reverse()) &#123;</span><br><span class="line">                let &#123; parentPath, node &#125; = referPath;</span><br><span class="line">                if (!parentPath.isCallExpression(&#123; &quot;callee&quot;: node &#125;)) &#123;</span><br><span class="line">                    canRemoved = false;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                let args = parentPath.node.arguments;</span><br><span class="line">                if (!createReplacement(args, expression)) &#123;</span><br><span class="line">                    canRemoved = false;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                console.log(parentPath.toString());</span><br><span class="line">                parentPath.replaceWith(createReplacement(args, expression));</span><br><span class="line">            &#125;</span><br><span class="line">            canRemoved &amp;&amp; path.remove();</span><br><span class="line">            path.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">const reStoreUnaryOfReturn = replaceExpressionOfReturn(</span><br><span class="line">    expr =&gt; types.isUnaryExpression(expr) &amp;&amp; types.isIdentifier(expr.argument),</span><br><span class="line">    (args, expr) =&gt; args.length == 1 ? types.unaryExpression(expr.operator, args[0], true) : null</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">const reStoreBinaryOfReturn = replaceExpressionOfReturn(</span><br><span class="line">    expr =&gt; types.isBinaryExpression(expr) &amp;&amp; types.isIdentifier(expr.left) &amp;&amp; types.isIdentifier(expr.right),</span><br><span class="line">    (args, expr) =&gt; args.length == 2 ? types.binaryExpression(expr.operator, args[0], args[1]) : null</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">const reStoreArrayOfReturn = replaceExpressionOfReturn(</span><br><span class="line">    expr =&gt; types.isArrayExpression(expr),</span><br><span class="line">    (args, expr) =&gt; args.length == 0 ? expr : null</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">for (let i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">    traverse(ast, reStoreUnaryOfReturn);</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">    traverse(ast, reStoreBinaryOfReturn);</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line"></span><br><span class="line">    traverse(ast, reStoreArrayOfReturn);</span><br><span class="line">    ast = parser.parse(generator(ast, opts = &#123; &quot;jsescOption&quot;: &#123; &quot;minimal&quot;: true &#125; &#125;).code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
                    
                </div>

                
                        
<div class="post-copyright-info-container border-box">
    <div class="copyright-info-content border-box">
        <div class="copyright-info-top border-box">
            <div class="copyright-post-title border-box text-ellipsis">
                JSé€†å‘_5_ASTè§£æ··æ·†
            </div>

            <div class="copyright-post-link border-box text-ellipsis">
                2024/09/01/JSé€†å‘_5_ASTè§£æ··æ·†/
            </div>
        </div>

        <div class="copyright-info-bottom border-box">
            <div class="copyright-post-author bottom-item">
                <div class="type">
                    ä½œè€…
                </div>
                <div class="content">xfblog</div>
            </div>

            <div class="post-time bottom-item">
                <div class="type">
                    å‘å¸ƒäº
                </div>
                <div class="content">2024-09-01 00:00</div>
            </div>


            <div class="post-license bottom-item">
                <div class="type">
                    è®¸å¯
                </div>
                <div class="content tooltip" data-tooltip-content="CC BY-NC-SA 4.0">
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" target="_blank">
                        
                            <i class="fa-brands fa-creative-commons"></i>
                            <i class="fa-brands fa-creative-commons-by"></i>
                            <i class="fa-brands fa-creative-commons-nc"></i>
                            <i class="fa-brands fa-creative-commons-sa"></i>
                        
                    </a>
                </div>
            </div>
        </div>

        <i class="copyright-bg fa-solid fa-copyright"></i>
    </div>
    <div class="copy-copyright-info flex-center tooltip" data-tooltip-content="å¤åˆ¶ç‰ˆæƒä¿¡æ¯" data-tooltip-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/JS%E9%80%86%E5%90%91/">JSé€†å‘</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E7%88%AC%E8%99%AB/">çˆ¬è™«</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/Python/">Python</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                            <div class="post-share-container border-box">
    <ul class="share-list-wrap border-box">
        <li class="qq share-item border-box flex-center tooltip"
            data-tooltip-content="åˆ†äº«åˆ° QQ"
        >
            <i class="fa-brands fa-qq"></i>
        </li>
        <li class="wechat share-item border-box flex-center tooltip tooltip-img"
            data-tooltip-content="åˆ†äº«åˆ°å¾®ä¿¡"
            data-tooltip-img-tip="å¾®ä¿¡æ‰«ä¸€æ‰«"
            data-tooltip-img-style="background-color: #fff; top: -10px; padding: 0.6rem 0.6rem 0.1rem 0.6rem;"
        >
            <i class="fa-brands fa-weixin"></i>
        </li>
        <li class="weibo share-item border-box flex-center tooltip"
            data-tooltip-content="åˆ†äº«åˆ°å¾®åš"
        >
            <i class="fa-brands fa-weibo"></i>
        </li>
    </ul>
</div>

                        
                    </div>
                </div>

                
                    

<div class="reward-author-container border-box flex-center">
    <div class="reward-btn border-box flex-center tooltip tooltip-img"
            data-tooltip-img-url="/images/zfb.webp"
            data-tooltip-img-trigger="click"
            data-tooltip-img-style="top: -6px;"
    >
        <i class="fa-solid fa-gift"></i>&nbsp;åˆ›ä½œä¸æ˜“ï¼Œæ‰“èµéšæ„ï¼Œæ‚¨çš„æ”¯æŒæ˜¯æˆ‘æ›´æ–°çš„åŠ¨åŠ›ğŸ’ªï¼
    </div>
</div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2024/11/01/%E8%AE%A1%E7%AE%97%E6%9C%BA_Configure/"
                                   title="è®¡ç®—æœº_Configure"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">è®¡ç®—æœº_Configure</span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2024/07/01/JS%E9%80%86%E5%90%91_4_%E8%A1%A5%E7%8E%AF%E5%A2%83%E4%B8%93%E9%A2%98/"
                                   title="JSé€†å‘_4_è¡¥ç¯å¢ƒä¸“é¢˜"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">JSé€†å‘_4_è¡¥ç¯å¢ƒä¸“é¢˜</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%B6%E3%80%81AST-%E9%80%9A%E7%94%A8%E6%A8%A1%E7%89%88"><span class="nav-text">é›¶ã€AST é€šç”¨æ¨¡ç‰ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%A7%A3%E6%B7%B7%E6%B7%86%E6%80%9D%E8%B7%AF%E4%B8%8E%E7%BB%86%E8%8A%82%E5%A4%84%E7%90%86"><span class="nav-text">1. __è§£æ··æ·†æ€è·¯ä¸ç»†èŠ‚å¤„ç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%A8%A1%E7%89%88-%E7%AE%80%E6%98%93%E7%89%88%E8%A7%A3%E6%B7%B7%E6%B7%86%E6%A8%A1%E7%89%88"><span class="nav-text">2. æ¨¡ç‰ˆ -&gt; ç®€æ˜“ç‰ˆè§£æ··æ·†æ¨¡ç‰ˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%A8%A1%E7%89%88-%E5%B8%B8%E7%94%A8-banding-%E5%86%99%E6%B3%95"><span class="nav-text">3. æ¨¡ç‰ˆ -&gt; å¸¸ç”¨ banding å†™æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%A8%A1%E7%89%88-%E9%A2%84%E5%A4%84%E7%90%86%E8%A7%A3%E6%B7%B7%E6%B7%86%E6%A8%A1%E7%89%88"><span class="nav-text">4. æ¨¡ç‰ˆ -&gt; é¢„å¤„ç†è§£æ··æ·†æ¨¡ç‰ˆ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81AST-%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98"><span class="nav-text">ä¸€ã€AST æŠ€æœ¯ä¸“é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%E5%8E%9F%E7%90%86"><span class="nav-text">1. ä»£ç æ··æ·†åŸç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%AF%AD%E6%B3%95%E6%A0%91%E8%8A%82%E7%82%B9%E5%90%8D%E8%AF%8D"><span class="nav-text">2. è¯­æ³•æ ‘èŠ‚ç‚¹åè¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-bable"><span class="nav-text">3. bable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-path"><span class="nav-text">4. path</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-scope"><span class="nav-text">5. scope</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E5%B8%B8%E8%A7%81%E8%AF%AD%E6%B3%95%E6%8A%80%E5%B7%A7"><span class="nav-text">6. å¸¸è§è¯­æ³•æŠ€å·§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-ast-%E5%BF%85%E5%A4%87-js-%E8%AF%AD%E6%B3%95%E4%B8%8E%E7%89%B9%E6%80%A7"><span class="nav-text">7. ast å¿…å¤‡ js è¯­æ³•ä¸ç‰¹æ€§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E5%8A%A8%E6%80%81-js-%E6%9B%BF%E6%8D%A2%E8%B0%83%E8%AF%95"><span class="nav-text">8. åŠ¨æ€ js æ›¿æ¢è°ƒè¯•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%88%A4%E6%96%AD%E8%8A%82%E7%82%B9%E9%80%9A%E7%94%A8%E5%87%BD%E6%95%B0"><span class="nav-text">äºŒã€åˆ¤æ–­èŠ‚ç‚¹é€šç”¨å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%87%BD%E6%95%B0-%E8%8A%82%E7%82%B9%E5%AD%97%E9%9D%A2%E9%87%8F%E5%9F%BA%E7%A1%80%E5%88%A4%E6%96%AD"><span class="nav-text">1. å‡½æ•° -&gt; èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%87%BD%E6%95%B0-%E8%8A%82%E7%82%B9%E5%AD%97%E9%9D%A2%E9%87%8F%E9%80%92%E5%BD%92%E5%88%A4%E6%96%AD"><span class="nav-text">2. å‡½æ•° -&gt; èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%87%BD%E6%95%B0%E4%BC%98%E5%8C%96-%E8%8A%82%E7%82%B9%E5%AD%90%E9%9D%A2%E9%87%8F%E5%88%A4%E6%96%AD"><span class="nav-text">3. å‡½æ•°ä¼˜åŒ– -&gt; èŠ‚ç‚¹å­é¢é‡åˆ¤æ–­</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%87%BD%E6%95%B0-%E5%88%A4%E6%96%AD%E8%8A%82%E7%82%B9%E6%98%AF%E5%90%A6%E7%BA%AF%E5%87%BD%E6%95%B0"><span class="nav-text">3. å‡½æ•° -&gt; åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦çº¯å‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E8%A7%A3%E6%B7%B7%E6%B7%86%E9%80%9A%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="nav-text">ä¸‰ã€è§£æ··æ·†é€šç”¨æ’ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%8F%92%E4%BB%B6-%E7%BC%96%E7%A0%81%E8%BF%98%E5%8E%9F%E5%8D%81%E8%BF%9B%E5%88%B6"><span class="nav-text">1. æ’ä»¶ -&gt; ç¼–ç è¿˜åŸåè¿›åˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8F%92%E4%BB%B6-%E6%A0%87%E8%AF%86%E7%AC%A6%E7%BB%9F%E4%B8%80%E5%AD%97%E9%9D%A2%E9%87%8F%E5%8C%96"><span class="nav-text">2. æ’ä»¶ -&gt; æ ‡è¯†ç¬¦ç»Ÿä¸€å­—é¢é‡åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8F%92%E4%BB%B6-%E6%8A%98%E5%8F%A0%E5%AD%97%E9%9D%A2%E9%87%8F%E6%88%96%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">3. æ’ä»¶ -&gt; æŠ˜å å­—é¢é‡æˆ–è¡¨è¾¾å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%8F%92%E4%BB%B6-%E7%AE%80%E5%8C%96%E5%BE%AA%E7%8E%AF%E5%92%8C-if-%E8%AF%AD%E5%8F%A5"><span class="nav-text">4. æ’ä»¶ -&gt; ç®€åŒ–å¾ªç¯å’Œ if è¯­å¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%8F%92%E4%BB%B6-%E7%AE%80%E5%8C%96%E9%80%97%E5%8F%B7%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">5. æ’ä»¶ -&gt; ç®€åŒ–é€—å·è¡¨è¾¾å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%8F%92%E4%BB%B6-%E5%AF%B9%E8%B1%A1-val-%E5%80%BC%E5%85%A8%E4%B8%BA%E5%B8%B8%E9%87%8F"><span class="nav-text">6. æ’ä»¶ -&gt; å¯¹è±¡ val å€¼å…¨ä¸ºå¸¸é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%8F%92%E4%BB%B6-%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E5%85%A8%E4%B8%BA%E5%B8%B8%E9%87%8F"><span class="nav-text">7. æ’ä»¶ -&gt; æ•°ç»„å…ƒç´ å…¨ä¸ºå¸¸é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E6%8F%92%E4%BB%B6-%E5%9E%83%E5%9C%BE%E4%BB%A3%E7%A0%81%E5%88%A0%E9%99%A4"><span class="nav-text">8. æ’ä»¶ -&gt; åƒåœ¾ä»£ç åˆ é™¤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%8F%98%E9%87%8F%E7%9B%B8%E5%85%B3%E6%8F%92%E4%BB%B6"><span class="nav-text">å››ã€å˜é‡ç›¸å…³æ’ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%8F%92%E4%BB%B6-%E5%88%86%E7%A6%BB%E5%A4%9A%E4%B8%AA%E5%8F%98%E9%87%8F%E5%90%8C%E5%AE%9A%E4%B9%89"><span class="nav-text">1. æ’ä»¶ -&gt; åˆ†ç¦»å¤šä¸ªå˜é‡åŒå®šä¹‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8F%92%E4%BB%B6-%E5%90%88%E5%B9%B6%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E4%B8%8E%E5%AE%9A%E4%B9%89"><span class="nav-text">2. æ’ä»¶ -&gt; åˆå¹¶å˜é‡å£°æ˜ä¸å®šä¹‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8F%92%E4%BB%B6-%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0%E8%BD%AC%E8%87%AA%E5%AE%9A"><span class="nav-text">3. æ’ä»¶ -&gt; å˜é‡å®šä¹‰å‡½æ•°è½¬è‡ªå®š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%8F%92%E4%BB%B6-%E5%AE%9A%E4%B9%89%E5%AD%97%E9%9D%A2%E9%87%8F%E6%9C%AA%E6%94%B9%E8%BF%98%E5%8E%9F"><span class="nav-text">4. æ’ä»¶ -&gt; å®šä¹‰å­—é¢é‡æœªæ”¹è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%8F%92%E4%BB%B6-%E8%B5%8B%E5%80%BC%E5%AD%97%E9%9D%A2%E9%87%8F%E6%9C%AA%E6%94%B9%E8%BF%98%E5%8E%9F"><span class="nav-text">5. æ’ä»¶ -&gt; èµ‹å€¼å­—é¢é‡æœªæ”¹è¿˜åŸ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%87%BD%E6%95%B0%E7%9B%B8%E5%85%B3%E6%8F%92%E4%BB%B6"><span class="nav-text">äº”ã€å‡½æ•°ç›¸å…³æ’ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%8F%92%E4%BB%B6-%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%BF%98%E5%8E%9F"><span class="nav-text">1. æ’ä»¶ -&gt; å†…ç½®å‡½æ•°è°ƒç”¨è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8F%92%E4%BB%B6-%E5%81%87%E5%87%BD%E6%95%B0%E4%BD%93%E5%86%85%E5%AE%B9%E8%BF%98%E5%8E%9F"><span class="nav-text">2. æ’ä»¶ -&gt; å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8F%92%E4%BB%B6-ob-%E5%85%B8%E5%9E%8B%E8%8A%B1%E6%8C%87%E4%BB%A4%E8%BF%98%E5%8E%9F"><span class="nav-text">3. æ’ä»¶ -&gt; ob å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E6%9D%A1%E4%BB%B6%E4%B8%8E%E9%80%BB%E8%BE%91%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9B%B8%E5%85%B3%E6%8F%92%E4%BB%B6"><span class="nav-text">å…­ã€æ¡ä»¶ä¸é€»è¾‘è¡¨è¾¾å¼ç›¸å…³æ’ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%B5%8C%E5%A5%97%E5%9C%A8%E8%AF%AD%E5%8F%A5%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8C%96"><span class="nav-text">1. åµŒå¥—åœ¨è¯­å¥ä¸­çš„ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9D%A1%E4%BB%B6%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%BD%AC-if-%E8%AF%AD%E5%8F%A5"><span class="nav-text">2. æ¡ä»¶è¡¨è¾¾å¼è½¬ if è¯­å¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%815s-%E7%9B%BE%E8%A7%A3%E6%B7%B7%E6%B7%86%E4%B8%93%E9%A2%98"><span class="nav-text">ä¸ƒã€5s ç›¾è§£æ··æ·†ä¸“é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%96%B0%E7%89%88%E9%80%9A%E7%94%A8%E6%8F%92%E4%BB%B6-%E8%AF%BB%E5%8F%96%E8%A7%A3%E5%AF%86%E4%BB%A3%E7%A0%81"><span class="nav-text">1. æ–°ç‰ˆé€šç”¨æ’ä»¶ -&gt; è¯»å–è§£å¯†ä»£ç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%96%B0%E7%89%88%E9%80%9A%E7%94%A8%E6%8F%92%E4%BB%B6-%E8%BF%98%E5%8E%9F-call"><span class="nav-text">2. æ–°ç‰ˆé€šç”¨æ’ä»¶ -&gt; è¿˜åŸ call()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%B8%93%E7%94%A8%E6%8F%92%E4%BB%B6-%E8%AF%BB%E5%8F%96%E5%B9%B6%E8%BF%98%E5%8E%9F-call"><span class="nav-text">3. ä¸“ç”¨æ’ä»¶ -&gt; è¯»å–å¹¶è¿˜åŸ call()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E4%B8%93%E7%94%A8%E6%8F%92%E4%BB%B6%E4%BC%98%E5%8C%96-%E5%8D%8A%E9%80%9A%E7%94%A8"><span class="nav-text">4. ä¸“ç”¨æ’ä»¶ä¼˜åŒ– -&gt; åŠé€šç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%8F%92%E4%BB%B6-object-%E5%AF%B9%E8%B1%A1%E5%90%88%E5%B9%B6"><span class="nav-text">5. æ’ä»¶ -&gt; object å¯¹è±¡åˆå¹¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%8F%92%E4%BB%B6-%E6%B7%B1%E6%8B%B7%E8%B4%9D%E8%B5%8B%E5%80%BC%E5%BC%95%E7%94%A8"><span class="nav-text">6. æ’ä»¶ -&gt; æ·±æ‹·è´èµ‹å€¼å¼•ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%8F%92%E4%BB%B6-obj-%E5%AF%B9%E8%B1%A1-value-%E5%AE%9E%E7%8E%B0"><span class="nav-text">7. æ’ä»¶ -&gt; obj å¯¹è±¡ value å®ç°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E6%8F%92%E4%BB%B6-%E5%A4%84%E7%90%86%E5%B9%B3%E5%9D%A6%E6%8E%A7%E5%88%B6%E6%B5%81"><span class="nav-text">8. æ’ä»¶ -&gt; å¤„ç†å¹³å¦æ§åˆ¶æµ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E6%8F%92%E4%BB%B6-%E2%80%93-%E6%B7%BB%E5%8A%A0%E8%B0%83%E8%AF%95%E6%89%93%E5%8D%B0%E8%AF%AD%E5%8F%A5"><span class="nav-text">9. æ’ä»¶ â€“&gt; æ·»åŠ è°ƒè¯•æ‰“å°è¯­å¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%E3%80%81OB-%E8%A7%A3%E6%B7%B7%E6%B7%86%E4%B8%93%E9%A2%98"><span class="nav-text">å…«ã€OB è§£æ··æ·†ä¸“é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%8F%92%E4%BB%B6-%E8%BF%98%E5%8E%9F%E8%B0%83%E7%94%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">1. æ’ä»¶ -&gt; è¿˜åŸè°ƒç”¨è¡¨è¾¾å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8F%92%E4%BB%B6-object-%E5%AF%B9%E8%B1%A1%E5%90%88%E5%B9%B6"><span class="nav-text">2. æ’ä»¶ -&gt; object å¯¹è±¡åˆå¹¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8F%92%E4%BB%B6-%E6%B7%B1%E6%8B%B7%E8%B4%9D%E8%B5%8B%E5%80%BC%E5%BC%95%E7%94%A8"><span class="nav-text">3. æ’ä»¶ -&gt; æ·±æ‹·è´èµ‹å€¼å¼•ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%8F%92%E4%BB%B6-obj-%E5%AF%B9%E8%B1%A1-value-%E5%AE%9E%E7%8E%B0"><span class="nav-text">4. æ’ä»¶ -&gt; obj å¯¹è±¡ value å®ç°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%8F%92%E4%BB%B6-%E5%A4%84%E7%90%86%E5%B9%B3%E5%9D%A6%E6%8E%A7%E5%88%B6%E6%B5%81"><span class="nav-text">5. æ’ä»¶ -&gt; å¤„ç†å¹³å¦æ§åˆ¶æµ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E9%87%8D%E7%82%B9-AST-%E8%BF%98%E5%8E%9F%E4%B8%93%E9%A2%98"><span class="nav-text">ä¹ã€é‡ç‚¹ AST è¿˜åŸä¸“é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%A1%88%E4%BE%8B-%E5%A4%8D%E6%9D%82%E6%8E%A7%E5%88%B6%E6%B5%81%E8%BF%98%E5%8E%9F"><span class="nav-text">1. æ¡ˆä¾‹ -&gt; å¤æ‚æ§åˆ¶æµè¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%A1%88%E4%BE%8B%E4%BC%98%E5%8C%96-%E5%A4%8D%E6%9D%82%E6%8E%A7%E5%88%B6%E6%B5%81%E8%BF%98%E5%8E%9F"><span class="nav-text">2. æ¡ˆä¾‹ä¼˜åŒ– -&gt; å¤æ‚æ§åˆ¶æµè¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%A1%86%E6%9E%B6-%E9%80%9A%E7%94%A8%E7%BA%AF%E5%87%BD%E6%95%B0%E8%BF%98%E5%8E%9F"><span class="nav-text">3. æ¡†æ¶ -&gt; é€šç”¨çº¯å‡½æ•°è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%A8%A1%E7%89%88-%E4%B8%93%E7%94%A8%E5%87%BD%E6%95%B0%E8%BF%98%E5%8E%9F%E6%A8%A1%E7%89%88"><span class="nav-text">4. æ¨¡ç‰ˆ -&gt; ä¸“ç”¨å‡½æ•°è¿˜åŸæ¨¡ç‰ˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%A1%88%E4%BE%8B-datadome%E8%BF%98%E5%8E%9F"><span class="nav-text">5. æ¡ˆä¾‹ -&gt; datadomeè¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%A1%88%E4%BE%8B-px3-%E8%BF%98%E5%8E%9F"><span class="nav-text">6. æ¡ˆä¾‹ -&gt; px3 è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%8F%92%E4%BB%B6-px3-%E5%87%BD%E6%95%B0%E9%87%8D%E5%91%BD%E5%90%8D"><span class="nav-text">7. æ’ä»¶ -&gt; px3 å‡½æ•°é‡å‘½å</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E3%80%81Akamai-2-0-%E8%BF%98%E5%8E%9F%E4%B8%93%E9%A2%98"><span class="nav-text">åã€Akamai 2.0 è¿˜åŸä¸“é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0-%E6%8A%80%E5%B7%A7-%E8%BF%87-toString-%E6%A3%80%E6%B5%8B"><span class="nav-text">0. æŠ€å·§ -&gt; è¿‡ toString æ£€æµ‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%80%9D%E8%B7%AF-%E5%9B%BA%E5%AE%9A%E7%BB%93%E6%9E%9C%E5%87%BD%E6%95%B0%E8%BF%98%E5%8E%9F"><span class="nav-text">1. æ€è·¯ -&gt; å›ºå®šç»“æœå‡½æ•°è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%80%9D%E8%B7%AF-%E5%81%87%E5%87%BD%E6%95%B0%E4%BD%93%E5%86%85%E5%AE%B9%E8%BF%98%E5%8E%9F"><span class="nav-text">2. æ€è·¯ -&gt; å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%80%9D%E8%B7%AF-%E5%A4%A7%E9%87%8F%E5%AD%97%E9%9D%A2%E9%87%8F%E8%BF%98%E5%8E%9F"><span class="nav-text">3. æ€è·¯ -&gt; å¤§é‡å­—é¢é‡è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%80%9D%E8%B7%AF-ob-%E5%85%B8%E5%9E%8B%E8%8A%B1%E6%8C%87%E4%BB%A4%E8%BF%98%E5%8E%9F"><span class="nav-text">4. æ€è·¯ -&gt; ob å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    Copyright&nbsp;&copy;&nbsp;<span>2021</span>&nbsp;-&nbsp;2025&nbsp;<a href="https://xfblog.cn/" target="_self">å°å‚…åšå®¢</a>&nbsp;-&nbsp;All&nbsp;rights&nbsp;reserved.&nbsp;&nbsp;&nbsp;&nbsp;
    
            <!-- &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">xfblog</a> -->
        
    </div>

    <!-- <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div> -->

    

    

        
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%B6%E3%80%81AST-%E9%80%9A%E7%94%A8%E6%A8%A1%E7%89%88"><span class="nav-text">é›¶ã€AST é€šç”¨æ¨¡ç‰ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%A7%A3%E6%B7%B7%E6%B7%86%E6%80%9D%E8%B7%AF%E4%B8%8E%E7%BB%86%E8%8A%82%E5%A4%84%E7%90%86"><span class="nav-text">1. __è§£æ··æ·†æ€è·¯ä¸ç»†èŠ‚å¤„ç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%A8%A1%E7%89%88-%E7%AE%80%E6%98%93%E7%89%88%E8%A7%A3%E6%B7%B7%E6%B7%86%E6%A8%A1%E7%89%88"><span class="nav-text">2. æ¨¡ç‰ˆ -&gt; ç®€æ˜“ç‰ˆè§£æ··æ·†æ¨¡ç‰ˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%A8%A1%E7%89%88-%E5%B8%B8%E7%94%A8-banding-%E5%86%99%E6%B3%95"><span class="nav-text">3. æ¨¡ç‰ˆ -&gt; å¸¸ç”¨ banding å†™æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%A8%A1%E7%89%88-%E9%A2%84%E5%A4%84%E7%90%86%E8%A7%A3%E6%B7%B7%E6%B7%86%E6%A8%A1%E7%89%88"><span class="nav-text">4. æ¨¡ç‰ˆ -&gt; é¢„å¤„ç†è§£æ··æ·†æ¨¡ç‰ˆ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81AST-%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98"><span class="nav-text">ä¸€ã€AST æŠ€æœ¯ä¸“é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%E5%8E%9F%E7%90%86"><span class="nav-text">1. ä»£ç æ··æ·†åŸç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%AF%AD%E6%B3%95%E6%A0%91%E8%8A%82%E7%82%B9%E5%90%8D%E8%AF%8D"><span class="nav-text">2. è¯­æ³•æ ‘èŠ‚ç‚¹åè¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-bable"><span class="nav-text">3. bable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-path"><span class="nav-text">4. path</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-scope"><span class="nav-text">5. scope</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E5%B8%B8%E8%A7%81%E8%AF%AD%E6%B3%95%E6%8A%80%E5%B7%A7"><span class="nav-text">6. å¸¸è§è¯­æ³•æŠ€å·§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-ast-%E5%BF%85%E5%A4%87-js-%E8%AF%AD%E6%B3%95%E4%B8%8E%E7%89%B9%E6%80%A7"><span class="nav-text">7. ast å¿…å¤‡ js è¯­æ³•ä¸ç‰¹æ€§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E5%8A%A8%E6%80%81-js-%E6%9B%BF%E6%8D%A2%E8%B0%83%E8%AF%95"><span class="nav-text">8. åŠ¨æ€ js æ›¿æ¢è°ƒè¯•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%88%A4%E6%96%AD%E8%8A%82%E7%82%B9%E9%80%9A%E7%94%A8%E5%87%BD%E6%95%B0"><span class="nav-text">äºŒã€åˆ¤æ–­èŠ‚ç‚¹é€šç”¨å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%87%BD%E6%95%B0-%E8%8A%82%E7%82%B9%E5%AD%97%E9%9D%A2%E9%87%8F%E5%9F%BA%E7%A1%80%E5%88%A4%E6%96%AD"><span class="nav-text">1. å‡½æ•° -&gt; èŠ‚ç‚¹å­—é¢é‡åŸºç¡€åˆ¤æ–­</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%87%BD%E6%95%B0-%E8%8A%82%E7%82%B9%E5%AD%97%E9%9D%A2%E9%87%8F%E9%80%92%E5%BD%92%E5%88%A4%E6%96%AD"><span class="nav-text">2. å‡½æ•° -&gt; èŠ‚ç‚¹å­—é¢é‡é€’å½’åˆ¤æ–­</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%87%BD%E6%95%B0%E4%BC%98%E5%8C%96-%E8%8A%82%E7%82%B9%E5%AD%90%E9%9D%A2%E9%87%8F%E5%88%A4%E6%96%AD"><span class="nav-text">3. å‡½æ•°ä¼˜åŒ– -&gt; èŠ‚ç‚¹å­é¢é‡åˆ¤æ–­</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%87%BD%E6%95%B0-%E5%88%A4%E6%96%AD%E8%8A%82%E7%82%B9%E6%98%AF%E5%90%A6%E7%BA%AF%E5%87%BD%E6%95%B0"><span class="nav-text">3. å‡½æ•° -&gt; åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦çº¯å‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E8%A7%A3%E6%B7%B7%E6%B7%86%E9%80%9A%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="nav-text">ä¸‰ã€è§£æ··æ·†é€šç”¨æ’ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%8F%92%E4%BB%B6-%E7%BC%96%E7%A0%81%E8%BF%98%E5%8E%9F%E5%8D%81%E8%BF%9B%E5%88%B6"><span class="nav-text">1. æ’ä»¶ -&gt; ç¼–ç è¿˜åŸåè¿›åˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8F%92%E4%BB%B6-%E6%A0%87%E8%AF%86%E7%AC%A6%E7%BB%9F%E4%B8%80%E5%AD%97%E9%9D%A2%E9%87%8F%E5%8C%96"><span class="nav-text">2. æ’ä»¶ -&gt; æ ‡è¯†ç¬¦ç»Ÿä¸€å­—é¢é‡åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8F%92%E4%BB%B6-%E6%8A%98%E5%8F%A0%E5%AD%97%E9%9D%A2%E9%87%8F%E6%88%96%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">3. æ’ä»¶ -&gt; æŠ˜å å­—é¢é‡æˆ–è¡¨è¾¾å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%8F%92%E4%BB%B6-%E7%AE%80%E5%8C%96%E5%BE%AA%E7%8E%AF%E5%92%8C-if-%E8%AF%AD%E5%8F%A5"><span class="nav-text">4. æ’ä»¶ -&gt; ç®€åŒ–å¾ªç¯å’Œ if è¯­å¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%8F%92%E4%BB%B6-%E7%AE%80%E5%8C%96%E9%80%97%E5%8F%B7%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">5. æ’ä»¶ -&gt; ç®€åŒ–é€—å·è¡¨è¾¾å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%8F%92%E4%BB%B6-%E5%AF%B9%E8%B1%A1-val-%E5%80%BC%E5%85%A8%E4%B8%BA%E5%B8%B8%E9%87%8F"><span class="nav-text">6. æ’ä»¶ -&gt; å¯¹è±¡ val å€¼å…¨ä¸ºå¸¸é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%8F%92%E4%BB%B6-%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E5%85%A8%E4%B8%BA%E5%B8%B8%E9%87%8F"><span class="nav-text">7. æ’ä»¶ -&gt; æ•°ç»„å…ƒç´ å…¨ä¸ºå¸¸é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E6%8F%92%E4%BB%B6-%E5%9E%83%E5%9C%BE%E4%BB%A3%E7%A0%81%E5%88%A0%E9%99%A4"><span class="nav-text">8. æ’ä»¶ -&gt; åƒåœ¾ä»£ç åˆ é™¤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%8F%98%E9%87%8F%E7%9B%B8%E5%85%B3%E6%8F%92%E4%BB%B6"><span class="nav-text">å››ã€å˜é‡ç›¸å…³æ’ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%8F%92%E4%BB%B6-%E5%88%86%E7%A6%BB%E5%A4%9A%E4%B8%AA%E5%8F%98%E9%87%8F%E5%90%8C%E5%AE%9A%E4%B9%89"><span class="nav-text">1. æ’ä»¶ -&gt; åˆ†ç¦»å¤šä¸ªå˜é‡åŒå®šä¹‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8F%92%E4%BB%B6-%E5%90%88%E5%B9%B6%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E4%B8%8E%E5%AE%9A%E4%B9%89"><span class="nav-text">2. æ’ä»¶ -&gt; åˆå¹¶å˜é‡å£°æ˜ä¸å®šä¹‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8F%92%E4%BB%B6-%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0%E8%BD%AC%E8%87%AA%E5%AE%9A"><span class="nav-text">3. æ’ä»¶ -&gt; å˜é‡å®šä¹‰å‡½æ•°è½¬è‡ªå®š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%8F%92%E4%BB%B6-%E5%AE%9A%E4%B9%89%E5%AD%97%E9%9D%A2%E9%87%8F%E6%9C%AA%E6%94%B9%E8%BF%98%E5%8E%9F"><span class="nav-text">4. æ’ä»¶ -&gt; å®šä¹‰å­—é¢é‡æœªæ”¹è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%8F%92%E4%BB%B6-%E8%B5%8B%E5%80%BC%E5%AD%97%E9%9D%A2%E9%87%8F%E6%9C%AA%E6%94%B9%E8%BF%98%E5%8E%9F"><span class="nav-text">5. æ’ä»¶ -&gt; èµ‹å€¼å­—é¢é‡æœªæ”¹è¿˜åŸ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%87%BD%E6%95%B0%E7%9B%B8%E5%85%B3%E6%8F%92%E4%BB%B6"><span class="nav-text">äº”ã€å‡½æ•°ç›¸å…³æ’ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%8F%92%E4%BB%B6-%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%BF%98%E5%8E%9F"><span class="nav-text">1. æ’ä»¶ -&gt; å†…ç½®å‡½æ•°è°ƒç”¨è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8F%92%E4%BB%B6-%E5%81%87%E5%87%BD%E6%95%B0%E4%BD%93%E5%86%85%E5%AE%B9%E8%BF%98%E5%8E%9F"><span class="nav-text">2. æ’ä»¶ -&gt; å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8F%92%E4%BB%B6-ob-%E5%85%B8%E5%9E%8B%E8%8A%B1%E6%8C%87%E4%BB%A4%E8%BF%98%E5%8E%9F"><span class="nav-text">3. æ’ä»¶ -&gt; ob å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E6%9D%A1%E4%BB%B6%E4%B8%8E%E9%80%BB%E8%BE%91%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9B%B8%E5%85%B3%E6%8F%92%E4%BB%B6"><span class="nav-text">å…­ã€æ¡ä»¶ä¸é€»è¾‘è¡¨è¾¾å¼ç›¸å…³æ’ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%B5%8C%E5%A5%97%E5%9C%A8%E8%AF%AD%E5%8F%A5%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8C%96"><span class="nav-text">1. åµŒå¥—åœ¨è¯­å¥ä¸­çš„ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9D%A1%E4%BB%B6%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%BD%AC-if-%E8%AF%AD%E5%8F%A5"><span class="nav-text">2. æ¡ä»¶è¡¨è¾¾å¼è½¬ if è¯­å¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%815s-%E7%9B%BE%E8%A7%A3%E6%B7%B7%E6%B7%86%E4%B8%93%E9%A2%98"><span class="nav-text">ä¸ƒã€5s ç›¾è§£æ··æ·†ä¸“é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%96%B0%E7%89%88%E9%80%9A%E7%94%A8%E6%8F%92%E4%BB%B6-%E8%AF%BB%E5%8F%96%E8%A7%A3%E5%AF%86%E4%BB%A3%E7%A0%81"><span class="nav-text">1. æ–°ç‰ˆé€šç”¨æ’ä»¶ -&gt; è¯»å–è§£å¯†ä»£ç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%96%B0%E7%89%88%E9%80%9A%E7%94%A8%E6%8F%92%E4%BB%B6-%E8%BF%98%E5%8E%9F-call"><span class="nav-text">2. æ–°ç‰ˆé€šç”¨æ’ä»¶ -&gt; è¿˜åŸ call()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%B8%93%E7%94%A8%E6%8F%92%E4%BB%B6-%E8%AF%BB%E5%8F%96%E5%B9%B6%E8%BF%98%E5%8E%9F-call"><span class="nav-text">3. ä¸“ç”¨æ’ä»¶ -&gt; è¯»å–å¹¶è¿˜åŸ call()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E4%B8%93%E7%94%A8%E6%8F%92%E4%BB%B6%E4%BC%98%E5%8C%96-%E5%8D%8A%E9%80%9A%E7%94%A8"><span class="nav-text">4. ä¸“ç”¨æ’ä»¶ä¼˜åŒ– -&gt; åŠé€šç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%8F%92%E4%BB%B6-object-%E5%AF%B9%E8%B1%A1%E5%90%88%E5%B9%B6"><span class="nav-text">5. æ’ä»¶ -&gt; object å¯¹è±¡åˆå¹¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%8F%92%E4%BB%B6-%E6%B7%B1%E6%8B%B7%E8%B4%9D%E8%B5%8B%E5%80%BC%E5%BC%95%E7%94%A8"><span class="nav-text">6. æ’ä»¶ -&gt; æ·±æ‹·è´èµ‹å€¼å¼•ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%8F%92%E4%BB%B6-obj-%E5%AF%B9%E8%B1%A1-value-%E5%AE%9E%E7%8E%B0"><span class="nav-text">7. æ’ä»¶ -&gt; obj å¯¹è±¡ value å®ç°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E6%8F%92%E4%BB%B6-%E5%A4%84%E7%90%86%E5%B9%B3%E5%9D%A6%E6%8E%A7%E5%88%B6%E6%B5%81"><span class="nav-text">8. æ’ä»¶ -&gt; å¤„ç†å¹³å¦æ§åˆ¶æµ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E6%8F%92%E4%BB%B6-%E2%80%93-%E6%B7%BB%E5%8A%A0%E8%B0%83%E8%AF%95%E6%89%93%E5%8D%B0%E8%AF%AD%E5%8F%A5"><span class="nav-text">9. æ’ä»¶ â€“&gt; æ·»åŠ è°ƒè¯•æ‰“å°è¯­å¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%E3%80%81OB-%E8%A7%A3%E6%B7%B7%E6%B7%86%E4%B8%93%E9%A2%98"><span class="nav-text">å…«ã€OB è§£æ··æ·†ä¸“é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%8F%92%E4%BB%B6-%E8%BF%98%E5%8E%9F%E8%B0%83%E7%94%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">1. æ’ä»¶ -&gt; è¿˜åŸè°ƒç”¨è¡¨è¾¾å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8F%92%E4%BB%B6-object-%E5%AF%B9%E8%B1%A1%E5%90%88%E5%B9%B6"><span class="nav-text">2. æ’ä»¶ -&gt; object å¯¹è±¡åˆå¹¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8F%92%E4%BB%B6-%E6%B7%B1%E6%8B%B7%E8%B4%9D%E8%B5%8B%E5%80%BC%E5%BC%95%E7%94%A8"><span class="nav-text">3. æ’ä»¶ -&gt; æ·±æ‹·è´èµ‹å€¼å¼•ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%8F%92%E4%BB%B6-obj-%E5%AF%B9%E8%B1%A1-value-%E5%AE%9E%E7%8E%B0"><span class="nav-text">4. æ’ä»¶ -&gt; obj å¯¹è±¡ value å®ç°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%8F%92%E4%BB%B6-%E5%A4%84%E7%90%86%E5%B9%B3%E5%9D%A6%E6%8E%A7%E5%88%B6%E6%B5%81"><span class="nav-text">5. æ’ä»¶ -&gt; å¤„ç†å¹³å¦æ§åˆ¶æµ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E9%87%8D%E7%82%B9-AST-%E8%BF%98%E5%8E%9F%E4%B8%93%E9%A2%98"><span class="nav-text">ä¹ã€é‡ç‚¹ AST è¿˜åŸä¸“é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%A1%88%E4%BE%8B-%E5%A4%8D%E6%9D%82%E6%8E%A7%E5%88%B6%E6%B5%81%E8%BF%98%E5%8E%9F"><span class="nav-text">1. æ¡ˆä¾‹ -&gt; å¤æ‚æ§åˆ¶æµè¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%A1%88%E4%BE%8B%E4%BC%98%E5%8C%96-%E5%A4%8D%E6%9D%82%E6%8E%A7%E5%88%B6%E6%B5%81%E8%BF%98%E5%8E%9F"><span class="nav-text">2. æ¡ˆä¾‹ä¼˜åŒ– -&gt; å¤æ‚æ§åˆ¶æµè¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%A1%86%E6%9E%B6-%E9%80%9A%E7%94%A8%E7%BA%AF%E5%87%BD%E6%95%B0%E8%BF%98%E5%8E%9F"><span class="nav-text">3. æ¡†æ¶ -&gt; é€šç”¨çº¯å‡½æ•°è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%A8%A1%E7%89%88-%E4%B8%93%E7%94%A8%E5%87%BD%E6%95%B0%E8%BF%98%E5%8E%9F%E6%A8%A1%E7%89%88"><span class="nav-text">4. æ¨¡ç‰ˆ -&gt; ä¸“ç”¨å‡½æ•°è¿˜åŸæ¨¡ç‰ˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%A1%88%E4%BE%8B-datadome%E8%BF%98%E5%8E%9F"><span class="nav-text">5. æ¡ˆä¾‹ -&gt; datadomeè¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%A1%88%E4%BE%8B-px3-%E8%BF%98%E5%8E%9F"><span class="nav-text">6. æ¡ˆä¾‹ -&gt; px3 è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%8F%92%E4%BB%B6-px3-%E5%87%BD%E6%95%B0%E9%87%8D%E5%91%BD%E5%90%8D"><span class="nav-text">7. æ’ä»¶ -&gt; px3 å‡½æ•°é‡å‘½å</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E3%80%81Akamai-2-0-%E8%BF%98%E5%8E%9F%E4%B8%93%E9%A2%98"><span class="nav-text">åã€Akamai 2.0 è¿˜åŸä¸“é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0-%E6%8A%80%E5%B7%A7-%E8%BF%87-toString-%E6%A3%80%E6%B5%8B"><span class="nav-text">0. æŠ€å·§ -&gt; è¿‡ toString æ£€æµ‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%80%9D%E8%B7%AF-%E5%9B%BA%E5%AE%9A%E7%BB%93%E6%9E%9C%E5%87%BD%E6%95%B0%E8%BF%98%E5%8E%9F"><span class="nav-text">1. æ€è·¯ -&gt; å›ºå®šç»“æœå‡½æ•°è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%80%9D%E8%B7%AF-%E5%81%87%E5%87%BD%E6%95%B0%E4%BD%93%E5%86%85%E5%AE%B9%E8%BF%98%E5%8E%9F"><span class="nav-text">2. æ€è·¯ -&gt; å‡å‡½æ•°ä½“å†…å®¹è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%80%9D%E8%B7%AF-%E5%A4%A7%E9%87%8F%E5%AD%97%E9%9D%A2%E9%87%8F%E8%BF%98%E5%8E%9F"><span class="nav-text">3. æ€è·¯ -&gt; å¤§é‡å­—é¢é‡è¿˜åŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%80%9D%E8%B7%AF-ob-%E5%85%B8%E5%9E%8B%E8%8A%B1%E6%8C%87%E4%BB%A4%E8%BF%98%E5%8E%9F"><span class="nav-text">4. æ€è·¯ -&gt; ob å…¸å‹èŠ±æŒ‡ä»¤è¿˜åŸ</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/toggle-theme.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/code-block.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/local-search.js"></script>


<!-- lazyload -->

    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/lazyload.js"></script>


<div class="pjax">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/post/post-helper.js"></script>

        <!-- toc -->
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/post/toc.js"></script>
        

        <!-- copyright-info -->
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/post/copyright-info.js"></script>
        

        <!-- share -->
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/post/share.js"></script>
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->

    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.2.5/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart()
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd()
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'))
            KEEP.initExecute()
        });
    });
</script>




    
        
            
<script class="custom-inject-js" src="/js/run_time.js" data-pjax></script>

        
    
        
            
<script class="custom-inject-js" src="/js/code_click_copy.js" data-pjax></script>

        
    
        
            
<script class="custom-inject-js" src="/js/copyrightpro.js" data-pjax></script>

        
    

</body>
</html>
